<html>

<head>
<meta name="GENERATOR" content="Notepad">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="Author" content="Steve McMahon">
<meta name="KeyWords" content="VB, VB6, Visual Basic, Visual Basic 5, Visual Basic 6, Dynamic HTML, DHTML, IE4, Internet Explorer, Internet Explorer 4, Active X, Active X Controls, Visual Basic Controls">
<meta name="Description" content="Provides controls allowing you to create drop-down windows from any VB Form. Includes full source.">
<title>vbAccelerator Drop-Down and Popup Form Control</title>
</head>

<body bgcolor="#FFFFFF" topmargin="0" leftmargin="0" link="#660000" vlink="#999966" LEFTMARGIN="0" TOPMARGIN="0" MARGINHEIGHT="0" MARGINWIDTH="0" background="..\..\images\legacy.html">

<!-- AD:START -->
<table bgcolor="#336699" border="0" cellpadding="0" cellspacing="0" width="100%" >
<tr>
<td width="468">
<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<a href="..\..\home\index.html"><img src="..\..\home\res\vbaccelad.png" width="468" height="60" 
border="0" alt="vbAccelerator - Faster VB and .NET Code" /></a>
</noscript>
</td>
<td>
<a href="..\..\home\index.html"><img src="..\..\home\res\vbaccelnew.png" width="125" height="60" 
border="0" alt="The new vbAccelerator Site - more VB and .NET Code and Controls" /></a>
</td>
</tr>
</table>
<!-- AD:END -->

<a name="sectop"></a>	
<table border="0" width="100%" cellspacing="0" cellpadding="0">
<tr bgcolor="#660000">
	<td width="100%" height="25">
	<font color="#FFFFFF" face="verdana,arial,helvetica" size="2"><strong>
	Source Code
	</strong>
	</font>
	</td>
	<td width="96">
	<font color="#FFFFFF" face="verdana,arial,helvetica" size="2"><strong>
	<a title="Installation Instructions and Requirements" href="..\..\install.htm"><img src="..\..\images\install.gif" height="12" width="96" border="0" valign="center"></a>
	</strong>
	</font>
	</td>
	<td width="96">
	<font color="#FFFFFF" face="verdana,arial,helvetica" size="2"><strong>
	<a title="Back to Source Code" href="..\..\overview.htm"><img src="..\..\images\srccode.gif" height="12" width="96" border="0" valign="center"></a>
	</strong>
	</font>
	</td>
</tr>
</table>
<table border="0" width="100%" cellspacing="0" cellpadding="0">
<tr bgcolor="#FFCC00">
	<td valign="bottom" width="32">
	<font color="#666666" face="verdana,arial,helvetica" size="6"><strong>1</strong></font>
	</td>
	<td valign="center">
	<font color="#666666" face="verdana,arial,helvetica" size="4"><strong>VB 5 Custom Controls</strong></font>
	</td>
	<td width="10">&nbsp</td>
</tr>
</table>

<!-- SUPERCEEDED:START -->
<br />
<table border="0" width="100%" cellspacing="0" cellpadding="5">
<tr>
<td width="66" bgcolor="#FFFFFF"><br /></td>
<td width="100%" bgcolor="#EEEEEE">
	<p>
	<font color="#666666" face="verdana,arial,helvetica" size="5">
	<b>&nbsp;NOTE:</b></font>
	<font color="#999999" face="verdana,arial,helvetica" size="2">this code has been superceded by the <a href="..\..\home\vb\code\controls\drop_down_tool_windows\drop_down_form_control\article.html" target="_top">version at the new site</a>.
	</font>
	<br />
        </p>
</td>
<td width="66" bgcolor="#FFFFFF"><br /></td>
</tr>
</table>
<br />
<!-- SUPERCEDED:END -->

<table border="0" width="100%" cellspacing="0" cellpadding="0">
<tr bgcolor="#EEEEEE">
	<td>&nbsp</td>
	<td>
	<font color="#000000" face="verdana,arial,helvetica" size="2">
	<p><b>vbAccelerator Drop-Down and Popup Form Control</b></p>
	</font>
	</td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>
	<font color="#660000" face="verdana,arial,helvetica" size="1">
	<p>Enables any VB form to be used as a drop-down, plus ensures all forms with the ToolWindow style operate just like Office</p>
	</font>	
	</td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td>&nbsp;</td>
	<td>
	<p>
	<font color="#000000" face="verdana,arial,helvetica" size="2">
	<img src="..\..\images\vbalddfm.gif" alt="MDI Project With Three Windows Under Drop-Down Form Control" width="200" height="142"><br>
	<br>
	</font>
	</p>
	<p>
	<p>
	<table border="0" cellspacing="0" cellpadding="2" width="100%"	<tr>
		<td colspan="5" bgcolor="#99CCFF">
		<font color="#000000" face="verdana,arial,helvetica" size="1">
		<b>Download Code</b>
		</font>
		</td>
	</tr>
	<tr>
	<td valign="top" width="16"><a href="vbalddfm.zip"><img src="..\..\images\vbdnload.gif" width="16" height="16" border="0" hspace="4" alt="VB5 code"></a></td>
	<td width="45%"><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="vbalddfm.zip">VB5 Control Binary (19kb)</a></font></td>
	<td width="3"><img src="..\..\images\grpixel.gif" width="1" height="1" hspace="0"></td>
	<td valign="top" width="16"><a href="vbalddfm6.zip"><img src="..\..\images\vbdnld6.gif" width="16" height="16" border="0" hspace="4" alt="VB6 code"></a></td>
	<td width="45%"><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="vbalddfm6.zip">VB6 Control Binary (19kb)</a></font></td>
	</tr>
	<tr>
	<td valign="top" width="16"><a href="ddfmdem.zip"><img src="..\..\images\vbdnload.gif" width="16" height="16" border="0" hspace="4" alt="VB5 code"></a></td>
	<td><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="ddfmdem.zip">VB5 Demonstration Project (45kb)</a></font></td>
	<td width="3"><img src="..\..\images\grpixel.gif" width="1" height="1" hspace="0"></td>
	<td valign="top" width="16"><a href="ddfmdem6.zip"><img src="..\..\images\vbdnld6.gif" width="16" height="16" border="0" hspace="4" alt="VB6 code"></a></td>
	<td><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="ddfmdem6.zip">VB6 Demonstration Project (45kb)</a></font></td>
	</tr>
	<tr>
	<td valign="top" width="16"><a href="ddfmall.zip"><img src="..\..\images\vbdnload.gif" width="16" height="16" border="0" hspace="4" alt="VB5 code"></a></td>
	<td><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="ddfmall.zip">VB5 Full Source Code (87kb)</a></font></td>
	<td width="3"><img src="..\..\images\grpixel.gif" width="1" height="1" hspace="0"></td>
	<td valign="top" width="16"><a href="ddfmall6.zip"><img src="..\..\images\vbdnld6.gif" width="16" height="16" border="0" hspace="4" alt="VB6 code"></a></td>
	<td><font color="#000000" face="verdana,arial,helvetica" size="2"><a href="ddfmall6.zip">VB6 Full Source Code (87kb)</a></font></td>
	</tr>

	<tr>
	<td colspan="2" valign="top"><font color="#000000" face="verdana,arial,helvetica" size="1"><b>Required Files:</b>
		<li><a href="..\..\index\projidx.htm#ssubtmr.dll">vbAccelerator SSubTmr.DLL for VB5</a>
	</td>
	<td width="3"><img src="..\..\images\grpixel.gif" width="1" height="1%" hspace="0"></td>
	<td colspan="2" valign="top"><font color="#000000" face="verdana,arial,helvetica" size="1"><b>Required Files:</b>
		<li><a href="..\..\index\projidx.htm#ssubtmr6.dll">vbAccelerator SSubTmr6.DLL for VB6</a>
	</td>
	</tr>
	</table>
	<br>
	<table>
	<tr>
		<td width="20">&nbsp</td>
		<td colspan="2" bgcolor="#EEEEEE">
		<font color="#000000" face="verdana,arial,helvetica" size="1">
		<b>Source Code Note</b>
		</font>
		</td>
		<td width="30">&nbsp</td>
	</tr>
	<tr>
		<td width="20">&nbsp</td>
		<td valign="top"><img src="..\..\images\bullet.gif" border="0" hspace="2" width="8" height="8"></td>
		<td>
		<font color="#000000" face="verdana,arial,helvetica" size="1">
		This OCX is a binary compatible component which works with all other samples.  
		If you compile your own copy of this OCX yourself <b>please</b> make sure you change
		the name.  See <a href="..\..\mission.htm" target="vbamain">disclaimer and license</a> for more details.
		</font>
		</td>
		<td>&nbsp</td>
	</tr>
	</table>
	</p>
	<font color="#000000" face="verdana,arial,helvetica" size="2">
	<p><b>Overview</b><br>	
	It allows you to use any form as a drop-down window, and optionally to drag
	the form off and float it over the form.  The form behaves just like the drop-down
	windows in Office, albeit you cannot currently dock them (yet!)  The code includes a VB
	titlebar modifier class which ensures that any owned forms with the 
	<i>WS_EX_TOOLWINDOW</i> style
	(i.e. VB WindowStyles 4 and 5) shown in a VB app do not take focus away 
	from the owner form's titlebar - and the form also stays active in the 
	TaskBar too.  This functionality is completely
	generic and works regardless of how many taskbar forms you have in your app.
	<br><br>
	<b>Please Release Me</b><br>
	The preview of this control was launched back in August, with the aim of a release a month later
	Unfortunately, the preview version hit a snag.  When you showed a drop-down window,
	the tasklist switched so it looked like your form was inactive.  It doesn't sound like much, 
	does it?  Surely you could fix that with a couple of quick API calls?  Well, that just didn't
	happen.  The problem with this sort of thing is that whilst VB performs incorrectly, the
	implementation is hidden and there is no way of working out what it is doing.  And the
	implementation relies on certain messages being passed correctly, so although it was possible
	to solve parts of the problem (keep the form's titlebar in focus or keep the task bar icon
	highlighted), many of the solutions had consequences on VB's ability to track the focus 
	control or form. These consequences vary from the tedious (focus always switches to
	an MDI child form, or have to click twice on a control to make it operate) to the 
	dramatic (blue screen of death, Kernel32.exe faults, white GPF screens, deadcafe...  I've had 
	every single one now!)
	<br><br>
	<b><a href="badjoke.htm">The Question, or the Answer?</a></b><br>
	Anyway, seven months later, I spotted a Q&A article by Karl Peterson  
	in <a href="..\..\linxadv.htm#secdevx">VBPJ</a>, where he writes an &quot;Ask the VB Pro&quot;
	column.  The question in question was how to set your application's icon so it always shows
	correctly in the Alt-Tab list. The interesting thing about the article was it described how
	VB creates a hidden window (with the class name <i>ThunderMain</i>) which is the 
	ultimate owner of all other VB windows in a VB application.
	Hmmm... So would that affect the TaskBar, then?
	<br><br>
	You can find the window if you fire up Spy++ and point it at a top-level VB form 
	and then look for the parent window, or, if you're in VB, you can get the window handle using the
	<i>GetWindow</i> API call:
	<br><br>
<font face="Lucida Console,courier new" size="1">
&nbsp;&nbsp;&nbsp;hWndThunderMain = GetWindow(Me.hWnd, GW_OWNER)<br>
</font>
	<br><br>
	It took some playing to work out that you can prevent
	the Taskbar icon from losing its highlight by making the ThunderMain
	window invisible when you are about to show an owned window.  A bit more
	playing revealed that the perfect behaviour was achieved if you instead just
	stripped the <i>WS_VISIBLE</i> style bit at the appropriate time, the 
	appropriate time being when the ThunderMain window gets a  
	<i>WM_WINDOWPOSCHANGING</i> message, because it is about to modify the ZOrder
	position and when the window returned by the <i>GetActiveWindow</i>
	API call is owned by another VB window rather than ThunderMain.
	Cool!  Three or four versions later, and finally here is the code: a full, generic 
	implementation of the MS Office integration of its main
	window with Win32, which works on Win95,98,NT and 2000.	
	<br><br>
	<b>Pregnant - by the Boy I was Babysitting</b><br>
	Since VB operates by only setting up one ThunderMain window per VB application, this results
	in a tricky coding problem when it comes to add the subclass.  If every window
	just adds a subclass to the ThunderMain window, then you end up processing the
	same message multiple times when a window is shown. This works fine when you
	have one window in the application - but of course, that isn't a problem anyway!
	When you have two windows, you get into problems, particularly when the windows
	have contradictory intentions about what to do with the taskbar icon -
	and they start &quot;fighting&quot; each other, causing your VB app to go into
	a flickering loop which can only be stopped by extreme use of Task Manager :)
	<br><br>
	The solution to this problem is to ensure that regardless of the source object,
	only one subclass is installed, and its processing works without reference to
	the object which installed the subclass (otherwise you need to fire the same
	message to multiple objects, and they could return conflicting results).  
	<br><br>
	Whilst
	the <a href="..\ssubtmr\ssubtmr.htm">Subclassing and Timer Assistant</a> component
	available from this site solves most subclassing issues, it doesn't solve this one,
	so some customised subclassing code was needed to ensure the object behaves in
	this manner.  You can find this code in the module <i>mTitleBarMod.bas</i> within
	the Drop-Down form control.  Note that if any other component within your 
	application needed to subclass the hidden VB window, you could run into problems
	with this subclassing approach: it would no longer be guaranteed to receive
	messages in the same order and hence the focus processing could be lost.
	<br><br>
	<b>The Drop-Down Form Package</b><br>
	This object is compiled as an ActiveX control with two constituent controls:
	<ol>
	
	<li><b>vbalTitleBarModifier</b><br>
	This component is invisible at runtime and installs the <i>ThunderMain</i> 
	subclasser discussed above to ensure the titlebar activation is correct.  This
	component should be added to all main forms in your application.
	<br><br>
	In use, this component has only one method; <i>Attach</i>.  You pass in the 
	<i>hWnd</i> of the form you are trying to show as a parameter and the control
	then does all the rest of the work.
	<br><br>
	<li><b>vbalDropDownClient</b><br>
	This component acts as a replacement titlebar on windows with VB <i>WindowStyle</i>
	4 or 5 and the <i>Caption</i> property set to blank and <i>ControlBox</i> set to False. 
	It provides the automatic hide functionality when the form is set to drop-down and
	also enables the form to be &quot;dragged-off&quot and floated on the screen.  It
	also provides methods to restrict the size of the window on screen and can
	be used to auto-hide floating toolwindows when the user switches to anther
	application similar to the behaviour of Word and Excel.
	<br><br>
	This component provides a number of useful events to your dropdown window:
	<ul>
	<li><i>AppActivate</i> - Raised whenever the application is activated or inactivated. 
	You can hide/show the tool window here to emulate the behaviour of Office.
	<li><i>DeactivateForm</i> - Raised whenever focus switches from the ToolWindow
	to another form in the application.  If the window is in the drop-down state,
	then the control post a <i>WM_CLOSE</i> message to the form, which has the
	same effect as if the user chose the System Menu close option.
	<li><i>CaptionResize</i> - Raised when the control has resized the caption, for
	example, when the form switches between the drop-down and floating states.  This
	event enables you to position the controls on the form to the appropriate point.
	<li><i>Moving</i> - Raised whenever the form is moved.  You can control the
	position of the form by modifying the left, top, width and height parameters of
	this event.
	<li><i>RightClick</i> - Raised whenever the user right clicks on the control.
	<li><i>Sizing</i> - Raised whenever the form is sized.  You can control the
	position and size of the form by modifying the left,top,width and height 
	parameters of this event.
	</ul>
	The control's behaviour can be customised using the properties and methods:
	<ul>
	<li><i>AllowResize</i><br>This property enables you to create a form which
	behaves like the Fixed ToolWindow but with the more pleasant 3D border 
	provided by a Sizable ToolWindow.
	<li><i>AllowTearOff</i><br>Determines whether you can tear-off the control 
	when it is in the drop-down state.
	<li><i>Caption</i><br>Gets/sets the caption of the Tool Window.
	<li><i>MoveOnFormMouseDown</i><br>If set to True, enables mouse clicks on the
	form to start the form moving as if it was a click on the titlebar.
	<li><i>ShowState</i><br>Gets/sets the current state of the Tool Window - hidden,
	shown in the drop-down position or shown floating. 
	</ul>
	</ol>
	For more information on the techniques used to detect sizing and activation
	changes in these controls, check out these articles:
	<ul>
	<li><a href="..\ssubtmr\yielddet.htm">Detecting when another application is activate</a>
	<li><a href="..\ssubtmr\ctrlres.htm">Sophisticated control over Window Sizing and Moving</a>
	<li><a href="..\ssubtmr\hittest.htm">Reliable interception of WM_NCHITTEST messages</a>
	</ul>
	<b>Showing Drop-Down Forms from Modal Forms</b><br>
	One problem with this technique is that you cannot use it directly from a form shown with
	modally in VB, otherwise you get the error message &quot;Can't show non-modal form when modal
	form is displayed&quot;.  There is a workaround for this problem by which you can emulate
	showing the form modally.  Check out the article <a href="..\ssubtmr\modalemu.htm">Emulating
	Modal Forms</a>.  This technique has the additional advantage in that it allows you to
	create VB projects which have an Internet Explorer style New Window option, but showing a
	modal form in one window does not block execution in the other.
	<br><br><br>
	</p>

	</font>
	</td>
	<td>&nbsp</td>
</tr>
<tr>
	<td>&nbsp</td>
	<td colspan="2">
	<font color="#000000" face="verdana,arial,helvetica" size="2">
	<br><br><br>
	<p><a href="#sectop"><img src="..\..\images\top.gif" border="0" width="8" height="12" hspace="4" alt="Top"></a>Back to <a href="#sectop">top</a><br>
	<a href="..\..\overview.htm"><img src="..\..\images\sc.gif" border="0" width="8" height="12" hspace="4" alt="Source Code - What We're About!"></a>Back to <a href="..\..\overview.htm">Source Code</a></p>
	</font>
	</td>
	<td>&nbsp</td>
</tr>
</table>	

<!-- BODY:END -->


<!-- SUPERCEEDED:START -->
<br />
<table border="0" width="100%" cellspacing="0" cellpadding="5">
<tr>
<td width="66" bgcolor="#FFFFFF"><br /></td>
<td width="100%" bgcolor="#EEEEEE">
	<p>
	<font color="#666666" face="verdana,arial,helvetica" size="5">
	<b>&nbsp;NOTE:</b></font>
	<font color="#999999" face="verdana,arial,helvetica" size="2">this code has been superceded by the <a href="..\..\home\vb\code\controls\drop_down_tool_windows\drop_down_form_control\article.html" target="_top">version at the new site</a>.
	</font>
	<br />
        </p>
</td>
<td width="66" bgcolor="#FFFFFF"><br /></td>
</tr>
</table>
<br />
<!-- SUPERCEDED:END -->

<!-- FOOTER:START -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr>
        <td colspan="2">
        <IMG SRC="..\..\images\grpixel.gif" height="1" width="100%" border="0" ALT="">
        </td>
    </tr>
    <tr>
	<td width="16">&nbsp;</td>
        <td>
	<font size="1" face="Verdana, Arial, Helvetica">
	<p>
	<a href="..\..\mission.htm">About</a>&nbsp;&nbsp;<a 
	href="..\..\contrib.htm">Contribute</a>&nbsp;&nbsp;<a 
	href="mailto:steve@vbaccelerator.com">Send Feedback</a>&nbsp;&nbsp;<a 
	href="..\..\privacy.html">Privacy</a>
	<br><br>
        Copyright &copy; 1999-2000, Steve McMahon (
	<a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>). All Rights Reserved.<br>
	Last updated: 21 March 2000</font></p>
        </td>
    </tr>
</table>
<!-- FOOTER:END -->

</body>
</html>
