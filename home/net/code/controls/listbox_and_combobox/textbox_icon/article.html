<html lang="en" >
<head>

<title>vbAccelerator - Adding an Icon or Control to a TextBox or ComboBox</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
The standard .NET Framework ComboBox does not support an icon in the text box
section of the control.  This article presents a class which can be used to
show an icon, a control or a custom-drawn image into any TextBox or ComboBox 
(VB.NET and C# code provided).
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBox and ComboBox</a>&#160;.&#160;Adding an Icon or Control to a TextBox or ComboBox</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="text_box_margin_customise.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Text Box Margin Customise</a> (91K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:12999</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=12999&type=article&title=adding_20an_20icon_20or_20control_20to_20a_20textbox_20or_20combobox.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;.NET</p><p class="nav">&#160;&#160;VB.NET</p><p class="nav">&#160;&#160;C#</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />23 Oct 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Adding an Icon or Control to a TextBox or ComboBox</h1><img src="textboxicon.png" width="312" height="400" alt="TextBox Icon Demonstration" /><p /><p>
The standard .NET Framework ComboBox does not support an icon in the text box
section of the control.  This article presents a class which can be used to
show an icon, a control or a custom-drawn image into any TextBox or ComboBox 
(VB.NET and C# code provided).
</p><h2>Making Space in a TextBox</h2><p>
One feature of the Windows text box control which isn't exposed in any way in
the .NET Framework is the ability to set a left or right margin to the control
using the <span class="code">EM_SETMARGINS</span> message.
By taking advantage of this you can move the text over and therefore make space
for an object on the left or right hand side of the control.  The same 
technique can also be applied to a combo box control with the <span class="code">DropDown</span>
style, since internally that includes a standard TextBox.  All that needs to be done
to set the margins is to find the handle to the control.
</p><p>
This article presents a <span class="code">TextBoxMarginCustomise</span> class which provides
both the ability to set the margins on any control along with a series of methods which make
drawing into the new margin area or placing a control over it straightforward.
</p><h2>Using the Class</h2><p>
The simplest thing you can do with the class is to set the margin of a text box.
Various static methods are exposed to set the margin on either a class (or class
derived from) the Framework TextBox and ComboBox classes:
</p><pre>
   // Set the near margin of comboBox1:
   TextBoxMarginCustomise.NearMargin(comboBox1, 16);
   // Set the far margin of textBox1
   TextBoxMarginCustomise.FarMargin(textBox, 4);
</pre><p>
Note that if you change the font of the control you will need to reset the 
margin.
</p><p>
If you want to use the class to place something into the margin then you'll
need to create an instance of the class and use one of the three modes.
</p><ol><li><strong>Drawing an Icon from an ImageList</strong><p>
Using this method will cause the margin to be automatically set from the 
size of the images in the ImageList, and setting the <span class="code">Icon</span> property to the
zero-based index of the image in the ImageList control will display the icon.  To blank the area,
set the <span class="code">Icon</span> property to -1.
</p><pre>
using vbAccelerator.Components.Controls;

   ...

   private TextBoxMarginCustomise textBox1Icon;

   ...

   // Assign a text box customiser to show an
   // icon in the near margin of textBox1:
   textBox1Icon = new TextBoxMarginCustomise();
   textBox1Icon.ImageList = ilsIcons;
   textBox1Icon.Icon = 1;
   textBox1Icon.Attach(textBox1);   
</pre></li><li><strong>Showing a Control</strong><p>
This is performed in the same way as setting an icon, except that you use the
<span class="code">Control</span> property to assign the control:
</p><pre>
   private TextBoxMarginCustomise comboBox3Icon;

   // Set to display a CheckBox control in the near
   // margin of a combo box:
   comboBox3Icon = new TextBoxMarginCustomise();
   comboBox3Icon.Control = checkBox2;
   comboBox3Icon.Attach(comboBox3);
</pre></li><li><strong>Drawing a Customised Image</strong><p>
To customise painting you need to create a class which implements the
<span class="code">ITextBoxMarginCustomisePainter</span> interface.
Then you can connect the class using the <span class="code">CustomPainter</span>
property.
</p><p>
Implementing the <span class="code">ITextBoxMarginCustomisePainter</span> interface
is a matter of providing a concrete implementation of the <span class="code">GetMarginWidth</span>
and <span class="code">Draw</span> methods:
</p><pre>
   public class MyMarginPainter : ITextBoxMarginCustomisePainter
   {
      /// <summary>
      /// Called to obtain the width of the margin.
      /// </summary>
      /// <returns>Width of the margin</returns>
      public int GetMarginWidth()
      {
         return 18;
      }

      /// <summary>
      /// Called whenever the margin area needs to
      /// be repainted.
      /// </summary>
      /// <param name="gfx">Graphics object to paint on.</param>
      /// <param name="rcDraw">Boundary of margin area.</param>
      /// <param name="rightToLeft">Whether the control is right to left 
      /// or not</param>
      public void Draw(Graphics gfx, Rectangle rcDraw, bool rightToLeft)
      {
         // example fills the rectangle with the highlight colour
         gfx.FillRect(SystemBrushes.Highlight, rcDraw);
      }
   }
</pre><p>
Once done you attach a new instance of the class:
</p><pre>
   private TextBoxMarginCustomise customPaint;

   customPaint = new TextBoxMarginCustomise();
   customPaint.CustomPainter = new MyMarginPainter();
   customPaint.Attach(textBox4);
</pre></li></ol><h2>Implementation Details</h2><p>
There are two parts to the implementation of <span class="code">TextBoxMarginCustomise</span>.
The first is the functionality which allows the margins to be set, and the second is
functionality to draw onto the TextBox.
</p><h3>1. Setting Margins</h3><p>
The margin setting message in the Windows API allows the left or right margin
of the text box to be set.  However, to be consistent with the rest of the .NET
Framework the class exposes these as Near and Far margin properties, which means
it needs to know whether the Window is right to left or not.  In this class this
is done by interrogating the Windows Styles but it could equally be done using
the standard Framework properties.
</p><p>
The margin message itself takes a single parameter with both left and right margin
values combined into a single long value.  The LoWord contains the left margin
and the HiWord contains the right margin.  This code demonstrates setting the
Far margin for a TextBox with a given handle (setting the Near margin is a
matter of reversing the margin flag and shift):
</p><pre>
      [DllImport("user32", CharSet=CharSet.Auto)]
      private extern static int SendMessage(
         IntPtr hwnd, 
         int wMsg,
         int wParam, 
         int lParam);

      private const int EC_LEFTMARGIN = 0x1;
      private const int EC_RIGHTMARGIN = 0x2;
      private const int EC_USEFONTINFO = 0xFFFF;
      private const int EM_SETMARGINS = 0xD3;
      private const int EM_GETMARGINS = 0xD4;


      [DllImport("user32", CharSet=CharSet.Auto)]
      private extern static int GetWindowLong(
         IntPtr hWnd,
         int dwStyle);

      private const int GWL_EXSTYLE = (-20);
      private const int WS_EX_RIGHT             = 0x00001000;
      private const int WS_EX_LEFT              = 0x00000000;
      private const int WS_EX_RTLREADING        = 0x00002000;
      private const int WS_EX_LTRREADING        = 0x00000000;
      private const int WS_EX_LEFTSCROLLBAR     = 0x00004000;
      private const int WS_EX_RIGHTSCROLLBAR    = 0x00000000;

      private static bool IsRightToLeft(IntPtr handle)
      {
         int style = GetWindowLong(handle, GWL_EXSTYLE);
         return (
            ((style &amp; WS_EX_RIGHT) == WS_EX_RIGHT) ||
            ((style &amp; WS_EX_RTLREADING) == WS_EX_RTLREADING) ||
            ((style &amp; WS_EX_LEFTSCROLLBAR) == WS_EX_LEFTSCROLLBAR));   
      }

      private static void FarMargin(IntPtr handle, int margin)
      {
         int message = IsRightToLeft(handle) ? EC_LEFTMARGIN : EC_RIGHTMARGIN;
         if (message == EC_LEFTMARGIN)
         {
            margin = margin &amp; 0xFFFF;
         }
         else
         {
            margin = margin * 0x10000;
         }
         SendMessage(handle, EM_SETMARGINS, message, margin);
      }
</pre><p>
To make the class work with ComboBoxes, we need to be able to find the 
handle to the TextBox within the ComboBox.  This is done using the Windows
<span class="code">FindWindowsEx</span> API call, using the class name of
the TextBox (which is "EDIT"):
</p><pre>
      [DllImport("user32", CharSet=CharSet.Auto)]
      private extern static IntPtr FindWindowEx(
         IntPtr hwndParent, 
         IntPtr hwndChildAfter,
         [MarshalAs(UnmanagedType.LPTStr)]
         string lpszClass,
         [MarshalAs(UnmanagedType.LPTStr)]
         string lpszWindow);

      /// <summary>
      /// Gets the handle of the TextBox contained within a 
      /// ComboBox control.
      /// </summary>
      /// <param name="handle">The ComboBox window handle.</param>
      /// <returns>The handle of the contained text box.</returns>
      public static IntPtr ComboEdithWnd(IntPtr handle)
      {
         handle = FindWindowEx(handle, IntPtr.Zero, "EDIT", "\0");
         return handle;
      }

      /// <summary>
      /// Sets the far margin of a TextBox control or the
      /// TextBox contained within a ComboBox.
      /// </summary>
      /// <param name="ctl">The Control to set the far margin
      /// for</param>
      /// <param name="margin">New far margin in pixels, or -1
      /// to use the default far margin.</param>
      public static void FarMargin(Control ctl, int margin)
      {
         IntPtr handle = ctl.Handle;
         if (typeof(System.Windows.Forms.ComboBox).IsAssignableFrom(ctl.GetType()))
         {
            handle = ComboEdithWnd(handle);
         }
         FarMargin(handle, margin);
      }
</pre><h3>2. Drawing Onto the TextBox</h3><p>
This functionality is achieved by derived from <span class="code">NativeWindow</span>,
which allows access to the message stream for the TextBox window the class is
attached to.  The TextBox is a slightly tricky control because it repaints itself
in response to many messages and not just the standard <span class="code">WM_PAINT</span>
message.  Here's the <span class="code">WndProc</span> override:
</p><pre>
      private const int WM_PAINT = 0xF;
      
      private const int WM_SETFOCUS = 0x7;
      private const int WM_KILLFOCUS = 0x8;

      private const int WM_SETFONT = 0x30;

      private const int WM_MOUSEMOVE = 0x200;
      private const int WM_LBUTTONDOWN = 0x201;
      private const int WM_RBUTTONDOWN = 0x204;
      private const int WM_MBUTTONDOWN = 0x207;
      private const int WM_LBUTTONUP = 0x202;
      private const int WM_RBUTTONUP = 0x205;
      private const int WM_MBUTTONUP = 0x208;
      private const int WM_LBUTTONDBLCLK = 0x203;
      private const int WM_RBUTTONDBLCLK = 0x206;
      private const int WM_MBUTTONDBLCLK = 0x209;

      private const int WM_KEYDOWN = 0x0100;
      private const int WM_KEYUP = 0x0101;
      private const int WM_CHAR = 0x0102;


      /// <summary>
      /// Calls the base WndProc and performs WM_PAINT
      /// processing to draw the icon if necessary.
      /// </summary>
      /// <param name="m">Windows Message</param>
      protected override void WndProc(ref Message m)
      {
         base.WndProc(ref m);

         if (this.control == null)
         {
            switch (m.Msg)
            {
               case WM_SETFONT:
                  setMargin();
                  break;
               case WM_PAINT:
                  RePaint();
                  break;
               case WM_SETFOCUS: 
               case WM_KILLFOCUS:
                  RePaint();
                  break;
               case WM_LBUTTONDOWN:
               case WM_RBUTTONDOWN:
               case WM_MBUTTONDOWN:
                  RePaint();
                  break;
               case WM_LBUTTONUP:
               case WM_RBUTTONUP:
               case WM_MBUTTONUP:
                  RePaint();
                  break;
               case WM_LBUTTONDBLCLK:
               case WM_RBUTTONDBLCLK:
               case WM_MBUTTONDBLCLK:
                  RePaint();
                  break;
               case WM_KEYDOWN:
               case WM_CHAR:
               case WM_KEYUP:
                  RePaint();
                  break;
               case WM_MOUSEMOVE:
                  // Only need to process if a mouse button is down:
                  if (!m.WParam.Equals(IntPtr.Zero))
                  {
                     RePaint();
                  }
                  break;
            }
         }
         else
         {
            switch (m.Msg)
            {
               case WM_PAINT:
                  moveControl();
                  break;
            }
         }
      }
</pre><p>
This loop instructs the control to repaint for most messages; it also ensures that the
margin is correctly set when the edit control's font changes (the <span class="code">WM_SETFONT</span>
message) and, if a control is being placed in the margin, calls a positioning routine whenever
the item is painted.  This positioning routine checks whether the control is in the right place
and moves it if not.
</p><p>
To actually perform the painting, the code needs to get a <span class="code">Graphics</span> object to draw on.
This is performed using the API to obtain a <span class="code">hDC</span> for the control
and then converting that to a managed <span class="code">Graphics</span> object:
</p><pre>
   [StructLayout(LayoutKind.Sequential)]
      private struct RECT
   {
      public int left;
      public int top;
      public int right;
      public int bottom;
   }

   [DllImport("user32")]
   private extern static IntPtr GetDC(
      IntPtr hwnd);
   [DllImport("user32")]
   private extern static int ReleaseDC (
      IntPtr hwnd, 
      IntPtr hdc);
   [DllImport("user32")]
   private extern static int GetClientRect (
      IntPtr hwnd,
      ref RECT rc);

   ...

   GetClientRect(this.Handle, ref rcClient);
   bool rightToLeft = IsRightToLeft(this.Handle);

   IntPtr handle = this.Handle;
   IntPtr hdc = GetDC(handle);
   Graphics gfx = Graphics.FromHdc(hdc);

   // ... Drawing here ...

   gfx.Dispose();
   ReleaseDC(handle, hdc);
</pre><h2>Conclusion</h2><p>
This article provides a class you can use to add margins to TextBox controls which can
then be used to display icons, custom graphics or controls.  Using this technique in particular
you can easily create a more functional ComboBox control which matches the one used in
Windows Explorer, and you have complete flexibility over what is rendered in the margin.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBox and ComboBox</a>&#160;.&#160;Adding an Icon or Control to a TextBox or ComboBox</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 23 October 2003</p></td><td></td></tr></table>
</body></html>