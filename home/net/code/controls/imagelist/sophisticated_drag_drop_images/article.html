<html lang="en" >
<head>

<title>vbAccelerator - Sophisticated Drag-Drop Images</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
The standard .NET Framework drag-drop functionality provides a cursor to indicate that a drag-drop function is in progress. This article demonstrates how to add an image of the object being dragged to the drag-drop control, in the same way that Explorer does using the ImageList APIs.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;Sophisticated Drag-Drop Images</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="imagelistdragcs.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />ImageListDragCS</a> (56K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:12890</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=12890&type=article&title=sophisticated_20drag_2ddrop_20images.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;.NET</p><p class="nav">&#160;&#160;C#</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />6 Sep 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Sophisticated Drag-Drop Images</h1><p class="splash">Add customisable Explorer-Style drag-drop images to .NET Framework applications using the ImageList API</p><img src="dragdropimage.png" width="460" height="300" alt="Drag-Drop Image Demonstration" /><p /><p>
The standard .NET Framework drag-drop functionality provides a cursor to indicate that a drag-drop function is in progress. This article demonstrates how to add an image of the object being dragged to the drag-drop control, in the same way that Explorer does using the ImageList APIs.
</p><h2>About ImageList Drag and Drop</h2><p>
The ComCtl32.DLL ImageList implementation provides functions for dragging an image on the screen.

The dragging functions move an image smoothly, in color, and without any flashing of the cursor. In addition, when you use the functions under Windows 2000 or XP the drag image is also rendered translucently and preserves any alpha shadows which greatly improves the visual appearance.
</p><p>
Unfortunately although the .NET
Framework <span class="code">ImageList</span> class is a thin
wrapper on this implementation it doesn't expose any of the methods.
However, there are only 8 API functions needed and they can
easily be wrapped into a re-usable class which encapsulates the
Unmanaged code.
</p><h3>Using the Sample Code</h3><p>The main class in the sample is 
<span class="code">ImageListDrag</span>. To use the class you follow these steps:</p><ol><li><strong>Create an instance of the class</strong><pre>
ImageListDrag imageListDrag = new ImageListDrag();
</pre></li><li><strong>Tell the class which ImageList to use</strong><pre>
imageListDrag.hImageList = ils.Handle();
</pre></li><li><strong>Set the drag image to draw during dragging</strong><p>
Typically you start a drag operation when specific conditions
are met during a <span class="code">MouseDown</span> action.
Once you know a drag operation is needed, you tell the 
class the index of the image in the ImageList to draw and
the position to offset the drag image from the cursor in
pixels using the <span class="code">StartDrag</span> method.  
Once the drag operation has completed, call the <span class="code">CompleteDrag</span> method to clear the image:
</p><pre>
   protected override void OnMouseDown(MouseEventArgs e)
   {
       // ... code to determine if drag needed

       // if it is, then start the operation:

      imageListDrag.StartDrag(iconIndex, -8, -8);
   
      this.DoDragDrop(data, DragDropEffects.Move);
 
      imageListDrag.CompleteDrag();
   }
</pre></li><li><strong>Update the drag image as dragging is performed</strong><p>
The <span class="code">GiveFeedback</span> event is called 
repeatedly during a drag operation whenever the item being
dragged is over a drop target.
</p><pre>
   protected override void OnGiveFeedback(GiveFeedbackEventArgs e)
   {
       // Raise the GiveFeedback event
       base.OnGiveFeedback(e);

       // Draw the drag image:			
       ilsDrag.DragDrop();
   }
</pre><p>
During this event you can also detect which object the mouse is over and hide or show the drag image using the <span class="code">HideDragImage</span> method.
</p></li></ol><p>
That's pretty much it for creating a standard drag image. If you want to update the contents of the window you're dragging over, then you should call <span class="code">HideDragImage(true)</span> prior to drawing and <span class="code">HideDragImage(false)</span> once complete. This ensures you don't overdraw the drag cursor.
</p><h2>Creating Custom Drag Images</h2><p>
Since the drag image is sourced from an image within an ImageList,
it is straightforward to create custom drag images using the
<span class="code">System.Drawing.Graphics</span> methods just 
prior to starting the drag operation.  The sample code demonstrates
how to do this with the TextBox control, rendering a portion of the
selected text into the first image of an ImageList used for
dragging:
</p><pre>
   private void constructDragImage()
   {
      System.Windows.Forms.ImageList ils = this.ImageList;
			
      // Clear images in image list:
      ils.Images.Clear();

      // ImageList is buggy, need to ensure we do this:
      IntPtr ilsHandle = ils.Handle;

      // Create the bitmap to hold the drag image:
      Bitmap bitmap = new Bitmap(ils.ImageSize.Width, ils.ImageSize.Height);			
      // Get a graphics object from it:
      Graphics gfx = Graphics.FromImage(bitmap);
      // Default fill the bitmap with black:
      gfx.FillRectangle(Brushes.Black, 0, 0, bitmap.Width, bitmap.Height);

      // Draw text in highlighted form:
      StringFormat fmt = new StringFormat(StringFormatFlags.LineLimit);
      fmt.Alignment = StringAlignment.Center;				
      SizeF size = gfx.MeasureString(this.SelectedText, this.Font, bitmap.Width, fmt);
      float left = 0F;
      if (size.Height&gt; bitmap.Height)
      {
         size.Height = bitmap.Height;
      }
      if (size.Width &lt; bitmap.Width)
      {
         left = (bitmap.Width - size.Width)/2F;
      }
      RectangleF textRect = new RectangleF(
         left, 0F, size.Width, size.Height);
      gfx.FillRectangle(SystemBrushes.Highlight, textRect);
      gfx.DrawString(this.SelectedText, this.Font, SystemBrushes.HighlightText,
         textRect, fmt);
      fmt.Dispose();

      // Add the image to the ImageList:
      ils.Images.Add(bitmap, Color.Black);

      // Clear up the graphics object:
     gfx.Dispose();
     // Clear up the bitmap:
     bitmap.Dispose();

   }
</pre><p>
Note that a lot of code during a drag-drop event in the .NET Framework runs on a differnt thread
to the main UI thread.  By default, exceptions thrown on the background thread don't get reported
unless you explicitly catch them - beware!
</p><h2>Limitations</h2><p>This section discusses some of the issues that can occur when using drag-drop images
and how to work around them.</p><h3>Painting Issues</h3><p>The ImageList SDK notes that when drawing the drag image you can get issues 
with updates or screen painting unless you use the <span class="code">ImageList_DragLeave</span>
API function to hide the drag image whilst the painting occurs (which is what the 
<span class="code">HideDragImage</span> method in the class does). Unfortunately, if you 
don't own the control that's being painted doing this isn't really an option. There are 
three things you can do to help avoid this being a problem:
</p><ol><li><strong>Draw the Drag Image Underneath the Cursor</strong><p>
If you draw the drag image below the cursor, then its unlikely that any 
painting in the control will occur in the area of the drag image. To do this, use negative 
values for the <span class="code">xOffset</span> and <span class="code">yOffset</span> parameters 
of the <span class="code">StartDrag</span> method.
</p></li><li><strong>Force windows to repaint to clear any left over effects when dropping</strong><p>
After a drop it is possible that the control's display will be affected. For example, dropping 
text on a text box causes the new text to be inserted, and some of that may occur under 
the drag image. You can fix any artifacts by calling the Framework's <span class="code">Invalidate</span>
and <span class="code">Update</span> methods. If the Window is particularly tricky then the Windows
<span class="code">RedrawWindow</span> API call can be used. 
</p><pre>
private struct RECT
{
   public int left;
   public int top;
   public int right;
   public int bottom;
}

[DllImport("user32")]
private extern static int RedrawWindow (
    IntPtr hwnd, ref RECT lprcUpdate,
    IntPtr hrgnUpdate, int fuRedraw);
[DllImport("user32")]
private extern static int (
   IntPtr hwnd, ref RECT lpRect);

private const int RDW_UPDATENOW = 0x100;
private const int RDW_INVALIDATE = 0x1;
private const int RDW_ALLCHILDREN = 0x80;
private const int RDW_ERASE = 0x4;

..
 
   // Assuming the handle variable contains your Window's handle:
   RECT tR = new RECT();
   GetWindowRect(handle, ref tR);
   tR.right -= tr.left;
   tR.left = 0;
   tR.bottom -= tr.top;
   tR.top = 0; 
   RedrawWindow(handle, ref tR, IntPtr.Zero,
      RDW_UPDATENOW | RDW_INVALIDATE | 
      RDW_ALLCHILDREN | RDW_ERASE)
</pre></li><li><strong>Drag and Drop in the .NET Framework</strong><p>In order to display the drag drop image, you need to get some sort of event 
as the mouse moves. If the object that the mouse is over has 
<span class="code">AllowDrop</span> set to <span class="code">true</span> then the 
<span class="code">GiveFeedback</span> is fired whenever the mouse moves (and all the time when
it doesn't too!). However, if the object doesn't have it set then you won't get any events. This means 
that the drag image disappears as you move the mouse over that object. There are two 
ways of working around this:
</p><ol><li>Set all objects on the form to <span class="code">AllowDrop = true</span> at design-time or run-time. 
This ensures the drag image is always displayed, but note that you may also need to code the 
<span class="code">OnDragOver</span> method for every object to ensure
<span class="code">DragDropEffects.None</span> is returned to ensure the user gets a visual cue 
that they can't drop on that object.</li><li>Use a Windows Mouse Hook to capture all mouse events during the duration of the drag. This 
solves the issue completely but can adds complexity to debugging the project.</li></ol></li></ol><h2>Conclusion</h2><p>
The <span class="code">ImageListDrag</span> class allows you to add custom drag-images to .NET
Framework applications and is relatively simple to use, provided some care is taken placing
the drag image, only drawing over known objects and ensuring all objects on the form respond
to drag events.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;Sophisticated Drag-Drop Images</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 8 September 2003</p></td><td></td></tr></table>
</body></html>
