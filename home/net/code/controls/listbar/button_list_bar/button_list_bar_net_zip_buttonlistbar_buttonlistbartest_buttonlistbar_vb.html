<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: ButtonListBar_ButtonListBarTest_ButtonListBar.vb</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: ButtonListBar_ButtonListBarTest_ButtonListBar.vb" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBar</a>&#160;.&#160;<a href="article.html">.NET Button ListBar Control</a>&#160;.&#160;<a href="button_list_bar_net.html">Button List Bar.NET</a>&#160;.&#160;ButtonListBar_ButtonListBarTest_ButtonListBar.vb</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="button_list_bar_net.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Button List Bar.NET</a> (159K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:11827</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=11827&type=zip&title=button_20list_20bar_2enet_2ezip_5fbuttonlistbar_5fbuttonlistbartest_5fbutton.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;.NET</p><p class="nav">&#160;&#160;VB.NET</p><p class="nav">&#160;&#160;C#</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />23 Jan 2004<br /><p class="update">Corrected resource leak in drawing code.  The 
<span class="code">hFont</span> being returned by the <span class="code">ToHfont</span>
method was not being cleared up using <span class="code">DeleteObject</span>.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\vb\code\controls\listbar\button_list_bar\article.html">Button ListBar Control</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: ButtonListBar_ButtonListBarTest_ButtonListBar.vb</h1><pre>Namespace vbAccelerator.Controls.ListBar

#Region " Event Argument Classes "
    Public Class SelectionChangedEventArgs
        Private m_item As ButtonListBarItem = Nothing

        &lt;System.ComponentModel.Description("Gets the item that selection has
         changed to")&gt; _
        Public ReadOnly Property Item() As ButtonListBarItem
            Get
                Item = m_item
            End Get
        End Property

        &lt;System.ComponentModel.Description("Creates a new instance of the
         SelectionChangedEventArgs class for the specified item")&gt; _
        Public Sub New(ByVal item As ButtonListBarItem)
            m_item = item
        End Sub
    End Class

    Public Class ItemClickEventArgs
        Private m_item As ButtonListBarItem = Nothing
        Private m_ptClick As Point
        Private m_button As MouseButtons

        &lt;System.ComponentModel.Description("Gets the item that selection has
         changed to")&gt; _
        Public ReadOnly Property Item() As ButtonListBarItem
            Get
                Item = m_item
            End Get
        End Property

        &lt;System.ComponentModel.Description("Gets the X position of the mouse if
         the item click was done using the Mouse.  If the click was done using
         keys, this property is 0.  Check MouseButton parameter to see if it
         was a mouse event.")&gt; _
        Public ReadOnly Property X() As Integer
            Get
                X = m_ptClick.X
            End Get
        End Property

        &lt;System.ComponentModel.Description("Gets the Y position of the mouse if
         the item click was done using the Mouse.  If the click was done using
         keys, this property is 0.  Check MouseButton parameter to see if it
         was a mouse event.")&gt; _
        Public ReadOnly Property Y() As Integer
            Get
                Y = m_ptClick.Y
            End Get
        End Property

        &lt;System.ComponentModel.Description("Gets the mouse button used to
         perform the item click if it was done using the Mouse.  If the click
         was done using keys, the button will be set to None.")&gt; _
        Public ReadOnly Property Button() As MouseButtons
            Get
                Button = m_button
            End Get
        End Property

        &lt;System.ComponentModel.Description("Creates a new instance of the
         ItemClickEventArgs class")&gt; _
        Public Sub New(ByVal item As ButtonListBarItem, ByVal ptClick As Point,
         ByVal button As MouseButtons)
            m_ptClick = ptClick
            m_item = item
            m_button = button
        End Sub
    End Class
#End Region

#Region " Delegates "
    Public Delegate Sub ItemClickEventHandler(ByVal sender As Object, ByVal
     eventArgs As ItemClickEventArgs)
    Public Delegate Sub SelectionChangedEventHandler(ByVal sender As Object,
     ByVal eventArgs As SelectionChangedEventArgs)
#End Region

#Region " ButtonListBar "
    Public Class ButtonListBar
        Inherits System.Windows.Forms.UserControl

#Region " Private Member Variables "
        Private m_imageList As ImageList = Nothing
        Private m_toolTip As ToolTip = Nothing
        Private m_items As ButtonListBarItems = Nothing
        Private m_isXp As Boolean = False
        Private m_buttonWidth As Integer = 96
        Private m_lastButtonWidth As Integer
        Private m_showScroll As Boolean = False
#End Region

#Region " Events "
        Public Event ItemClick As ItemClickEventHandler
        Public Event BarClick As MouseEventHandler
        Public Event SelectionChanged As SelectionChangedEventHandler
#End Region

#Region " Windows Form Designer generated code "

        Public Sub New()
            MyBase.New()

            'This call is required by the Windows Form Designer.
            InitializeComponent()

            'Add any initialization after the InitializeComponent() call

        End Sub

        'UserControl overrides dispose to clean up the component list.
        Protected Overloads Overrides Sub Dispose(ByVal disposing As Boolean)
            If disposing Then
                If Not (components Is Nothing) Then
                    components.Dispose()
                End If
            End If
            MyBase.Dispose(disposing)
        End Sub

        'Required by the Windows Form Designer
        Private components As System.ComponentModel.IContainer

        'NOTE: The following procedure is required by the Windows Form Designer
        'It can be modified using the Windows Form Designer.  
        'Do not modify it using the code editor.
        &lt;System.Diagnostics.DebuggerStepThrough()&gt; Private Sub
         InitializeComponent()
            '
            'ButtonListBar
            '
            Me.AutoScroll = True
            Me.Name = "ButtonListBar"

        End Sub

#End Region

#Region " UnManaged Code "
        &lt;System.Runtime.InteropServices.StructLayout(Runtime.InteropServices.Lay
        outKind.Sequential)&gt; _
        Private Structure RECT
            Public left As Integer
            Public top As Integer
            Public right As Integer
            Public bottom As Integer

            Public Overrides Function ToString() As String
                ToString = String.Format("({0},{1})-({2},{3})", left, top,
                 right, bottom)
            End Function

        End Structure
        &lt;System.Runtime.InteropServices.StructLayout(Runtime.InteropServices.Lay
        outKind.Sequential)&gt; _
        Private Structure SIZEAPI
            Public cx As Integer
            Public cy As Integer

            Public Overrides Function ToString() As String
                ToString = String.Format("{0} x {1}", cx, cy)
            End Function
        End Structure

        Private Declare Function SelectObject Lib "gdi32" ( _
            ByVal hDC As IntPtr, ByVal hObject As IntPtr) As IntPtr
        Private Declare Function DeleteObject Lib "gdi32" ( _
            ByVal hObject As IntPtr) As Integer
        Private Declare Function GetSystemMetrics Lib "user32" (ByVal nIndex As
         Integer) As Integer
        Private Const SM_CXVSCROLL As Integer = 2

        Private Declare Unicode Function OpenThemeData Lib "uxtheme.dll" _
            (ByVal hwnd As IntPtr, ByVal pszClassList As String) As IntPtr
        Private Declare Unicode Function CloseThemeData Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr) As Integer
        Private Declare Unicode Function DrawThemeBackground Lib "uxtheme.dll" _
            (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByRef pRect As RECT, _
            ByRef pClipRect As RECT _
            ) As Integer
        Private Declare Unicode Function DrawThemeParentBackground Lib
         "uxtheme.dll" _
           (ByVal hwnd As IntPtr, ByVal hDC As IntPtr, _
           ByRef prc As RECT) As Integer
        Private Declare Unicode Function GetThemeBackgroundContentRect Lib
         "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByRef pBoundingRect As RECT, _
            ByRef pContentRect As RECT) As Integer
        Private Declare Unicode Function DrawThemeText Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByVal pszText As String, ByVal iCharCount As Integer, _
            ByVal dwTextFlag As Integer, ByVal dwTextFlags2 As Integer, _
            ByRef pRect As RECT) As Integer
        Private Declare Unicode Function DrawThemeIcon Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByRef pRect As RECT, _
            ByVal hIml As IntPtr, _
            ByVal iImageIndex As Integer) As Integer
        Private Declare Unicode Function GetThemePartSize Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByRef prc As RECT, _
            ByVal eSize As Integer, _
            ByRef psz As SIZEAPI) As Integer
        Private Declare Unicode Function GetThemeTextExtent Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByVal pszText As String, ByVal iCharCount As Integer, _
            ByVal dwTextFlags As Integer, _
            ByRef pBoundingRect As RECT, _
            ByRef pExtentRect As RECT) As Integer
        Private Declare Unicode Function DrawThemeEdge Lib "uxtheme.dll" _
           (ByVal hTheme As IntPtr, ByVal hDC As IntPtr, _
            ByVal iPartId As Integer, ByVal iStateId As Integer, _
            ByRef pDestRect As RECT, _
            ByVal uEdge As Integer, ByVal uFlags As Integer, _
            ByRef pContentRect As RECT) As Integer
        Private Const S_OK = 0
        Private Const HWND_DESKTOP = 0

        ' THEMESIZE
        Private Const TS_MIN As Integer = 0            '// minimum size
        Private Const TS_TRUE As Integer = 1            '// size without
         stretching
        Private Const TS_DRAW As Integer = 2           '// size that theme mgr
         will use to draw part

        ' Button class
        Private Const UXTHEMEBUTTONCLASS As String = "Button"
        Private Const UXTHEMETOOLBARCLASS As String = "Toolbar"
        ' Button part
        Private Const TP_BUTTON As Integer = 1
        Private Const BP_PUSHBUTTON As Integer = 1
        ' Button states
        Private Const TS_NORMAL As Integer = 1
        Private Const TS_HOT As Integer = 2
        Private Const TS_PRESSED As Integer = 3
        Private Const TS_DISABLED As Integer = 4
        Private Const TS_CHECKED As Integer = 5
        Private Const TS_HOTCHECKED As Integer = 6
        Private Const PBS_DISABLED As Integer = 4

        ' DrawTextFlags
        Private Const DT_TOP As Integer = &amp;H0
        Private Const DT_LEFT As Integer = &amp;H0
        Private Const DT_CENTER As Integer = &amp;H1
        Private Const DT_RIGHT As Integer = &amp;H2
        Private Const DT_VCENTER As Integer = &amp;H4
        Private Const DT_BOTTOM As Integer = &amp;H8
        Private Const DT_WORDBREAK As Integer = &amp;H10
        Private Const DT_SINGLELINE As Integer = &amp;H20
        Private Const DT_EXPANDTABS As Integer = &amp;H40
        Private Const DT_TABSTOP As Integer = &amp;H80
        Private Const DT_NOCLIP As Integer = &amp;H100
        Private Const DT_EXTERNALLEADING As Integer = &amp;H200
        Private Const DT_CALCRECT As Integer = &amp;H400
        Private Const DT_NOPREFIX As Integer = &amp;H800
        Private Const DT_INTERNAL As Integer = &amp;H1000
        Private Const DT_EDITCONTROL As Integer = &amp;H2000
        Private Const DT_PATH_ELLIPSIS As Integer = &amp;H4000
        Private Const DT_END_ELLIPSIS As Integer = &amp;H8000&amp;
        Private Const DT_MODIFYSTRING As Integer = &amp;H10000
        Private Const DT_RTLREADING As Integer = &amp;H20000
        Private Const DT_WORD_ELLIPSIS As Integer = &amp;H40000
        Private Const DT_NOFULLWIDTHCHARBREAK As Integer = &amp;H80000
        Private Const DT_HIDEPREFIX As Integer = &amp;H100000
        Private Const DT_PREFIXONLY As Integer = &amp;H200000

        ' UxTheme DrawText Additional Flag
        Private Const DTT_GRAYED As Integer = &amp;H1             '// draw a
         grayed-out string

#End Region

        Private Sub ButtonListBar_Load(ByVal sender As System.Object, ByVal e
         As System.EventArgs) Handles MyBase.Load
            MyBase.TabStop = True
            MyBase.SetStyle( _
               ControlStyles.AllPaintingInWmPaint Or _
                ControlStyles.UserPaint Or _
                ControlStyles.DoubleBuffer Or _
                ControlStyles.ResizeRedraw, _
                True)
            m_items = CreateItemCollection()
            Dim ver As System.Version = System.Environment.OSVersion.Version()
            If (ver.Major &gt; 5) Then
                m_isXp = True
            ElseIf (ver.Major = 5) Then
                If (ver.Minor &gt;= 1) Then
                    m_isXp = True
                End If
            End If
        End Sub

        &lt;System.ComponentModel.Description("Gets/sets the ImageList used to
         source icons for this control.")&gt; _
        Public Property ImageList() As System.Windows.Forms.ImageList
            Get
                ImageList = m_imageList
            End Get
            Set(ByVal Value As System.Windows.Forms.ImageList)
                m_imageList = Value
            End Set
        End Property

        &lt;System.ComponentModel.Description("Gets/sets the ToolTip object that
         will be used to display ToolTips for this control.")&gt; _
        Public Property ToolTip() As System.Windows.Forms.ToolTip
            Get
                ToolTip = m_toolTip
            End Get
            Set(ByVal Value As System.Windows.Forms.ToolTip)
                m_toolTip = Value
            End Set
        End Property

        &lt;System.ComponentModel.Description("Returns the collection of items
         associated with this control.")&gt; _
        Public ReadOnly Property Items() As ButtonListBarItems
            Get
                Items = m_items
            End Get
        End Property

        Public Property ButtonWidth() As Integer
            Get
                ButtonWidth = m_buttonWidth
            End Get
            Set(ByVal Value As Integer)
                m_buttonWidth = Value
                OnItemChanged(Nothing)
            End Set
        End Property

        &lt;System.ComponentModel.Description("Returns the selected item, if any,
         within the control.")&gt; _
        Public ReadOnly Property SelectedItem() As ButtonListBarItem
            Get
                Dim item As ButtonListBarItem
                For Each item In m_items
                    If (item.Selected) Then
                        SelectedItem = item
                        Exit For
                    End If
                Next
            End Get
        End Property

        Friend Function OnSelectItem(ByVal item As ButtonListBarItem, ByVal
         Value As Boolean) As Boolean
            Dim i As Integer
            If (Value) Then
                For i = 0 To m_items.Count - 1
                    If Not (m_items(i) Is item) Then
                        If (m_items(i).Selected) Then
                            m_items(i).Selected = False
                        End If
                    End If
                Next
                Dim e As New SelectionChangedEventArgs(item)
                OnSelectionChanged(e)
                OnSelectItem = Value
            Else
                OnSelectItem = Value
            End If
        End Function

        Friend Sub OnItemChanged(ByVal item As ButtonListBarItem)
            '
            Dim minHeight = 0

            If Not (m_items Is Nothing) Then
                If (m_items.Count &gt; 0) Then

                    ' Measure all the items &amp; evaluate the overall height
                    Dim useXpStyles As Boolean = m_isXp
                    Dim hTheme As IntPtr = IntPtr.Zero

                    If (useXpStyles) Then
                        hTheme = OpenThemeData(Me.Handle, UXTHEMEBUTTONCLASS)
                        If (hTheme.Equals(IntPtr.Zero)) Then
                            useXpStyles = False
                        End If
                    End If

                    Dim barItem As ButtonListBarItem
                    Dim lastBarItem As ButtonListBarItem
                    Dim iconSize As Integer
                    Dim gfx As Graphics = Graphics.FromHwnd(Me.Handle)

                    If Not (m_imageList Is Nothing) Then
                        iconSize = m_imageList.ImageSize.Height
                    End If

                    If (useXpStyles) Then
                        Dim tTextR As RECT
                        Dim tTextBoundR As RECT
                        Dim lR As Integer

                        Dim hdc As IntPtr = gfx.GetHdc()
                        Dim hFont As IntPtr = Me.Font.ToHfont
                        Dim hFontOld As IntPtr = SelectObject(hdc, hFont)

                        For Each barItem In m_items
                            Dim itemText As String = barItem.Text
                            tTextR.top = 0
                            tTextR.bottom = 1280
                            tTextR.left = 6
                            tTextR.right = m_buttonWidth - 12
                            tTextBoundR.top = 0
                            tTextBoundR.bottom = 1280
                            tTextBoundR.left = 3
                            tTextBoundR.right = m_buttonWidth - 12

                            lR = GetThemeTextExtent( _
                                hTheme, _
                                hdc, _
                                TP_BUTTON, _
                                TS_NORMAL, _
                                itemText, -1, _
                                DT_CENTER Or DT_WORDBREAK, _
                                tTextBoundR, tTextR)
                            'Console.WriteLine("GetThemeTextExtent {0}, {1},
                             {2}", lR, barItem.Text, tTextR.ToString())
                            If (lastBarItem Is Nothing) Then
                                barItem.Start() = 4
                            Else
                                barItem.Start() = lastBarItem.Start +
                                 lastBarItem.Extent + 4
                            End If
                            barItem.Extent = tTextR.bottom - tTextR.top + 4 +
                             iconSize + 6
                            minHeight = barItem.Start + barItem.Extent
                            lastBarItem = barItem
                        Next

                        SelectObject(hdc, hFontOld)
                        DeleteObject(hFont)
                        gfx.ReleaseHdc(hdc)
                        CloseThemeData(hTheme)
                    Else
                        Dim fmt As StringFormat = New StringFormat()
                        fmt.Alignment = StringAlignment.Center
                        fmt.LineAlignment = StringAlignment.Near
                        fmt.Trimming = StringTrimming.None
                        fmt.HotkeyPrefix = Drawing.Text.HotkeyPrefix.Show
                        For Each barItem In m_items
                            Dim itemText As String = barItem.Text
                            Dim itemHeight = gfx.MeasureString(itemText,
                             Me.Font, m_buttonWidth - 12, fmt).Height
                            Console.WriteLine("GDI+ String Height {0}, {1}",
                             itemText, itemHeight)
                            If (lastBarItem Is Nothing) Then
                                barItem.Start() = 4
                            Else
                                barItem.Start() = lastBarItem.Start +
                                 lastBarItem.Extent + 4
                            End If
                            barItem.Extent = itemHeight + 4 + iconSize + 6
                            minHeight = barItem.Start + barItem.Extent
                            lastBarItem = barItem
                        Next
                        fmt.Dispose()

                    End If

                    gfx.Dispose()

                    minHeight = minHeight + 3
                End If
            End If

            Dim scrollChanged As Boolean = False
            Dim showScroll As Boolean = False
            If (minHeight &gt; Me.Height) Then
                showScroll = True
            End If
            Me.AutoScrollMinSize = New Size(0, minHeight)
            If Not (m_showScroll = showScroll) Or _
                Not (m_lastButtonWidth = m_buttonWidth) Then
                If (showScroll) Then
                    Me.Width = m_buttonWidth + GetSystemMetrics(SM_CXVSCROLL)
                Else
                    Me.Width = m_buttonWidth
                End If
                m_showScroll = showScroll
                m_lastButtonWidth = m_buttonWidth
            Else
                Me.Invalidate()
            End If

            '
        End Sub

        &lt;System.ComponentModel.Description("Called to create the internal item
         collection for this control.")&gt; _
        Protected Overridable Function CreateItemCollection() As
         ButtonListBarItems
            CreateItemCollection = New ButtonListBarItems(Me)
        End Function

        &lt;System.ComponentModel.Description("Processes key strokes in the
         control.")&gt; _
        Protected Overrides Sub OnKeyDown(ByVal e As KeyEventArgs)
            MyBase.OnKeyDown(e)
            If Not (m_items Is Nothing) Then
                If (m_items.Count &gt; 0) Then
                    Dim lNewIndex As Integer = -1
                    Dim lCurrentIndex As Integer = -1
                    Dim lMouseOverIndex As Integer = -1
                    Dim bFound As Boolean
                    Dim i As Integer

                    For i = 0 To m_items.Count - 1
                        If (m_items(i).MouseOver) Then
                            lMouseOverIndex = i
                        End If
                        If (m_items(i).Selected) Then
                            lCurrentIndex = i
                        End If
                    Next i

                    If (lMouseOverIndex &gt; 0) Then
                        lCurrentIndex = lMouseOverIndex
                    End If

                    Select Case e.KeyCode
                        Case Keys.Up
                            lNewIndex = selectNext(lCurrentIndex, -1)
                        Case Keys.Down
                            lNewIndex = selectNext(lCurrentIndex, 1)
                        Case Keys.PageUp
                            lNewIndex = selectNext(lCurrentIndex, -4)
                        Case Keys.PageDown
                            lNewIndex = selectNext(lCurrentIndex, 4)
                        Case Keys.Home
                            lNewIndex = 1
                            Do While Not bFound
                                If (m_items(lNewIndex).Enabled) Then
                                    bFound = True
                                Else
                                    lNewIndex = lNewIndex + 1
                                    If (lNewIndex &gt;= m_items.Count) Then
                                        bFound = True
                                    End If
                                End If
                            Loop
                        Case Keys.End
                            lNewIndex = m_items.Count - 1
                            Do While Not bFound
                                If (m_items(lNewIndex).Enabled) Then
                                    bFound = True
                                Else
                                    lNewIndex = lNewIndex - 1
                                    If (lNewIndex &lt; 0) Then
                                        bFound = True
                                    End If
                                End If
                            Loop
                        Case Keys.Enter
                            If (lMouseOverIndex &gt;= 0) Then
                                m_items(lMouseOverIndex).Selected = True
                                m_items(lMouseOverIndex).MouseOver = False
                                For i = 0 To m_items.Count - 1
                                    m_items(i).MouseOver = False
                                Next
                                ensureVisible(lMouseOverIndex)
                                Dim itemClickArgs As ItemClickEventArgs = New
                                 ItemClickEventArgs(m_items(lMouseOverIndex),
                                 Nothing, MouseButtons.None)
                                OnItemClick(itemClickArgs)
                            End If
                    End Select

                    If (lNewIndex &lt;&gt; lCurrentIndex) And (lNewIndex &gt; -1) And
                     (lNewIndex &lt; m_items.Count) Then
                        For i = 0 To m_items.Count - 1
                            If (i = lNewIndex) Then
                                m_items(i).MouseOver = True
                            Else
                                m_items(i).MouseOver = False
                            End If
                        Next i
                        ensureVisible(lNewIndex)
                        Me.Invalidate()
                    End If

                End If
            End If

        End Sub

        Private Function selectNext( _
            ByVal lCurrent As Integer, _
            ByVal lDir As Integer _
            ) As Integer
            Dim bFound As Boolean
            Dim lNewIndex As Integer
            Dim lLastChecked As Integer

            lLastChecked = lCurrent
            Do While Not (bFound)
                lNewIndex = lLastChecked + lDir

                If (lNewIndex &lt; 0) Or (lNewIndex &gt;= m_items.Count) Then
                    If (Math.Abs(lDir) &gt; 1) Then
                        ' equivalent to hitting Home or End:
                        If (Math.Sign(lDir) = 1) Then
                            ' End
                            lNewIndex = m_items.Count - 1
                            Do While Not bFound
                                If (m_items(lNewIndex).Enabled) Then
                                    bFound = True
                                Else
                                    lNewIndex = lNewIndex - 1
                                    If (lNewIndex &lt; 0) Then
                                        bFound = True
                                    End If
                                End If
                            Loop
                        Else
                            ' Home
                            lNewIndex = 0
                            Do While Not bFound
                                If (m_items(lNewIndex).Enabled) Then
                                    bFound = True
                                Else
                                    lNewIndex = lNewIndex + 1
                                    If (lNewIndex &gt;= m_items.Count) Then
                                        bFound = True
                                    End If
                                End If
                            Loop
                        End If
                    End If
                    bFound = True
                Else
                    lLastChecked = lNewIndex
                    If (m_items(lNewIndex).Enabled) Then
                        bFound = True
                    End If
                    lDir = Math.Sign(lDir)
                End If
            Loop
            selectNext = lNewIndex

        End Function


        &lt;System.ComponentModel.Description("Ensures the keyboard interface
         responds correctly in the control.")&gt; _
        Protected Overrides Function IsInputKey(ByVal keyData As
         System.Windows.Forms.Keys) As Boolean
            Dim ret As Boolean = MyBase.IsInputKey(keyData)
            Select Case keyData
                Case Keys.Up
                    ret = True
                Case Keys.Down
                    ret = True
                Case Keys.Right
                    ret = True
                Case Keys.Left
                    ret = True
                Case Keys.Enter
                    ret = True
            End Select
            IsInputKey = ret
        End Function

        &lt;System.ComponentModel.Description("Performs control painting.")&gt; _
        Protected Overrides Sub OnPaint(ByVal e As
         System.Windows.Forms.PaintEventArgs)
            '

            ' Clear the background
            Dim br As Brush = New SolidBrush(Me.BackColor)
            e.Graphics.FillRectangle(br, e.ClipRectangle)
            br.Dispose()

            If (m_items Is Nothing) Then
                Exit Sub
            End If
            If (m_items.Count = 0) Then
                Exit Sub
            End If

            ' Paint the buttons:
            Dim useXpStyles As Boolean = m_isXp

            Dim hTheme As IntPtr = IntPtr.Zero
            If (useXpStyles) Then
                hTheme = OpenThemeData(Me.Handle, UXTHEMETOOLBARCLASS)
                If (hTheme.Equals(IntPtr.Zero)) Then
                    useXpStyles = False
                End If
            End If

            Dim iconSize As Integer = 0

            If Not (m_imageList Is Nothing) Then
                iconSize = m_imageList.ImageSize.Height
            End If

            Dim barItem As ButtonListBarItem = Nothing
            Dim iStateId As Integer = 0
            Dim itemText As String = ""

            If (useXpStyles) Then

                ' Drawing using XP Styles

                Dim hDC As IntPtr = e.Graphics.GetHdc()

                Dim tR As New RECT()
                tR.left = 0
                tR.right = m_buttonWidth
                tR.top = 0
                tR.bottom = Me.Height

                Dim tItemR As New RECT()
                Dim tContentR As New RECT()
                Dim tIconR As New RECT()
                Dim hFont As IntPtr = Me.Font.ToHfont
                Dim hFontOld As IntPtr = IntPtr.Zero
                hFontOld = SelectObject(hDC, hFont)

                Dim textAlign As Integer
                textAlign = DT_CENTER Or DT_WORDBREAK

                For Each barItem In m_items

                    tItemR.left = tR.left + 3
                    tItemR.right = tR.right - 3
                    tItemR.top = barItem.Start + Me.AutoScrollPosition.Y
                    tItemR.bottom = barItem.Start + barItem.Extent +
                     Me.AutoScrollPosition.Y

                    If (barItem.Enabled) Then
                        If (barItem.MouseDown) Then
                            If (barItem.MouseOver) Then
                                If (barItem.Selected) Then
                                    iStateId = TS_HOTCHECKED
                                Else
                                    iStateId = TS_PRESSED
                                End If
                            Else
                                If (barItem.Selected) Then
                                    iStateId = TS_CHECKED
                                Else
                                    iStateId = TS_HOT
                                End If
                            End If
                        Else
                            If (barItem.MouseOver) Then
                                If (barItem.Selected) Then
                                    iStateId = TS_HOTCHECKED
                                Else
                                    iStateId = TS_HOT
                                End If
                            Else
                                If (barItem.Selected) Then
                                    iStateId = TS_CHECKED
                                Else
                                    iStateId = TS_NORMAL
                                End If
                            End If
                        End If
                    Else
                        iStateId = TS_DISABLED
                    End If

                    DrawThemeBackground(hTheme, hDC, TP_BUTTON, iStateId, _
                       tItemR, tItemR)
                    GetThemeBackgroundContentRect(hTheme, hDC, TP_BUTTON,
                     iStateId, _
                       tItemR, tContentR)

                    If (iStateId = TS_DISABLED) Then
                        CloseThemeData(hTheme)
                        hTheme = OpenThemeData(Me.Handle, UXTHEMEBUTTONCLASS)
                        iStateId = PBS_DISABLED
                    End If

                    tIconR = tContentR
                    tIconR.left = tContentR.left + (tContentR.right -
                     tContentR.left - iconSize) \ 2
                    tIconR.right = tIconR.left + iconSize
                    tIconR.top += 4
                    tIconR.bottom = tIconR.top + iconSize
                    If (iStateId = TS_PRESSED) Then
                        tIconR.left += 1
                        tIconR.top += 1
                    End If

                    If Not (m_imageList Is Nothing) Then
                        SelectObject(hDC, hFontOld)
                        DeleteObject(hFont)
                        e.Graphics.ReleaseHdc(hDC)
                        If (barItem.Enabled) Then
                            e.Graphics.DrawImage( _
                                m_imageList.Images(barItem.IconIndex), _
                                tIconR.left, tIconR.top)
                        Else
                            ControlPaint.DrawImageDisabled( _
                                e.Graphics, _
                                m_imageList.Images(barItem.IconIndex), _
                                tIconR.left, _
                                tIconR.top, _
                                Me.BackColor)
                        End If
                        hDC = e.Graphics.GetHdc()
                        hFont = Me.Font.ToHfont
                        hFontOld = SelectObject(hDC, hFont)
                    End If

                    tContentR.top = tContentR.top + 4 + iconSize
                    tContentR.left += 3
                    tContentR.right -= 3
                    If (iStateId = TS_PRESSED) Then
                        tContentR.left += 1
                        tContentR.top += 1
                        tContentR.right += 1
                        tContentR.bottom += 1
                    End If

                    itemText = barItem.Text
                    DrawThemeText(hTheme, hDC, BP_PUSHBUTTON, iStateId, _
                       itemText, -1, _
                       textAlign, _
                       IIf(barItem.Enabled, 0, DTT_GRAYED), _
                       tContentR)

                    If (iStateId = TS_DISABLED) Then
                        CloseThemeData(hTheme)
                        hTheme = OpenThemeData(Me.Handle, UXTHEMETOOLBARCLASS)
                    End If

                Next

                CloseThemeData(hTheme)
                SelectObject(hDC, hFontOld)
                DeleteObject(hFont)
                e.Graphics.ReleaseHdc(hDC)

            Else
                ' Drawing using .NET Framework

                Dim fmt As StringFormat = New StringFormat()
                fmt.Alignment = StringAlignment.Center
                fmt.LineAlignment = StringAlignment.Near
                fmt.Trimming = StringTrimming.None
                fmt.HotkeyPrefix = Drawing.Text.HotkeyPrefix.Show
                Dim brText As Brush = New SolidBrush(Me.ForeColor)

                For Each barItem In m_items
                    If (barItem.Enabled) Then
                        If (barItem.MouseDown) Then
                            If (barItem.MouseOver) Then
                                If (barItem.Selected) Then
                                    iStateId = TS_HOTCHECKED
                                Else
                                    iStateId = TS_PRESSED
                                End If
                            Else
                                If (barItem.Selected) Then
                                    iStateId = TS_CHECKED
                                Else
                                    iStateId = TS_HOT
                                End If
                            End If
                        Else
                            If (barItem.MouseOver) Then
                                If (barItem.Selected) Then
                                    iStateId = TS_HOTCHECKED
                                Else
                                    iStateId = TS_HOT
                                End If
                            Else
                                If (barItem.Selected) Then
                                    iStateId = TS_CHECKED
                                Else
                                    iStateId = TS_NORMAL
                                End If
                            End If
                        End If
                    Else
                        iStateId = TS_DISABLED
                    End If

                    Dim itemRect As New Rectangle(3, barItem.Start,
                     m_buttonWidth - 6, barItem.Extent)
                    itemRect.Offset(0, Me.AutoScrollPosition.Y)

                    ' Draw background to item (if necessary);
                    If (iStateId = TS_CHECKED) Then
                        e.Graphics.FillRectangle(SystemBrushes.Control,
                         itemRect)
                    End If

                    ' Draw border:
                    If (iStateId = TS_HOTCHECKED) Or (iStateId = TS_CHECKED)
                     Then
                        'DrawEdgeAPI(m_cMemDC.hDC, tItemR, BDR_SUNKEN, BF_RECT
                         Or BF_SOFT)
                        ControlPaint.DrawBorder3D(e.Graphics, itemRect,
                         Border3DStyle.Sunken, Border3DSide.All)
                    ElseIf (iStateId = TS_HOT) Then
                        'DrawEdgeAPI(m_cMemDC.hDC, tItemR, BDR_RAISED, BF_RECT
                         Or BF_SOFT)
                        ControlPaint.DrawBorder3D(e.Graphics, itemRect,
                         Border3DStyle.Raised, Border3DSide.All)
                    ElseIf (iStateId = TS_PRESSED) Then
                        'DrawEdgeAPI(m_cMemDC.hDC, tItemR, BDR_SUNKEN, BF_RECT
                         Or BF_SOFT)
                        ControlPaint.DrawBorder3D(e.Graphics, itemRect,
                         Border3DStyle.Sunken, Border3DSide.All)
                    End If

                    itemRect.Inflate(-2, -2)
                    Dim iconRect As New Rectangle( _
                        itemRect.X + (itemRect.Width - iconSize) \ 2, _
                        itemRect.Y + 4, _
                        iconSize, _
                        iconSize)
                    If (iStateId = TS_PRESSED) Then
                        iconRect.Offset(1, 1)
                    End If

                    If Not (m_imageList Is Nothing) Then
                        If (barItem.Enabled) Then
                            e.Graphics.DrawImage( _
                                m_imageList.Images(barItem.IconIndex), _
                                iconRect.X, iconRect.Y)
                        Else
                            ControlPaint.DrawImageDisabled( _
                                e.Graphics, _
                                m_imageList.Images(barItem.IconIndex), _
                                iconRect.X, _
                                iconRect.Y, _
                                Me.BackColor)
                        End If
                    End If

                    itemRect.Y = itemRect.Y + iconSize + 4
                    'itemRect.Inflate(-6, 0)
                    If (iStateId = TS_PRESSED) Then
                        itemRect.Offset(1, 1)
                    End If

                    Dim textRect As New RectangleF(itemRect.X, itemRect.Y,
                     itemRect.Width, itemRect.Height)

                    itemText = barItem.Text
                    If (iStateId = TS_DISABLED) Then
                        ControlPaint.DrawStringDisabled(e.Graphics, _
                            itemText, Me.Font,
                             Color.FromKnownColor(KnownColor.ControlDark), _
                            textRect, fmt)
                    Else
                        e.Graphics.DrawString( _
                            itemText, Me.Font, brText, _
                            textRect, fmt)
                    End If

                Next
                brText.Dispose()
                fmt.Dispose()

            End If

            '
        End Sub

        &lt;System.ComponentModel.Description("Ensures hot-tracking is cleared
         when the mouse leaves the control.")&gt; _
        Protected Overrides Sub OnMouseLeave(ByVal e As System.EventArgs)
            '
            MyBase.OnMouseLeave(e)
            '
            Dim i As Integer
            Dim index As Integer
            For i = 0 To m_items.Count - 1
                If (m_items(i).MouseDown) Then
                    Exit Sub
                Else
                    If (m_items(i).MouseOver) Then
                        index = i
                    End If
                End If
            Next i

            If (index &gt;= 0) And (m_items.Count &gt; 0) Then
                If (HitTest() &lt; 0) Then
                    setToolTip("")
                    m_items(index).MouseOver = False
                    Me.Invalidate()
                End If
            End If
        End Sub

        &lt;System.ComponentModel.Description("Performs mouse processing in the
         control.")&gt; _
        Protected Overrides Sub OnMouseDown(ByVal e As
         System.Windows.Forms.MouseEventArgs)
            '
            MyBase.OnMouseDown(e)

            Dim index As Integer
            Dim itemEventArgs As ItemClickEventArgs
            index = HitTest()
            If (index &gt; -1) Then
                If (e.Button = MouseButtons.Left) Then
                    m_items(index).MouseDown = True
                    Me.Invalidate()
                ElseIf (e.Button = MouseButtons.Right) Then
                    itemEventArgs = New ItemClickEventArgs(m_items(index), New
                     Point(e.X, e.Y), MouseButtons.Right)
                    OnItemClick(itemEventArgs)
                End If
            ElseIf (e.Button = MouseButtons.Right) Then
                OnBarClick(e)
            End If
            '
        End Sub

        Private Sub setToolTip(ByVal sToolTip As String)
            If Not (m_toolTip Is Nothing) Then
                m_toolTip.SetToolTip(Me, sToolTip)
            End If
        End Sub

        &lt;System.ComponentModel.Description("Performs mouse processing in the
         control.")&gt; _
        Protected Overrides Sub OnMouseMove(ByVal e As
         System.Windows.Forms.MouseEventArgs)
            '
            MyBase.OnMouseMove(e)

            Dim index As Integer
            Dim changed As Boolean = False
            index = HitTest()
            Dim i As Integer
            For i = 0 To m_items.Count - 1
                If (i = index) Then
                    If Not (m_items(i).MouseOver) Then
                        setToolTip(m_items(i).ToolTip)
                        m_items(i).MouseOver = True
                        changed = True
                    End If
                Else
                    If (m_items(i).MouseOver) Then
                        m_items(i).MouseOver = False
                        changed = True
                    End If
                End If
            Next i
            If (index = -1) Then
                setToolTip("")
            End If

            If (changed) Then
                Me.Invalidate()
            End If

            '
        End Sub

        &lt;System.ComponentModel.Description("Performs mouse processing in the
         control.")&gt; _
        Protected Overrides Sub OnMouseUp(ByVal e As
         System.Windows.Forms.MouseEventArgs)
            '
            MyBase.OnMouseUp(e)
            If (e.Button = MouseButtons.Left) Then
                Dim i As Integer
                Dim changed As Boolean
                For i = 0 To m_items.Count - 1
                    If (m_items(i).MouseDown) Then
                        If (HitTest() = i) Then
                            If (m_items(i).Enabled) Then
                                ' Click
                                m_items(i).MouseDown = False
                                m_items(i).Selected = True
                                ensureVisible(i)
                                Me.Invalidate()
                                Dim itemEventArgs As ItemClickEventArgs = New
                                 ItemClickEventArgs( _
                                    m_items(i), _
                                    New Point(e.X, e.Y), _
                                    MouseButtons.Left)
                                OnItemClick(itemEventArgs)
                            Else
                                m_items(i).MouseDown = False
                            End If
                        Else
                            ' no click
                            m_items(i).MouseDown = False
                            changed = True
                        End If
                    End If
                Next i
                If (changed) Then
                    Me.Invalidate()
                End If
            End If

            '
        End Sub

        Private Sub ensureVisible(ByVal lIndex As Integer)
            '
            Dim lOffset As Integer
            lOffset = Me.AutoScrollPosition.Y

            Dim lTop As Integer
            lTop = m_items(lIndex).Start + lOffset - 3
            Dim lNewValue As Integer
            If (lTop &lt; 0) Then
                ' need to scroll up
                lNewValue = (-lOffset) + lTop
                If (lNewValue &lt;= 2) Then
                    lNewValue = 0
                End If
                pScrollTo(lNewValue)
            Else
                Dim lBottom As Integer
                lBottom = m_items(lIndex).Start + lOffset - 3 +
                 m_items(lIndex).Extent
                If (lBottom &gt; Me.ClientSize.Height) Then
                    ' need to scroll down
                    lNewValue = -Me.AutoScrollPosition.Y + (lBottom -
                     Me.ClientSize.Height) + 6
                    If (lNewValue &gt;= Me.AutoScrollMinSize.Height - 4) Then
                        lNewValue = Me.AutoScrollMinSize.Height
                    End If
                    pScrollTo(lNewValue)
                End If
            End If
            '
        End Sub

        Private Sub pScrollTo(ByVal lNewPos As Integer)
            Dim lNow As Integer
            Dim lStepSize As Integer
            Dim bComplete As Boolean
            Dim lNewValue As Integer

            lNow = -Me.AutoScrollPosition.Y
            If (lNewPos &gt; lNow) Then
                lStepSize = 1
            Else
                lStepSize = -1
            End If

            Do While Not bComplete
                lNewValue = lNow + lStepSize
                If (lStepSize &lt; 0) Then
                    If (lNewValue &lt; lNewPos) Then
                        lNewValue = lNewPos
                        bComplete = True
                    End If
                Else
                    If (lNewValue &gt; lNewPos) Then
                        lNewValue = lNewPos
                        bComplete = True
                    End If
                End If
                Me.AutoScrollPosition = New Point(0, Math.Abs(lNewValue))
                lStepSize = lStepSize * 2
            Loop

        End Sub

        &lt;System.ComponentModel.Description("Processes Alt- Mnemonic key strokes
         for the items in the control.")&gt; _
        Protected Overrides Function ProcessMnemonic(ByVal charCode As Char) As
         Boolean
            '
            Dim ret As Boolean = MyBase.ProcessMnemonic(charCode)
            Dim i As Integer
            Dim itemText As String
            Dim pos As Integer
            Dim compareText As String
            Dim index As Integer = -1
            compareText = "&amp;" + Char.ToUpper(charCode)
            For i = 0 To m_items.Count - 1
                itemText = m_items(i).Text.ToUpper()
                pos = itemText.IndexOf(compareText)
                If (pos &gt; 0) Then
                    index = i
                    ret = True
                    Exit For
                End If
            Next
            If (index &gt; -1) Then
                m_items(index).Selected = True
                ensureVisible(index)
                Dim itemClickArgs As ItemClickEventArgs = New
                 ItemClickEventArgs(m_items(i), Nothing, MouseButtons.None)
                OnItemClick(itemClickArgs)
            End If

            ProcessMnemonic = ret
            '
        End Function

        &lt;System.ComponentModel.Description("Raises the ItemClick event.")&gt; _
        Protected Overridable Sub OnItemClick(ByVal e As ItemClickEventArgs)
            RaiseEvent ItemClick(Me, e)
        End Sub

        &lt;System.ComponentModel.Description("Raises the BarClick event.")&gt; _
        Protected Overridable Sub OnBarClick(ByVal e As MouseEventArgs)
            RaiseEvent BarClick(Me, e)
        End Sub

        &lt;System.ComponentModel.Description("Raises the SelectionChanged
         event.")&gt; _
        Protected Overridable Sub OnSelectionChanged(ByVal e As
         SelectionChangedEventArgs)
            RaiseEvent SelectionChanged(Me, e)
        End Sub

        &lt;System.ComponentModel.Description("Performs control resizing.")&gt; _
        Protected Overrides Sub OnResize(ByVal e As System.EventArgs)
            '
            MyBase.OnResize(e)
            OnItemChanged(Nothing)
            '
        End Sub

        Private Function HitTest() As Integer
            Dim p As New Point(Cursor.Position.X, Cursor.Position.Y)
            p = Me.PointToClient(p)
            HitTest = HitTestPoint(p.X, p.Y)
        End Function

        Private Function HitTestPoint(ByVal x As Integer, ByVal y As Integer)
         As Integer
            Dim ret As Integer = -1
            If (x &gt;= 3) And (x &lt;= m_buttonWidth - 6) Then
                If (y &gt;= 0 And y &lt;= Me.ClientSize.Height) Then
                    Dim barItem As ButtonListBarItem
                    Dim i As Integer
                    For i = 0 To m_items.Count - 1
                        barItem = m_items(i)
                        If (y &gt;= barItem.Start + Me.AutoScrollPosition.Y) Then
                            If (y &lt; barItem.Start + barItem.Extent +
                             Me.AutoScrollPosition.Y) Then
                                ret = i
                                Exit For
                            End If
                        End If
                    Next
                End If
            End If
            HitTestPoint = ret
        End Function

    End Class
#End Region

#Region " ButtonListBarItems "
    Public Class ButtonListBarItems
        Inherits CollectionBase

        Private m_owner As ButtonListBar = Nothing

        &lt;System.ComponentModel.DescriptionAttribute("Adds an item to the
         Listbar.")&gt; _
        Public Sub Add(ByVal item As ButtonListBarItem)
            item.Owner = m_owner
            MyBase.InnerList.Add(item)
            m_owner.OnItemChanged(item)
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Adds an array of items to
         the Listbar.")&gt; _
        Public Sub Add(ByVal items() As ButtonListBarItem)
            Dim item As ButtonListBarItem
            For Each item In items
                If Not (item Is Nothing) Then
                    item.Owner = m_owner
                    MyBase.InnerList.Add(item)
                End If
            Next
            m_owner.OnItemChanged(Nothing)
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Inserts an item to the
         Listbar at the specified zero-based index.")&gt; _
        Public Sub Insert( _
                ByVal index As Integer, _
                ByVal item As ButtonListBarItem _
            )
            item.Owner = m_owner
            MyBase.InnerList.Insert(index, item)
            m_owner.OnItemChanged(item)
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the item with
         the specified index.")&gt; _
        Default Public Property Item(ByVal index As Integer) As
         ButtonListBarItem
            Get
                Item = MyBase.InnerList(index)
            End Get
            Set(ByVal Value As ButtonListBarItem)
                MyBase.InnerList(index) = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new, blank
         instance of the class for the specified ButtonListBar.")&gt; _
        Public Sub New(ByVal owner As ButtonListBar)
            m_owner = owner
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class for the specified ButtonListBar and populates the item
         collection using the array of ButtonListBarItem objects passed in.")&gt; _
        Public Sub New( _
                ByVal owner As ButtonListBar, _
                ByVal items As ButtonListBarItem() _
            )
            m_owner = owner

            Dim barItem As ButtonListBarItem
            For Each barItem In items
                barItem.Owner = m_owner
                MyBase.InnerList.Add(barItem)
            Next
            m_owner.OnItemChanged(Nothing)
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class for the specified ButtonListBar and populates it by cloning
         the items in the provided ButtonListBarItems collection passed in.")&gt; _
        Public Sub New( _
                ByVal owner As ButtonListBar, _
                ByVal items As ButtonListBarItems _
            )
            m_owner = owner

            Dim barItemFrom As ButtonListBarItem
            Dim barItemNew As ButtonListBarItem
            For Each barItemFrom In items
                barItemNew = barItemFrom.Clone()
                barItemNew.Owner = m_owner
                MyBase.InnerList.Add(barItemNew)
            Next
            m_owner.OnItemChanged(Nothing)
        End Sub

        Protected Overrides Sub OnRemoveComplete(ByVal index As Integer, ByVal
         value As Object)
            MyBase.OnRemoveComplete(index, value)
            ' notify parent:
            m_owner.OnItemChanged(Nothing)
        End Sub

        Protected Overrides Sub OnClearComplete()
            MyBase.OnClearComplete()
            ' notify parent:
            m_owner.OnItemChanged(Nothing)
        End Sub

        Protected Overrides Sub OnInsertComplete(ByVal index As Integer, ByVal
         value As Object)
            MyBase.OnInsertComplete(index, value)
            Dim item As ButtonListBarItem = value
            item.Owner = m_owner
            ' notify parent:
            m_owner.OnItemChanged(Nothing)
        End Sub

        Protected Overrides Sub OnSetComplete(ByVal index As Integer, ByVal
         oldValue As Object, ByVal newValue As Object)
            MyBase.OnSetComplete(index, oldValue, newValue)
            Dim item As ButtonListBarItem = newValue
            item.Owner = m_owner
            ' notify parent:
            m_owner.OnItemChanged(Nothing)
        End Sub
    End Class
#End Region

#Region " ButtonListBarItem "
    Public Class ButtonListBarItem
        Implements ICloneable

        Private m_caption As String = ""
        Private m_toolTip As String = ""
        Private m_tag As Object = Nothing
        Private m_iconIndex As Integer = -1
        Private m_enabled As Boolean = True
        Private m_start As Integer = 0
        Private m_extent As Integer = 0
        Private m_owner As ButtonListBar = Nothing
        Private m_mouseOver As Boolean = False
        Private m_mouseDown As Boolean = False
        Private m_selected As Boolean = False

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the text for
         this item")&gt; _
        Public Property Text() As String
            Get
                Text = m_caption
            End Get
            Set(ByVal Value As String)
                m_caption = Value
                If Not (m_owner Is Nothing) Then
                    m_owner.OnItemChanged(Me)
                End If
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the tooltip for
         this item")&gt; _
        Public Property ToolTip() As String
            Get
                ToolTip = m_toolTip
            End Get
            Set(ByVal Value As String)
                m_toolTip = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets an object
         associated with this item")&gt; _
        Public Property Tag() As Object
            Get
                Tag = m_tag
            End Get
            Set(ByVal Value As Object)
                m_tag = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the icon index
         for this item")&gt; _
        Public Property IconIndex() As Integer
            Get
                IconIndex = m_iconIndex
            End Get
            Set(ByVal Value As Integer)
                m_iconIndex = Value
                If Not (m_owner Is Nothing) Then
                    m_owner.OnItemChanged(Me)
                End If
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets whether this
         item is enabled")&gt; _
        Public Property Enabled() As Boolean
            Get
                Enabled = m_enabled
            End Get
            Set(ByVal Value As Boolean)
                m_enabled = Value
                If Not (m_owner Is Nothing) Then
                    m_owner.OnItemChanged(Me)
                End If
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the owning
         ButtonListBar for this item")&gt; _
        Friend Property Owner() As ButtonListBar
            Get
                Owner = m_owner
            End Get
            Set(ByVal Value As ButtonListBar)
                m_owner = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the start
         position of the item in the bar.  For internal use only")&gt; _
        Friend Property Start() As Integer
            Get
                Start = m_start
            End Get
            Set(ByVal Value As Integer)
                m_start = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Gets/sets the extent of
         the item in the bar.  For internal use only")&gt; _
        Friend Property Extent() As Integer
            Get
                Extent = m_extent
            End Get
            Set(ByVal Value As Integer)
                m_extent = Value
            End Set
        End Property

        Public Property Selected() As Boolean
            Get
                Selected = m_selected
            End Get
            Set(ByVal Value As Boolean)
                If (Value &lt;&gt; m_selected) Then
                    If Not (m_owner Is Nothing) Then
                        m_selected = m_owner.OnSelectItem(Me, Value)
                        m_owner.OnItemChanged(Me)
                    End If
                End If
            End Set
        End Property

        Friend Property MouseDown() As Boolean
            Get
                MouseDown = m_mouseDown
            End Get
            Set(ByVal Value As Boolean)
                m_mouseDown = Value
            End Set
        End Property

        Friend Property MouseOver() As Boolean
            Get
                MouseOver = m_mouseOver
            End Get
            Set(ByVal Value As Boolean)
                m_mouseOver = Value
            End Set
        End Property

        &lt;System.ComponentModel.DescriptionAttribute("Creates a copy of this
         object.")&gt; _
        Public Function Clone() As Object Implements System.ICloneable.Clone
            Dim myClone As New ButtonListBarItem( _
                m_caption, _
                m_iconIndex, _
                m_toolTip, _
                m_enabled)
            myClone.Tag = m_tag
            Clone = myClone
        End Function

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new, blank
         instance of the class.")&gt; _
        Public Sub New()
            MyBase.New()
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class and sets the Text property.")&gt; _
        Public Sub New(ByVal text As String)
            MyBase.New()
            m_caption = text
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class and sets the Text and Icon Index properties.")&gt; _
        Public Sub New( _
                ByVal text As String, _
                ByVal iconIndex As Integer _
            )
            MyBase.New()
            m_caption = text
            m_iconIndex = iconIndex
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class and sets the Text, Icon Index and ToolTip properties.")&gt; _
        Public Sub New( _
                ByVal text As String, _
                ByVal iconIndex As Integer, _
                ByVal toolTip As String _
            )
            MyBase.New()
            m_caption = text
            m_iconIndex = iconIndex
            m_toolTip = toolTip
        End Sub

        &lt;System.ComponentModel.DescriptionAttribute("Creates a new instance of
         the class and sets the Text, Icon Index, ToolTip and Enabled
         properties.")&gt; _
        Public Sub New( _
                ByVal text As String, _
                ByVal iconIndex As Integer, _
                ByVal toolTip As String, _
                ByVal enabled As Boolean _
            )
            MyBase.New()
            m_caption = text
            m_iconIndex = iconIndex
            m_toolTip = toolTip
            m_enabled = enabled
        End Sub

    End Class
#End Region

End Namespace
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\vb\code\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBar</a>&#160;.&#160;<a href="article.html">.NET Button ListBar Control</a>&#160;.&#160;<a href="button_list_bar_net.html">Button List Bar.NET</a>&#160;.&#160;ButtonListBar_ButtonListBarTest_ButtonListBar.vb</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 4 February 2004</p></td><td></td></tr></table>
</body></html>