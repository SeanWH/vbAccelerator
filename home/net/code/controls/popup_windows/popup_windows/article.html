<html lang="en" >
<head>

<title>vbAccelerator - Use .NET Forms as Popup Windows</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
This article provides a reusable class which you can use to convert a form into a 
popup which works in the same way as the drop-down portion of a ListBox or the popup
controls for picking colours or tables in Office.  In addition to wrapping all
the functionality you need to ensure the popup is cancelled if the user clicks out
of the popup or alt-tabs to another application, it also ensures the title bar of the
application stays in focus whilst the drop-down is displayed. VB.NET and C# code provided.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Popup Windows</a>&#160;.&#160;Use .NET Forms as Popup Windows</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="popup_form_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Popup Form Demonstration</a> (62K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:13309</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=13309&type=article&title=use_20_2enet_20forms_20as_20popup_20windows.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;.NET</p><p class="nav">&#160;&#160;C#</p><p class="nav">&#160;&#160;VB.NET</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 1 / 1</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 0 / 0</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:8 January 2004</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />1 Nov 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\windows_messages\mouse_gestures\article.html">Adding Mouse Gesture Support to .NET Windows Applications</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\windows_messages\subclassing_in__net\article.html">Subclassing In .NET</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\vb\code\controls\drop_down_tool_windows\drop_down_form_control\article.html">vbAccelerator Drop-Down and Popup Form Control</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Use .NET Forms as Popup Windows</h1><p class="splash">A reusable class to convert any form into a Popup Window.</p><img src="popupcontrol.png" width="166" height="197" alt="Popup Window Demonstration Project" /><p /><p>
This article provides a reusable class which you can use to convert a form into a 
popup which works in the same way as the drop-down portion of a ListBox or the popup
controls for picking colours or tables in Office.  In addition to wrapping all
the functionality you need to ensure the popup is cancelled if the user clicks out
of the popup or alt-tabs to another application, it also ensures the title bar of the
application stays in focus whilst the drop-down is displayed. VB.NET and C# code provided.
</p><h2>Creating a Popup Window</h2><p>
Popup Windows shown from controls are used widely in Windows applications
to provide succinct and functional UIs.  Examples of popup windows include things like
menus, combo-box drop-downs, the date-time picker and many of the tools provided in
Microsoft Office applications.  If you are building a professional application then
having the ability to create these types of controls is invaluable.  Unfortunately, 
there isn't a built-in control or Windows style in the Windows API or .NET Framework
which lets you do this easily.
</p><p>
If you try to create a drop-down control using a standard .NET Framework form, you'll
see it is easy enough to make it pop up in the correct place, but there are two
things that need to be done to make it act like a popup window from a control:
</p><ol><li><strong>Cancellation</strong><br />
The popup part of a drop-down control is cancelled whenever the user clicks somewhere 
away from the drop-down, or if they alt-tab to another application.  Although in theory
you may be able to write code to detect these events, once you've done it the 
resulting code would be extremely difficult to maintain.
</li><li><strong>Keep the Application Window Titlebar Active</strong><br />
When ever you show a new form, regardless of whether it has a titlebar or if it is
an owned form, the window you've shown it from loses focus.  This is correct if the
new Window is a dialog or separate view, but not correct if you are showing a popup.
An alternative which doesn't cause the loss of focus is to use a control instead
of a form, but if you do that then the control is contained within the boundaries
of the owning form, and a drop-down should be able to display anywhere.  You can
try hacking the control by modifying its parent, but then you'll find that focus
no longer works at all.
</li></ol><p>
Resolving these issues requires a little persistence, but it can be done, and the 
<span class="code">PopupWindowHelper</span> class provided with this article 
is a reusable class which does it with the help of a small handful of unmanaged
calls, subclassing and message loop filtering.
</p><h2>About <span class="code">PopupWindowHelper</span></h2><p>
To understand the structure of the <span class="code">PopupWindowHelper</span> class,
its best first to understand how it goes about solving the problems posed in the
last section.  There are two parts to the solution:
</p><ol><li>Detecting Popup Form Cancellation by Mouse Click</li><li>Keeping the Main Form Title Active and Detecting Alt-Tabbing</li></ol><p>
I'll cover these in turn.
</p><h3>1. Detecting Popup Form Cancellation by Mouse Click</h3><p>
As you will have seen from the .NET Windows namespace, mouse events are provided 
individually to the form or control that the mouse is over when the event occurs.
So how can you detect a mouse event over any control or form regardless of 
where it occurs?  The answer is to filter all messages sent to the application's
Message Loop.  A more in-depth description of this technique is provided in
the article <a href="..\..\..\libraries\windows_messages\mouse_gestures\article.html">Adding Mouse Gesture Support to .NET
Windows Applications</a> so I won't cover it again here, suffice to say that
to use this technique you implement the <span class="code">IMessageFilter</span>
interface which then receives notifications of a mouse event over any object.
</p><h3>2. Keeping the Main Form Title Active and Detecting Alt-Tabbing</h3><p>
Both of these requirements can be met by subclassing the main window which
shows the popup window.  To subclass a window, you use the <span class="code">NativeWindow</span>
object as described in <a href="..\..\..\libraries\windows_messages\subclassing_in__net\article.html">Subclassing in .NET</a>, which allows you
to intercept all messages intended for the Window.  Then there are two messages to look
out for.
</p><p>
First, keeping the title active. This aspect is slightly tricky.  
Windows controls the active state of a title bar
using the <span class="code">WM_NCACTIVATE</span> (Non-client Activate) message.
However, this message is also used for other things such as keyboard focus, which
can lead to big problems if you interrupt processing of it.  Particularly in this
case: if you attempt to consume or modify a <span class="code">WM_NCACTIVATE</span> message
that asks to deactivate a Window, you'll find that the window that is subsequently shown
cannot gain the input focus regardless of what you do.  
   </p><p>
The solution to this problem is, of course, a hack. I first chanced upon this in 1999
when trying to <a href="..\..\..\..\..\vb\code\controls\drop_down_tool_windows\drop_down_form_control\article.html">create the same effect in VB Classic</a>: 
rather than trying to ignore or modify the <span class="code">WM_NCACTIVATE</span> message, instead
process it as normal but immediately send another <span class="code">WM_NCACTIVATE</span> 
back again to tell the Window to render itself in the active state again.  This
<strong>is</strong> a bit of a hack, but it works as well here as it did before.
</p><p>
Detecting Alt-Tabbing is more straightforward.
The <span class="code">WM_ACTIVATEAPP</span> message is sent to all top level 
windows of an application when you Alt-Tab to or from the application.  The 
<span class="code">WParam</span> value indicates the state: a value of 0 means
the application is being deactivated, otherwise it is being activated.
</p><h2><span class="code">PopupWindowHelper</span> Implementation</h2><p>
Given the description above, it should come as no surprise that the implementation 
consists of two classes, one to subclass the main window for <span class="code">WM_NCACTIVATE</span>
and <span class="code">WM_ACTIVATEAPP</span> messages and another to implement the 
message filter:
</p><img src="popupwindowhelperuml.png" width="356" height="301" alt="PopupWindowHelper implementation UML Diagram." /><p class="caption">PopupWindowHelper implementation UML Diagram.</p><p>
The <span class="code">PopupWindowHelperMessageFilter</span> performs message filtering for mouse
clicks.   Basically, it checks to see whether a mouse event is detected outside the popup form,
and if so, raises an event which notifies the <span class="code">PopupWindowHelper</span>
class of the event:
</p><pre>
      private const int WM_LBUTTONDOWN = 0x201;
      private const int WM_RBUTTONDOWN = 0x204;
      private const int WM_MBUTTONDOWN = 0x207;
      private const int WM_NCLBUTTONDOWN = 0x0A1;
      private const int WM_NCRBUTTONDOWN = 0x0A4;
      private const int WM_NCMBUTTONDOWN = 0x0A7;

      /// &lt;summary&gt;
      /// Checks the message loop for mouse messages whilst the popup
      /// window is displayed.  If one is detected the position is
      /// checked to see if it is outside the form, and the owner
      /// is notified if so.
      /// &lt;/summary&gt;
      /// &lt;param name="m"&gt;Windows Message about to be 
      /// processed by the message loop&lt;/param&gt;
      /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; to filter the message, &lt;c&gt;false&lt;/c&gt; 
      /// otherwise.  This implementation always returns 
      /// &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
      public bool PreFilterMessage(ref Message m)
      {
         if (this.popup != null)
         {
            switch (m.Msg)
            {            
               case WM_LBUTTONDOWN:
               case WM_RBUTTONDOWN:
               case WM_MBUTTONDOWN:
               case WM_NCLBUTTONDOWN:
               case WM_NCRBUTTONDOWN:
               case WM_NCMBUTTONDOWN:
                  OnMouseDown();
                  break;
            }
         }
         return false;
      }

      /// &lt;summary&gt;
      /// Checks the mouse location and calls the OnCancelPopup method
      /// if the mouse is outside the popup form.      
      /// &lt;/summary&gt;
      private void OnMouseDown()
      {
         // Get the cursor location
         Point cursorPos = Cursor.Position;
         // Check if it is within the popup form
         if (!popup.Bounds.Contains(cursorPos))
         {
            // If not, then call to see if it should be closed
            OnCancelPopup(new PopupCancelEventArgs(popup, cursorPos));
         }
      }
</pre><p>
The <span class="code">PopupWindowHelper</span> performs processing on the messages
passing through the window procedure of the main form:
</p><pre>
   [DllImport("user32", CharSet = CharSet.Auto)]
   private extern static int SendMessage(
      IntPtr handle, int msg, int wParam, IntPtr lParam);

   [DllImport("user32", CharSet = CharSet.Auto)]
   private extern static int PostMessage(
       IntPtr handle, int msg, int wParam, IntPtr lParam);

   private const int WM_ACTIVATE = 0x006;
   private const int WM_ACTIVATEAPP = 0x01C;
   private const int WM_NCACTIVATE = 0x086;


      /// &amp;lt;summary&amp;gt;
      /// Subclasses the owning form's existing Window Procedure to enables the 
      /// title bar to remain active when a popup is show, and to detect if
      /// the user clicks onto another application whilst the popup is visible.
      /// &amp;lt;/summary&amp;gt;
      /// &amp;lt;param name="m"&amp;gt;Window Procedure Message&amp;lt;/param&amp;gt;
      protected override void WndProc(ref Message m)
      {
         base.WndProc(ref m);
         if (this.popupShowing)
         {
            // check for WM_ACTIVATEAPP and WM_NCACTIVATE
            if (m.Msg == WM_NCACTIVATE)
            {
               // Check if the title bar will made inactive:
               if (((int) m.WParam) == 0)
               {
                  // If so reactivate it.
                  SendMessage(this.Handle, WM_NCACTIVATE, 1, IntPtr.Zero);
                  
                  // Note it's no good to try and consume this message;
                  // if you try to do that you'll end up with windows
                  // that don't respond.
               }

            }
            else if (m.Msg == WM_ACTIVATEAPP)
            {
               // Check if the application is being deactivated.
               if ((int)m.WParam == 0)
               {
                  // It is so cancel the popup:
                  ClosePopup();
                  // And put the title bar into the inactive state:
                  PostMessage(this.Handle, WM_NCACTIVATE, 0, IntPtr.Zero);
               }
            }
         }
      }
</pre><h2>Using the Class to Make a Popup Form</h2><p>
This is very simple to do.  Bring in the <span class="code">PopupWindowHelper</span> code
into your project, and then perform the following steps:
</p><ol><li>Create a form to display as a popup, and set these properties:
<ul><li><span class="code">ControlBox = false</span></li><li><span class="code">FormBorderStyle = None</span></li><li><span class="code">MinimizeBox = false</span></li><li><span class="code">MaximizeBox = false</span></li><li><span class="code">ShowInTaskBar = false</span></li><li><span class="code">Text = ""</span></li><li><span class="code">TopMost = true</span></li></ul></li><li>Create an instance of the <span class="code">PopupWindowHelper</span> class.</li><li>Respond to the <span class="code">PopupCancel</span> and <span class="code">PopupClose</span>
as required to determine when the popup is cancelled or closed as required.</li><li>Use the <span class="code">ShowPopup</span> method of <span class="code">PopupWindowHelper</span> 
to show the popup window.</li></ol><h2>Conclusion</h2><p>
This article provides a reusable class which wraps up all the tricky details of 
implementing a popup form which can be used as a drop-down from a control.
The demonstration project provided here is rudimentary, but the technique can
be easily used to create sophisticated drop-down controls like colour pickers,
undo/redo drop-downs, table pickers and so on.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Popup Windows</a>&#160;.&#160;Use .NET Forms as Popup Windows</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 15 November 2003</p></td><td></td></tr></table>
</body></html>