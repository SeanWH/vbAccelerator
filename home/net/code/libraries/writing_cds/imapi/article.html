<html lang="en" >
<head>
<title>vbAccelerator - Image Mastering API (IMAPI) Wrapper for .NET</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
IMAPI is provided with Windows XP and above to provide full control over the creation
of audio and data discs.  This sample provides a wrapper around the API allowing it to be 
used from .NET; both VB and C# client code is provided.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" />
<link rel="contents" href="../index.asp" /><link rel="meta" type="application/rdf+xml" href="./article.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Image Mastering API (IMAPI) Wrapper for .NET</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="acclimapiwrapper_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />acclImapiWrapper Binary</a> (21K)</p><p /><p class="nav"><a href="imapi_wrapper_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />IMAPI Wrapper Demonstration</a> (84K)</p><p class="nav"><a href="imapi_wrapper_documentation.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />IMAPI Wrapper Documentation</a> (85K)</p><p class="nav"><a href="imapi_wrapper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />IMAPI Wrapper</a> (89K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:15411</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=15411&type=article&title=image_20mastering_20api_20_28imapi_29_20wrapper_20for_20_2enet.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;.NET</p><p class="nav">&#160;&#160;VB.NET</p><p class="nav">&#160;&#160;C#</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 Jun 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Image Mastering API (IMAPI) Wrapper for .NET</h1><img src="imapiproperties.png" width="349" height="463" alt="IMAPI Properties Sample" /><p /><p>
IMAPI is provided with Windows XP and above to provide full control over the creation
of audio and data discs.  This sample provides a wrapper around the API allowing it to be 
used from .NET; both VB and C# client code is provided.
</p><h2>About IMAPI</h2><p>
The Image Mastering API allows an application to stage and burn a simple audio or data image to CD-R
and CD-RW devices.  All XP and above systems come with the Adaptec implementation of IMAPI, which 
is controlled through the <span class="code">MSDiscMasterObj</span> COM object.
In theory other implementations of the API could be made available by vendors but I have
not seen any details of any other implementations.   The API interfaces are briefly described
in the diagram and table below:
</p><img src="msdiscmasterobj.png" width="270" height="152" alt="The MS Disc Master Object" /><p class="caption">MS Disc Master Object</p><table class="article"><tr class="header"><td><strong>Interface</strong></td><td><strong>System</strong></td><td><strong>Description</strong></td></tr><tr><td valign="top"><span class="code">ICDBurn</span></td><td valign="top"><span class="code">Shell</span></td><td valign="top"><p>Simple interface for writing files to CD.  <span class="code">Burn</span> method copies 
staging area to CD.</p></td></tr><tr class="body"><td valign="top"><span class="code">IDiscMaster</span></td><td valign="top"><span class="code">IMAPI</span></td><td valign="top"><p>Controls an IMAPI session.  Opens, closes, enumerates and selects recorders, and allows
burning of data or audio discs.</p></td></tr><tr><td valign="top"><span class="code">IDiscRecorder</span></td><td valign="top"><span class="code">IMAPI</span></td><td valign="top"><p>Provides access to a single recorder connected to the system.</p></td></tr><tr class="body"><td valign="top"><span class="code">IRedbookDiscMaster</span></td><td valign="top"><span class="code">IMAPI</span></td><td valign="top"><p>Contains functions to create a Redbook (audio) disc on the active recorder.</p></td></tr><tr><td valign="top"><span class="code">IJolietDiscMaster</span></td><td valign="top"><span class="code">IMAPI</span></td><td valign="top"><p>Contains functions to create a Joliet (data) disc on the active recorder.</p></td></tr><tr class="body"><td valign="top"><span class="code">IDiscMasterProgressEvents</span></td><td valign="top"><span class="code">IMAPI</span></td><td valign="top"><p>Interface you can implement to receive feedback about progress during a burn and 
notification of Plug'n'Play events affecting the available recorders.</p></td></tr></table><h2>Implementing an IMAPI Wrapper</h2><p>
The IMAPI COM interface isn't implemented in a particularly Interop-friendly way.  The
DLLs containing the implementations do not have type libraries nor do they expose ProgIds
to construct the objects.  There isn't even any IDL code to help along the creation
of a type library in the Platform SDK; rather there is a MIDL-generated file which is 
intended for use in C++ (or at a push, C).
</p><p>
Based on the <a href="..\..\..\..\..\vb\code\libraries\writing_cds\imapi\article.html">VB Classic</a> implementation of this 
wrapper, I took the approach of using Interop to modify the MIDL declares into
something which can be used directly from Managed code.  Here's an example
of how to do the translation for the <span class="code">IDiscMaster</span>
interface.
</p><p class="caption">1. MIDL Definition of IDiscMaster</p><pre>
EXTERN_C const IID IID_IDiscMaster;

#if defined(__cplusplus) &amp;&amp; !defined(CINTERFACE)
    
    MIDL_INTERFACE("520CCA62-51A5-11D3-9144-00104BA11C5E")
    IDiscMaster : public IUnknown
    {
    public:
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            Open( void) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            EnumDiscMasterFormats( 
            /* [out] */ IEnumDiscMasterFormats **ppEnum) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            GetActiveDiscMasterFormat( 
            /* [out] */ LPIID lpiid) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            SetActiveDiscMasterFormat( 
            /* [in] */ REFIID riid,
            /* [iid_is][out] */ void **ppUnk) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            EnumDiscRecorders( 
            /* [out] */ IEnumDiscRecorders **ppEnum) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            GetActiveDiscRecorder( 
            /* [out] */ IDiscRecorder **ppRecorder) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            SetActiveDiscRecorder( 
            /* [in] */ IDiscRecorder *pRecorder) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            ClearFormatContent( void) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            ProgressAdvise( 
            /* [in] */ IDiscMasterProgressEvents *pEvents,
            /* [retval][out] */ UINT_PTR *pvCookie) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            ProgressUnadvise( 
            /* [in] */ UINT_PTR vCookie) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            RecordDisc( 
            /* [in] */ boolean bSimulate,
            /* [in] */ boolean bEjectAfterBurn) = 0;
        
        virtual /* [helpstring] */ HRESULT STDMETHODCALLTYPE 
            Close( void) = 0;
        
    };
</pre><p class="caption">2. Interop Definition of IDiscMaster</p><pre>
   /// &lt;summary&gt;
   /// IDiscMaster interface
   /// &lt;/summary&gt;
   [ComImportAttribute()]
   [GuidAttribute("520CCA62-51A5-11D3-9144-00104BA11C5E")]
   [InterfaceTypeAttribute(ComInterfaceType.InterfaceIsIUnknown)]
   internal interface IDiscMaster
   {
      /// &lt;summary&gt;
      /// Opens an IMAPI object
      /// &lt;/summary&gt;
      void Open();

      /// &lt;summary&gt;
      /// Retrieves a format enumerator
      /// &lt;/summary&gt;
      void EnumDiscMasterFormats(
         out IEnumDiscMasterFormats ppEnum);

      /// &lt;summary&gt;
      /// Retrieves the currently selected recorder format
      /// &lt;/summary&gt;
      void GetActiveDiscMasterFormat(
         out Guid lpiid);

      /// &lt;summary&gt;
      /// Sets a new active recorder format
      /// &lt;/summary&gt;
      void SetActiveDiscMasterFormat(
         [In()]
         ref Guid riid,
         [MarshalAs(UnmanagedType.Interface)]
         out object ppUnk);

      /// &lt;summary&gt;
      /// Retrieves a recorder enumerator
      /// &lt;/summary&gt;
      void EnumDiscRecorders(
         out IEnumDiscRecorders ppEnum);

      /// &lt;summary&gt;
      /// Gets the active disc recorder
      /// &lt;/summary&gt;
      void GetActiveDiscRecorder(
         out IDiscRecorder ppRecorder);

      /// &lt;summary&gt;
      /// Sets the active disc recorder
      /// &lt;/summary&gt;
      void SetActiveDiscRecorder(
         IDiscRecorder pRecorder);

      /// &lt;summary&gt;
      /// Clears the contents of an unburnt image
      /// &lt;/summary&gt;
      void ClearFormatContent();

      /// &lt;summary&gt;
      /// Registers for progress notifications
      /// &lt;/summary&gt;
      void ProgressAdvise(
         IDiscMasterProgressEvents pEvents,
         out IntPtr pvCookie);

      /// &lt;summary&gt;
      /// Cancels progress notifications
      /// &lt;/summary&gt;
      void ProgressUnadvise(
         IntPtr vCookie);

      /// &lt;summary&gt;
      /// Burns the staged image to the active recorder
      /// &lt;/summary&gt;
      void RecordDisc(
         int bSimulate,
         int bEjectAfterBurn);

      /// &lt;summary&gt;
      /// Closes the interface
      /// &lt;/summary&gt;
      void Close();

   }
</pre><h2>About the IMAPI Wrapper</h2><p>
The wrapper is implemented in the library <span class="i">acclImapiWrapper.dll</span>.
This is signed with a strong key-name pair, so can be installed into the Global
Assembly Cache (GAC).  To use it, you can either register it into the GAC using
<span class="code">gacutil /if</span> or you can just copy it into the output
directory of the application.  Whichever of those options you choose, you will
need to be able to add the DLL to your project's references.
</p><p>
The following sections provide an overview of the IMAPI Wrapper, as well
as providing some related information you will want to know when using it.   
Further documentation of all of the classes and methods is available from the
downloads.
</p><ol><li><a href="#interface">Wrapper Interface</a></li><li><a href="#interop">Interop and Non-Deterministic Finalization</a></li><li><a href="#reuse">Reusable Internal Code</a></li></ol><a name="interface" /><h3>1. Wrapper Interface</h3><p>
The UML diagram below shows the objects exposed by the IMAPI Wrapper:
</p><img src="imapiwrapperuml.png" width="500" height="502" alt="IMAPI Wrapper UML Diagram" /><p class="caption">IMAPI Wrapper UML Diagram</p><p>
A brief high-level overview of the interfaces and their use is as follows:
</p><ul><li><strong><span class="code">DiscMaster</span></strong><p>
This is the main class of the library and the only one which is directly 
instantiable using <span class="code">new</span>.  All other objects are
obtained from this class.  DiscMaster provides four main services:
</p><ol><li>Ability to set the active disc mastering format to either Joliet (data)
or Redbook (audio) and obtain a <span class="code">JolietDiscMaster</span> or
<span class="code">RedbookDiscMaster</span> object which can be used to build up
the stash image to burn to the disc.
</li><li>Get the list of recorders attached to the system using the 
<span class="code">DiscRecorders</span> collection.  This also allows the
active disc recorder to be set for a burn.
</li><li>Initiate a CD Burn using the <span class="code">RecordDisc</span> method, 
and provide progress information through a series of events whilst stashing and
disc burn is underway.</li><li>Access to the <span class="code">SimpleDiscRecorder</span>object.</li></ol></li><li><strong><span class="code">SimpleDiscRecorder</span></strong><p>
This class is Microsoft's high level wrapper around IMAPI which is used by
Explorer.  It offers a very simple service for creating data CDs: you
copy files to the staging folder and then call the <span class="code">Burn</span>
method, which brings up the standard Windows wizard for burning the disc.
For more details on using this interface, refer to the VB classic article
<a href="..\..\..\..\..\vb\code\libraries\writing_cds\simple_cd_burn\article.html">Simple Data CD Creation Using ICDBurn</a>.
</p></li><li><strong><span class="code">DiscRecorders</span></strong><p>
A standard managed-code collection of the recorders attached to the system.
</p></li><li><strong><span class="code">DiscRecorder</span></strong><p>
Represents a single recorder attached to the system.  This class provides
five main functions:
</p><ol><li>Obtaining identification information for the recorder, including the
recorder's <span class="code">DriveLetter</span>, <span class="code">Vendor</span>,
<span class="code">Product</span>, <span class="code">Revision</span> and 
<span class="code">RecorderType</span> (CDR or CDRW).</li><li>Getting information about the media contained within the disc using the
<span class="code">GetMediaDetails</span> function.  Note to obtain media
details you first need to open the recorder for exclusive access using
<span class="code">OpenExclusive</span>.  You should close it again immediately
afterwards using <span class="code">Close</span>.</li><li>Erasing a CDRW disc using the <span class="code">EraseCDRW</span> method.</li><li>Ejecting the drive tray using <span class="code">Eject</span>.</li><li>Getting recorder properties, such as the drive speed, as a collection. This
is obtained from the <span class="code">Properties</span> accessor.</li></ol></li><li><strong><span class="code">RedbookDiscMaster</span></strong><p>
A class which allows an audio CD image to be staged.  Audio CDs store audio
in "blocks", which each represent 1/75s of audio (since audio
CDs are encoded in 16 bit stereo at 44.1kHz, a block is 2352 bytes). Any
audio track must be an exact multiple of this block size, and hence the
class operates in terms of blocks.
</p><p>
The main functions of the class are to provide information about the
used and total available space on the disc, to create audio tracks and
to add blocks of data to the track.  Tracks can either be created
using the <span class="code">AddAudioTrackFromStream</span> method, 
or, for more fine-grained control a track can be created using 
<span class="code">CreateAudioTrack</span> followed by multiple calls
to <span class="code">AddAudioTrackBlocks</span> method followed by
<span class="code">CloseAudioTrack</span>. 
</p><p>
Audio data is added as raw 16-bit stereo L-R pairs at 44.1kHz sampling
frequency.  If the data being added is not an even multiple of 2352 bytes,
the class will append trailing 0 bytes to the data to make it an even block.
</p></li><li><strong><span class="code">JolietDiscMaster</span></strong><p>
A class allowing a data CD image to be staged.  Data CDs are more 
sophisticated than audio CDs in that they can contain multiple sub-directories,
and therefore a more complex staging mechanism is needed.  Each directory
is represented as a <span class="code">JolietDiscMasterStorage</span> object,
which allows either files or sub <span class="code">JolietDiscMasterStorage</span>
objects to be associated with it.  Note that in this implementation, it is assumed that
the data to be written to the data CD exists in the form of a file elsewhere
on the file system.  It is possible to create CDs directly from streams which
don't have any underlying file with some modification to the code (perhaps
a callback to the application to request the stream).
</p><p>
To build up the image, get the root storage directory from the 
<span class="code">RootStorage</span> property.  Files and subdirectory storage
objects can then be aded to this.
</p><p>
Once the image has been built up, the <span class="code">AddData</span> 
transfers the information described in the RootStorage to the data CD image.
</p></li><li><strong><span class="code">JolietDiscMasterStorage</span></strong><p>
This class represents a single directory on a data CD. Files are added
to the directory using <span class="code">AddFile</span> and subdirectories
using <span class="code">CreateFolder</span>, which returns a new instance
of this class for the subdirectory.  When adding a file, you specify the
name of the source file on the file system as well as the name of the file
when it is written to CD.  Typically the name of the file on the CD will
be the filename portion of the source file.
</p><p>
Note that only the file name/folder name
information is actually added to the class when these methods are called;
the information is not read until the owning <span class="code">JolietDiscMaster</span>
object's <span class="code">AddData</span> method is called.
</p></li></ul><a name="interop" /><h3>2. Interop and Non-Deterministic Finalization</h3><p>
Since IMAPI is implemented as using COM, there is something of an impedance
mismatch when you come to use it from the .NET Framework.  Being a COM
library, IMAPI expects <span class="code">AddRef</span> and <span class="code">Release</span> to be called on all objects in pairs.  If <span class="code">Release</span> is 
not called on the <span class="code">DiscMaster</span> object, then any attempt to 
use it again will fail with IMAPI error code <span class="code">IMAPI_E_STASHINUSE</span>,
which has the error description "another application is already using the IMAPI stash 
file required to stage a disc image. Try again later."  Since the "other"
application was your own one, and is now dead, there is no way of recovering and the
error will persist until you restart the machine.
</p><p>
Whilst .NET provides the <span class="code">IDisposable</span> pattern to help 
dealing with this problem, there is still a problem.  If for any reason your application
hits an unhandled exception, <span class="code">Dispose</span> is not called, and
instead only the finalizer for the class gets called.  During class finalization, you
may only call code on unmanaged objects.  In my library, the <span class="code">DiscMaster</span> object is held in a managed object, and so you cannot call
any code on it during finalization.  This means that any application using the
library needs to take steps to ensure that <span class="code">Dispose</span> is 
always called on the disposable classes in the library (any use of
<span class="code">DiscMaster</span>, <span class="code">RedbookDiscMaster</span> or
<span class="code">JolietDiscMaster</span>).
</p><p>
There are two things you should do to prevent this sort of problem.  The first
is to use <span class="code">try...catch</span> blocks for calls to the IMAPI 
library methods, and secondly you should install a <span class="code">ThreadException</span>
handler for your application.  The thread exception handler is called whenever your
application hits an unhandled exception and therefore allows you call <span class="code">Dispose</span> on things which need it before the application dies:
</p><pre>
using System.Threading;

   public frmAudioCDCreator()
   {
        Application.ThreadException += new ThreadExceptionEventHandler(
           application_ThreadException);
   }

   private void application_ThreadException(
          object sender, 
          ThreadExceptionEventArgs e)
   {
       // (Normally you would not show the user the actual message)
       MessageBox.Show(this, String.Format(
          "An untrapped exception occurred: {0}.  The application will now close.", 
          e.Exception), Text, MessageBoxButtons.OK, MessageBoxIcon.Error);

       // Call the method which disposes resources:
       Close();
    }
</pre><a name="reuse" /><h3>3. Reusable Internal Code</h3><p>
The IMAPI wrapper library contains a few internal classes which should be reusable
if you're writing other code to interoperate with COM, such as OLE Structure Storage
applications.
</p><ul><li><span class="code">IStreamOnStream</span> - an adapter which allows a .NET
<span class="code">Stream</span> object to expose its methods through a COM 
<span class="code">IStream</span> interface.</li><li><span class="code">IStreamOnFileStream</span> - a specialisation of
<span class="code">IStreamOnStream</span> which works for .NET 
<span class="code">FileStream</span> objects.</li><li><span class="code">PropertyStorage</span> - a class which wraps
a COM <span class="code">IPropertyStorage</span> implementation.  Exposes
properties as <span class="code">Property</span> objects.</li></ul><li><span class="code">PinnedByteBuffer</span> - an array of bytes which is
pinned in memory and hence the address of the buffer is available for any
unmanaged calls which take a pointer to a buffer as an argument.  The current
implementation is non-threadsafe but it would be easy to convert to an 
immutable version by making the size of the buffer fixed at construction 
time.</li><p>
To use any of these objects, you will also need to extract the the relevant
interface definitions from <span class="code">IMAPIInterop</span>.
</p><h2>The Properties Sample</h2><p>
To demonstrate the library, the downloads include a simple sample for
enumerating the disc recorders on the system and showing all of the
properties for each recorder.  The code for performing this, in VB.NET,
is as follows:
</p><pre>
        tvwRecorders.Nodes.Clear()

        ' Get a new Disc Master instance
        Dim dm As DiscMaster = New DiscMaster()

        ' Obtain information about the simple disc recorder:
        Dim simpleRecorder As SimpleDiscRecorder = dm.SimpleDiscRecorder
        Dim simpleNode As TreeNode = tvwRecorders.Nodes.Add("Simple CD Burner")
        If (simpleRecorder.HasRecordableDrive()) Then

            simpleNode.Nodes.Add( _
                String.Format("Drive Letter: {0}", _
                simpleRecorder.GetRecorderDriveLetter()))
            simpleNode.Nodes.Add( _
                String.Format("Staging Area: {0}",_
                simpleRecorder.GetBurnStagingAreaFolder(Handle)))
        Else
            simpleNode.Nodes.Add("Not present")
        End If
        simpleNode.Expand()


        ' Add information about each recorder on the system:
        Dim recordersNode As TreeNode = tvwRecorders.Nodes.Add("Recorders")
        Dim recorderIndex As Integer = 0
        Dim recorder As DiscRecorder
        For Each recorder In dm.DiscRecorders

            Dim recorderNode As TreeNode = recordersNode.Nodes.Add( _
                String.Format("Recorder {0}", ++recorderIndex))

            ' Add identifying information about the recorder:
            recorderNode.Nodes.Add( _
               String.Format("Vendor: {0}", recorder.Vendor))
            recorderNode.Nodes.Add( _
               String.Format("Product: {0}", recorder.Product))
            recorderNode.Nodes.Add( _
               String.Format("Revision: {0}", recorder.Revision))
            recorderNode.Nodes.Add( _
               String.Format("OSPath: {0}", recorder.OsPath))
            recorderNode.Nodes.Add( _
               String.Format("DriveLetter: {0}", recorder.DriveLetter))

            ' Show media information:
            Dim mediaNode As TreeNode = recorderNode.Nodes.Add("Media")
            recorder.OpenExclusive()
            Dim media As MediaDetails = recorder.GetMediaDetails()
            If (media.MediaPresent) Then
                mediaNode.Nodes.Add( _
                    String.Format("Sessions: {0}", media.Sessions))
                mediaNode.Nodes.Add( _
                    String.Format("LastTrack: {0}", media.LastTrack))
                mediaNode.Nodes.Add( _
                    String.Format("StartAddress: {0}", media.StartAddress))
                mediaNode.Nodes.Add( _
                    String.Format("NextWritable: {0}", media.NextWritable))
                mediaNode.Nodes.Add( _
                    String.Format("FreeBlocks: {0}", media.FreeBlocks))
                mediaNode.Nodes.Add( _
                   String.Format("MediaType: {0}", media.MediaType))
                mediaNode.Nodes.Add( _
                   String.Format("Flags: {0}", media.MediaFlags))
            Else
                mediaNode.Nodes.Add("No media present")
            End If
            recorder.CloseExclusive()

            ' Show the properties
            Dim props As DiscRecorderProperties = recorder.Properties
            Dim propertyNode As TreeNode = recorderNode.Nodes.Add("Properties")
            ' Note property is a keyword in VB, so we need to escape it:
            Dim prop As [Property]
            For Each prop In props
                propertyNode.Nodes.Add(String.Format("[{0}] {1} = {2}", _
                    prop.Id, prop.Name, prop.Value))
            Next
            props.Dispose()
            recordersNode.ExpandAll()

        Next

       ' Important!  Make sure you do this:
       dm.Dispose()

</pre><h2>Conclusion</h2><p>
This article provides a wrapper around the Image Mastering API to allow it
to be used easily from VB or C# .NET managed applications.  The use of 
a wrapper isolates coders from the tricky parts of working with COM interfaces
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\vb\code\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Image Mastering API (IMAPI) Wrapper for .NET</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 28 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>