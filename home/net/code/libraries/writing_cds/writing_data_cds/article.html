<html lang="en" >
<head>
<title>vbAccelerator - Writing Data CDs</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
This article demonstrates how to use the IMAPI wrapper to burn data CDs (also known
as 'Joliet' format CDs).  Sample code is provided in both C# and VB.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" />
<link rel="contents" href="../index.asp" /><link rel="meta" type="application/rdf+xml" href="./article.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Writing Data CDs</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="data_cd_writer.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Data CD Writer</a> (138K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:15413</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=15413&type=article&title=writing_20data_20cds.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;C#</p><p class="nav">&#160;&#160;VB.NET</p><p class="nav">&#160;&#160;.NET</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 Jun 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\imapi\article.html">Image Mastering API (IMAPI) Wrapper for .NET</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Writing Data CDs</h1><img src="datacdcreator.png" width="500" height="308" alt="Simple Data CD Creator Application" /><p /><p>
This article demonstrates how to use the IMAPI wrapper to burn data CDs (also known
as "Joliet" format CDs).  Sample code is provided in both C# and VB.
</p><h2>Writing Data CDs</h2><p>
Before you begin, note that this sample uses the 
<a href="..\imapi\article.html">IMAPI Wrapper</a> for the CD burning functions. 
To run the sample, you will need to have <span class="i">acclImapiWrapper.DLL</span>
registered in the Global Assembly cache (GAC).  If you place the DLL next to
the executable in your Debug or Release directory then you will also be able to run
(but you may need to change the project references to run in VS.NET).
</p><p>
Recording a data CD using IMAPI involves performing the following steps:
</p><ol><li>Initialise the library by obtaining a <span class="code">DiscMaster</span> 
instance, setting the active mastering format to Joliet to obtain a 
<span class="code">JolietDiscMaster</span> instance to build up the staging
image that will be burnt to disc, and setting the active recorder.</li><li>Constructing a <span class="code">JolietDiscMasterStorage</span> hierarchy
to represent the files you want to burn to disc, and their filenames on disc.</li><li>Instructing <span class="code">JolietDiscMaster</span> to copy the files from
the <span class="code">JolietDiscMasterStorage</span> to the disc image, and then
burning the CD.</li></ol><p>
During the last step, the <span class="code">DiscMaster</span> will raise a number
of events describing progress as the disc is staged or burnt, and also allows the
burn to be cancelled.
</p><p>
I'll describe these steps briefly with VB.NET code examples.  The C# code is
very similar; refer to the downloads for details.
</p><h3>1. Initialising the Library</h3><p>
The only directly instantiable class in the IMAPI Wrapper is the 
<span class="code">DiscMaster</span> object, from which all other classes
can be obtained.  This can be declared <span class="code">WithEvents</span>
in VB because you'll want to catch the progress and cancel events.
Next, the recording mode is set by obtaining a <span class="code">JolietDiscMaster</span>
object.  A reference to the returned object is kept as this is needed to stage
the image (calling the <span class="code">JolietDiscMaster()</span> again will result
in a new instance being returned).  Having done that, the list of recorders is
populated into a ComboBox and the selected index set.
</p><pre>
    Private WithEvents discMaster As discMaster = Nothing
    Private jolietDiscMaster As JolietDiscMaster = Nothing


    Private Sub GetRecorders()
        Dim ex As Exception
        Try
            discMaster = New DiscMaster()
            jolietDiscMaster = discMaster.JolietDiscMaster()
            Dim recorder As DiscRecorder
            For Each recorder In discMaster.DiscRecorders
                cboRecorder.Items.Add( _
                 New ComboRecorderWrapper(recorder))
            Next

            If (cboRecorder.Items.Count &gt; 0) Then
                cboRecorder.SelectedIndex = 0
            End If
        Catch ex
            MessageBox.Show( _
                Me, String.Format("Unable to initialise the IMAPI library {0}", ex), _
                Text, MessageBoxButtons.OK, MessageBoxIcon.Stop)
            If Not (discMaster Is Nothing) Then
                discMaster.Dispose()
            End If
        End Try
    End Sub

    Private Sub cboRecorder_SelectedIndexChanged( _
            ByVal sender As Object, _
            ByVal e As System.EventArgs _
        ) Handles cboRecorder.SelectedIndexChanged
        If (cboRecorder.SelectedIndex &gt; -1) Then
            Dim wrapper As ComboRecorderWrapper = cboRecorder.SelectedItem
            discMaster.DiscRecorders.ActiveDiscRecorder = wrapper.DiscRecorder
        End If
    End Sub
</pre><p>
As noted in the <a href="..\..\..\..\..\..\article_asp\id=todo.html">IMAPI Wrapper</a> article, you
must ensure that the <span class="code">Dispose</span> method is called on
the <span class="code">DiscMaster</span> instance before ending your application.  
Failure to do this will result in any subsequent attempt to access the library
failing with a "Stash In Use" error.  To ensure this occurs, I've
included an Application ThreadException handler, which is called in the unfortunate
event of an untrapped exception in the code:
</p><pre>
    Public Sub New()

	' ... 

        'Add any initialization after the InitializeComponent() call
        AddHandler Application.ThreadException, 
            AddressOf application_ThreadException      

        Show()
        Refresh()

        GetRecorders()

    End Sub

    Private Sub application_ThreadException( _
        ByVal sender As Object, _
        ByVal e As ThreadExceptionEventArgs)
        MessageBox.Show(Me, _
           String.Format("An untrapped exception occurred: {0}.", _
             e.Exception), _
             Text, MessageBoxButtons.OK, MessageBoxIcon.Error)
        Close()
    End Sub

    Protected Overrides Sub OnClosing( _
        ByVal e As System.ComponentModel.CancelEventArgs)

        ' ....

        '// Clear up:
        MyBase.OnClosing(e)
        Cursor.Current = Cursors.WaitCursor
        sbrMain.Text = "Closing IMAPI interface..."
        jolietDiscMaster.Dispose()
        discMaster.Dispose()
        Cursor.Current = Cursors.Default

    End Sub
</pre><p>
In this sample I'm exposing the stack trace of the exception
directly; in a real application this would be bad practice and really
the exception should be logged and a more descriptive message shown.
</p><h3>2. Constructing a JolietDiscMasterStorage hierarchy</h3><p>
The <span class="code">JolietDiscMaster</span> instance exposes a
<span class="code">RootStorage</span> property, which returns a
<span class="code">JolietDiscMasterStorage</span> instance representing
the root directory of the CD.  You can add files and/or sub-directories to this
object; sub-directories are also represented as <span class="code">JolietDiscMasterStorage</span> objects.  When adding a file, you specify
the path of the file to copy from on disc and the name of the file in the
directory to write it out to.  Sub-directories just have a name.  For the
purposes of the sample, I just allow a directory to be added and optionally
recursed:
</p><pre>
    ''' &lt;summary&gt;
    ''' Adds a directory to the storage, optionally including
    ''' any subdirectories.
    ''' &lt;/summary&gt;
    ''' &lt;param name="path"&gt;Path to the directory to add&lt;/param&gt;
    ''' &lt;param name="recurse"&gt;&lt;c&gt;true&lt;/c&gt; to include subdirectories,
    ''' &lt;c&gt;false&lt;/c&gt; otherwise.&lt;/param&gt;
    Public Sub AddDirectory(ByVal path As String, ByVal recurse As Boolean)
        Dim storage As JolietDiscMasterStorage = jolietDiscMaster.RootStorage
        AddFilesToStorage(storage, path, recurse)
    End Sub

    Private Sub AddFilesToStorage( _
        ByVal storage As JolietDiscMasterStorage, _
        ByVal startPath As String, _
        ByVal recurse As Boolean)

        If (recurse) Then
            Dim dir As String
            For Each dir In Directory.GetDirectories(startPath)
                Dim subStorage As JolietDiscMasterStorage = _
                    storage.CreateSubFolder(Path.GetFileName(dir))
                AddFilesToStorage(subStorage, dir, recurse)            
            Next
        End If

        Dim file As String
        For Each file In Directory.GetFiles(startPath)
            storage.AddFile(file, Path.GetFileName(file))
        Next
    End Sub
</pre><h3>Burning the Disc</h3><p>
With that done, creating the disc is easy: firstly any existing content in
the image is cleared, then data is added using the <span class="code">AddData</span>
method of <span class="code">JolietDiscMaster</span> and finally the disc is 
recorded using the <span class="code">DiscMaster</span><span class="code">RecordDisc</span>
method:
</p><pre>
    ''' &lt;summary&gt;
    ''' Creates a data CD from the specified files
    ''' &lt;/summary&gt;
    ''' &lt;param name="simulate"&gt;Simulate CD burning&lt;/param&gt;
    ''' &lt;param name="ejectWhenComplete"&gt;&lt;c&gt;true&lt;/c&gt; to eject the CD
    ''' tray when the burn is complete, &lt;c&gt;false&lt;/c&gt; otherwise&lt;/param&gt;
    ''' &lt;param name="overwrite"&gt;&lt;c&gt;true&lt;/c&gt; to overwrite existing files
    ''' on CDRW media, &lt;c&gt;false&lt;/c&gt; otherwise&lt;/param&gt;
    Public Sub CreateCD( _
              ByVal simulate As Boolean, _
              ByVal ejectWhenComplete As Boolean, _
              ByVal overwrite As Boolean
        )

        '// Ensure we don't have anything in the stage
        discMaster.ClearFormatContent()

        '// Stage the content
        jolietDiscMaster.AddData(overwrite)

        '// burn the disc
        discMaster.RecordDisc(simulate, ejectWhenComplete)

        '// Easy!
    End Sub
</pre><p>
Whilst burning is in progress, there are six events to respond to:
</p><ol><li><span class="code">AddProgress</span> - raised as files are added
to the image.</li><li><span class="code">PreparingBurn</span> - raised once the image has
been created and the CD is about to burnt.</li><li><span class="code">BlockProgress</span> - raised as blocks are burnt to
disc (a block is 2048 bytes).</li><li><span class="code">ClosingDisc</span> - raised once the burn has
completed and the CD (or session) is about to be closed.</li><li><span class="code">Complete</span> - raised when the burn has
completed.</li><li><span class="code">QueryCancel</span> - raised whilst data is added
to the image or burning is in progress.  Setting the <span class="code">Cancel</span>
property of the event arguments will cancel the operation.</li></ol><p>
That is really all you need to do to create the disc; however, if you want
to be able to respond to cancellations, or to show progress you will need
to write your application so the burn runs on a background thread.  The
construction of the wrapper makes this very easy to do using <span class="code">BeginInvoke</span>.
</p><h2>Using BeginInvoke for a Smooth User Experience</h2><p>
Buring a CD is typically a long operation.  If you invoke a burn operation
on the user-interface thread, then the application will appear to be locked
up whilst the burn occurs.  Under XP and above, a feature was added which
allows the caption and border of the window to be unfrozen if XP detects that 
the application has been locked up for a significant length of time.  After
this point in .NET Framework applications, calls to update controls and so
forth no longer have any effect.
</p><p>
Therefore we want a way to invoke the CD burn on a background thread.  Since
the IMAPI wrapper makes a call to check whether the burn is cancelled at
frequent intervals, and this is done through an <span class="code">event</span>,
there is also a safe way to cancel a burn operation at any time.
</p><p>
Any method in a class can be invoked asynchronously in .NET by creating
a <span class="code">delegate</span> for it.  Once you have done this, the
compiler is responsible for automatically creating three methods for
the delegate:
</p><ol><li>The <span class="code">Invoke</span> method, which has the same parameters and return value as the delegate and allows the method to be called synchronously.</li><li>The <span class="code">BeginInvoke</span> method, which is the same as <span class="code">Invoke</span> except it adds two more parameters: an <span class="code">AsyncCallback</span> delegate and an object to hold state.</li><li>The <span class="code">EndInvoke</span> method, which the same return value as the delegate, any <span class="code">ref</span> or <span class="code">out</span> parameters and an extra parameter holding an <span class="code">IAsyncResult</span> object.</li></ol><p>
This makes asynchronous invocation easy.  There are four coding steps:
</p><ol><li>Declare a delegate for the method you want to call asynchronously.</li><li>Write a completion event handler for the method you want to call, which will
be called when the method completes.</li><li>Create an <span class="code">AsyncCallback</span> handler and connect it
to your completion event handler.</li><li>Invoke the delegate's method asynchronously using <span class="code">BeginInvoke</span>.
</li></ol><p>
Here's the code for doing this in VB and C#.  Unsurprisingly the code is very
similar; the only real difference being VB's odd use of 
<span class="code">AddressOf</span> to refer to delegates.
In this case the method I want to
call is the <span class="code">CreateCD</span> method implemented in my 
<span class="code">DataCDCreator</span> class.  This method takes three boolean parameters (for
simulate burn, eject when complete and overwrite) and has no return value:
</p><p class="caption">VB Code for Asynchronous Invocation</p><pre>
''' &lt;summary&gt;
''' Delegate representing the CreateCD method
''' &lt;/summary&gt;
Public Delegate Sub CreateCDDelegate( _
    ByVal simulate As Boolean, _
    ByVal ejectWhenComplete As Boolean, _
    ByVal overwrite As Boolean)
</pre><pre>
    Private creator As DataCDCreator = Nothing
    Private createCDHandler As CreateCDDelegate = Nothing

        ' Asynchronously invoke the creator
        creator = New DataCDCreator(discMaster, jolietDiscMaster)
        creator.AddDirectory(txtFolder.Text, True)

        createCDHandler = AddressOf creator.CreateCD
        Dim callback As AsyncCallback = AddressOf createCD_Complete
        Dim ar As IAsyncResult = createCDHandler.BeginInvoke( _
            simulate, ejectWhenComplete, overwrite, callback, Nothing)


    ''' &lt;summary&gt;
    ''' Called when CD creation completes
    ''' &lt;/summary&gt;
    ''' &lt;param name="ar"&gt;Result of method call (none)&lt;/param&gt;
    Private Sub createCD_Complete(ByVal ar As IAsyncResult)
        ' NB should surround with try - catch - end try
        SetApplicationMode(False)
        createCDHandler.EndInvoke(ar)
    End Sub
</pre><p class="caption">C# Code for Asynchronous Invocation</p><pre>
   /// &lt;summary&gt;
   /// Delegate representing the CreateCD method
   /// &lt;/summary&gt;
   public delegate void CreateCDDelegate(
       bool simulate, 
       bool ejectWhenComplete, 
       bool overwrite);
</pre><pre>
      private DataCDCreator creator = null;
      private CreateCDDelegate createCDHandler = null;


        // Asynchronously invoke the creator
        creator = new DataCDCreator(discMaster, jolietDiscMaster);
        creator.AddDirectory(txtFolder.Text, true);
               
        createCDHandler = new CreateCDDelegate(creator.CreateCD);
        AsyncCallback callback = new AsyncCallback(createCD_Complete);
        IAsyncResult ar = createCDHandler.BeginInvoke(
            simulate, ejectWhenComplete, overwrite, callback, null);


      /// &lt;summary&gt;
      /// Called when CD creation completes
      /// &lt;/summary&gt;
      /// &lt;param name="ar"&gt;Result of method call (none)&lt;/param&gt;
      private void createCD_Complete(IAsyncResult ar)
      {
         // NB should surround with try-catch
         SetApplicationMode(false);
         createCDHandler.EndInvoke(ar);
      }
</pre><h2>More Ideas</h2><p>
The sample application here is rather trivial, in that all it allows you
to do is to copy an existing directory to the CD.  However, that's not
an actual limitation, since when you create the storage you can specify that
any file is mapped to a different path and or file on the destination CD.
A more complete application would allow you to drag files from any location
to the CD, and rename them if possible.
</p><p>
You could use this code to create an almost unattended CD writer (the only
thing you need to do is to ensure suitable media is available in the drive)
rather than having a UI.
</p><h2>Conclusion</h2><p>
This article demonstrates how to create Data CDs from VB or C# using
the IMAPI Wrapper.  Although the sample has a simple UI it performs all
of the major operations you'll need to perform and should be easy to 
extend.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\vb\code\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">NET</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Writing Data CDs</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 28 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>