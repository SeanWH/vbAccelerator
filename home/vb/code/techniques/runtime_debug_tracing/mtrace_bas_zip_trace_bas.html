<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: Trace.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: Trace.bas" /><link rel="stylesheet" href="..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.html">Techniques</a>&#160;.&#160;<a href="article.asp\index.html">RunTime Debug Tracing</a>&#160;.&#160;<a href="mtrace_bas.html">mTrace.bas</a>&#160;.&#160;Trace.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="mtrace_bas.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />mTrace.bas</a> (1K)</p><p /><p class="nav"><a href="trace_sample_application.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Trace Sample Application</a> (14K)</p><p /><p class="nav"><a href="vb5_tracer_utility.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Tracer Utility</a> (92K)</p><p /><p class="nav"><a href="vb6_tracer_utility.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Tracer Utility</a> (84K)</p><br /><br /><img src="..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:3564</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\linkto_asp\id=3564&type=zip&title=mtrace_2ebas_2ezip_5ftrace.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 1 / 1</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 0 / 0</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:19 March 2003</p>
<br /><br /><img src="..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\res\update.png" width="8" height="8" alt="Update" />3 Feb 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\stringbuilder\article.html">StringBuilder Class for VB</a></p><br /><br /><img src="..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: Trace.bas</h1><pre>Attribute VB_Name = "mTrace"
Option Explicit

Private Declare Function GetProp Lib "user32" Alias "GetPropA" (ByVal hwnd As
 Long, ByVal lpString As String) As Long
Private Declare Function EnumWindows Lib "user32" (ByVal lpEnumFunc As Long,
 ByVal lParam As Long) As Long
Private Declare Function SendMessageTimeout Lib "user32" Alias
 "SendMessageTimeoutA" (ByVal hwnd As Long, ByVal msg As Long, ByVal wParam As
 Long, lParam As Any, ByVal fuFlags As Long, ByVal uTimeout As Long, lpdwResult
 As Long) As Long
Private Const SMTO_NORMAL = &amp;H0
Public Const WM_COPYDATA = &amp;H4A
Public Type COPYDATASTRUCT
   dwData As Long
   cbData As Long
   lpData As Long
End Type
Private Const THISAPPID = "vbAcceleratorVBTRACER"


Private m_hWnd As Long
Private m_bInitialised As Boolean

#If TRACEMODE = 1 Then
Public Sub Trace(ParamArray args() As Variant)
   If (DoTrace) Then
      Dim sPrint As String
      SendTraceMessage args()
   End If
End Sub

Public Sub Assert(ByVal condition As Boolean, ParamArray args() As Variant)
   If Not (m_hWnd = 0) Then
      Debug.Assert condition
      SendTraceMessage args(), "Assert Failed"
   End If
End Sub

Private Function DoTrace() As Boolean
   If Not (m_bInitialised) Then
      FindTraceWindow
      m_bInitialised = True
   End If
   DoTrace = Not (m_hWnd = 0)
End Function

Private Function SendTraceMessage(ParamArray args() As Variant)
   
   On Error Resume Next
   Dim i As Long
   Dim j As Long
   Dim sPrint As String
   For i = LBound(args) To UBound(args)
      If ((VarType(args(i)) And vbArray) = vbArray) Then
         For j = LBound(args(i)) To UBound(args(i))
            sPrint = sPrint &amp; args(i)(j) &amp; vbTab
         Next j
      Else
         sPrint = sPrint &amp; args(i) &amp; vbTab
      End If
   Next i
   sPrint = App.EXEName &amp; ": " &amp; App.hInstance &amp; ": " &amp; App.ThreadID &amp; ": " &amp;
    Format$(Now, "yyyymmdd hhnnss") &amp; ": " &amp; sPrint

   Dim tCDS As COPYDATASTRUCT, b() As Byte, lR As Long
   b = StrConv(sPrint, vbFromUnicode)
   tCDS.dwData = 0
   tCDS.cbData = UBound(b) + 1
   tCDS.lpData = VarPtr(b(0))
            
   ' Give in if not response
   lR = SendMessageTimeout(m_hWnd, WM_COPYDATA, 0, tCDS, SMTO_NORMAL, 5000, lR)
   
   
End Function

Private Function FindTraceWindow() As Long
   ' Enumerate top-level windows:
   m_hWnd = 0
   EnumWindows AddressOf EnumWindowsProc, 0
End Function
Private Function EnumWindowsProc( _
        ByVal hwnd As Long, _
        ByVal lParam As Long _
    ) As Long
Dim bStop As Boolean
   ' Customised windows enumeration procedure.  Stops
   ' when it finds another application with the Window
   ' property set, or when all windows are exhausted.
   bStop = False
   If IsTraceWindow(hwnd) Then
      EnumWindowsProc = 0
      m_hWnd = hwnd
   Else
      EnumWindowsProc = 1
   End If
End Function

Private Function IsTraceWindow(ByVal hwnd As Long) As Boolean
   IsTraceWindow = (GetProp(hwnd, THISAPPID &amp; "_TRACEWIN") = 1)
End Function


#Else
Public Sub Trace(ParamArray args() As Variant)

End Sub
Public Sub Assert(ByVal condition As Boolean)

End Sub
#End If


</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.html">Techniques</a>&#160;.&#160;<a href="article.asp\index.html">RunTime Debug Tracing</a>&#160;.&#160;<a href="mtrace_bas.html">mTrace.bas</a>&#160;.&#160;Trace.bas</p><br /><p class="nav"><a href="..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>