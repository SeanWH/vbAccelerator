<html lang="en" >
<head>

<title>vbAccelerator - 256 Colour DIBSections </title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="The Image Processing using DIBSections sample provided on this site shows you how to implement 
a True-Colour DIBSection in VB. This is great for code which needs an effectively unlimited 
number of colours to perform effectively (such as blurring, sharpening, resampling 
and so on) but if you are interested in high-performance graphics effects it isn't the quickest way." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">DIB Sections</a>&#160;.&#160;256 Colour DIBSections </p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_256_colour_dibsection_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 256 Colour DIBSection Demonstration</a> (132K)</p><p /><p class="nav"><a href="vb6_256_colour_dibsection_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 256 Colour DIBSection Demonstration</a> (130K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:3015</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=3015&type=article&title=256_20colour_20dibsections_20.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />13 Jan 2003<br /><p class="update">Added a VB6 download.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\true_colour_dibsection\article.html">True Colour DIBSection</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\alpha_dibsection\article.html">Alpha DIBSections</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>256 Colour DIBSections </h1><p class="splash">The fastest way to animate all the pixels using GDI </p><img src="dibs256.gif" width="204" height="128" alt="Pixel Melt Demonstration" /><p /><p>The Image Processing using DIBSections sample provided on this site shows you how to implement 
a <a href="..\true_colour_dibsection\article.html">True-Colour DIBSection</a> in VB. This is great for code which needs an effectively unlimited 
number of colours to perform effectively (such as blurring, sharpening, resampling 
and so on) but if you are interested in high-performance graphics effects it isn't the quickest way.</p><p>True-colour images use 3 bytes for every pixel. To change the colours of 
a true-colour image requires you to modify every single byte in the image 
in turn. However, if you can manage using only 256 colours in your image then 
things can work much quicker. Firstly, there is only 1 byte per pixel in 
a 256 colour image, so to process through all the pixels there are 9x less 
bytes to consider. Secondly, the palette of a 256 colour image is implemented in 
a separate data structure. If you just want to modify the colours of the image, 
but not the pixels, you can modify the palette information directly - so you only 
have to access 256x3 bytes.</p><p>This means graphics code using 256 colour images can run considerably 
quicker than its true-colour counterpart. In this article I reimplement some of 
the colour algorithms using a 256 colour version of the DIB Section class. The 
performance increase is stunning - for example, to perform a fade on a 512x512 
image runs 20x quicker on my system, at a ridiculous 200 frames per second!</p><h2>In Practice</h2><p>First I should note that this sample, although it works on 256 colour images, 
has only been coded for systems with <i>more</i> than 256 colour displays. To get 
it to work on a 256 colour display means you have to implement palette handling, 
and Visual Basic makes palette modification incredibly difficult. I suppose 
VB's palette system is aimed at database programmers who want to show 256 
colour images on 256 colour displays, but that's it really. Anyone who 
has a nice routine for palette modification, please send it to me!</p><p>Creating a 256 colour DIBSection is very similar to creating a true 
colour one - see the article Using DIB Sections in VB for more information. 
The difference is that you need to implement a colour palette in the DIBSection 
itself and also when loading an Image up you need to copy this colour table across.</p><p>Here is the alternative version of the <i>BITMAPINFO</i> structure you use for a 256 colour DIBSection:</p><pre>
Private Type BITMAPINFO 
    bmiHeader As BITMAPINFOHEADER 
    bmiColors(0 to 255) As RGBQUAD 
End Type 
</pre><p>To copy the colour information across, you can take advantage of the 
<i>GetDIBColorTable</i> and <i>SetDIBColorTable</i> API calls to set the entire colour 
table in one call. Since Pictures in VB are stored as DIBs, you can call this 
method directly on any VB Picture object which is selected into a DC. Here is how a 
<i>StdPicture</i> object is copied across to a 256 colour DIBSection:</p><pre>
   ' Get the Desktop DC - this allows us to create a compatible device context
   ' to select the StdPicture's bitmap into:
   lhDCDesktop = CreateDCAsNull("DISPLAY", ByVal 0&amp;, ByVal 0&amp;, ByVal 0&amp;)
   If (lhDCDesktop &lt;&gt; 0) Then
      lHDC = CreateCompatibleDC(lhDCDesktop)
      DeleteDC lhDCDesktop

      ' If we get the compatible DC:
      If (lHDC &lt;&gt; 0) Then

         ' Select the bitmap into the compatible DC:
         lhBmpOld = SelectObject(lHDC, picThis.handle)

         ' Now get the StdPicture's DIB Color Table:
         lC = GetDIBColorTable(lHDC, 0, 256, tRGB(0))

         ' if this assert fails, the picture you're creating from
         ' is not 256 colours:
         Debug.Assert (lC = 256) 
         ' Here we copy the bits from the bitmap directly into the DIBSection memory:
         GetDIBits256 _
             lHDC, picThis.handle, 0, tBMP.bmHeight, _
             ByVal m_lPtr, m_tBI, DIB_RGB_COLORS

         ' Set the colour table to correct values:
         If (lC &gt; 0) Then
            SetDIBColorTable m_hDC, 0, 256, tRGB(0)
         End If

         ' clear up:
         SelectObject lHDC, lhBmpOld
         DeleteObject lHDC
      End If
   End If
</pre><p>The <i>GetDIBColorTable</i> and <i>SetDIBColorTable</i> calls make it easy to 
programmatically manipulate the colours in a DIB at very high speed. For example, here 
is loop which will cycle through all the colours in the palette of a 256 colour DIB:</p><pre>
Static tRGBSwap As RGBQUAD
Static tRGB(0 To 255) As RGBQUAD
Static i As Long
Static lC As Long
Static bGo As Boolean

   Do While bGo
      lC = GetDIBColorTable(hdc, 0, 256, tRGB(0))
      If lC = 256 Then
         LSet tRGBSwap = tRGB(0)
         For i = 1 To 255
            LSet tRGB(i - 1) = tRGB(i)
         Next i
         tRGB(255) = tRGBSwap
         SetDIBColorTable m_cDibIn.hdc, 0, 256, tRGB(0)
         m_cDibIn.PaintPicture Me.hdc, 96, 32
      End If
      DoEvents
   Loop 
</pre><p>The source code provided with this project provides the full implementation of the 
<i>cDibSection256</i> class, along with demonstrations of colour modification functions 
(fade, brighten, darken, invert, gray-scale and cycle) and pixel manipulation 
(the sample is called Pixel Melt and moves all pixels in the GIF in a random direction 
depending on its palette entry.)</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">DIB Sections</a>&#160;.&#160;256 Colour DIBSections </p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>
