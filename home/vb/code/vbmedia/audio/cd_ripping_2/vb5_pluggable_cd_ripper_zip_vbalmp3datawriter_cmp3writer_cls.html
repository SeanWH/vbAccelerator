<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3Writer.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3Writer.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" /><link rel="contents" href="./VB5_Pluggable_CD_Ripper.asp" /><link rel="meta" type="application/rdf+xml" href="./VB5 Pluggable CD Ripper.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">CD Ripping in VB Part 2</a>&#160;.&#160;<a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>&#160;.&#160;vbalMp3DataWriter_cMp3Writer.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_cd_ripper_plugin_interface.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 CD Ripper Plugin Interface</a> (9K)</p><p class="nav"><a href="vb5_pluggable_cd_ripper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Pluggable CD Ripper</a> (191K)</p><p /><p class="nav"><a href="vb6_cd_ripper_plugin_interface.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 CD Ripper Plugin Interface</a> (9K)</p><p class="nav"><a href="vb6_pluggable_cd_ripper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Pluggable CD Ripper</a> (192K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:15192</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=15192&type=zip&title=vb5_20pluggable_20cd_20ripper_2ezip_5fvbalmp3datawriter_5fcmp3writer.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 May 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\controls\s_grid_2\s_grid_2\article.html">SGrid 2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\controls\tab_controls\visual_studio_style_tab_control\article.html">vbAccelerator Visual Studio Style Tab Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\mp3_encoding_with_lame\article.html">MP3 Encoding with LAME</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\cd_ripping_1\article.html">CD Ripping in VB Part 1</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3Writer.cls</h1><p>This file is part of the download <a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>, which is described in the article <a href="article.html">CD Ripping in VB Part 2</a>.</p><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cMp3Writer"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit

' ------------------------------------------------------------
' Name:   cMp3Writer
' Author: Steve McMahon (steve@vbaccelerator.com)
' Date:   2004-05-06
' Description:
' Just a generic file writer for writing data from memory
' buffers in chunks.
'
' See http://vbaccelerator.com/
' ------------------------------------------------------------

Private Const GMEM_FIXED = &amp;H0
Private Const GMEM_ZEROINIT = &amp;H40
Private Const GPTR = (GMEM_FIXED Or GMEM_ZEROINIT)
Private Declare Function LocalAlloc Lib "kernel32" (ByVal wFlags As Long, ByVal
 wBytes As Long) As Long
Private Declare Function LocalLock Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Function LocalFree Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Function LocalUnlock Lib "kernel32" (ByVal hMem As Long) As Long

Private Declare Function CreateFile Lib "kernel32" Alias "CreateFileA" (ByVal
 lpFileName As String, ByVal dwDesiredAccess As Long, ByVal dwShareMode As
 Long, lpSecurityAttributes As Any, ByVal dwCreationDisposition As Long, ByVal
 dwFlagsAndAttributes As Long, ByVal hTemplateFile As Long) As Long
Private Declare Function ReadFile Lib "kernel32" (ByVal hFile As Long, lpBuffer
 As Any, ByVal nNumberOfBytesToRead As Long, lpNumberOfBytesRead As Long,
 lpOverlapped As Any) As Long
Private Declare Function WriteFile Lib "kernel32" (ByVal hFile As Long,
 lpBuffer As Any, ByVal nNumberOfBytesToWrite As Long, lpNumberOfBytesWritten
 As Long, lpOverlapped As Any) As Long
Private Declare Function SetFilePointer Lib "kernel32" (ByVal hFile As Long,
 ByVal lDistanceToMove As Long, lpDistanceToMoveHigh As Long, ByVal
 dwMoveMethod As Long) As Long
Private Declare Function CloseHandle Lib "kernel32" (ByVal hObject As Long) As
 Long
Private Const INVALID_HANDLE_VALUE = -1
Private Const CREATE_ALWAYS = 2
Private Const GENERIC_READ = &amp;H80000000
Private Const GENERIC_WRITE = &amp;H40000000
Private Const FILE_ATTRIBUTE_ARCHIVE = &amp;H20
Private Const FILE_ATTRIBUTE_COMPRESSED = &amp;H800
Private Const FILE_ATTRIBUTE_DIRECTORY = &amp;H10
Private Const FILE_ATTRIBUTE_HIDDEN = &amp;H2
Private Const FILE_ATTRIBUTE_NORMAL = &amp;H80
Private Const FILE_ATTRIBUTE_READONLY = &amp;H1
Private Const FILE_ATTRIBUTE_SYSTEM = &amp;H4
Private Const FILE_ATTRIBUTE_TEMPORARY = &amp;H100
Private Const FILE_BEGIN = 0

Private m_hMem As Long
Private m_ptrMem As Long
Private m_sFile As String
Private m_lBufferSize As Long
Private m_hFile As Long

Private Const cErrBase = 29870

Public Sub CloseFile()
   If Not (m_hFile = 0) Then
      CloseHandle m_hFile
      m_hFile = 0
   End If
End Sub
Private Function OpenFile(ByVal sFile As String) As Long
Dim hFile As Long
Dim lErr As Long

   hFile = CreateFile(sFile, _
                 GENERIC_READ Or GENERIC_WRITE, _
                  ByVal 0&amp;, _
                  ByVal 0&amp;, _
                  CREATE_ALWAYS, _
                  FILE_ATTRIBUTE_NORMAL, _
                  0)
   lErr = Err.LastDllError
   If (hFile = INVALID_HANDLE_VALUE) Then
      ' error
      errHandler "OpenFile", 2
   Else
      OpenFile = hFile
   End If
End Function

Public Property Let FileName(ByVal sFile As String)
   CloseFile
   m_sFile = sFile
   If (m_hMem = 0) Then
      If Not (AllocateBuffer(m_lBufferSize)) Then
         Exit Property
      End If
   End If
   m_hFile = OpenFile(sFile)
End Property
Public Property Get FileName() As String
   FileName = m_sFile
End Property
Public Property Get BufferSize() As Long
   BufferSize = m_lBufferSize
End Property
Public Property Let BufferSize(ByVal lSize As Long)
   freeBuffer
   If (AllocateBuffer(lSize)) Then
      m_lBufferSize = lSize
   Else
      m_lBufferSize = 0
   End If
End Property
Public Property Get BufferPointer() As Long
   BufferPointer = m_ptrMem
End Property
Public Function WriteBufferToFile(ByVal lSize As Long) As Long
Dim lR As Long
Dim lBytesWritten As Long
   
   ' Validation
   If (lSize &gt; m_lBufferSize) Then
      errHandler "WriteBufferToFile", 3
      Exit Function
   End If
   If (m_hFile = 0) Or (m_ptrMem = 0) Then
      errHandler "WriteBufferToFile", 4
      Exit Function
   End If
   
   ' Write
   lR = WriteFile( _
      m_hFile, ByVal m_ptrMem, _
      lSize, lBytesWritten, ByVal 0&amp;)
   
   ' Check what we wrote
   If (lR = 0) Or Not (lSize = lBytesWritten) Then
      errHandler "WriteBufferToFile", 5
   End If
   
   WriteBufferToFile = lBytesWritten
   
End Function

Private Function AllocateBuffer(ByVal lSize As Long) As Long
   m_hMem = LocalAlloc(GPTR, lSize)
   If (m_hMem = 0) Then
      errHandler "AllocateBuffer", 1
      Exit Function
   End If
   m_ptrMem = LocalLock(m_hMem)
   If (m_ptrMem = 0) Then
      freeBuffer
      errHandler "AllocateBuffer", 1
      Exit Function
   End If
   AllocateBuffer = True
End Function

Private Sub freeBuffer()
   If Not (m_ptrMem = 0) Then
      LocalUnlock m_hMem
      m_ptrMem = 0
   End If
   If Not (m_hMem = 0) Then
      LocalFree m_hMem
   End If
End Sub

Private Sub errHandler(ByVal sProc As String, ByVal lErr As Long)
Dim sMsg As String
   Select Case lErr
   Case 1
      sMsg = "Unable to allocate output buffer for writing"
   Case 2
      sMsg = "Unable to open file for writing"
   Case 3
      sMsg = "Cannot write more data than is available in the buffer"
   Case 4
      sMsg = "File not open for writing"
   Case 5
      sMsg = "Failed to write buffer to file"
   End Select
   Err.Raise cErrBase + lErr, App.EXEName &amp; "." &amp; sProc, sMsg
End Sub


Private Sub Class_Initialize()
   m_lBufferSize = 8192
End Sub

Private Sub Class_Terminate()
   On Error Resume Next ' don't throw in terminate
   freeBuffer
   CloseFile
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">CD Ripping in VB Part 2</a>&#160;.&#160;<a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>&#160;.&#160;vbalMp3DataWriter_cMp3Writer.cls</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 12 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>