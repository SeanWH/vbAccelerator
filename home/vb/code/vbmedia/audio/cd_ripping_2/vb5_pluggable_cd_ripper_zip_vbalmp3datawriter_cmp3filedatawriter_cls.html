<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3FileDataWriter.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3FileDataWriter.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" /><link rel="contents" href="./VB5_Pluggable_CD_Ripper.asp" /><link rel="meta" type="application/rdf+xml" href="./VB5 Pluggable CD Ripper.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">CD Ripping in VB Part 2</a>&#160;.&#160;<a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>&#160;.&#160;vbalMp3DataWriter_cMp3FileDataWriter.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_cd_ripper_plugin_interface.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 CD Ripper Plugin Interface</a> (9K)</p><p class="nav"><a href="vb5_pluggable_cd_ripper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Pluggable CD Ripper</a> (191K)</p><p /><p class="nav"><a href="vb6_cd_ripper_plugin_interface.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 CD Ripper Plugin Interface</a> (9K)</p><p class="nav"><a href="vb6_pluggable_cd_ripper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Pluggable CD Ripper</a> (192K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:15192</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=15192&type=zip&title=vb5_20pluggable_20cd_20ripper_2ezip_5fvbalmp3datawriter_5fcmp3filedatawriter.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 May 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\controls\s_grid_2\s_grid_2\article.html">SGrid 2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\controls\tab_controls\visual_studio_style_tab_control\article.html">vbAccelerator Visual Studio Style Tab Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\mp3_encoding_with_lame\article.html">MP3 Encoding with LAME</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\cd_ripping_1\article.html">CD Ripping in VB Part 1</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: vbalMp3DataWriter_cMp3FileDataWriter.cls</h1><p>This file is part of the download <a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>, which is described in the article <a href="article.html">CD Ripping in VB Part 2</a>.</p><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cMp3FileDataWriter"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit

' ------------------------------------------------------------
' Name:   cMP3FileDataWriter
' Author: Steve McMahon (steve@vbaccelerator.com)
' Date:   2004-05-06
' Description:
' Chunked data writer wrapper around cLameEncoder class.
' Deals with the case when the chunks have a different size
' (smaller/larger) than the chunk size that the LAME encoder
' expects.
'
' See http://vbaccelerator.com/
' ------------------------------------------------------------

Private Const GMEM_FIXED = &amp;H0
Private Const GMEM_ZEROINIT = &amp;H40
Private Const GPTR = (GMEM_FIXED Or GMEM_ZEROINIT)
Private Declare Function LocalAlloc Lib "kernel32" (ByVal wFlags As Long, ByVal
 wBytes As Long) As Long
Private Declare Function LocalLock Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Function LocalFree Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Function LocalUnlock Lib "kernel32" (ByVal hMem As Long) As Long

Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)

Implements IWaveDataWriter
Implements IPluginInformation

Private m_cLame As cLameEncoder
Private m_ptrOverflow As Long
Private m_hMemOverflow As Long
Private m_lOverflowSize As Long
Private m_lOverflowUsed As Long

Private m_sTitle As String
Private m_sArtist As String
Private m_sAlbum As String
Private m_sYear As String
Private m_sGenre As String
Private m_sComment As String
Private m_sTrack As String

Private Sub Class_Terminate()
   IWaveDataWriter_CloseFile
End Sub

Private Property Get IPluginInformation_Configuration() As
 vbalCDRipInterfaces.IPluginConfig
   Set IPluginInformation_Configuration = New cLameConfig
End Property

Private Property Get IPluginInformation_PluginAcknowledgements(ByVal locale As
 String) As String
Dim sAck As String
Dim c As New cLameEncoder
   sAck = "This plugin uses the LAME MP3 encoder from " &amp; c.Version.HomePage
   IPluginInformation_PluginAcknowledgements = sAck
End Property

Private Property Get IPluginInformation_PluginAuthor(ByVal locale As String) As
 String
   IPluginInformation_PluginAuthor = "Steve McMahon (steve@vbaccelerator.com)"
End Property

Private Property Get IPluginInformation_PluginDescription(ByVal locale As
 String) As String
Dim sDesc As String
Dim c As New cLameEncoder
   sDesc = "Writes VBR-encoded MP3 files using the LAME MP3 encoder."
   With c.Version
      sDesc = sDesc &amp; vbCrLf &amp; vbCrLf &amp; "   Using LAME encoder version: "
      sDesc = sDesc &amp; .MajorVersion &amp; "." &amp; .MinorVersion
      sDesc = sDesc &amp; vbCrLf &amp; "   Release Date: " &amp; format(.ReleaseDate,
       "short date")
      sDesc = sDesc &amp; vbCrLf &amp; "   Home page: " &amp; .HomePage
   End With
   IPluginInformation_PluginDescription = sDesc
End Property

Private Property Get IPluginInformation_PluginName(ByVal locale As String) As
 String
   IPluginInformation_PluginName = "MP3 Encoder"
End Property

Private Property Get IPluginInformation_PluginWebsite(ByVal locale As String)
 As String
   IPluginInformation_PluginWebsite = "http://vbaccelerator.com/"
End Property

Private Property Let IWaveDataWriter_Album(ByVal RHS As String)
   '
   m_sAlbum = RHS
   '
End Property

Private Property Let IWaveDataWriter_Artist(ByVal RHS As String)
   '
   m_sArtist = RHS
   '
End Property

Private Sub IWaveDataWriter_CloseFile()
   '
   If Not (m_cLame Is Nothing) And Not (m_ptrOverflow = 0) Then
   
      ' Flush anything left
      If (m_lOverflowUsed &gt; 0) Then
         m_cLame.WriteData m_ptrOverflow, m_lOverflowUsed
         m_lOverflowUsed = 0
      End If
      
      ' Flush the MP3
      m_cLame.CloseFile
      
      WriteTags m_cLame.FileName
   
   End If
   
   If Not (m_ptrOverflow = 0) Then
      LocalUnlock m_ptrOverflow
      m_ptrOverflow = 0
   End If
   If Not (m_hMemOverflow = 0) Then
      LocalFree m_hMemOverflow
      m_hMemOverflow = 0
   End If
   m_lOverflowUsed = 0
   m_lOverflowSize = 0
   '
End Sub

Private Property Let IWaveDataWriter_Comment(ByVal RHS As String)
   '
   m_sComment = RHS
   '
End Property

Private Property Get IWaveDataWriter_FileExtension() As String
   '
   IWaveDataWriter_FileExtension = "mp3"
   '
End Property

Private Property Let IWaveDataWriter_Genre(ByVal RHS As String)
   '
   m_sGenre = RHS
   '
End Property

Private Function IWaveDataWriter_OpenFile(ByVal sSoundFile As String) As Boolean
   '
   IWaveDataWriter_CloseFile
   
   Set m_cLame = New cLameEncoder
   m_cLame.EncodingPreset = LQP_STANDARD
   
   On Error Resume Next
   m_cLame.OpenFile sSoundFile
   Dim lErr As Long, sErr As String
   lErr = Err.Number
   sErr = Err.Description
   If (Err.Number = 0) Then
      On Error GoTo 0
      m_lOverflowSize = m_cLame.BufferSize
      m_hMemOverflow = LocalAlloc(GPTR, m_lOverflowSize)
      If Not (m_hMemOverflow = 0) Then
         m_ptrOverflow = LocalLock(m_hMemOverflow)
         If Not (m_ptrOverflow = 0) Then
            IWaveDataWriter_OpenFile = True
            Exit Function
         Else
            LocalFree m_hMemOverflow
            m_hMemOverflow = 0
         End If
      End If
      m_lOverflowSize = 0
      On Error GoTo 0
      m_cLame.errHandler "IWaveDataWriter_OpenFile", 7, False
   Else
      m_lOverflowSize = 0
      On Error GoTo 0
      Err.Raise lErr, "IWaveDataWriter_OpenFile", sErr
   End If
   '
End Function

Private Property Let IWaveDataWriter_Title(ByVal RHS As String)
   '
   m_sTitle = RHS
   '
End Property

Private Property Let IWaveDataWriter_TrackNumber(ByVal RHS As String)
   '
   m_sTrack = RHS
   '
End Property

Private Function IWaveDataWriter_WriteWavData(ByVal lPtrBuff As Long, ByVal
 lWriteSize As Long) As Long
   '
   If Not (m_cLame Is Nothing) And Not (m_ptrOverflow = 0) Then
      
      ' Append to overflow if we can:
      If (m_lOverflowUsed &gt; 0) Then
         If (lWriteSize + m_lOverflowUsed &gt; m_lOverflowSize) Then
         Dim ptrOffset As Long
            ptrOffset = UnsignedAdd(m_ptrOverflow, m_lOverflowUsed)
         Dim lAppendSize As Long
            lAppendSize = m_lOverflowSize - m_lOverflowUsed
            CopyMemory ByVal ptrOffset, ByVal lPtrBuff, lAppendSize
         
            ' Write overflow:
            m_cLame.WriteData m_ptrOverflow, m_lOverflowSize
            m_lOverflowUsed = 0
         
            ' Advance the pointer
            lPtrBuff = UnsignedAdd(lPtrBuff, lAppendSize)
            lWriteSize = lWriteSize - lAppendSize
         End If
      End If
            
      ' Write out any full chunks
      Do While (lWriteSize &gt; m_lOverflowSize)
         ' Write the data:
         m_cLame.WriteData lPtrBuff, m_lOverflowSize
         ' Advance the pointer:
         lPtrBuff = UnsignedAdd(lPtrBuff, m_lOverflowSize)
                  
         lWriteSize = lWriteSize - m_lOverflowSize
         
      Loop
      
      ' Append anything that's left over to the overflow buffer
      If (lWriteSize &gt; 0) Then
         CopyMemory ByVal m_ptrOverflow, ByVal lPtrBuff, lWriteSize
         m_lOverflowUsed = lWriteSize
      End If
   
   End If
   '
End Function

Private Function UnsignedAdd(Start As Long, Incr As Long) As Long
' This function is useful when doing pointer arithmetic,
' but note it only works for positive values of Incr

   If Start And &amp;H80000000 Then 'Start &lt; 0
      UnsignedAdd = Start + Incr
   ElseIf (Start Or &amp;H80000000) &lt; -Incr Then
      UnsignedAdd = Start + Incr
   Else
      UnsignedAdd = (Start + &amp;H80000000) + (Incr + &amp;H80000000)
   End If
   
End Function

Private Property Let IWaveDataWriter_Year(ByVal RHS As String)
   '
   m_sYear = RHS
   '
End Property


Private Sub WriteTags(ByVal sFile As String)
   
   Dim cID3v1 As New cMP3ID3v1
   cID3v1.MP3File = sFile
   cID3v1.Album = m_sAlbum
   cID3v1.Artist = m_sArtist
   cID3v1.Comment = m_sComment
   ' cID3v1.Genre TODO
   cID3v1.Title = m_sTitle
   cID3v1.Track = m_sTrack
   cID3v1.Year = m_sYear
   cID3v1.Update
   
   Dim cID3v2 As New cMP3ID3v2
   cID3v2.MP3File = sFile
   cID3v2.Album = m_sAlbum
   cID3v2.Artist = m_sArtist
   cID3v2.Comment = m_sComment
   cID3v2.EncodedBy = "vbAccelerator CD Ripper"
   cID3v2.Title = m_sTitle
   cID3v2.Track = m_sTrack
   cID3v2.Year = m_sYear
   
   cID3v2.Update
   
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">CD Ripping in VB Part 2</a>&#160;.&#160;<a href="vb5_pluggable_cd_ripper.html">VB5 Pluggable CD Ripper</a>&#160;.&#160;vbalMp3DataWriter_cMp3FileDataWriter.cls</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 12 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>