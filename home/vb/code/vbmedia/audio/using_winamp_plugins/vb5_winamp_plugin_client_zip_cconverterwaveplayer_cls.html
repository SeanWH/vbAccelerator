<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cConverterWavePlayer.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cConverterWavePlayer.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" /><link rel="contents" href="./VB5_Winamp_Plugin_Client.asp" /><link rel="meta" type="application/rdf+xml" href="./VB5 Winamp Plugin Client.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">Using WinAmp In Plugins From VB</a>&#160;.&#160;<a href="vb5_winamp_plugin_client.html">VB5 Winamp Plugin Client</a>&#160;.&#160;cConverterWavePlayer.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_winamp_plugin_client.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Winamp Plugin Client</a> (65K)</p><p /><p class="nav"><a href="vb6_winamp_plugin_client.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Winamp Plugin Client</a> (62K)</p><p /><p class="nav"><a href="winamp_plugin_wrapper.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Winamp Plugin Wrapper</a> (40K)</p><p class="nav"><a href="winamp_plugins.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Winamp Plugins</a> (344K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:15234</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=15234&type=zip&title=vb5_20winamp_20plugin_20client_2ezip_5fcconverterwaveplayer.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 May 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\resources\links\other\cdex\article.html">CDEx</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\streaming_wav_file_player\article.asp\index.html">Streaming .WAV File Player </a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cConverterWavePlayer.cls</h1><p>This file is part of the download <a href="vb5_winamp_plugin_client.html">VB5 Winamp Plugin Client</a>, which is described in the article <a href="article.html">Using WinAmp In Plugins From VB</a>.</p><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cConverterWavePlayer"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit


Private Const WM_DESTROY = &amp;H2&amp;

Private Const CALLBACK_WINDOW = &amp;H10000
Private Const WAVE_MAPPER = -1&amp;
Private Const MM_WOM_DONE = &amp;H3BD
Private Const MMSYSERR_NOERROR = 0
Private Const SEEK_CUR = 1
Private Const SEEK_END = 2
Private Const SEEK_SET = 0
Private Const TIME_BYTES = &amp;H4
Private Const WHDR_DONE = &amp;H1

' Wave formats:
Public Enum EWaveFormat
   WAVE_FORMAT_UNKNOWN = &amp;H0        ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_PCM = &amp;H1
   WAVE_FORMAT_ADPCM = &amp;H2          ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_IEEE_FLOAT = &amp;H3     ' /*  Microsoft Corporation  *' /
                                        ' /*  IEEE754: range (+1, -1]  *' /
                                        ' /*  32-bit' /64-bit format as defined
                                         by *' /
                                        ' /*  MSVC++ float' /double type *' /
   WAVE_FORMAT_IBM_CVSD = &amp;H5       ' /*  IBM Corporation  *' /
   WAVE_FORMAT_ALAW = &amp;H6           ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_MULAW = &amp;H7          ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_OKI_ADPCM = &amp;H10     ' /*  OKI  *' /
   WAVE_FORMAT_DVI_ADPCM = &amp;H11     ' /*  Intel Corporation  *' /
   WAVE_FORMAT_MEDIASPACE_ADPCM = &amp;H12      ' /*  Videologic  *' /
   WAVE_FORMAT_SIERRA_ADPCM = &amp;H13          ' /*  Sierra Semiconductor Corp  *'
    /
   WAVE_FORMAT_G723_ADPCM = &amp;H14    ' /*  Antex Electronics Corporation  *' /
   WAVE_FORMAT_DIGISTD = &amp;H15       ' /*  DSP Solutions, Inc.  *' /
   WAVE_FORMAT_DIGIFIX = &amp;H16       ' /*  DSP Solutions, Inc.  *' /
   WAVE_FORMAT_DIALOGIC_OKI_ADPCM = &amp;H17    ' /*  Dialogic Corporation  *' /
   WAVE_FORMAT_MEDIAVISION_ADPCM = &amp;H18     ' /*  Media Vision, Inc. *' /
   WAVE_FORMAT_YAMAHA_ADPCM = &amp;H20          ' /*  Yamaha Corporation of America
     *' /
   WAVE_FORMAT_SONARC = &amp;H21        ' /*  Speech Compression  *' /
   WAVE_FORMAT_DSPGROUP_TRUESPEECH = &amp;H22           ' /*  DSP Group, Inc  *' /
   WAVE_FORMAT_ECHOSC1 = &amp;H23       ' /*  Echo Speech Corporation  *' /
   WAVE_FORMAT_AUDIOFILE_AF36 = &amp;H24        ' /*    *' /
   WAVE_FORMAT_APTX = &amp;H25          ' /*  Audio Processing Technology  *' /
   WAVE_FORMAT_AUDIOFILE_AF10 = &amp;H26        ' /*    *' /
   WAVE_FORMAT_DOLBY_AC2 = &amp;H30     ' /*  Dolby Laboratories  *' /
   WAVE_FORMAT_GSM610 = &amp;H31        ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_MSNAUDIO = &amp;H32      ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_ANTEX_ADPCME = &amp;H33          ' /*  Antex Electronics Corporation
     *' /
   WAVE_FORMAT_CONTROL_RES_VQLPC = &amp;H34     ' /*  Control Resources Limited  *'
    /
   WAVE_FORMAT_DIGIREAL = &amp;H35      ' /*  DSP Solutions, Inc.  *' /
   WAVE_FORMAT_DIGIADPCM = &amp;H36     ' /*  DSP Solutions, Inc.  *' /
   WAVE_FORMAT_CONTROL_RES_CR10 = &amp;H37      ' /*  Control Resources Limited  *'
    /
   WAVE_FORMAT_NMS_VBXADPCM = &amp;H38          ' /*  Natural MicroSystems  *' /
   WAVE_FORMAT_CS_IMAADPCM = &amp;H39   ' /* Crystal Semiconductor IMA ADPCM *' /
   WAVE_FORMAT_ECHOSC3 = &amp;H3A       ' /* Echo Speech Corporation *' /
   WAVE_FORMAT_ROCKWELL_ADPCM = &amp;H3B        ' /* Rockwell International *' /
   WAVE_FORMAT_ROCKWELL_DIGITALK = &amp;H3C     ' /* Rockwell International *' /
   WAVE_FORMAT_XEBEC = &amp;H3D         ' /* Xebec Multimedia Solutions Limited *' /
   WAVE_FORMAT_G721_ADPCM = &amp;H40    ' /*  Antex Electronics Corporation  *' /
   WAVE_FORMAT_G728_CELP = &amp;H41     ' /*  Antex Electronics Corporation  *' /
   WAVE_FORMAT_MPEG = &amp;H50          ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_MPEGLAYER3 = &amp;H55    ' /*  ISO' /MPEG Layer3 Format Tag *' /
   WAVE_FORMAT_CIRRUS = &amp;H60        ' /*  Cirrus Logic  *' /
   WAVE_FORMAT_ESPCM = &amp;H61         ' /*  ESS Technology  *' /
   WAVE_FORMAT_VOXWARE = &amp;H62       ' /*  Voxware Inc  *' /
   WAVEFORMAT_CANOPUS_ATRAC = &amp;H63          ' /*  Canopus, co., Ltd.  *' /
   WAVE_FORMAT_G726_ADPCM = &amp;H64    ' /*  APICOM  *' /
   WAVE_FORMAT_G722_ADPCM = &amp;H65    ' /*  APICOM      *' /
   WAVE_FORMAT_DSAT = &amp;H66          ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_DSAT_DISPLAY = &amp;H67          ' /*  Microsoft Corporation  *' /
   WAVE_FORMAT_SOFTSOUND = &amp;H80     ' /*  Softsound, Ltd.      *' /
   WAVE_FORMAT_RHETOREX_ADPCM = &amp;H100       ' /*  Rhetorex Inc  *' /
   WAVE_FORMAT_CREATIVE_ADPCM = &amp;H200       ' /*  Creative Labs, Inc  *' /
   WAVE_FORMAT_CREATIVE_FASTSPEECH8 = &amp;H202         ' /*  Creative Labs, Inc 
    *' /
   WAVE_FORMAT_CREATIVE_FASTSPEECH10 = &amp;H203        ' /*  Creative Labs, Inc 
    *' /
   WAVE_FORMAT_QUARTERDECK = &amp;H220  ' /*  Quarterdeck Corporation  *' /
   WAVE_FORMAT_FM_TOWNS_SND = &amp;H300         ' /*  Fujitsu Corp.  *' /
   WAVE_FORMAT_BTV_DIGITAL = &amp;H400          ' /*  Brooktree Corporation  *' /
   WAVE_FORMAT_OLIGSM = &amp;H1000      ' /*  Ing C. Olivetti &amp; C., S.p.A.  *' /
   WAVE_FORMAT_OLIADPCM = &amp;H1001    ' /*  Ing C. Olivetti &amp; C., S.p.A.  *' /
   WAVE_FORMAT_OLICELP = &amp;H1002     ' /*  Ing C. Olivetti &amp; C., S.p.A.  *' /
   WAVE_FORMAT_OLISBC = &amp;H1003      ' /*  Ing C. Olivetti &amp; C., S.p.A.  *' /
   WAVE_FORMAT_OLIOPR = &amp;H1004      ' /*  Ing C. Olivetti &amp; C., S.p.A.  *' /
   WAVE_FORMAT_LH_CODEC = &amp;H1100    ' /*  Lernout &amp; Hauspie  *' /
   WAVE_FORMAT_NORRIS = &amp;H1400      ' /*  Norris Communications, Inc.  *' /

' /' /
' /' /  the WAVE_FORMAT_DEVELOPMENT format tag can be used during the
' /' /  development phase of a new wave format.  Before shipping, you MUST
' /' /  acquire an official format tag from Microsoft.
' /' /
   WAVE_FORMAT_DEVELOPMENT = &amp;HFFFF
End Enum

Private Type mmioinfo
   dwFlags As Long
   fccIOProc As Long
   pIOProc As Long
   wErrorRet As Long
   htask As Long
   cchBuffer As Long
   pchBuffer As String
   pchNext As String
   pchEndRead As String
   pchEndWrite As String
   lBufOffset As Long
   lDiskOffset As Long
   adwInfo(4) As Long
   dwReserved1 As Long
   dwReserved2 As Long
   hmmio As Long
End Type

Private Type WAVEHDR
   lpData As Long
   dwBufferLength As Long
   dwBytesRecorded As Long
   dwUser As Long
   dwFlags As Long
   dwLoops As Long
   lpNext As Long
   Reserved As Long
End Type

Private Type WAVEINCAPS
   wMid As Integer
   wPid As Integer
   vDriverVersion As Long
   szPname As String * 32
   dwFormats As Long
   wChannels As Integer
End Type

Private Type WAVEFORMATEX
   wFormatTag As Integer
   nChannels As Integer
   nSamplesPerSec As Long
   nAvgBytesPerSec As Long
   nBlockAlign As Integer
   wBitsPerSample As Integer
   cbSize As Integer
End Type

Private Type MMCKINFO
   ckid As Long
   ckSize As Long
   fccType As Long
   dwDataOffset As Long
   dwFlags As Long
End Type

Private Type MMTIME
   wType As Long
   u As Long
   x As Long
End Type

Private Declare Function waveOutGetPosition Lib "winmm.dll" (ByVal hWaveOut As
 Long, lpInfo As MMTIME, ByVal uSize As Long) As Long
Private Declare Function waveOutOpen Lib "winmm.dll" (hWaveOut As Long, ByVal
 uDeviceID As Long, ByVal format As String, ByVal dwCallback As Long, ByRef
 fPlaying As Boolean, ByVal dwFlags As Long) As Long
Private Declare Function waveOutPrepareHeader Lib "winmm.dll" (ByVal hWaveIn As
 Long, lpWaveInHdr As WAVEHDR, ByVal uSize As Long) As Long
Private Declare Function waveOutReset Lib "winmm.dll" (ByVal hWaveIn As Long)
 As Long
Private Declare Function waveOutUnprepareHeader Lib "winmm.dll" (ByVal hWaveIn
 As Long, lpWaveInHdr As WAVEHDR, ByVal uSize As Long) As Long
Private Declare Function waveOutClose Lib "winmm.dll" (ByVal hWaveIn As Long)
 As Long
Private Declare Function waveOutGetDevCaps Lib "winmm.dll" Alias
 "waveInGetDevCapsA" (ByVal uDeviceID As Long, lpCaps As WAVEINCAPS, ByVal
 uSize As Long) As Long
Private Declare Function waveOutGetNumDevs Lib "winmm.dll" () As Long
Private Declare Function waveOutGetErrorText Lib "winmm.dll" Alias
 "waveInGetErrorTextA" (ByVal err As Long, ByVal lpText As String, ByVal uSize
 As Long) As Long
Private Declare Function waveOutWrite Lib "winmm.dll" (ByVal hWaveOut As Long,
 lpWaveOutHdr As Any, ByVal uSize As Long) As Long
Private Declare Function waveOutPause Lib "winmm.dll" (ByVal hWaveOut As Long)
 As Long
Private Declare Function waveOutRestart Lib "winmm.dll" (ByVal hWaveOut As
 Long) As Long
Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" (dest As
 Any, src As Any, ByVal cb As Long)
Private Declare Sub CopyMemoryFromString Lib "kernel32" Alias "RtlMoveMemory"
 (dest As Any, ByVal source As String, ByVal cb As Long)
Private Declare Function PostWavMessage Lib "USER32" Alias "PostMessageA"
 (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByRef hdr As
 WAVEHDR) As Long
Private Declare Sub SleepApi Lib "kernel32" Alias "Sleep" (ByVal dwMilliseconds
 As Long)

Private Const GMEM_FIXED = &amp;H0
Private Const NUM_BUFFERS = 5

Implements ISubclass

Private Const cErrBase = 29670

Private m_hWnd As Long

Private m_bPlaying As Boolean

Private m_lPtrFormat As Long      ' pointer to wave format
Private m_tFormat As WAVEFORMATEX    ' waveformat structure

Private m_tHdr() As WAVEHDR    ' wave headers
Private m_lBufferSize As Long ' size of buffer

Private m_hWaveOut As Long        ' waveout handle

Private m_cConverter As cWinAmpAudioConverter

Public Event Progress(ByVal lTime As Long)
Public Event Complete()


Public Sub Attach(ByVal hWnd As Long)
   m_hWnd = hWnd
   AttachMessage Me, m_hWnd, MM_WOM_DONE
   AttachMessage Me, m_hWnd, WM_DESTROY
End Sub
Public Sub Detach()
   If m_hWnd Then
      DetachMessage Me, m_hWnd, MM_WOM_DONE
      DetachMessage Me, m_hWnd, WM_DESTROY
      m_hWnd = 0
   End If
End Sub

Private Sub pErrorHandler(ByVal lR As Long)
Dim sMsg As String
Dim iPos As Long
   sMsg = String$(260, 0)
   waveOutGetErrorText lR, sMsg, Len(sMsg)
   iPos = InStr(sMsg, vbNullChar)
   If Not iPos = 0 Then
      sMsg = Left$(sMsg, iPos - 1)
   End If
   err.Raise cErrBase + lR + 10, App.EXEName &amp; ".cWavePlayer", sMsg
End Sub

Private Sub pInternalErrorHandler(ByVal lR As Long)
Dim sMsg As String
   Select Case lR
   Case 1
      sMsg = "Class not ready; call attach method first."
   Case 2
      sMsg = "Unable to open file."
   Case 3
      sMsg = "Not a Wave file."
   Case 4
      sMsg = "Unable to retrieve format chunk"
   Case 5
      sMsg = "Error reading format"
   Case 6
      sMsg = "No Wave File Open"
   Case 7
      sMsg = "Insufficient memory"
   Case 8
      sMsg = "Position out of range"
   Case 9
      sMsg = "No wave file playing"
   Case 10
      sMsg = "Buffer time out of range, choose a number of second between 0.001
       and 10"
   End Select
   err.Raise cErrBase + lR, App.EXEName &amp; ".cWavePlayer", sMsg
End Sub

Public Function Play(cConverter As cWinAmpAudioConverter) As Boolean
Dim lR As Long
Dim sFormatBuffer As String
Dim iBuffer As Long

   Debug.Print "Play Called", m_hWaveOut
   If (m_bPlaying) Then
      StopPlay
   End If

   Set m_cConverter = cConverter

   If m_hWnd = 0 Then
      pInternalErrorHandler 1
      Exit Function
   End If
          
   ' Standard 16bit 44.1kHz stereo wav
   m_tFormat.nAvgBytesPerSec = 176400
   m_tFormat.nBlockAlign = 4
   m_tFormat.nChannels = 2
   m_tFormat.nSamplesPerSec = 44100
   m_tFormat.wBitsPerSample = 16
   m_tFormat.wFormatTag = WAVE_FORMAT_PCM
   
   m_lBufferSize = cConverter.ConvertChunk(1)
   cConverter.TrackSeek 0
       
   sFormatBuffer = String$(50, 0)
   CopyMemory ByVal sFormatBuffer, m_tFormat, LenB(m_tFormat)
   lR = waveOutOpen(m_hWaveOut, WAVE_MAPPER, sFormatBuffer, m_hWnd, True,
    CALLBACK_WINDOW)
    
   If Not (lR = MMSYSERR_NOERROR) Then
      pErrorHandler lR
      Play = False
      Exit Function
   End If

   ReDim m_tHdr(1 To cConverter.BufferCount) As WAVEHDR
   For iBuffer = 1 To cConverter.BufferCount
      With m_tHdr(iBuffer)
         .lpData = cConverter.ReadBufferPtr(iBuffer)
         .dwBufferLength = m_lBufferSize
         .dwUser = iBuffer
         .dwFlags = 0
         .dwLoops = 0
      End With
      lR = waveOutPrepareHeader(m_hWaveOut, m_tHdr(iBuffer),
       LenB(m_tHdr(iBuffer)))
      If Not (lR = MMSYSERR_NOERROR) Then
         pErrorHandler lR
      End If
   Next iBuffer

   m_bPlaying = True
   Play = True
    
   ' Start playing by posting callback functions to read into
   ' the buffers &amp; play:
   For iBuffer = 1 To cConverter.BufferCount
      PostWavMessage m_hWnd, MM_WOM_DONE, 0, m_tHdr(iBuffer)
   Next
    
End Function

Public Sub StopPlay()
   If m_bPlaying Then
      m_bPlaying = False
      waveOutReset m_hWaveOut
      Do While Not (m_hWaveOut = 0)
         DoEvents
         Debug.Print "Waiting for close"
      Loop
   End If
End Sub

Public Function FileSeek(ByVal Position As Long) As Boolean
   '
   m_cConverter.TrackSeek Position
   '
End Function

Public Sub Pause(ByVal bState As Boolean)
   If m_hWaveOut = 0 Then
      pInternalErrorHandler 9
   End If
   If bState Then
      waveOutPause m_hWaveOut
   Else
      waveOutRestart m_hWaveOut
   End If
End Sub

Public Property Get Position() As Long
   '
   Position = m_cConverter.TrackCurrentTime
   '
End Property

Public Property Get Playing() As Boolean
Dim tMMT As MMTIME
Dim lR As Long
    
   If Not (m_hWaveOut = 0) Then
      tMMT.wType = TIME_BYTES
      lR = waveOutGetPosition(m_hWaveOut, tMMT, LenB(tMMT))
      If (lR = MMSYSERR_NOERROR) Then
         Playing = True
      Else
         Playing = False
      End If
   End If
End Property



Private Sub Class_Terminate()
   
   ' Stop playing and clear up:
   StopPlay
   
   On Error Resume Next
   Detach
   
End Sub

Private Property Let ISubclass_MsgResponse(ByVal RHS As SSubTimer.EMsgResponse)
   '
End Property

Private Property Get ISubclass_MsgResponse() As SSubTimer.EMsgResponse
   ' Windows processes messages first:
   ISubclass_MsgResponse = emrPreprocess
End Property

Private Function ISubclass_WindowProc(ByVal hWnd As Long, ByVal iMsg As Long,
 ByVal wParam As Long, ByVal lParam As Long) As Long
Dim tWavHdr As WAVEHDR
Dim lR As Long
Dim lReadSize As Long
Dim bCalledRead As Boolean
Dim lWriteSize As Long
Dim iBuffer As Long
    
   Select Case iMsg
   Case MM_WOM_DONE
   
      ' Get the WAVEHDR structure for this call:
      CopyMemory tWavHdr, ByVal lParam, 24
      
      If (m_bPlaying) Then
         ' Get the data from the converter:
         lReadSize = m_cConverter.ConvertChunk(tWavHdr.dwUser)
         
         ' Write the amount of data we just read into the
         ' memory buffer to the output sound device output buffer.
         If (lReadSize &gt; 0) Then
            
            tWavHdr.dwBufferLength = lReadSize
            CopyMemory ByVal lParam, tWavHdr, 24
            
            lWriteSize = waveOutWrite(m_hWaveOut, ByVal lParam, LenB(tWavHdr))
            
            If (tWavHdr.dwUser = m_cConverter.BufferCount) Then
               RaiseEvent Progress(m_cConverter.TrackCurrentTime)
            End If
            
         End If
      End If


      ' Ensure we close all buffers
      If Not (m_bPlaying) Or (lReadSize = 0) Then
         waveOutUnprepareHeader m_hWaveOut, m_tHdr(tWavHdr.dwUser),
          LenB(m_tHdr(tWavHdr.dwUser))
         
         If (m_bPlaying And lReadSize = 0) Then
            RaiseEvent Complete
         End If
         
         ' Once we have finished with the buffer we can close the buffer:
         lR = waveOutClose(m_hWaveOut)
         If (lR = MMSYSERR_NOERROR) Then
            m_hWaveOut = 0
         End If
         
         m_bPlaying = False
      End If
      
   Case WM_DESTROY
      ' The app is closing but this class is still attached;
      ' we should try and clear up as a courtesy to the developer:
      On Error Resume Next
      StopPlay
      
      Detach
   End Select
   
End Function

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.html">vbMedia</a>&#160;.&#160;<a href="..\index.html">Audio</a>&#160;.&#160;<a href="article.html">Using WinAmp In Plugins From VB</a>&#160;.&#160;<a href="vb5_winamp_plugin_client.html">VB5 Winamp Plugin Client</a>&#160;.&#160;cConverterWavePlayer.cls</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 9 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>