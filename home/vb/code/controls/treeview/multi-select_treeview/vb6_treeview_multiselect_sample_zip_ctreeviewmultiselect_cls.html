<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cTreeViewMultiSelect.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cTreeViewMultiSelect.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">TreeView</a>&#160;.&#160;<a href="article.asp\index.html">Multiple Selections in a TreeView</a>&#160;.&#160;<a href="vb6_treeview_multiselect_sample.html">VB6 TreeView MultiSelect Sample</a>&#160;.&#160;cTreeViewMultiSelect.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_treeview_multiselect_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 TreeView MultiSelect Sample</a> (34K)</p><p /><p class="nav"><a href="vb6_treeview_multiselect_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 TreeView MultiSelect Sample</a> (32K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:14626</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=14626&type=zip&title=vb6_20treeview_20multiselect_20sample_2ezip_5fctreeviewmultiselect.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />10 Mar 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\treeview_control\article.html">vbAccelerator TreeView Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\resources\links\other\eclipse\article.html">Eclipse</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cTreeViewMultiSelect.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cTreeViewMultiSelect"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit

Private m_cNodeSelectionRoot As cTreeViewNode
Private m_colSelected As New Collection
Private m_lastSelectedItem  As cTreeViewNode
Private m_bSelectionChanged As Boolean
Private WithEvents m_tvw As vbalTreeView
Attribute m_tvw.VB_VarHelpID = -1

Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As
 Integer

Public Property Get SelectionCount() As Long
   SelectionCount = m_colSelected.count
End Property
Public Property Get SelectedNode(ByVal lIndex As Long) As cTreeViewNode
   Set SelectedNode = m_colSelected(lIndex)
End Property

Public Sub Attach(tvw As vbalTreeView)
   Set m_tvw = tvw
End Sub
Public Sub Detach()
   Set m_tvw = Nothing
   Set m_colSelected = Nothing
End Sub

Private Sub SelectBetween(tvw As vbalTreeView, node1 As cTreeViewNode, node2 As
 cTreeViewNode)
Dim bInSelection As Boolean
Dim bNoneFoundYet As Boolean
Dim nodStart As cTreeViewNode
Dim sKey1 As String
Dim sKey2 As String
   Set m_colSelected = New Collection
   Set nodStart = tvw.nodes(1)
   sKey1 = node1.Key
   sKey2 = node2.Key
   iterateSelectBetween nodStart, sKey1, sKey2, bInSelection, True
End Sub
Private Sub iterateSelectBetween(nodStart As cTreeViewNode, ByVal sKey1 As
 String, ByVal sKey2 As String, ByRef bInSelection As Boolean, ByRef
 bNoneFoundYet As Boolean)
   
   Do While Not (nodStart Is Nothing)
      If Not (bInSelection) Then
         If (bNoneFoundYet) Then
            If (nodStart.Key = sKey1) Then
               bInSelection = True
               bNoneFoundYet = False
            ElseIf (nodStart.Key = sKey2) Then
               Dim sKeySwap As String
               sKeySwap = sKey2
               sKey2 = sKey1
               sKey1 = sKeySwap
               bInSelection = True
               bNoneFoundYet = False
            End If
         End If
      End If
      NodeSelected(nodStart) = bInSelection
      If (bInSelection) Then
         If (nodStart.Key = sKey2) Then
            bInSelection = False
         End If
      End If
      If (nodStart.Expanded And nodStart.Children.count &gt; 0) Then
         iterateSelectBetween nodStart.Children(1), sKey1, sKey2, bInSelection,
          bNoneFoundYet
      End If
      Set nodStart = nodStart.NextSibling
   Loop
   
End Sub

Public Property Get NodeSelected(node As cTreeViewNode) As Boolean
Dim nodSel As cTreeViewNode
   On Error Resume Next
   Set nodSel = m_colSelected(node.Key)
   On Error GoTo 0
   If Not (nodSel Is Nothing) Then
      NodeSelected = (nodSel.BackColor = vbHighlight)
   End If
End Property
Public Property Let NodeSelected(node As cTreeViewNode, ByVal bState As Boolean)
Dim nodAlready As cTreeViewNode
   
   On Error Resume Next
   Set nodAlready = m_colSelected(node.Key)
   On Error GoTo 0
   
   If (bState) Then
      If (nodAlready Is Nothing) Then
         m_colSelected.Add node, node.Key
         node.BackColor = vbHighlight
         node.ForeColor = vbHighlightText
         node.MouseOverBackColor = vbHighlight
         node.MouseOverForeColor = vbHighlightText
         node.SelectedMouseOverBackColor = vbHighlight
         node.SelectedMouseOverForeColor = vbHighlightText
         node.SelectedBackColor = vbHighlight
         node.SelectedForeColor = vbHighlightText
         node.SelectedNoFocusBackColor = vbHighlight
         node.SelectedNoFocusForeColor = vbHighlightText
         node.Text = node.Text
      End If
   Else
      If Not (nodAlready Is Nothing) Then
         m_colSelected.Remove nodAlready.Key
         node.BackColor = vbWindowBackground
         node.ForeColor = vbWindowText
         node.MouseOverBackColor = vbWindowBackground
         node.MouseOverForeColor = vbWindowText
         node.SelectedMouseOverBackColor = vbWindowBackground
         node.SelectedMouseOverForeColor = vbWindowText
         node.SelectedBackColor = vbWindowBackground
         node.SelectedForeColor = vbWindowText
         node.SelectedNoFocusBackColor = vbWindowBackground
         node.SelectedNoFocusForeColor = vbWindowText
         node.Text = node.Text
      End If
   End If
End Property


Private Sub m_tvw_KeyDown(KeyCode As Integer, Shift As Integer)
   If (KeyCode = vbKeyReturn) Or (KeyCode = vbKeySpace) Then
      If Not (m_tvw.SelectedItem Is Nothing) Then
         m_tvw.SelectedItem.Expanded = Not (m_tvw.SelectedItem.Expanded)
      End If
      KeyCode = 0
   End If
   m_bSelectionChanged = False
End Sub

Private Sub m_tvw_MouseDown(Button As Integer, Shift As Integer, x As Single, y
 As Single)
   
   ' Note we only need to do this on MouseDown, since
   ' the TreeView uses the Control key to allow scrolling
   ' when the mouse is not clicked.
   If (Shift And vbCtrlMask) = vbCtrlMask Then
      If Not (m_bSelectionChanged) Then
         If Not (m_lastSelectedItem Is Nothing) Then
            NodeSelected(m_lastSelectedItem) = Not
             (NodeSelected(m_lastSelectedItem))
         End If
      End If
   End If
   m_bSelectionChanged = False
   
End Sub

Private Sub m_tvw_SelectedNodeChanged()
Dim nodSelected As cTreeViewNode
   
   '
   m_bSelectionChanged = True
   Set m_lastSelectedItem = m_tvw.SelectedItem
   
   If Not (GetAsyncKeyState(vbKeyControl) = 0) Then
      ' Invert selection state for this node:
      If Not (m_lastSelectedItem Is Nothing) Then
         NodeSelected(m_lastSelectedItem) = Not
          (NodeSelected(m_lastSelectedItem))
      End If
   ElseIf Not (GetAsyncKeyState(vbKeyShift) = 0) Then
      ' Ensure all items between m_cNodeSelectionRoot and m_lastSelectedItem
      ' are selected, and anything else is not selected.
      If Not (m_cNodeSelectionRoot Is Nothing) Then
         If Not (m_lastSelectedItem Is Nothing) Then
            SelectBetween m_tvw, m_cNodeSelectionRoot, m_lastSelectedItem
         End If
      End If
   Else
      ' Clear anything that's selected
      For Each nodSelected In m_colSelected
         NodeSelected(nodSelected) = False
      Next
      Set m_colSelected = New Collection
      Set m_cNodeSelectionRoot = m_lastSelectedItem
      ' Select this item if necessary
      If Not (m_cNodeSelectionRoot Is Nothing) Then
         NodeSelected(m_cNodeSelectionRoot) = True
      End If
   End If
   '

End Sub

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">TreeView</a>&#160;.&#160;<a href="article.asp\index.html">Multiple Selections in a TreeView</a>&#160;.&#160;<a href="vb6_treeview_multiselect_sample.html">VB6 TreeView MultiSelect Sample</a>&#160;.&#160;cTreeViewMultiSelect.cls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 18 April 2004</p></td><td></td></tr></table>
</body></html>