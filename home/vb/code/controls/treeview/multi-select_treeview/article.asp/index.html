<html lang="en" >
<head>

<title>vbAccelerator - Multiple Selections in a TreeView</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
This example provides a class which you can attach to the vbAccelerator TreeView control
to provide multiple selection support in a TreeView.  Although Windows TreeView controls don't
actually support multi-select, you can emulate it by using Owner-Drawing to set the colours
of the nodes.  This technique is similar to the one used in the 
Eclipse Java IDE.
" /><link rel="stylesheet" href="..\..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\..\index.html">TreeView</a>&#160;.&#160;Multiple Selections in a TreeView</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="..\vb5_treeview_multiselect_sample.html"><img src="..\..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 TreeView MultiSelect Sample</a> (34K)</p><p /><p class="nav"><a href="..\vb6_treeview_multiselect_sample.html"><img src="..\..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 TreeView MultiSelect Sample</a> (32K)</p><br /><br /><img src="..\..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:14443</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\..\linkto_asp\id=14443&type=article&title=multiple_20selections_20in_20a_20treeview.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />10 Mar 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\treeview_control\article.html">vbAccelerator TreeView Control</a></p><p class="nav"><img src="..\..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\..\resources\links\other\eclipse\article.html">Eclipse</a></p><br /><br /><img src="..\..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Multiple Selections in a TreeView</h1><img src="..\multiselect.png" width="348" height="384" alt="Multi-Select TreeView Demonstration" /><p /><p>
This example provides a class which you can attach to the vbAccelerator TreeView control
to provide multiple selection support in a TreeView.  Although Windows TreeView controls don't
actually support multi-select, you can emulate it by using Owner-Drawing to set the colours
of the nodes.  This technique is similar to the one used in the 
<a href="id=13691.html">Eclipse Java IDE</a>.
</p><h2>Emulating Multiple Selects</h2><p>
In an owner-draw TreeView, you can change the colours used to draw the node in any
state.  By setting the colours of selected nodes to the normal background and foreground
colours, the "real" selection in the TreeView is completely hidden.  With 
that in place, you can start setting individual node's background and foreground colours
so that the nodes appear to be selected.
</p><p>
Setting which nodes are then "selected" is simply a matter of setting the 
colours at the right time and responding to the selection modifier keys (shift and control)
correctly. 
</p><h2>A Class To Allow Multi-Selects</h2><p>
The TreeView control fires some of its notification events in an unexpected order.
For example, <span class="code">SelectedNodeChanged</span> fires before the
<span class="code">MouseDown</span> event.  This makes the code to implement multi-select
a little sensitive and hence a good candidate to wrap up in a class.
</p><p>
The first thing to sort out is setting the colours of a node so that it appears selected
or not.  The <span class="code">NodeSelected</span> property of the class is used for this:
</p><pre>
Public Property Let NodeSelected( _
      node As cTreeViewNode, _
      ByVal bState As Boolean _
   )
Dim nodAlready As cTreeViewNode
   
   On Error Resume Next
   Set nodAlready = m_colSelected(node.Key)
   On Error GoTo 0
   
   If (bState) Then
      If (nodAlready Is Nothing) Then
         m_colSelected.Add node, node.Key
         node.BackColor = vbHighlight
         node.ForeColor = vbHighlightText
         node.MouseOverBackColor = vbHighlight
         node.MouseOverForeColor = vbHighlightText
         node.SelectedMouseOverBackColor = vbHighlight
         node.SelectedMouseOverForeColor = vbHighlightText
         node.SelectedBackColor = vbHighlight
         node.SelectedForeColor = vbHighlightText
         node.SelectedNoFocusBackColor = vbHighlight
         node.SelectedNoFocusForeColor = vbHighlightText
         node.Text = node.Text
      End If
   Else
      If Not (nodAlready Is Nothing) Then
         m_colSelected.Remove nodAlready.Key
         node.BackColor = vbWindowBackground
         node.ForeColor = vbWindowText
         node.MouseOverBackColor = vbWindowBackground
         node.MouseOverForeColor = vbWindowText
         node.SelectedMouseOverBackColor = vbWindowBackground
         node.SelectedMouseOverForeColor = vbWindowText
         node.SelectedBackColor = vbWindowBackground
         node.SelectedForeColor = vbWindowText
         node.SelectedNoFocusBackColor = vbWindowBackground
         node.SelectedNoFocusForeColor = vbWindowText
         node.Text = node.Text
      End If
   End If
End Property
</pre><p>
In order to maintain the virtual selection state in an easily accessible way, 
a VB collection <span class="code">m_colSelected</span> is used to store the list
of selected nodes.  This is also used to determine whether there is any need to
change the colours of a node.
</p><p>
With that done, the logic to set the selections to the right state can be added.
It turns out there are only two events you need to respond to: 
<span class="code">SelectedNodeChanged</span> and <span class="code">MouseDown</span>.
The <span class="code">SelectedNodeChanged</span> does not provide information about
whether any of the shift modifier keys are pressed, so this needs to be discovered
using the <span class="code">GetAsyncKeyState</span> API.  Also, the code needs to 
keep track of two nodes in order to perform correctly:
</p><ol><li>The Last Selected Node, which is used to allow a node to be toggled selected/
unselected when an item is clicked and the control key is pressed.</li><li>The "Selection Root", which is used to store the first node in a
selection so that the correct items can be selected when the shift key is pressed.</li></ol><p>
The code to achieve that looks like this:
</p><pre>
Private m_cNodeSelectionRoot As cTreeViewNode
Private m_colSelected As New Collection
Private m_lastSelectedItem  As cTreeViewNode
Private m_bSelectionChanged As Boolean

Private WithEvents m_tvw As vbalTreeView

Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As Integer


Private Sub m_tvw_MouseDown( _
      Button As Integer, Shift As Integer, _
      x As Single, y As Single _ 
   )
   
   ' Note we only need to do this on MouseDown, since
   ' the TreeView uses the Control key to allow scrolling
   ' when the mouse is not clicked.
   If (Shift And vbCtrlMask) = vbCtrlMask Then
      If Not (m_bSelectionChanged) Then
         If Not (m_lastSelectedItem Is Nothing) Then
            NodeSelected(m_lastSelectedItem) = Not (NodeSelected(m_lastSelectedItem))
         End If
      End If
   End If
   m_bSelectionChanged = False
   
End Sub

Private Sub m_tvw_SelectedNodeChanged()
Dim nodSelected As cTreeViewNode
   
   '
   m_bSelectionChanged = True
   Set m_lastSelectedItem = m_tvw.SelectedItem
   
   If Not (GetAsyncKeyState(vbKeyControl) = 0) Then
      ' Invert selection state for this node:
      If Not (m_lastSelectedItem Is Nothing) Then
         NodeSelected(m_lastSelectedItem) = Not (NodeSelected(m_lastSelectedItem))
      End If
   ElseIf Not (GetAsyncKeyState(vbKeyShift) = 0) Then
      ' Ensure all items between m_cNodeSelectionRoot and m_lastSelectedItem
      ' are selected, and anything else is not selected.
      If Not (m_cNodeSelectionRoot Is Nothing) Then
         If Not (m_lastSelectedItem Is Nothing) Then
            SelectBetween m_tvw, m_cNodeSelectionRoot, m_lastSelectedItem
         End If
      End If
   Else
      ' Clear anything that's selected
      For Each nodSelected In m_colSelected
         NodeSelected(nodSelected) = False
      Next
      Set m_colSelected = New Collection
      Set m_cNodeSelectionRoot = m_lastSelectedItem
      ' Select this item if necessary
      If Not (m_cNodeSelectionRoot Is Nothing) Then
         NodeSelected(m_cNodeSelectionRoot) = True
      End If
   End If
   '

End Sub
</pre><p>
With that in place, all that's needed to complete the implementation is 
a way of selecting all the items in-betweeen two nodes.  As with most
things in a TreeView, this can be achieved using iteration:
</p><pre>
Private Sub SelectBetween( _
       tvw As vbalTreeView, _
       node1 As cTreeViewNode, _
       node2 As cTreeViewNode _
    )
Dim bInSelection As Boolean
Dim bNoneFoundYet As Boolean
Dim nodStart As cTreeViewNode
Dim sKey1 As String
Dim sKey2 As String
   Set m_colSelected = New Collection
   Set nodStart = tvw.nodes(1)
   sKey1 = node1.Key
   sKey2 = node2.Key
   iterateSelectBetween nodStart, sKey1, sKey2, bInSelection, True
End Sub

Private Sub iterateSelectBetween( _
       nodStart As cTreeViewNode, _
       ByVal sKey1 As String, ByVal sKey2 As String, _
       ByRef bInSelection As Boolean, _
       ByRef bNoneFoundYet As Boolean _
   )
   
   Do While Not (nodStart Is Nothing)
      If Not (bInSelection) Then
         If (bNoneFoundYet) Then
            If (nodStart.Key = sKey1) Then
               bInSelection = True
               bNoneFoundYet = False
            ElseIf (nodStart.Key = sKey2) Then
               Dim sKeySwap As String
               sKeySwap = sKey2
               sKey2 = sKey1
               sKey1 = sKeySwap
               bInSelection = True
               bNoneFoundYet = False
            End If
         End If
      End If
      NodeSelected(nodStart) = bInSelection
      If (bInSelection) Then
         If (nodStart.Key = sKey2) Then
            bInSelection = False
         End If
      End If
      If (nodStart.Expanded And nodStart.Children.count &gt; 0) Then
         iterateSelectBetween nodStart.Children(1), _
            sKey1, sKey2, bInSelection, bNoneFoundYet
      End If
      Set nodStart = nodStart.NextSibling
   Loop
   
End Sub
</pre><p>
This procedure is fairly simple, the only thing to note is that the start node
may be the first or the last in the selection, and so the code always iterates
from the top of the control down to the bottom, and once it detects either of the
two nodes which delimit the selection it then swaps them if necessary and only
continues iteration until the other node is found.
</p><h2>Using the Class</h2><p>
Since the class incorporates a <span class="code">WithEvents</span> instance of
the TreeView control there's very little you need to do to use it.  The only 
important thing is to make sure the <span class="code">NoCustomDraw</span> 
property of the control is set to <span class="code">False</span> before attempting
to use the class (it defaults to <span class="code">True</span>) otherwise the
class will have no visible effect.
</p><p>
The
following code snippet provides an example which shows the selected nodes
in the debug Window when you right click the TreeView:
</p><pre>
Private m_cTreeViewMultiSelect As cTreeViewMultiSelect

Private Sub Form_Load()
      
   Set m_cTreeViewMultiSelect = New cTreeViewMultiSelect
   m_cTreeViewMultiSelect.Attach tvwMultiSelect

End Sub

Private Sub tvwMultiSelect_NodeRightClick(node As cTreeViewNode)
   '
   If (m_cTreeViewMultiSelect.SelectionCount &gt; 0) Then
      Dim i As Long
      For i = 1 to m_cTreeViewMultiSelect.SelectionCount
         Debug.Print m_cTreeViewMultiSelect.SelectedNode(i).Text &amp; _
            " is selected."
      Next i
   End If
   '
End Sub
</pre><h2>Conclusion</h2><p>
This article demonstrates how to build a TreeView which allows multiple
selections.  Multiple selections in TreeViews are very helpful when you
want to provide as many options as possible in as small a screen space 
as possible; a great example of this use is in the Eclipse Java IDE
where you can use it to format, refactor or check-out multiple files from 
source control at the same time.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\..\index.html">TreeView</a>&#160;.&#160;Multiple Selections in a TreeView</p><br /><p class="nav"><a href="..\..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 March 2004</p></td><td></td></tr></table>
</body></html>