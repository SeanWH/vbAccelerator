<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: frmInternalDrag.frm</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: frmInternalDrag.frm" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">TreeView</a>&#160;.&#160;<a href="article.html">Drag Drop and the vbAccelerator TreeView Control</a>&#160;.&#160;<a href="vb5_treeview_drag_drop_samples.html">VB5 TreeView Drag Drop Samples</a>&#160;.&#160;frmInternalDrag.frm</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_treeview_drag_drop_samples.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 TreeView Drag Drop Samples</a> (71K)</p><p /><p class="nav"><a href="vb6_treeview_drag_drop_samples.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 TreeView Drag Drop Samples</a> (68K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:14636</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=14636&type=zip&title=vb5_20treeview_20drag_20drop_20samples_2ezip_5ffrminternaldrag.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />16 Apr 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\treeview_control\article.html">vbAccelerator TreeView Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: frmInternalDrag.frm</h1><pre>VERSION 5.00
Object = "{A3A35BDB-3B6A-46F3-B662-08B8F72ECD03}#11.1#0"; "vbalTreeView.ocx"
Begin VB.Form frmInternalDrag 
   Caption         =   "vbAccelerator TreeView: Dragging in one control"
   ClientHeight    =   8340
   ClientLeft      =   4410
   ClientTop       =   1815
   ClientWidth     =   6015
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmInternalDrag.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   8340
   ScaleWidth      =   6015
   Begin vbalTreeViewLib.vbalTreeView tvwDrag 
      Height          =   7635
      Left            =   60
      TabIndex        =   0
      Top             =   540
      Width           =   5835
      _ExtentX        =   10292
      _ExtentY        =   13467
      OLEDropMode     =   1
      DragAutoExpand  =   -1
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
   End
   Begin VB.Label lblInfo 
      Caption         =   $"frmInternalDrag.frx":45A2
      Height          =   435
      Left            =   60
      TabIndex        =   1
      Top             =   60
      Width           =   5865
   End
End
Attribute VB_Name = "frmInternalDrag"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Private m_cIml As New cVBALSysImageList
Private m_lID As Long
Private m_shl As New Shell

Private Function validateDragLocation(nodDrag As cTreeViewNode, nodInsert As
 cTreeViewNode) As Boolean
   ' only ok if nodDrag's path is not a wholly
   ' contained child of nodInsert
   Dim sPathDrag As String
   Dim sPathInsert As String
   Dim iPos As Long
   Dim bOk As Boolean
   
   sPathDrag = nodDrag.Key
   iPos = InStr(sPathDrag, ":")
   sPathDrag = Mid(sPathDrag, iPos + 1)
   sPathInsert = nodInsert.Key
   iPos = InStr(sPathInsert, ":")
   sPathInsert = Mid(sPathInsert, iPos + 1)
   
   bOk = Not (InStr(sPathInsert, sPathDrag) = 1)
   validateDragLocation = bOk

End Function

Private Sub Form_Load()
   ' Create a System Image List:
   Set m_cIml = New cVBALSysImageList
   m_cIml.IconSizeX = 16
   m_cIml.IconSizeY = 16
   m_cIml.Create
   tvwDrag.ImageList = m_cIml.hIml
   
   tvwDrag.DragStyle = etvwDropHighlight

   ' Enumerate the shell's desktop folder for files
   Dim drives As Folder
   Set drives = m_shl.NameSpace(ssfDRIVES)
   Dim driveItem As FolderItem
   Dim nod As cTreeViewNode
   Dim count As Long
   Dim sKey As String
   For Each driveItem In drives.items
      If (driveItem.IsFolder) And (driveItem.IsFileSystem) Then
         m_lID = m_lID + 1
         sKey = m_lID &amp; ":" &amp; driveItem.Path
         Set nod = tvwDrag.Nodes.Add(, , sKey, driveItem.Name, _
         m_cIml.ItemIndex(driveItem.Path, True))
         nod.ItemData = 0
         m_lID = m_lID + 1
         nod.Children.Add , , "TODO:" &amp; m_lID, "Unexpanded"
      End If
   Next

End Sub

Private Sub Form_Resize()
   '
   On Error Resume Next
   Dim lWidth As Long
   lWidth = Me.ScaleWidth - tvwDrag.left * 2
   lblInfo.Width = lWidth
   tvwDrag.Move tvwDrag.left, tvwDrag.tOp, lWidth, Me.ScaleHeight - tvwDrag.tOp
    - lblInfo.tOp
   '
End Sub

Private Sub tvwDrag_BeforeExpand(node As vbalTreeViewLib.cTreeViewNode, cancel
 As Boolean)
   '
   If InStr(node.FirstChild.Key, "TODO:") = 1 Then
      
      Screen.MousePointer = vbHourglass
      
      node.Children.Remove 1
      node.ChildSortMode = etvwAlphabetic

      Dim items As Folder
      Dim itm As FolderItem
      Dim nod As cTreeViewNode
      Dim sKey As String
      Dim iPos As Long
      sKey = node.Key
      iPos = InStr(sKey, ":")
      sKey = Mid(sKey, iPos + 1)
      Set items = m_shl.NameSpace(sKey)
      If Not items Is Nothing Then
         For Each itm In items.items
            If (itm.IsFolder) And (itm.IsFileSystem) Then
               m_lID = m_lID + 1
               sKey = m_lID &amp; ":" &amp; itm.Path
               Set nod = node.Children.Add(, , sKey, itm.Name, _
               m_cIml.ItemIndex(itm.Path, True))
               nod.ItemData = 0
               m_lID = m_lID + 1
               nod.Children.Add , , "TODO:" &amp; m_lID, "Unexpanded"
            End If
         Next
      End If
      Screen.MousePointer = vbDefault
      
   End If
   '
End Sub

Private Sub tvwDrag_DragDropRequest(Data As DataObject, nodeOver As
 vbalTreeViewLib.cTreeViewNode, ByVal bAbove As Boolean, ByVal hitTest As Long)
   '
   ' Check if we're attempting to make something a child of
   ' itself:
   Dim nodDrag As cTreeViewNode
   Dim nodParent As cTreeViewNode
   
   Set nodDrag = tvwDrag.NodeFromDragData(Data)
   If Not (nodDrag Is Nothing) Then ' not a treeview node
      If validateDragLocation(nodDrag, nodeOver) Then
         
         Dim sPathFrom As String
         Dim sPathTo As String
         Dim iPos As Long
         Dim sText As String
         Dim sNewKey As String
         Dim sOldKey As String
         Dim sOldPath As String
         
         sPathFrom = nodDrag.Key
         iPos = InStr(sPathFrom, ":")
         sPathFrom = Mid(sPathFrom, iPos + 1)
         sPathTo = nodeOver.Key
         iPos = InStr(sPathTo, ":")
         sPathTo = Mid(sPathTo, iPos + 1)
         If (Right(sPathTo, 1) &lt;&gt; "\") Then sPathTo = sPathTo &amp; "\"
         sPathTo = sPathTo &amp; nodDrag.Text
         Dim sQuestion As String
         sQuestion = "Are you sure you want to move the folder " &amp; vbCrLf _
            &amp; nodDrag.Text &amp; " (" &amp; sPathFrom &amp; ") " &amp; vbCrLf &amp; _
            " to " &amp; vbCrLf &amp; _
            nodeOver.Text &amp; " (" &amp; sPathTo &amp; ") ?" &amp; vbCrLf &amp; vbCrLf &amp; _
            "Note: In this demo, NO changes to your folders on disk will be
             made"
         
         If (vbYes = MsgBox(sQuestion, vbQuestion Or vbYesNo)) Then
                        
            sText = nodDrag.Text
            sOldKey = nodDrag.Key
            sOldPath = sOldKey
            iPos = InStr(sOldPath, ":")
            sOldPath = Mid(sOldPath, iPos + 1)
            
            ' Delete the source drag node:
            nodDrag.Delete
            
            m_lID = m_lID + 1
            sNewKey = m_lID &amp; ":" &amp; sPathTo
                                    
            ' Move nodDrag to the right location:
            
            ' Put it in the new place:
            nodeOver.Children.Add , , sOldKey, sText, _
               m_cIml.ItemIndex(sOldPath, True), m_cIml.ItemIndex(sOldPath,
                True)
               ' note we use the old key because we haven't
               ' actually physically moved the directory.
            
         End If
         
      End If
   End If
   
   '
End Sub

Private Sub tvwDrag_OLEDragOver(Data As DataObject, Effect As Long, Button As
 Integer, Shift As Integer, x As Single, y As Single, State As Integer)
   
   ' Check if we're attempting to make something a child of
   ' itself:
   Dim nodDrag As cTreeViewNode
   Dim bOk As Boolean
   
   bOk = False
   
   ' Get drag node:
   Set nodDrag = tvwDrag.NodeFromDragData(Data)
   If Not (nodDrag Is Nothing) Then ' It isn't a treeview node
   
      ' Get drag insert point
      Dim nodInsert As cTreeViewNode
      Set nodInsert = tvwDrag.DragInsertNode()
      If Not (nodInsert Is Nothing) Then ' there is no current insert point
      
         bOk = validateDragLocation(nodDrag, nodInsert)
         
      End If
      
   End If
   
   Effect = IIf(bOk, vbDropEffectMove, vbDropEffectNone)
   
End Sub

Private Sub tvwDrag_OLEStartDrag(Data As DataObject, AllowedEffects As Long)
   '
   ' Check if this is a root node:
   Dim nodDrag As cTreeViewNode
   Set nodDrag = tvwDrag.NodeFromDragData(Data)
   If (nodDrag.Parent Is Nothing) Then
      ' Cannot drag parent items
      AllowedEffects = vbDropEffectNone
   Else
      AllowedEffects = vbDropEffectMove
   End If
   '
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">TreeView</a>&#160;.&#160;<a href="article.html">Drag Drop and the vbAccelerator TreeView Control</a>&#160;.&#160;<a href="vb5_treeview_drag_drop_samples.html">VB5 TreeView Drag Drop Samples</a>&#160;.&#160;frmInternalDrag.frm</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 18 April 2004</p></td><td></td></tr></table>
</body></html>