<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mHooks.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mHooks.bas" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Command Bar</a>&#160;.&#160;<a href="article.html">vbAccelerator CommandBar Control</a>&#160;.&#160;<a href="vb6_commandbar_full_source.html">VB6 CommandBar Full Source</a>&#160;.&#160;mHooks.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_commandbar_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 CommandBar Binary</a> (144K)</p><p class="nav"><a href="vb5_commandbar_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 CommandBar Demonstration</a> (31K)</p><p class="nav"><a href="vb5_commandbar_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 CommandBar Full Source</a> (256K)</p><p /><p class="nav"><a href="vb6_commandbar_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 CommandBar Binary</a> (144K)</p><p class="nav"><a href="vb6_commandbar_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 CommandBar Demonstration</a> (30K)</p><p class="nav"><a href="vb6_commandbar_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 CommandBar Full Source</a> (255K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:13869</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=13869&type=zip&title=vb6_20commandbar_20full_20source_2ezip_5fmhooks.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 8 / 8</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 5 / 5</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:11 February 2004</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />25 Jan 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mHooks.bas</h1><pre>Attribute VB_Name = "mHooks"
Option Explicit

Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As
 Integer
Private Declare Function SetWindowsHookEx Lib "user32" Alias
 "SetWindowsHookExA" (ByVal idHook As Long, ByVal lpfn As Long, ByVal hmod As
 Long, ByVal dwThreadId As Long) As Long
Private Declare Function UnhookWindowsHookEx Lib "user32" (ByVal hHook As Long)
 As Long
Private Declare Function CallNextHookEx Lib "user32" (ByVal hHook As Long,
 ByVal nCode As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetCurrentThreadId Lib "kernel32" () As Long
Private Const WH_KEYBOARD As Long = 2
Private Const MSGF_MENU = 2
Private Const HC_ACTION = 0
Private Const WH_MOUSE As Long = 7
Private Const WM_MOUSEMOVE = &amp;H200
Private Const WM_NCMOUSEMOVE = &amp;HA0
Private Declare Function WindowFromPoint Lib "user32" (ByVal xPoint As Long,
 ByVal yPoint As Long) As Long
Private Const WM_LBUTTONDOWN = &amp;H201
Private Const WM_MBUTTONDOWN = &amp;H207
Private Const WM_RBUTTONDOWN = &amp;H204
Private Const WM_NCLBUTTONDOWN = &amp;HA1
Private Const WM_NCMBUTTONDOWN = &amp;HA7
Private Const WM_NCRBUTTONDOWN = &amp;HA4

Private m_iKeyHookCount As Long
Private m_lKeyHookhWnd() As Long
Private m_hKeyHook As Long

Private m_iMouseHookCount As Long
Private m_lMouseHookhWnd() As Long
Private m_hMouseHook As Long

Public Sub AttachMouseHook(ByVal hWnd As Long)
   
   Dim lpfn As Long
   If (m_iMouseHookCount = 0) Then
      lpfn = HookAddress(AddressOf MouseFilter)
      m_hMouseHook = SetWindowsHookEx(WH_MOUSE, lpfn, 0&amp;, GetCurrentThreadId())
      Debug.Assert (m_hMouseHook &lt;&gt; 0)
   End If
   
   Dim i As Long
   For i = 1 To m_iMouseHookCount
      If hWnd = m_lMouseHookhWnd(i) Then
         ' we already have it
         'Debug.Assert False
         Exit Sub
      End If
   Next i
   
   If Not (m_hMouseHook = 0) Then
      ReDim Preserve m_lMouseHookhWnd(1 To m_iMouseHookCount + 1) As Long
      m_iMouseHookCount = m_iMouseHookCount + 1
      m_lMouseHookhWnd(m_iMouseHookCount) = hWnd
   End If
   
End Sub

Public Sub DetachMouseHook(ByVal hWnd As Long)
Dim i As Long
Dim lPtr As Long
Dim iThis As Long
   
   For i = 1 To m_iMouseHookCount
      If m_lMouseHookhWnd(i) = hWnd Then
         iThis = i
         Exit For
      End If
   Next i
   
   If Not (iThis = 0) Then
      If m_iMouseHookCount &gt; 1 Then
         For i = iThis To m_iMouseHookCount - 1
            m_lMouseHookhWnd(i) = m_lMouseHookhWnd(i + 1)
         Next i
      End If
      m_iMouseHookCount = m_iMouseHookCount - 1
      If m_iMouseHookCount &gt;= 1 Then
         ReDim Preserve m_lMouseHookhWnd(1 To m_iMouseHookCount) As Long
      Else
         Erase m_lMouseHookhWnd
      End If
   Else
      ' hmmm
   End If
   
   If m_iMouseHookCount &lt;= 0 Then
      If Not (m_hMouseHook = 0) Then
         UnhookWindowsHookEx m_hMouseHook
         m_hMouseHook = 0
      End If
   End If

End Sub


Public Sub AttachKeyboardHook(ByVal hWnd As Long)
   
   Dim lpfn As Long
   If m_iKeyHookCount = 0 Then
      lpfn = HookAddress(AddressOf KeyboardFilter)
      m_hKeyHook = SetWindowsHookEx(WH_KEYBOARD, lpfn, 0&amp;, GetCurrentThreadId())
      Debug.Assert (m_hKeyHook &lt;&gt; 0)
   End If
   
   Dim i As Long
   For i = 1 To m_iKeyHookCount
      If hWnd = m_lKeyHookhWnd(i) Then
         ' we already have it:
         Debug.Assert False
         Exit Sub
      End If
   Next i
      
   If Not (m_hKeyHook = 0) Then
      ReDim Preserve m_lKeyHookhWnd(1 To m_iKeyHookCount + 1) As Long
      m_iKeyHookCount = m_iKeyHookCount + 1
      m_lKeyHookhWnd(m_iKeyHookCount) = hWnd
   End If
   
End Sub

Public Sub DetachKeyboardHook(ByVal hWnd As Long)
Dim i As Long
Dim lPtr As Long
Dim iThis As Long
   
   For i = 1 To m_iKeyHookCount
      If m_lKeyHookhWnd(i) = hWnd Then
         iThis = i
         Exit For
      End If
   Next i
   
   If Not (iThis = 0) Then
      If m_iKeyHookCount &gt; 1 Then
         For i = iThis To m_iKeyHookCount - 1
            m_lKeyHookhWnd(i) = m_lKeyHookhWnd(i + 1)
         Next i
      End If
      m_iKeyHookCount = m_iKeyHookCount - 1
      If m_iKeyHookCount &gt;= 1 Then
         ReDim Preserve m_lKeyHookhWnd(1 To m_iKeyHookCount) As Long
      Else
         Erase m_lKeyHookhWnd
      End If
   Else
      ' hmmm
   End If
   
   If m_iKeyHookCount &lt;= 0 Then
      If Not (m_hKeyHook = 0) Then
         UnhookWindowsHookEx m_hKeyHook
         m_hKeyHook = 0
      End If
   End If

End Sub

Private Function HookAddress(ByVal lPtr As Long) As Long
   HookAddress = lPtr
End Function

Private Function KeyboardFilter(ByVal nCode As Long, ByVal wParam As Long,
 ByVal lParam As Long) As Long
Dim bProcessed As Boolean
Dim bConsume As Boolean
Dim bKeyUp As Boolean
Dim bShift As Boolean
Dim bAlt As Boolean
Dim bCtrl As Boolean
Dim shiftState As Long
Dim ctl As vbalCommandBar
Dim hWndActiveMenu As Long
Dim lhWndActiveMenu As Long
Dim bGotToEnd As Boolean

On Error GoTo ErrorHandler

   If nCode = HC_ACTION And m_iKeyHookCount &gt; 0 Then
   
      bKeyUp = ((lParam And &amp;H80000000) = &amp;H80000000)
      bShift = (GetAsyncKeyState(vbKeyShift) &lt;&gt; 0)
      bAlt = (GetAsyncKeyState(vbKeyMenu) &lt;&gt; 0) Or (wParam = vbKeyMenu)
      bCtrl = (GetAsyncKeyState(vbKeyControl) &lt;&gt; 0)
      
      shiftState = Abs(bShift * vbShiftMask) Or Abs(bCtrl * vbCtrlMask) Or
       Abs(bAlt * vbAltMask)
      
      If (InMenuLoop) Then
         hWndActiveMenu = ActiveMenu
         If (bAlt And Not (bKeyUp)) Then
            bProcessed = True
            SetInMenuLoop False, 0
         Else
            If (ControlFromhWnd(hWndActiveMenu, ctl)) Then
               If Not (bKeyUp) Then
                  HighlightDisabledItems = True
                  ctl.fKeyDown wParam, shiftState
                  bConsume = True
                  bProcessed = True
               End If
            End If
         End If
      Else
         If (bAlt) Then
            If (bKeyUp) Then

               ' entering menu loop with no item showing:
               lhWndActiveMenu = FindActiveMenuControl()
               If Not (lhWndActiveMenu = 0) Then
                  If ControlFromhWnd(lhWndActiveMenu, ctl) Then
                     ActiveMenu = lhWndActiveMenu
                     If (wParam = vbKeyMenu) Then
                        ctl.fTrack 0, 1, , True
                     End If
                  End If
                  SetInMenuLoop True, lhWndActiveMenu
                  If Not (wParam = vbKeyMenu) Then
                     If Not (ctl Is Nothing) Then
                        ctl.fKeyDown wParam, shiftState
                     End If
                  End If
                  bConsume = True
                  bProcessed = True
               End If
            Else
               If Not (wParam = vbKeyMenu) Then
                  lhWndActiveMenu = FindActiveMenuControl()
                  If Not (lhWndActiveMenu = 0) Then
                     If ControlFromhWnd(lhWndActiveMenu, ctl) Then
                        ActiveMenu = lhWndActiveMenu
                        SetInMenuLoop True, lhWndActiveMenu
                        ctl.fKeyDown wParam, shiftState
                     End If
                  End If
               End If
            End If
         End If
      End If
   
      If Not (bProcessed) Then
         If Not (bKeyUp) Then
            bConsume = ProcessAccelerators(wParam, shiftState)
         End If
      End If
   
   End If


   bGotToEnd = True
   If (bConsume) Then
      KeyboardFilter = 1
   Else
      KeyboardFilter = CallNextHookEx(m_hKeyHook, nCode, wParam, lParam)
   End If
   Exit Function


ErrorHandler:
   Debug.Print "Keyboard Hook Error!", Err.Description, Err.Source
   If Not bGotToEnd Then
      On Error Resume Next
      KeyboardFilter = CallNextHookEx(m_hKeyHook, nCode, wParam, lParam)
   End If
   Exit Function
   
End Function

Private Function MouseFilter(ByVal nCode As Long, ByVal wParam As Long, ByVal
 lParam As Long) As Long
Dim bProcessed As Boolean

On Error GoTo ErrorHandler
   
   If (nCode = HC_ACTION) Then
      HighlightDisabledItems = False
      If (wParam = WM_LBUTTONDOWN) Or (wParam = WM_RBUTTONDOWN) Or (wParam =
       WM_MBUTTONDOWN) Or _
         (wParam = WM_NCLBUTTONDOWN) Or (wParam = WM_NCRBUTTONDOWN) Or (wParam
          = WM_NCMBUTTONDOWN) Then
         Dim tP As POINTAPI
         GetCursorPos tP
         Dim hWnd As Long
         hWnd = WindowFromPoint(tP.x, tP.y)
         If Not (hWnd = ActiveMenu) Then
            Dim ctl As vbalCommandBar
            On Error GoTo NoControl
            If (ControlFromhWnd(hWnd, ctl)) Then
               If (hWnd = menuInitiator) Then
                  ScreenToClient hWnd, tP
                  If (ctl.fHitTest(tP.x, tP.y) = 0) Then
                     SetInMenuLoop False, 0
                  End If
               ElseIf Not (ctl.fIsSetAsMenu) Then
                  SetInMenuLoop False, 0
               End If
            Else
NoControl:
               On Error GoTo ErrorHandler
               SetInMenuLoop False, 0
            End If
         End If
      End If
   End If
   
   bProcessed = True
   MouseFilter = CallNextHookEx(m_hMouseHook, nCode, wParam, lParam)
   Exit Function


ErrorHandler:
   Debug.Print "Mouse Hook Error!"
   If Not bProcessed Then
      On Error Resume Next
      MouseFilter = CallNextHookEx(m_hMouseHook, nCode, wParam, lParam)
   End If
   Exit Function
   
End Function

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Command Bar</a>&#160;.&#160;<a href="article.html">vbAccelerator CommandBar Control</a>&#160;.&#160;<a href="vb6_commandbar_full_source.html">VB6 CommandBar Full Source</a>&#160;.&#160;mHooks.bas</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 February 2004</p></td><td></td></tr></table>
</body></html>