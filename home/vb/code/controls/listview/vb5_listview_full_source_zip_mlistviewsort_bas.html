<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mListViewSort.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mListViewSort.bas" /><link rel="stylesheet" href="..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator ListView Control</a>&#160;.&#160;<a href="vb5_listview_full_source.html">VB5 ListView Full Source</a>&#160;.&#160;mListViewSort.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_listview_control.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ListView Control</a> (84K)</p><p class="nav"><a href="vb5_listview_demonstration.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ListView Demonstration</a> (200K)</p><p class="nav"><a href="vb5_listview_full_source.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ListView Full Source</a> (344K)</p><p /><p class="nav"><a href="vb6_listview_control.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ListView Control</a> (85K)</p><p class="nav"><a href="vb6_listview_demonstration.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ListView Demonstration</a> (196K)</p><p class="nav"><a href="vb6_listview_full_source.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ListView Full Source</a> (341K)</p><br /><br /><img src="..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:4133</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\linkto_asp\id=4133&type=zip&title=vb5_20listview_20full_20source_2ezip_5fmlistviewsort.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 8 / 16</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 8 / 11</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:8 February 2004</p>
<br /><br /><img src="..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\res\update.png" width="8" height="8" alt="Update" />20 Jun 2003<br /><p class="update">Bug fixes and minor enhancements to the control:</p><p class="update">The <span class="code">Selected</span> property of
a ListItem always returned false, meaning it was impossible to 
determine which items were selected in a multi-select ListView.
Corrected. Same problem with the <span class="code">ItemCut</span>
property.</p><p class="update"><span class="code">Icon</span> property of ListItem set
the icon of the next item along in the control.  Fixed.</p><p class="update"><span class="code">Position</span> property added to the 
ColumnHeader object to allow the order of the column headers to be read
and set programmatically.</p><p class="update">Insert before parameter to the <span class="code">Add</span> method
of the ListItems collection was ignored.  Corrected.</p><p class="update">Setting a column alignment to right caused the column to be
centred, and vice-versa. Fixed.</p><p class="update">Mouse Up events were only generated for double-clicks.  Now
corrected.</p><p class="update">A <span class="code">KeyDown</span> event was generated when
a <span class="code">KeyUp</span> should have been.  Fixed</p><p class="update">Option to place the background image at a specified location
rather than tile it added.</p><p class="update"><span class="code">NoColumnHeaders</span> property added to
allow column headers to be hidden in Detail view.</p><p class="update">Added a call to <span class="code">LoadLibrary</span> on 
Shell32.DLL to prevent crashes when using a manifest.</p><p class="update">Thanks to Ben Andersen, Ian Goodwin, Vasanth Raj, Greg Thomson,
Frank Peters for the bug reports and code.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\xp_visual_styles\making_vb_apply_visual_styles_at_design_and_debug_time\article.html">Making VB Apply XP Visual Styles at Design and Debug Time</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\xp_visual_styles\using_xp_visual_styles_in_vb\article.html">Adding XP Visual Styles to Your Visual Basic Application</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\type_libraries\ole_guid_and_interface_definitions\article.html">Ole Guid and interface definitions (OleGuids.Tlb) </a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\type_libraries\ishellfolder\article.html">IShellFolder Extended Type Library Version 1.2 (ISHF_Ex.Tlb)</a></p><br /><br /><img src="..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mListViewSort.bas</h1><pre>Attribute VB_Name = "mListViewSort"
Option Explicit

Private m_eSortType As ESortTypeConstants
Private m_eSortOrder As ESortOrderConstants
Private m_lColumn As Long
Private m_tLV As LVITEM


Public Sub SortInit( _
      ByVal eSortOrder As ESortOrderConstants, _
      ByVal ESortType As ESortTypeConstants, _
      ByVal lColumn As Long _
   )
   m_eSortType = ESortType
   m_eSortOrder = eSortOrder
   m_lColumn = lColumn
End Sub

Public Function LVWSortCompare( _
        ByVal lParam1 As Long, _
        ByVal lParam2 As Long, _
        ByVal hWnd As Long _
    ) As Long
Dim s1 As String, s2 As String
Dim v1 As Variant, v2 As Variant, vt As Variant
Dim cI As pcListItem
Dim lIndex As Long, lR As Long

   'Compare the items
   'Return -ve if lI1&lt;lI2,
   '       0 if lI1 = lI2
   '       +ve if lI1 &gt; lI2
   '
   On Error Resume Next
   Select Case m_eSortType
   Case eLVSortItemData
      ' The lParam directly points to our
      ' structure holding the data:
      v1 = 0: v2 = 0
      If Not (lParam1 = 0) Then
         Set cI = ObjectFromPtr(lParam1)
         v1 = cI.ItemData
      End If
      If Not (lParam2 = 0) Then
         Set cI = ObjectFromPtr(lParam2)
         v2 = cI.ItemData
      End If
      
   Case eLVSortTag
      ' The lParam directly points to our
      ' structure holding the data:
      v1 = "": v2 = ""
      If Not (lParam1 = 0) Then
         Set cI = ObjectFromPtr(lParam1)
         v1 = cI.Tag
      End If
      If Not (lParam2 = 0) Then
         Set cI = ObjectFromPtr(lParam2)
         v2 = cI.Tag
      End If
   
   Case eLVSortNumeric
      ' Get the number equivalent of the text
      ' in the relevant column:
      v1 = 0: v2 = 0
      v1 = CDbl(GetLVTextFromlParam(hWnd, lParam1))
      v2 = CDbl(GetLVTextFromlParam(hWnd, lParam2))
      'Debug.Print v1, v2
   
   Case eLVSortDate
      ' Get the date equivalent of the text
      ' in the relevant column:
      s1 = GetLVTextFromlParam(hWnd, lParam1)
      If IsDate(s1) Then
         v1 = CDate(s1)
      Else
         v1 = DateSerial(100, 1, 1)
      End If
      s2 = CDate(GetLVTextFromlParam(hWnd, lParam2))
      If IsDate(s2) Then
         v2 = CDate(s2)
      Else
         v2 = DateSerial(100, 1, 1)
      End If
   
   Case eLVSortString
       v1 = GetLVTextFromlParam(hWnd, lParam1)
       v2 = GetLVTextFromlParam(hWnd, lParam2)
   
   Case eLVSortStringNoCase
       v1 = UCase$(GetLVTextFromlParam(hWnd, lParam1))
       v2 = UCase$(GetLVTextFromlParam(hWnd, lParam2))
   
   Case eLVSortSelected
      v1 = False: v2 = False
      lIndex = IndexForlParam(hWnd, lParam1)
      If lIndex &gt; -1 Then
         v1 = pIsState(hWnd, lIndex, LVIS_SELECTED)
      End If
      lIndex = IndexForlParam(hWnd, lParam2)
      If lIndex &gt; -1 Then
         v2 = pIsState(hWnd, lIndex, LVIS_SELECTED)
      End If
   
   Case eLVSortChecked
      v1 = False: v2 = False
      lIndex = IndexForlParam(hWnd, lParam1)
      If lIndex &gt; -1 Then
         lR = SendMessage(hWnd, LVM_GETITEMSTATE, lIndex, LVIS_STATEIMAGEMASK)
         v1 = ((lR And &amp;H2000&amp;) = &amp;H2000&amp;)
      End If
      lIndex = IndexForlParam(hWnd, lParam2)
      If lIndex &gt; -1 Then
         lR = SendMessage(hWnd, LVM_GETITEMSTATE, lIndex, LVIS_STATEIMAGEMASK)
         v2 = pIsState(hWnd, lIndex, LVIS_SELECTED)
      End If
      
   Case eLVSortIndent
      v1 = 0: v2 = 0
      lIndex = IndexForlParam(hWnd, lParam1)
      If lIndex &gt; -1 Then
         pGetStyle hWnd, lIndex, LVIF_PARAM
         v1 = m_tLV.iIndent
      End If
      lIndex = IndexForlParam(hWnd, lParam2)
      If lIndex &gt; -1 Then
         pGetStyle hWnd, lIndex, LVIF_PARAM
         v2 = m_tLV.iIndent
      End If
   
   Case eLVSortIcon
      v1 = -1: v2 = -1
      lIndex = IndexForlParam(hWnd, lParam1)
      If lIndex &gt; -1 Then
         pGetStyle hWnd, lIndex, LVIF_IMAGE
         v1 = m_tLV.iImage
      End If
      lIndex = IndexForlParam(hWnd, lParam2)
      If lIndex &gt; -1 Then
         pGetStyle hWnd, lIndex, LVIF_IMAGE
         v2 = m_tLV.iImage
      End If
   
   End Select
        
    If (m_eSortOrder = eSortOrderDescending) Then
        vt = v2
        v2 = v1
        v1 = vt
    End If
    
    If (v1 &lt; v2) Then
        LVWSortCompare = -1
    ElseIf (v1 = v2) Then
        LVWSortCompare = 0
    Else
        LVWSortCompare = 1
    End If
    
End Function

Private Function IndexForlParam( _
      ByVal hWnd As Long, _
      ByVal lParam As Long _
   ) As Long
Dim tVFI As LVFINDINFO

   tVFI.flags = LVFI_PARAM
   tVFI.lParam = lParam
   IndexForlParam = SendMessage(hWnd, LVM_FINDITEM, -1, tVFI)
   
End Function

Private Function GetLVTextFromlParam( _
      ByVal hWnd As Long, _
      ByVal lParam As Long _
   ) As String
Dim lIndex As Long
   lIndex = IndexForlParam(hWnd, lParam)
   If lIndex &gt;= 0 Then
      If m_lColumn = 0 Then
         pGetStyle hWnd, lIndex, LVIF_TEXT
         GetLVTextFromlParam = m_tLV.pszText
      Else
         pGetStyle hWnd, lIndex, LVIF_TEXT, m_lColumn
         GetLVTextFromlParam = m_tLV.pszText
      End If
   End If

End Function
' Retrieves the item info into ItemStyle module variable.
Private Sub pGetStyle(ByVal hWnd As Long, ByVal lIndex As Long, ByVal lMask As
 Long, Optional ByVal lSubItem As Long = 0)
Dim sBuf As String
Dim lPos As Long
    
   m_tLV.mask = lMask
   sBuf = String(261, 0)
   m_tLV.pszText = sBuf
   m_tLV.cchTextMax = 260
   m_tLV.iItem = lIndex
   m_tLV.iSubItem = lSubItem
   SendMessage hWnd, LVM_GETITEM, 0, m_tLV
   lPos = InStr(m_tLV.pszText, Chr$(0))
   If lPos &gt; 0 Then
      m_tLV.pszText = Left$(m_tLV.pszText, lPos - 1)
   End If
   m_tLV.cchTextMax = Len(m_tLV.pszText)
    
End Sub

Private Function pIsState(ByVal hWnd As Long, ByVal lIndex As Long, ByVal
 lValue As Long, Optional bUseAsMask As Boolean = False) As Long
   If bUseAsMask Then
      m_tLV.stateMask = lValue
   End If
   m_tLV.iItem = lIndex
   pGetStyle hWnd, lIndex, LVIF_STATE
   pIsState = CBool(m_tLV.state And lValue)
End Function

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator ListView Control</a>&#160;.&#160;<a href="vb5_listview_full_source.html">VB5 ListView Full Source</a>&#160;.&#160;mListViewSort.bas</p><br /><p class="nav"><a href="..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 23 June 2003</p></td><td></td></tr></table>
</body></html>