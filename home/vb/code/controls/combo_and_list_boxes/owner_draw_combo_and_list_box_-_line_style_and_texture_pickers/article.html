<html lang="en" >
<head>

<title>vbAccelerator - Using ecdClientDrawOnly with the Owner Draw Combo List Box Control</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="This article demonstrates how to use the ecdClientDrawOnly mode of the vbAccelerator Owner Draw
and Combo List Box control to draw completely customised Combo Boxes (note that exactly the same technique applies
for List Boxes as well).  The sample provides three useful implementations - a line picker, a line dash picker
and a texture or background picker." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Combo and List Boxes</a>&#160;.&#160;Using ecdClientDrawOnly with the Owner Draw Combo List Box Control</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_custom_owner_draw_combo.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Custom Owner Draw Combo</a> (43K)</p><p /><p class="nav"><a href="vb6_custom_owner_draw_combo.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Custom Owner Draw Combo</a> (41K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:1413</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=1413&type=article&title=using_20ecdclientdrawonly_20with_20the_20owner_20draw_20combo_20list_20bo.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />19 Dec 2002<br />VB6 version posted.</p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\owner_draw_combo_and_list_box\article.html">Owner Draw Combo and List Boxes Version 2.1</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Using ecdClientDrawOnly with the Owner Draw Combo List Box Control</h1><p class="splash">Create customised ListBoxes and Combo Boxes, demonstrating how to build line-style and texture-style pickers</p><img src="customdraw.png" width="392" height="222" alt="Custom Draw Combo Box Sample Application" /><p /><p>This article demonstrates how to use the <i>ecdClientDrawOnly</i> mode of the vbAccelerator Owner Draw
and Combo List Box control to draw completely customised Combo Boxes (note that exactly the same technique applies
for List Boxes as well).  The sample provides three useful implementations - a line picker, a line dash picker
and a texture or background picker.</p><h2>Custom Drawing with vbalODCL.ocx</h2><p>To draw your own styles with the vbAccelerator Owner Draw Combo and List Box, there are
three things you need to do:</p><ol><li>Set the <i>Style</i> property to <i>ecdClientDrawOnly</i> (2).</li><li>Provide the width and height of the item in response to the <i>MeasureItem</i> event.</li><li>Draw the item itself during the <i>DrawItem</i> event.</li></ol><h3>Responding to the MeasureItem event</h3><p>The <i>MeasureItem</i> event provides you with three parameters: the Index of the item
to measure and two byref long values, <i>WidthPixels</i> and <i>HeightPixels</i>.  Set
<i>WidthPixels</i> to the desired width of the item in pixels and <i>HeightPixels</i> to 
the height.  If you do not do this, the drop-down part of your combo box will be very small!</p><h3>Responding to the DrawItem event</h3><p>The <i>DrawItem</i> event provides the following parameters:</p><ul><li>Index As Long<br />  The ListIndex of the item to draw.</li><li>hDC As Long <br /> The hDC to draw the item into.    </li><li>bSelected As Boolean <br /> Whether the item is selected or not.    </li><li>bEnabled As Boolean<br />  Whether the item is enabled or not.    </li><li>LeftPixels As Long<br />  The left-hand corner of the area occupied by the item in pixels.    </li><li>TopPixels As Long<br />  The top corner of the area occupied by the item in pixels.    </li><li>RightPixels As Long<br />  The right-hand corner of the area occupied by the item in pixels.</li><li>BottomPixels As Long<br />  The bottom corner of the area occupied by the item in pixels.    </li><li>hFntOld As Long<br />  This is the handle to the font in the control before ODCboLst.OCX selected the appropriate font.  </li></ul><p>In order to draw an item you need to be able to perform drawing into the Device Context
specified by the hDC parameter. You can either do this using the GDI API, or, if you
are mad, by drawing into a VB object and then copying the contents into the DC using
<i>BitBlt</i>.  These methods are covered in turn.</p><h2>Drawing Using the GDI API - The Samples</h2><p>There are three sample combo boxes implemented in the sample code:</p><ol><li>A Line-Style Picker</li><li>A Line Dash Style Picker</li><li>A Texture Picker</li></ol><p>The implementation of each of these samples is fundamentally the same, just the
specifics of the drawing code in each case is different.  Therefore we'll just cover
the Line-Style picker.</p><h3>MeasureItem</h3><p>Items in the Line-Style picker all have the same height and width, and this is set to be
the same as the size of the combo box itself.  Thus the response to the MeasureItem event
is:</p><pre>
Private Sub cboLineStyle_MeasureItem( _
    Index As Long, WidthPixels As Long, HeightPixels As Long)
    WidthPixels = cboLineStyle.Width \ Screen.TwipsPerPixelX
    HeightPixels = cboLineStyle.Height \ Screen.TwipsPerPixelY
End Sub
</pre><h3>DrawItem</h3><p>The line picker itself displays the size of the line and then draws a sample of the
line itself.  The code uses the ComboBox <i>List</i> property to store the line size to 
display as text, the <i>ItemData</i> property to store the actual line size (multiplied
by 100 since ItemData is a long and the line width itself can have decimal places) and 
the <i>ItemExtraData</i> to store the style of line to draw.  If you wanted to store
more sophisticated information against a ComboBox item there are many possible techniques,
such as a using an key to an item within Collection (set the collection key to some character
followed by the ItemData) or array, or a pointer to an object.</p><p>Drawing the item then is a matter of drawing the background, getting the line size text and drawing 
that, then getting the line size and style and drawing a line sample next to the text.  
When drawing the background, we need to take account of whether the item is selected or 
not.  Drawing the background is accomplished as follows:
</p><pre>
    ' Ensure text draws with transparent background:
    SetBkMode hdc, TRANSPARENT
    ' Set up a rectangle based on DrawItem parameters:
    tR.left = LeftPixels
    tR.tOp = TopPixels
    tR.Bottom = BottomPixels
    tR.Right = RightPixels
    ' Set the background and text color to draw:
    If (bSelected) Then
        hBrush = GetSysColorBrush(COLOR_HIGHLIGHT)
        SetTextColor hdc, GetSysColor(COLOR_HIGHLIGHTTEXT)
    Else
        hBrush = GetSysColorBrush(COLOR_WINDOW)
        SetTextColor hdc, GetSysColor(COLOR_WINDOWTEXT)
    End If
    ' Draw the background:
    FillRect hdc, tR, hBrush
    ' Clear up - probably not needed for GetSysColorBrush
    DeleteObject hBrush
</pre><p>Once the background is displayed, the code checks if the control is in focus
and draws the dotted focus rectangle around the item if it is:</p><pre>
    If (GetFocus() = cboLineStyle.hwnd) And bSelected Then
        DrawFocusRect hdc, tR
    End If
</pre><p>Now the actual item can be drawn.  We check if any item is actually selected in the 
control: if not, then there is no more drawing to be done.  If the item is selected,
the text and line style are read and drawn:</p><pre>
    If (Index &lt;&gt; -1) Then
        ' Get details of item to draw:
        iLineWidth = cboLineStyle.ItemExtraData(Index)
        iLineStyle = cboLineStyle.ItemData(Index)
        sText = cboLineStyle.List(Index)

        ' Draw the text:
        LSet tTXR = tR
        tTXR.left = tTXR.left + 4
        ' Calculate the size needed for the text:
        DrawText hdc, sText, -1, tTXR, DT_CALCRECT
        ' Draw it
        DrawText hdc, sText, -1, tTXR, DT_LEFT
   
        ' Adjust drawing rectangle to line:
        tR.left = 24
        tR.Right = tR.Right - 4

        ' Finally draw the line:	
        Select Case iLineStyle
        Case 1
            ' single line:
            lY = tR.tOp + (tR.Bottom - tR.tOp) \ 2
            DrawLine hdc, tR.left, tR.Right, lY, (iLineWidth \ 100)
 
	' ... other line styles here ... 
      
        End Select
</pre><p>The <i>DrawLine</i> function is a VB wrapper to creating an appropriate pen
and drawing the line:</p><pre>
Private Function DrawLine( _
    ByVal hdc As Long, _
    ByVal lXStart As Long, ByVal lXEnd As Long, _
    ByVal lY As Long, ByVal lWidth As Long, _
    Optional ByVal lStyle As Long = PS_SOLID)
Dim hPen As Long
Dim hPenOld As Long
Dim tP As POINTAPI
Dim tLB As LOGBRUSH

   ' Create the Pen:
   tLB.lbColor = GetSysColor(COLOR_WINDOWTEXT)
   hPen = ExtCreatePen(PS_GEOMETRIC Or PS_ENDCAP_FLAT Or lStyle, _
       lWidth, tLB, 0, ByVal 0&amp;)
   ' Select the pen for drawing:
   hPenOld = SelectObject(hdc, hPen)

   ' Draw the line using the pen:
   BeginPath hdc
   MoveToEx hdc, lXStart, lY, tP
   LineTo hdc, lXEnd, lY
   EndPath hdc
   StrokePath hdc

   ' Remove the pen and clear up:
   SelectObject hdc, hPenOld
   DeleteObject hPen

End Function
</pre><h2>Alternative (More VB-like) Method</h2><p>An alternative to using the GDI API to draw the items is to use an intermediate PictureBox to draw
onto using VB commands, and then transfer the result using the GDI <i>BitBlt</i> method.  To do this,
add a PictureBox to your form. Set the <i>Visible</i> property to False and then set <i>AutoRedraw</i>
to True.</p><p>When the <i>DrawItem</i> event fires, ensure that the PictureBox is large enough to draw the item 
into, using for example:</p><pre>
If (picDraw.Width &lt; (RightPixels - LeftPixels) \ Screen.TwipsPerPixelX Then
   picDraw.Width = (RightPixels - LeftPixels) \ Screen.TwipsPerPixelX
End If
If (picDraw.Height &lt; (BottomPixels - TopPixels) \ Screen.TwipsPerPixelY Then
   picDraw.Height = (BottomPixels - BottomPixels) \ Screen.TwipsPerPixelY
End If
</pre><p>Now you can draw onto the PictureBox using any of the standard (awful) VB drawing methods such
as <i>CurrentX</i>, <i>CurrentY</i>, <i>Line</i>, <i>Print</i>, <i>PaintPicture</i> etc.  Once
complete, you can transfer the results to the hDC passed in by <i>DrawItem</i> like this:</p><pre>
Private Declare Function BitBlt Lib "gdi32" _
   (ByVal hDestDC As Long, _
   ByVal X As Long, ByVal Y As Long, _
   ByVal nWidth As Long, ByVal nHeight As Long, _
   ByVal hSrcDC As Long, _
   ByVal xSrc As Long, ByVal ySrc As Long, _
   ByVal dwRop As Long) As Long

...

   BitBlt hdc, LeftPixels, TopPixels, _
      (RightPixels - LeftPixels - 1), (BottomPixels - TopPixels - 1), _
      picDraw.hDC, _
      0, 0, _
      vbSrcCopy
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Combo and List Boxes</a>&#160;.&#160;Using ecdClientDrawOnly with the Owner Draw Combo List Box Control</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 1999-2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 23 December 2002</p></td><td></td></tr></table>
</body></html>
