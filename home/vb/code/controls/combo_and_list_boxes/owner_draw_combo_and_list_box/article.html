<html lang="en" >
<head>

<title>vbAccelerator - Owner Draw Combo and List Boxes Version 2.1</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="Owner draw combo and list boxes are an excellent way to improve the look and feel of your application. 
However, there is little support for them in Visual Basic. The only owner-draw combo box supplied is 
the Checked list box style, but this is a preset list box style with no possibility for customisation. 
Here I provide a new control, completely written in Visual Basic, which does all the hard work of setting 
up an owner draw combo or list box. It also provides some great looking preset implementations:Choosing coloursChoosing system coloursChoosing fontsDrawing combo or list boxes with icons, indentations and different font and fore/back colours for each itemSelecting paragraph styles, similar to the paragraph picker in Word" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Combo and List Boxes</a>&#160;.&#160;Owner Draw Combo and List Boxes Version 2.1</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_owner_draw_combo_list_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Owner Draw Combo List Control</a> (40K)</p><p class="nav"><a href="vb5_owner_draw_combo_list_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Owner Draw Combo List Full Source</a> (255K)</p><p /><p class="nav"><a href="vb6_owner_draw_combo_list_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Owner Draw Combo List Control</a> (41K)</p><p class="nav"><a href="vb6_owner_draw_combo_list_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Owner Draw Combo List Demonstration</a> (153K)</p><p class="nav"><a href="vb6_owner_draw_combo_list_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Owner Draw Combo List Full Source</a> (239K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:1412</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=1412&type=article&title=owner_20draw_20combo_20and_20list_20boxes_20version_202_2e1.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />19 Dec 2002<br />VB6 Version Added</p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\type_libraries\ole_guid_and_interface_definitions\article.html">Ole Guid and interface definitions (OleGuids.Tlb) </a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\system_image_list\article.html">Using the System Image List with (and without) vbAccelerator Controls</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Owner Draw Combo and List Boxes Version 2.1</h1><p class="splash">Customise Combo Boxes and List Boxes with this control</p><img src="paragraphstyles.png" width="256" height="201" alt="Combo Box in Paragraph Style Chooser Mode" /><p /><p>Owner draw combo and list boxes are an excellent way to improve the look and feel of your application. 
However, there is little support for them in Visual Basic. The only owner-draw combo box supplied is 
the Checked list box style, but this is a preset list box style with no possibility for customisation. 
Here I provide a new control, completely written in Visual Basic, which does all the hard work of setting 
up an owner draw combo or list box. It also provides some great looking preset implementations:</p><ul><li>Choosing colours</li><li>Choosing system colours</li><li>Choosing fonts</li><li>Drawing combo or list boxes with icons, indentations and different font and fore/back colours for each item</li><li>Selecting paragraph styles, similar to the paragraph picker in Word</li></ul><h2>Owner Draw Combo Boxes and List Boxes in the Win32 API</h2><p>Creating owner drawn combo boxes or list boxes is relatively straightforward, but leads to rather 
a lot of non-Basic style coding. When the control is created, the application should add 
<i>CBS_OWNERDRAWVARIABLE</i> (for combo boxes) or <i>LBS_OWNERDRAWVARIABLE</i> (for list boxes) 
to the Windows Style bit (this cannot be done after the control is created, however).</p><p>Having done this, Windows no longer draws the control. Instead it sends a 
<i>WM_DRAWITEM</i> message whenever a portion of the control needs to be repainted. 
This passes a pointer to a <i>DRAWITEMSTRUCT</i> structure filled out with what needs to be drawn and where:</p><pre>
Type DRAWITEMSTRUCT
    CtlType As Long     ' -Not needed
    CtlID As Long     ' -The ID of the control when created
    ItemId As Long     ' -The ListIndex of the item to draw
    ItemAction As Long     ' -What action is causing the draw call
    ItemState As Long     ' -The state of the item to be drawn
    hwndItem As Long     ' -The hWnd of the window to draw in
    hDC As Long     ' -The DC of the window to draw in
    rcItem As RECT     ' -The bounding rectangle of the item to be drawn
    itemData As Long     ' -The item data of the item to be drawn
End Type 
</pre><p>You then respond to this message by drawing the item into the DC as required.</p><p>In addition, whenever an item is added to the list box, Windows sends a 
<i>WM_MEASUREITEM</i> message. This contains a pointer to a <i>MEASUREITEMSTRUCT</i> structure that the 
application can fill in with the size of the item.</p><h2>Owner Draw Combo and List Boxes in Visual Basic</h2><p>In practice, doing this in Visual Basic is not simple. Firstly, you cannot take an existing 
Combo Box or List Box and then add the required owner-draw style bit - it has no effect, and at best will 
cause the control not to operate correctly.</p><p>So instead you have to create a new window by calling <i>CreateWindowEx</i>. This means there is a 
lot of hard work required to make the control respond like a normal VB control. The worst problem is 
with focus. Normally you do not need to worry about Focus because VB implements all the methods 
required to set focus to and from other OCX controls. However, if you create a non-OCX window using 
<i>CreateWindowEx</i>, VB's default methods have no idea whatsoever how to handle it. Focus continues to 
work in VB as if the window you created did not exist, except when you click on the window with the mouse, 
in which case VB fails to understand that any change in focus has occurred.</p><p>Focus setting for OCX controls is done properly by implementing the OLE <i>IOLEInPlaceActiveObject</i> 
interface. However, this interface is resolutely hard-coded into VB UserControl's so it is very hard 
to get at. The first release of this control attempted to hack around this problem by subclassing the 
<i>WM_SETFOCUS</i> message and responding in such a way that VB no longer had any control. 
There were many problems with this, such as the control failing to operate on MDI forms, 
<i>GotFocus</i> and <i>LostFocus</i> events not firing and VB getting confused about which the 
<i>ActiveControl</i> was. </p><p>Version 2 of the control fixes all the focus problems by implementing the <i>IOLEInPlaceActiveObject</i> 
interface. It does this using some seriously hardcore code developed by Mike Gainer, Matt Curland and 
Bill Storage. This replaces the UserControl's standard OLE vtable during the <i>UserControl_Initialise</i>
 event, allowing the <i>IOLEInPlaceActiveObject</i> interface to be overridden by local VB versions 
of these functions. Using this in combination with responding to all <i>WM_SETFOCUS</i> and 
<i>WM_MOUSEACTIVATE</i> messages allows the correct response to focus to be coded in. If you are 
attempting to create a VB control which uses <i>CreateWindowEx</i>, and your control has to get 
focus, you need to download and check out this code!</p><p>To get the rest of the features working is fairly straightforward (but again rather un-basic like - 
a lot of copying memory to and from pointers is required), and essentially consists of intercepting 
<i>WM_COMMAND</i>, <i>WM_MEASUREITEM</i> and <i>WM_DRAWITEM</i> notification events and 
translating VB's methods (<i>List</i>, <i>ListIndex</i> etc) into the equivalent <i>SendMessage</i> calls.</p><h2>Using the ODCboLst Control</h2><p>When you place a new instance of ODCboLst onto a form, the primary items relating to 
owner draw operation are the <i>ClientDraw</i> and <i>Style</i> properties.</p><p>The <i>Style</i> property allows you to choose what type of control you get. This 
is similar to the <i>Style</i> property of a normal combo box or list box, except that both are 
provided in the same control, and also simple list boxes are not supported (does anyone ever 
use these?) The settings are fairly self-explanatory:</p><ul><li>ecsDropDownCombo = 0</li><li>ecsDropDownList = 2</li><li>ecsListBox = 4</li><li>ecsListBoxMultiSelect = 5</li><li>ecsListBoxChecked = 6</li></ul><p>The <i>ClientDraw</i> property determines how the control is rendered, and what options you 
will have to draw into the control. The settings for this are:</p><ul><li>ecdNoClientDraw = 0</li><li>ecdDefaultDrawThenClient = 1</li><li>ecdClientDrawOnly = 2 </li><li>ecdColourPickerWithNames = 3 </li><li>ecdColourPickerNoNames = 4 </li><li>ecdSysColourPicker = 5 </li><li>ecdParagraphStyles = 6 </li><li>ecdFontPicker = 7 </li></ul><p>These styles will be covered in turn.</p><h3>ecdNoClientDraw</h3><p>In this style, you are not allowed to do any drawing yourself. All drawing is done internally 
in the control using the default drawing method. The default drawing method supports the 
following properties for each item in the control:</p><ul><li>ItemForeColor(n)<br />  Sets/gets the colour text will be drawn in for the item. If set to -1, the control's text colour will be used.</li><li>ItemBackColor(n)<br />  Sets/gets the back colour for the item. If set to -1, the control's back colour will be used.    </li><li>ItemFont(n)<br />  Sets/gets the font for the item. If this is not specified, or set to nothing, the control's font will be used.    </li><li>ItemIcon(n)<br />  Sets/gets the zero-based index of an image within an ImageList to be drawn for the item. In order for this to work, the control's ImageList property must be initialised. Set the property either to a Visual Basic ImageList control, or to a valid ImageList handle.    </li><li>ItemIndent(n)<br />  Sets/gets the indentation, in pixels, from the left margin which will be left before the item is drawn.    </li><li>ItemHeight(n)<br />  The height of the item in pixels. If not specified, the default of 20 pixels will be used.    </li><li>ItemXAlign(n)<br />  Sets/gets the horizontal alignment of the item's text within its boundary. The default is left aligned (eixLeft).    </li><li>ItemYAlign(n)<br />  Sets/gets the vertical alignment of the item's text within its boundary. The default is top aligned (eixTop). If you set the vertical alignment to centred or vertical, only one line of text will be shown.    </li><li>ItemUnderline(n)<br />  Whether a ruling will be drawn underneath the item (spans the whole control width regardless of indentation).    </li><li>ItemOverline(n)<br />  Whether a ruling will be drawn over the item (spans the whole control width regardless of indentation).    </li></ul><h3>ecdDefaultDrawThenClient</h3><p>This mode performs the same as <i>ecdNoClient</i> except that once it has finished painting it raises a 
<i>DrawItem</i> event which allows you to perform extra drawing on the list items. This event is described 
in <i>ecdClientDrawOnly</i> next.</p><h3>ecdClientDrawOnly</h3><p>In this mode, the control makes no attempt at drawing, except that it selects the 
font appropriate to the item into the control's drawing DC. It raises a <i>DrawItem</i> event to the 
owner form, which should draw the item itself. The parameters for the <i>DrawItem</i> event are as follows:</p><ul><li>Index As Long<br />  The ListIndex of the item to draw.</li><li>hDC As Long <br /> The hDC to draw the item into.    </li><li>bSelected As Boolean <br /> Whether the item is selected or not.    </li><li>bEnabled As Boolean<br />  Whether the item is enabled or not.    </li><li>LeftPixels As Long<br />  The left-hand corner of the area occupied by the item in pixels.    </li><li>TopPixels As Long<br />  The top corner of the area occupied by the item in pixels.    </li><li>RightPixels As Long<br />  The right-hand corner of the area occupied by the item in pixels.</li><li>BottomPixels As Long<br />  The bottom corner of the area occupied by the item in pixels.    </li><li>hFntOld As Long<br />  This is the handle to the font in the control before ODCboLst.OCX selected the appropriate font.  </li></ul><p>The "Line Style and Texture Pickers" in this section provides sample source on how 
to use this method. The sample uses GDI methods to the drawing, however you could equally use 
VB drawing methods to draw into a picture box with <i>AutoRedraw</i> set to True and then use one call 
to <i>BitBlt</i> to transfer the item to the <i>DrawItem</i> hDC if you are more comfortable with 
VB's drawing methods.</p><h3>ecdColourPickerWithNames</h3><p>This style causes ODCboLst to draw a colour picker box. All drawing is done internally in 
the control using the default drawing method. The drawing method supports the following properties 
for each item in the control:</p><ul><li>ItemBackColor(n)<br />  Sets/gets the colour that will appear in the colour sample box next to each item in the combo box.</li></ul><h3>ecdColourPickerNoNames</h3><p>This style is the same as <i>ecdColourPickerWithNames</i> except that it shows colour sample boxes only.</p><h3>ecdSysColourPicker</h3><p>This style is the same as <i>ecdColourPicker</i>, except that it preinitialises the 
colours to the system colours.</p><h3>ecdParagraphStyles</h3><p>This mode performs the same as <i>ecdNoClient</i> except that once it has finished the default paint 
it additionally paints a box on the right hand side showing the text centring and font sizes. 
This style is aimed at setting up a paragraph style selector similar to the one in Word.</p><h3>ecdFontPicker</h3><p>This mode performs the same as <i>ecdNoClient</i> except the combo/list box is 
initialised with all the screen and printer fonts on the system and it draws a TT/printer 
icon next to the font.</p><h2>Other Additional Properties and Methods</h2><p>In addition to the owner-draw related properties and methods, the following are also provided:</p><ul><li>Sub AddItemAndData(sItem As String, [lIconIndex As Long = -1], [lIndent As Long], [lForeColour As OLE_COLOR = -1], [lBackColour As OLE_COLOR = -1], [lItemData As Long], [lExtraData As Long], [lHeight As Long = -1], [eTextXAlign As EItemXAlign = eixLeft], [eTextYAlign As EItemYAlign = eixTop], [fntThis As StdFont])<br />
This method allows you to add an item but also set the extended properties of each list item at the same time. If you have a lot of items to add, and you are setting one or more extended properties, it will be considerably quicker to use this method than the AddItem method followed by the individual extended properties.</li><li>Sub InsertItem(sItem As String, lIndex As Long)<br />
This method is the same as AddItem except it inserts after the index lIndex.</li><li>Sub InsertItemAndData(sItem As String, lIndex As Long, [lIconIndex As Long = -1], [lIndent As Long], [lForeColour As OLE_COLOR = -1], [lBackColour As OLE_COLOR = -1], [lItemData As Long], [lExtraData As Long], [lHeight As Long], [eTextXAlign As EItemXAlign = eixLeft], [eTextYAlign As EItemYAlign = eixTop], [fntThis As StdFont])<br />
This method is the same as AddItemAndData except it inserts after the index lIndex.</li><li>Property ImageList As Variant<br />
Assigns a VB ImageList control or valid handle to an ImageList to the control. This provides 
a source for icons under the default drawing scheme.  Note that you must use a ComCtl32 compatible 
Image List - the one provided in MSComCtl.OCX (VB6 Common Controls) is not compatible.</li><li>Property DropDownWidth As Long (combo box styles only)<br />
Allows the drop down size to be changed. Set to &gt; 0 to set the width of the drop down 
portion of the combo box in pixels, or to &lt;=0 to use the default.</li><li>Property ExtendedUI As Boolean (ecsDropDownList Style only)<br />
Set to True if you wish the combo box to drop down in response to the Down Arrow rather than the F4 key.</li><li>Function FindItemIndex(sToFind As String, [bExactMatch As Boolean = False]) As Long<br />
Attempts to find the item matching sToFind in the control. If <i>bExactMatch</i> is True, the 
control will search for an exact match, otherwise it will match the characters in <i>sToFind</i> 
against the first characters in the list items. Returns the <i>ListIndex</i> of the item if found, 
-1 otherwise.</li><li>Property MaxLength as Long (ecsDropDownCombo Style only)<br />
Sets the maximum number of characters which can be typed into the edit box section of the combo box.</li><li>Sub SelectRange(IndexStart As Long, IndexEnd As Long, bState As Boolean) (ecsListBoxMultiSelect and ecsListBoxChecked only)<br />
Sets the selection state for the items from <i>IndexStart</i> to <i>IndexEnd</i> to <i>bState</i>.</li><li>Sub ShowDropDown(bState As Boolean) (Combo boxes only)<br />
Drops down a combo when <i>bState</i> is True, closes it when <i>bState</i> is False.</li><li>Sub ShowDropDownAtPosition(XPixels As Long, YPixels As Long, [WidthPixels As Long], [HeightPixels As Long]) (Combo boxes only)<br />
Same as <i>ShowDropDown</i> except it only allows the drop down to be shown and additionally 
allows the drop down to be positioned. Use this to draw the drop down portion of a combo box 
in response to e.g. clicked a command button.</li></ul><h2>Additional Events</h2><ul><li>DropDown (Combo Boxes only)<br />
Raised when the combo is dropped down.</li><li>CloseUp (Combo Boxes only)<br />
Raised when the combo is closed.</li></ul><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Combo and List Boxes</a>&#160;.&#160;Owner Draw Combo and List Boxes Version 2.1</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 14 June 2003</p></td><td></td></tr></table>
</body></html>
