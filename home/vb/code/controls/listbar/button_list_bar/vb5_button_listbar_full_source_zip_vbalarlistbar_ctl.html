<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: vbalARListBar.ctl</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: vbalARListBar.ctl" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBar</a>&#160;.&#160;<a href="article.html">Button ListBar Control</a>&#160;.&#160;<a href="vb5_button_listbar_full_source.html">VB5 Button ListBar Full Source</a>&#160;.&#160;vbalARListBar.ctl</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_button_listbar_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Button ListBar Control</a> (27K)</p><p class="nav"><a href="vb5_button_listbar_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Button ListBar Demonstration</a> (68K)</p><p class="nav"><a href="vb5_button_listbar_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Button ListBar Full Source</a> (123K)</p><p /><p class="nav"><a href="vb6_button_listbar_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Button ListBar Control</a> (27K)</p><p class="nav"><a href="vb6_button_listbar_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Button ListBar Demonstration</a> (66K)</p><p class="nav"><a href="vb6_button_listbar_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Button ListBar Full Source</a> (121K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:11700</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=11700&type=zip&title=vb5_20button_20listbar_20full_20source_2ezip_5fvbalarlistbar.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />5 Jul 2003<br /><p class="update">Fixed bug with icons not drawing when using VB6 MSCOMCTL.OCX
ImageList</p><p class="update">Added Mouse Wheel support. Thanks to Chris Eastwood
at <a href="javascript:window.alert(&quot;http://vbcodelibrary.co.uk/\nThis link was not retrieved.&quot;)">vbCode Library</a> for the
suggestion.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\displaying_alpha_(32bit)_icons_with_imagelists\article[1].html">Displaying Alpha (32bit) Icons with ImageLists</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\graphics_and_gdi\flicker_free_api_drawing\article.html">Flicker Free API Drawing</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\xp_visual_styles\drawing_with_xp_visual_styles\article.html">Drawing with XP Visual Styles</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\type_libraries\vbaccelerator_com_support_type_library\article.html">vbAccelerator COM/VB Support Type Library (vbaCOM.Tlb)</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\utilities\vbpzip\article.html">Visual Basic Project Zip Utility</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\adding_scroll_bars_to_forms__pictureboxes_and_usercontrols\article.html">Adding Scroll Bars to Forms, PictureBoxes and User Controls</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: vbalARListBar.ctl</h1><pre>VERSION 5.00
Begin VB.UserControl vbalARListBar 
   Alignable       =   -1  'True
   ClientHeight    =   3600
   ClientLeft      =   0
   ClientTop       =   0
   ClientWidth     =   4800
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   ScaleHeight     =   3600
   ScaleWidth      =   4800
   ToolboxBitmap   =   "vbalARListBar.ctx":0000
End
Attribute VB_Name = "vbalARListBar"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit

' ===========================================================================
' Name:     vbalARListBar.ctl
' Author:   Steve McMahon (steve@vbaccelerator.com)
' Date:     20 April 2003
' Requires: SSUBTMR.DLL
'           vbaCOMTLB.TLB
'
' ---------------------------------------------------------------------------
' Copyright  2003 Steve McMahon (steve@vbaccelerator.com)
' Visit vbAccelerator - free, advanced source code for VB programmers.
'     http://vbaccelerator.com
' ---------------------------------------------------------------------------
'
' Description:
' VB implementation of Windows Add/Remove programs style
' ListBar.
'
' Updates:
' 2003-07-02
'  * Added Mouse Wheel Support.  Thanks to Chris Eastwood for
'    the suggestion and starter code.
'    Visit his site at http://vbcodelibrary.co.uk/
'  * Control now gets focus when scroll bar clicked
'  * Icons did not draw when using VB6 MSCOMCTL.OCX ImageList; now
'    the native MSCOMCTL.OCX method is used.
' ===========================================================================


' ---------------------------------------------------------------------
' vbAccelerator Software License
' Version 1.0
' Copyright (c) 2002 vbAccelerator.com
'
' Redistribution and use in source and binary forms, with or
' without modification, are permitted provided that the following
' conditions are met:
'
' 1. Redistributions of source code must retain the above copyright
'    notice, this list of conditions and the following disclaimer.
'
' 2. Redistributions in binary form must reproduce the above copyright
'    notice, this list of conditions and the following disclaimer in
'    the documentation and/or other materials provided with the distribution.
'
' 3. The end-user documentation included with the redistribution, if any,
'    must include the following acknowledgment:
'
'  "This product includes software developed by vbAccelerator
 (http://vbaccelerator.com/)."
'
' Alternately, this acknowledgment may appear in the software itself, if
' and wherever such third-party acknowledgments normally appear.
'
' 4. The name "vbAccelerator" must not be used to endorse or promote products
'    derived from this software without prior written permission. For written
'    permission, please contact vbAccelerator through steve@vbaccelerator.com.
'
' 5. Products derived from this software may not be called "vbAccelerator",
'    nor may "vbAccelerator" appear in their name, without prior written
'    permission of vbAccelerator.
'
' THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED WARRANTIES,
' INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
' AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
' VBACCELERATOR OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
' INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
' BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
' USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
' THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
' (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
' THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
'
' ---------------------------------------------------------------------


Private Type SIZE
   cX As Long
   cY As Long
End Type

Private Type POINTAPI
   x As Long
   y As Long
End Type

Private Type RECT
   left As Long
   top As Long
   right As Long
   bottom As Long
End Type

Private Declare Function GetVersion Lib "kernel32" () As Long
Private Declare Function GetClientRect Lib "user32" (ByVal hwnd As Long, lpRect
 As RECT) As Long
Private Declare Function ScreenToClient Lib "user32" (ByVal hwnd As Long,
 lpPoint As POINTAPI) As Long
Private Declare Function PtInRect Lib "user32" (lpRect As RECT, ByVal x As
 Long, ByVal y As Long) As Long
Private Declare Function InflateRect Lib "user32" (lpRect As RECT, ByVal x As
 Long, ByVal y As Long) As Long
Private Declare Function OffsetRect Lib "user32" (lpRect As RECT, ByVal x As
 Long, ByVal y As Long) As Long
Private Declare Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As
 Integer
Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" (pDest As
 Any, pSrc As Any, ByVal ByteLen As Long)
Private Declare Function GetSystemMetrics Lib "user32" (ByVal nIndex As Long)
 As Long
Private Const SM_CXVSCROLL = 2

' Windows keyboard message constants:
Private Const WM_SYSCHAR&amp; = &amp;H106&amp;
Private Const WM_SYSKEYDOWN&amp; = &amp;H104&amp;

Private Declare Function FillRect Lib "user32" (ByVal hDC As Long, lpRect As
 RECT, ByVal hBrush As Long) As Long
Private Declare Function GetSysColorBrush Lib "user32" (ByVal nIndex As Long)
 As Long
Private Declare Function GetSysColor Lib "user32" (ByVal nIndex As Long) As Long
Private Declare Function CreateDCAsNull Lib "gdi32" Alias "CreateDCA" (ByVal
 lpDriverName As String, lpDeviceName As Any, lpOutput As Any, lpInitData As
 Any) As Long
Private Declare Function DeleteDC Lib "gdi32" (ByVal hDC As Long) As Long
Private Declare Function CreateCompatibleDC Lib "gdi32" (ByVal hDC As Long) As
 Long
Private Declare Function CreateCompatibleBitmap Lib "gdi32" (ByVal hDC As Long,
 ByVal nWidth As Long, ByVal nHeight As Long) As Long
Private Declare Function SelectObject Lib "gdi32" (ByVal hDC As Long, ByVal
 hObject As Long) As Long
Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As
 Long
Private Declare Function BitBlt Lib "gdi32" (ByVal hDestDC As Long, ByVal x As
 Long, ByVal y As Long, ByVal nWidth As Long, ByVal nHeight As Long, ByVal
 hSrcDC As Long, ByVal xSrc As Long, ByVal ySrc As Long, ByVal dwRop As Long)
 As Long
Private Declare Function DrawText Lib "user32" Alias "DrawTextA" (ByVal hDC As
 Long, ByVal lpStr As String, ByVal nCount As Long, lpRect As RECT, ByVal
 wFormat As Long) As Long
Private Declare Function SetBkColor Lib "gdi32" (ByVal hDC As Long, ByVal
 crColor As Long) As Long
Private Declare Function SetTextColor Lib "gdi32" (ByVal hDC As Long, ByVal
 crColor As Long) As Long
Private Declare Function SetBkMode Lib "gdi32" (ByVal hDC As Long, ByVal
 nBkMode As Long) As Long
Private Const TRANSPARENT = 1
Private Declare Function OleTranslateColor Lib "OLEPRO32.DLL" (ByVal OLE_COLOR
 As Long, ByVal HPALETTE As Long, pccolorref As Long) As Long
Private Declare Function CreateSolidBrush Lib "gdi32" (ByVal crColor As Long)
 As Long
Private Declare Function DrawEdgeAPI Lib "user32" Alias "DrawEdge" (ByVal hDC
 As Long, qrc As RECT, ByVal edge As Long, ByVal grfFlags As Long) As Long
Private Declare Function DrawState Lib "user32" Alias "DrawStateA" _
   (ByVal hDC As Long, ByVal hBrush As Long, _
   ByVal lpDrawStateProc As Long, _
   ByVal lParam As Long, ByVal wParam As Long, _
   ByVal x As Long, ByVal y As Long, _
   ByVal cX As Long, ByVal cY As Long, _
   ByVal fuFlags As Long) As Long
Private Declare Function DestroyIcon Lib "user32" (ByVal hIcon As Long) As Long

'/* Image type */
Private Const DST_COMPLEX = &amp;H0
Private Const DST_TEXT = &amp;H1
Private Const DST_PREFIXTEXT = &amp;H2
Private Const DST_ICON = &amp;H3
Private Const DST_BITMAP = &amp;H4

' /* State type */
Private Const DSS_NORMAL = &amp;H0
Private Const DSS_UNION = &amp;H10         ' /* Gray string appearance */
Private Const DSS_DISABLED = &amp;H20
Private Const DSS_MONO = &amp;H80
Private Const DSS_RIGHT = &amp;H8000


Private Declare Function OpenThemeData Lib "uxtheme.dll" _
   (ByVal hwnd As Long, ByVal pszClassList As Long) As Long
Private Declare Function CloseThemeData Lib "uxtheme.dll" _
   (ByVal hTheme As Long) As Long
Private Declare Function DrawThemeBackground Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal lhDC As Long, _
    ByVal iPartId As Long, ByVal iStateId As Long, _
    pRect As RECT, pClipRect As RECT) As Long
Private Declare Function DrawThemeParentBackground Lib "uxtheme.dll" _
   (ByVal hwnd As Long, ByVal hDC As Long, prc As RECT) As Long
Private Declare Function GetThemeBackgroundContentRect Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, _
    ByVal iPartId As Long, ByVal iStateId As Long, _
    pBoundingRect As RECT, pContentRect As RECT) As Long
Private Declare Function DrawThemeText Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, ByVal iPartId As Long, _
    ByVal iStateId As Long, ByVal pszText As Long, _
    ByVal iCharCount As Long, ByVal dwTextFlag As Long, _
    ByVal dwTextFlags2 As Long, pRect As RECT) As Long
Private Declare Function DrawThemeIcon Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, ByVal iPartId As Long, _
    ByVal iStateId As Long, pRect As RECT, _
    ByVal hIml As Long, ByVal iImageIndex As Long) As Long
Private Declare Function GetThemePartSize Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, ByVal iPartId As Long, _
   ByVal iStateId As Long, prc As RECT, ByVal eSize As Long, _
   psz As SIZE) As Long
Private Declare Function GetThemeTextExtent Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, _
    ByVal iPartId As Long, ByVal iStateId As Long, _
    ByVal pszText As Long, ByVal iCharCount As Long, _
    ByVal dwTextFlags As Long, pBoundingRect As RECT, _
    pExtentRect As RECT) As Long
Private Declare Function DrawThemeEdge Lib "uxtheme.dll" _
   (ByVal hTheme As Long, ByVal hDC As Long, _
   ByVal iPartId As Long, ByVal iStateId As Long, _
   pDestRect As RECT, _
   ByVal uEdge As Long, ByVal uFlags As Long, _
   pContentRect As RECT) As Long
Private Const S_OK = 0
Private Const HWND_DESKTOP = 0

' THEMESIZE
Private Const TS_MIN = 0            '// minimum size
Private Const TS_TRUE = 1           '// size without stretching
Private Const TS_DRAW = 2           '// size that theme mgr will use to draw
 part

' Button class
Private Const UXTHEMEBUTTONCLASS = "Button"
Private Const UXTHEMETOOLBARCLASS = "Toolbar"
' Button part
Private Const TP_BUTTON = 1
Private Const BP_PUSHBUTTON = 1
' Button states
Private Const TS_NORMAL = 1
Private Const TS_HOT = 2
Private Const TS_PRESSED = 3
Private Const TS_DISABLED = 4
Private Const TS_CHECKED = 5
Private Const TS_HOTCHECKED = 6
Private Const PBS_DISABLED = 4

' DrawTextFlags
Private Const DT_TOP = &amp;H0
Private Const DT_LEFT = &amp;H0
Private Const DT_CENTER = &amp;H1
Private Const DT_RIGHT = &amp;H2
Private Const DT_VCENTER = &amp;H4
Private Const DT_BOTTOM = &amp;H8
Private Const DT_WORDBREAK = &amp;H10
Private Const DT_SINGLELINE = &amp;H20
Private Const DT_EXPANDTABS = &amp;H40
Private Const DT_TABSTOP = &amp;H80
Private Const DT_NOCLIP = &amp;H100
Private Const DT_EXTERNALLEADING = &amp;H200
Private Const DT_CALCRECT = &amp;H400
Private Const DT_NOPREFIX = &amp;H800
Private Const DT_INTERNAL = &amp;H1000
Private Const DT_EDITCONTROL = &amp;H2000
Private Const DT_PATH_ELLIPSIS = &amp;H4000
Private Const DT_END_ELLIPSIS = &amp;H8000&amp;
Private Const DT_MODIFYSTRING = &amp;H10000
Private Const DT_RTLREADING = &amp;H20000
Private Const DT_WORD_ELLIPSIS = &amp;H40000
Private Const DT_NOFULLWIDTHCHARBREAK = &amp;H80000
Private Const DT_HIDEPREFIX = &amp;H100000
Private Const DT_PREFIXONLY = &amp;H200000

' UxTheme DrawText Additional Flag
Private Const DTT_GRAYED = &amp;H1             '// draw a grayed-out string

' DrawEdgeEdgeTypes
Private Const BDR_RAISEDOUTER = &amp;H1
Private Const BDR_SUNKENOUTER = &amp;H2
Private Const BDR_RAISEDINNER = &amp;H4
Private Const BDR_SUNKENINNER = &amp;H8

Private Const BDR_OUTER = (BDR_RAISEDOUTER Or BDR_SUNKENOUTER)
Private Const BDR_INNER = (BDR_RAISEDINNER Or BDR_SUNKENINNER)
Private Const BDR_RAISED = (BDR_RAISEDOUTER Or BDR_RAISEDINNER)
Private Const BDR_SUNKEN = (BDR_SUNKENOUTER Or BDR_SUNKENINNER)
Private Const EDGE_RAISED = (BDR_RAISEDOUTER Or BDR_RAISEDINNER)
Private Const EDGE_SUNKEN = (BDR_SUNKENOUTER Or BDR_SUNKENINNER)
Private Const EDGE_ETCHED = (BDR_SUNKENOUTER Or BDR_RAISEDINNER)
Private Const EDGE_BUMP = (BDR_RAISEDOUTER Or BDR_SUNKENINNER)

' DrawEdgeBorderFlags
Private Const BF_LEFT = &amp;H1
Private Const BF_TOP = &amp;H2
Private Const BF_RIGHT = &amp;H4
Private Const BF_BOTTOM = &amp;H8

Private Const BF_TOPLEFT = (BF_TOP Or BF_LEFT)
Private Const BF_TOPRIGHT = (BF_TOP Or BF_RIGHT)
Private Const BF_BOTTOMLEFT = (BF_BOTTOM Or BF_LEFT)
Private Const BF_BOTTOMRIGHT = (BF_BOTTOM Or BF_RIGHT)
Private Const BF_RECT = (BF_LEFT Or BF_TOP Or BF_RIGHT Or BF_BOTTOM)
Private Const BF_DIAGONAL = &amp;H10
Private Const BF_DIAGONAL_ENDTOPRIGHT = (BF_DIAGONAL Or BF_TOP Or BF_RIGHT)
Private Const BF_DIAGONAL_ENDTOPLEFT = (BF_DIAGONAL Or BF_TOP Or BF_LEFT)
Private Const BF_DIAGONAL_ENDBOTTOMLEFT = (BF_DIAGONAL Or BF_BOTTOM Or BF_LEFT)
Private Const BF_DIAGONAL_ENDBOTTOMRIGHT = (BF_DIAGONAL Or BF_BOTTOM Or
 BF_RIGHT)
Private Const BF_MIDDLE = &amp;H800             '/* Fill in the middle */
Private Const BF_SOFT = &amp;H1000              '/* For softer buttons */
Private Const BF_ADJUST = &amp;H2000            '/* Calculate the space left over */
Private Const BF_FLAT = &amp;H4000              '/* For flat rather than 3D borders
 */
Private Const BF_MONO = &amp;H8000              '/* For monochrome borders */

Private Type IMAGELISTDRAWPARAMS
    cbSize As Long
    hIml As Long
    i As Long
    hdcDst As Long
    x As Long
    y As Long
    cX As Long
    cY As Long
    xBitmap As Long
    yBitmap As Long
    rgbBk As Long
    rgbFg As Long
    fStyle As Long
    dwRop As Long
    fState As Long
    Frame As Long
    crEffect As Long
End Type
Private Declare Function ImageList_DrawIndirect Lib "comctl32.dll" ( _
    pimldp As IMAGELISTDRAWPARAMS) As Long
Private Declare Function ImageList_GetImageRect Lib "comctl32.dll" ( _
        ByVal hIml As Long, _
        ByVal i As Long, _
        prcImage As RECT _
    ) As Long
Private Declare Function ImageList_Draw Lib "comctl32.dll" ( _
        ByVal hIml As Long, ByVal i As Long, _
        ByVal hdcDst As Long, ByVal x As Long, ByVal y As Long, _
        ByVal fStyle As Long _
    ) As Long
Private Declare Function ImageList_GetIcon Lib "comctl32.dll" ( _
        ByVal hIml As Long, _
        ByVal i As Long, _
        ByVal diIgnore As Long _
    ) As Long
Private Declare Function ImageList_Create Lib "COMCTL32" (ByVal MinCx As Long,
 ByVal MinCy As Long, ByVal flags As Long, ByVal cInitial As Long, ByVal cGrow
 As Long) As Long
Private Declare Function ImageList_AddMasked Lib "COMCTL32" (ByVal hImageList
 As Long, ByVal hbmImage As Long, ByVal crMask As Long) As Long
Private Declare Function ImageList_Destroy Lib "COMCTL32" (ByVal hImageList As
 Long) As Long
Private Const ILD_TRANSPARENT = 1
Private Const ILD_BLEND25 = 2
Private Const ILD_SELECTED = 4
Private Const ILD_IMAGE = &amp;H20&amp;
Private Const ILD_PRESERVEALPHA = &amp;H1000&amp;
Private Const ILC_COLOR = &amp;H0
Private Const ILC_COLOR32 = &amp;H20
Private Const ILC_MASK = &amp;H1&amp;
Private Const ILS_SATURATE = &amp;H4&amp;

Private Type tARListBarItem
   sKey As String
   iIconIndex As Long
   sCaption As String
   sToolTip As String
   bEnabled As Boolean
   bSelected As Boolean
   sTag As String
   lItemData As Long
   lID As Long
   yStart As Long
   yExtent As Long
   bMouseOver As Boolean
   bMouseDown As Boolean
End Type

' OleControl Interface support:
Private m_ptrGetControlInfoOrig As Long
Private m_ptrOnMnemonicOrg As Long
Private m_cMnemonics As pcMnemonics

Private WithEvents m_cScroll As pcScrollBars
Attribute m_cScroll.VB_VarHelpID = -1
Private m_cMemDC As pcMemDC
Private WithEvents m_tmr As CTimer
Attribute m_tmr.VB_VarHelpID = -1

Private m_hIml As Long
Private m_ptrVB6ImageList As Long
Private m_lIconSize As Long

Private m_lItemCount As Long
Private m_tItem() As tARListBarItem
Private m_lIDGenerator As Long

Private m_oBackColor As OLE_COLOR
Private m_oForeColor As OLE_COLOR
Private m_fnt As IFont
Private m_lButtonWidth As Long
Private m_lLastButtonWidth As Long

Private m_bIsNt As Boolean
Private m_bIsXp As Boolean
Private m_bRunTime As Boolean
Private m_bFocus As Boolean

Private m_sToolTip As String

Public Event SelectionChanged(ByVal lIndex As Long)
Attribute SelectionChanged.VB_Description = "Raised whenever the selected item
 is changed, either by the user or in code."
Public Event ItemClick(ByVal lIndex As Long)
Attribute ItemClick.VB_Description = "Raised when a new item is selected in the
 control using the mouse or the keyboard."
Public Event ItemRightClick(ByVal lIndex As Long, x As Single, y As Single)
Attribute ItemRightClick.VB_Description = "Raised when an item is
 right-clicked."
Public Event BarRightClick(x As Single, y As Single)
Attribute BarRightClick.VB_Description = "Raised when the bar area of the
 control is right-clicked."
Public Event MouseMove(Button As MouseButtonConstants, Shift As ShiftConstants,
 x As Single, y As Single)
Attribute MouseMove.VB_Description = "Raised when a MouseMove event occurs in
 the control."
Public Event MouseDown(Button As MouseButtonConstants, Shift As ShiftConstants,
 x As Single, y As Single)
Attribute MouseDown.VB_Description = "Raised when a MouseDown event occurs in
 the control."
Public Event MouseUp(Button As MouseButtonConstants, Shift As ShiftConstants, x
 As Single, y As Single)
Attribute MouseUp.VB_Description = "Raised when a MouseUp event occurs in the
 control."
Public Event KeyDown(KeyCode As KeyCodeConstants, Shift As ShiftConstants)
Attribute KeyDown.VB_Description = "Raised when a key down event occurs in the
 control."
Public Event KeyPress(KeyAscii As Integer)
Attribute KeyPress.VB_Description = "Raised when a KeyPress event occurs in the
 control."
Public Event KeyUp(KeyCode As KeyCodeConstants, Shift As ShiftConstants)
Attribute KeyUp.VB_Description = "Raised when a key is released in the control."

Public Event Resize()
Attribute Resize.VB_Description = "Raised when the control is resized."

Private Sub GetWindowsVersion( _
      Optional ByRef lMajor = 0, _
      Optional ByRef lMinor = 0, _
      Optional ByRef lRevision = 0, _
      Optional ByRef lBuildNumber = 0, _
      Optional ByRef bIsNt = False _
   )
Dim lR As Long
   lR = GetVersion()
   lBuildNumber = (lR And &amp;H7F000000) \ &amp;H1000000
   If (lR And &amp;H80000000) Then lBuildNumber = lBuildNumber Or &amp;H80
   lRevision = (lR And &amp;HFF0000) \ &amp;H10000
   lMinor = (lR And &amp;HFF00&amp;) \ &amp;H100
   lMajor = (lR And &amp;HFF)
   bIsNt = ((lR And &amp;H80000000) = 0)
End Sub

Public Property Get BackColor() As OLE_COLOR
Attribute BackColor.VB_Description = "Gets/sets the background colour of the
 bar.  The special value -1 sets the colour to the default."
   BackColor = m_oBackColor
End Property
Public Property Let BackColor(ByVal oColor As OLE_COLOR)
   m_oBackColor = oColor
   If (m_oBackColor = -1) Then
      If (m_bIsXp) Then
         UserControl.BackColor = vbButtonFace
      Else
         UserControl.BackColor = vbButtonShadow
      End If
   Else
      UserControl.BackColor = oColor
   End If
   PropertyChanged "BackColor"
End Property

Public Property Get Font() As StdFont
Attribute Font.VB_Description = "Gets/sets the font used to draw the items in
 the control."
   Set Font = UserControl.Font
End Property
Public Property Let Font(fnt As StdFont)
   Set UserControl.Font = fnt
   PropertyChanged "Font"
End Property
Public Property Set Font(fnt As StdFont)
   Set UserControl.Font = fnt
   PropertyChanged "Font"
End Property

Private Function NextId() As Long
   m_lIDGenerator = m_lIDGenerator + 1
   NextId = m_lIDGenerator
End Function

Public Property Get ButtonWidth() As Single
Attribute ButtonWidth.VB_Description = "Gets/sets the width of buttons in the
 control.  Use this property to set the width of the control: note the actual
 width will vary depending on whether the scroll bar is shown."
   ButtonWidth = pScaleX(m_lButtonWidth)
End Property
Public Property Let ButtonWidth(ByVal fButtonWidth As Single)
   m_lButtonWidth = pUnScaleX(fButtonWidth)
   UserControl_Resize
   pPaint
End Property

Public Sub Add( _
      Optional ByVal sKey As String = "", _
      Optional ByVal sCaption As String = "", _
      Optional ByVal lIconIndex As Long = -1, _
      Optional ByVal sToolTip As String = "", _
      Optional ByVal bEnabled As Boolean = True, _
      Optional ByVal sTag = "", _
      Optional ByVal lItemData = 0, _
      Optional KeyBefore As Variant _
   )
Attribute Add.VB_Description = "Adds or inserts a new item to the bar."
Dim lIndex As Long
Dim lBeforeIndex As Long
Dim i As Long
Dim lID As Long

   ' Check key before
   If Not (IsMissing(KeyBefore)) Then
      On Error Resume Next
      lBeforeIndex = ItemIndex(KeyBefore)
      On Error GoTo 0
      If (lBeforeIndex &lt;= 0) Then
         Err.Raise 9
         Exit Sub
      End If
   End If
   
   ' Check key:
   On Error Resume Next
   lIndex = ItemIndex(sKey)
   On Error GoTo 0
   If (lIndex &gt; 0) Then
      Err.Raise 457
      Exit Sub
   End If
   
   lID = NextId
   If Len(sKey) = 0 Then
      sKey = "ITEM:" &amp; lID
   End If
   
   ' Add the item:
   m_lItemCount = m_lItemCount + 1
   ReDim Preserve m_tItem(1 To m_lItemCount) As tARListBarItem
   
   If (lBeforeIndex &gt; 0) Then
      ' shift everything else down:
      For i = m_lItemCount - 1 To lBeforeIndex Step -1
         LSet m_tItem(i + 1) = m_tItem(i)
      Next i
   Else
      lBeforeIndex = m_lItemCount
   End If
   
   With m_tItem(lBeforeIndex)
      .sKey = sKey
      .sCaption = sCaption
      .iIconIndex = lIconIndex
      .sToolTip = sToolTip
      .sTag = sTag
      .lItemData = lItemData
      .bEnabled = bEnabled
      .lID = lID
   End With
   
   pAddAccessKey sCaption
      
   pResize
   pPaint
   
End Sub

Public Sub Remove(vKey As Variant)
Attribute Remove.VB_Description = "Removes the specified item from the control."
Dim lIndex As Long
Dim i As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      If (m_lItemCount = 1) Then
         Clear
      Else
         For i = lIndex To m_lItemCount - 1
            LSet m_tItem(i) = m_tItem(i + 1)
         Next i
         m_lItemCount = m_lItemCount - 1
         ReDim Preserve m_tItem(1 To m_lItemCount) As tARListBarItem
         pResize
         pPaint
      End If
   End If
End Sub

Public Sub Clear()
Attribute Clear.VB_Description = "Clears all items from the control."
   m_lItemCount = 0
   Erase m_tItem
   pPaint
End Sub

Public Property Get ItemCount() As Long
Attribute ItemCount.VB_Description = "Gets the number of items in the control."
   ItemCount = m_lItemCount
End Property

Public Property Get ItemIndex(vKey As Variant) As Long
Attribute ItemIndex.VB_Description = "Gets the index of the specified item in
 the control."
Dim lIndex As Long
Dim i As Long
   If (IsNumeric(vKey)) Then
      lIndex = CLng(vKey)
      If (lIndex &gt; 0) And (lIndex &lt;= m_lItemCount) Then
         ItemIndex = lIndex
      Else
         Err.Raise 9
      End If
   Else
      For i = 1 To m_lItemCount
         If (m_tItem(i).sKey = vKey) Then
            lIndex = i
            Exit For
         End If
      Next i
      If (lIndex &gt; 0) Then
         ItemIndex = lIndex
      Else
         Err.Raise 9
      End If
   End If
End Property

Public Property Get ItemCaption(vKey As Variant) As String
Attribute ItemCaption.VB_Description = "Gets/sets the caption for the specified
 item."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemCaption = m_tItem(lIndex).sCaption
   End If
End Property
Public Property Let ItemCaption(vKey As Variant, ByVal sCaption As String)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      pAddAccessKey sCaption
      m_tItem(lIndex).sCaption = sCaption
      pResize
      pPaint
   End If
End Property
Public Property Get ItemKey(vKey As Variant) As String
Attribute ItemKey.VB_Description = "Gets/sets the key associated with the
 specified item in the control."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemKey = m_tItem(lIndex).sKey
   End If
End Property
Public Property Let ItemKey(vKey As Variant, ByVal sKey As String)
Dim lIndex As Long
Dim i As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      For i = 1 To m_lItemCount
         If Not (i = lIndex) Then
            If (m_tItem(i).sKey = sKey) Then
               Err.Raise 457
               Exit Property
            End If
         End If
      Next i
      m_tItem(lIndex).sKey = sKey
   End If
End Property
Public Property Get ItemTag(vKey As Variant) As String
Attribute ItemTag.VB_Description = "Gets/sets a string value associated with
 the specified item."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemTag = m_tItem(lIndex).sTag
   End If
End Property
Public Property Let ItemTag(vKey As Variant, ByVal sTag As String)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      m_tItem(lIndex).sTag = sTag
   End If
End Property
Public Property Get ItemToolTip(vKey As Variant) As String
Attribute ItemToolTip.VB_Description = "Gets/sets the tooltip to display for
 the specified item."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemToolTip = m_tItem(lIndex).sToolTip
   End If
End Property
Public Property Let ItemToolTip(vKey As Variant, ByVal sToolTip As String)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      m_tItem(lIndex).sToolTip = sToolTip
   End If
End Property
Public Property Get ItemData(vKey As Variant) As Long
Attribute ItemData.VB_Description = "Gets/sets a long value associated with an
 item."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemData = m_tItem(lIndex).lItemData
   End If
End Property
Public Property Let ItemData(vKey As Variant, ByVal lItemData As Long)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      m_tItem(lIndex).lItemData = lItemData
   End If
End Property
Public Property Get ItemIcon(vKey As Variant) As Long
Attribute ItemIcon.VB_Description = "Gets/sets the 0-based index of the icon
 for the specified item."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemIcon = m_tItem(lIndex).iIconIndex
   End If
End Property
Public Property Let ItemIcon(vKey As Variant, ByVal lIconIndex As Long)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      m_tItem(lIndex).iIconIndex = lIconIndex
      pPaint
   End If
End Property

Public Property Get ItemSelected(vKey As Variant) As Boolean
Attribute ItemSelected.VB_Description = "Gets/sets whether an item is selected
 or not.  Either no items or one item can be selected."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemSelected = m_tItem(lIndex).bSelected
   End If
End Property
Public Property Let ItemSelected(vKey As Variant, ByVal bSelected As Boolean)
Dim lIndex As Long
Dim i As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      If (m_tItem(lIndex).bSelected = bSelected) Then
         ' nothing to do
      Else
         If (bSelected) Then
            For i = 1 To m_lItemCount
               m_tItem(i).bMouseOver = False
               If Not (i = lIndex) Then
                  m_tItem(i).bSelected = False
               End If
            Next i
         End If
         m_tItem(lIndex).bSelected = bSelected
         If (bSelected) Then
            pEnsureVisible lIndex
            RaiseEvent SelectionChanged(lIndex)
         End If
         pPaint
      End If
   End If
End Property
Public Property Get SelectedIndex() As Long
Attribute SelectedIndex.VB_Description = "Gets the selected item in the
 control.  Use the ItemSelected property to set the selected index."
Dim i As Long
   For i = 1 To m_lItemCount
      If (m_tItem(i).bSelected) Then
         SelectedIndex = i
         Exit For
      End If
   Next i
End Property
Public Property Get ItemEnabled(vKey As Variant) As Boolean
Attribute ItemEnabled.VB_Description = "Gets/sets whether the specified item is
 enabled or not."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      ItemEnabled = m_tItem(lIndex).bEnabled
   End If
End Property
Public Property Let ItemEnabled(vKey As Variant, ByVal bEnabled As Boolean)
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      m_tItem(lIndex).bEnabled = bEnabled
      pPaint
   End If
End Property

Public Sub EnsureItemVisible(vKey As Variant)
Attribute EnsureItemVisible.VB_Description = "Ensures the specified item is in
 view, scrolling if required."
Dim lIndex As Long
   lIndex = ItemIndex(vKey)
   If (lIndex &gt; 0) Then
      pEnsureVisible lIndex
   End If
End Sub

Public Property Let ImageList( _
        ByRef vImageList As Variant _
    )
Attribute ImageList.VB_Description = "Sets the ImageList used to draw the
 control.  If using a VB ImageList, set to the ImageList object, otherwise if
 using an API-based ImageList pass in the hImageList or hIml property.  Set to
 0 to clear the ImageList."
    m_hIml = 0
    m_ptrVB6ImageList = 0
    If (VarType(vImageList) = vbLong) Then
        ' Assume a handle to an image list:
        m_hIml = vImageList
    ElseIf (VarType(vImageList) = vbObject) Then
        ' Assume a VB image list:
        On Error Resume Next
        ' Get the image list initialised..
        vImageList.ListImages(1).Draw 0, 0, 0, 1
        m_hIml = vImageList.hImageList
        If (Err.Number = 0) Then
            ' Check for VB6 image list:
            If (TypeName(vImageList) = "ImageList") Then
               Dim o As Object
               Set o = vImageList
               m_ptrVB6ImageList = ObjPtr(o)
            End If
        Else
            Debug.Print "Failed to Get Image list Handle",
             "cARListBar.ImageList"
        End If
        On Error GoTo 0
    End If
    If (m_hIml &lt;&gt; 0) Then
        If (m_ptrVB6ImageList &lt;&gt; 0) Then
            m_lIconSize = vImageList.ImageHeight
        Else
            Dim rc As RECT
            ImageList_GetImageRect m_hIml, 0, rc
            m_lIconSize = rc.bottom - rc.top
        End If
    End If
End Property

Private Sub pAddAccessKey( _
      ByVal sNewCaption As String, _
      Optional ByVal sOldCaption As String = "" _
   )
Dim iPos As Long
Dim sToAdd As String
Dim sToRemove As String
Dim sKeys As String

   iPos = InStr(sNewCaption, "&amp;")
   If (iPos &gt; 0) And (iPos &lt; Len(sNewCaption)) Then
      sToAdd = UCase(Mid(sNewCaption, iPos + 1, 1))
   End If
   
   iPos = InStr(sOldCaption, "&amp;")
   If (iPos &gt; 0) And (iPos &lt; Len(sOldCaption)) Then
      sToRemove = UCase(Mid(sOldCaption, iPos + 1, 1))
   End If
   
   If (sToAdd = sToRemove) Then
      Exit Sub
   Else
      If Len(sToRemove) &gt; 0 Then
         m_cMnemonics.RemoveByKey sToRemove
      End If
      m_cMnemonics.AddByKey sToAdd
      pUpdateMnemonics
   End If
End Sub

Private Function Replace(ByVal sString As String, ByVal sToReplace As String,
 ByVal sReplaceWith As String) As String
Dim iPos As Long
Dim iNextPos As Long
Dim sRet As String
   If Len(sString) &gt; 0 Then
      iPos = 1
      iNextPos = 1
      Do While (iNextPos &gt; 0)
         iNextPos = InStr(sString, iPos, sToReplace)
         If (iNextPos &gt; 0) Then
            sRet = sRet &amp; Mid(sString, iPos, iNextPos - iPos) &amp; sReplaceWith
            iPos = iNextPos + Len(sToReplace)
         End If
      Loop
      sRet = sRet &amp; Mid(sString, iPos)
      Replace = sRet
   End If
End Function

Private Sub pSetToolTip(ByVal sToolTip As String)
   If StrComp(sToolTip, m_sToolTip, vbTextCompare) &lt;&gt; 0 Then
      If Len(sToolTip) = 0 Then
         sToolTip = vbNullChar
      End If
      On Error Resume Next
      UserControl.Extender.ToolTipText = sToolTip
      m_sToolTip = sToolTip
   End If
End Sub

Private Sub pEnsureVisible(ByVal lIndex As Long)
   '
   Dim tR As RECT
   GetClientRect hwnd, tR
   
   Dim lOffset As Long
   If Not m_cScroll Is Nothing Then
      If (m_cScroll.Visible(efsVertical)) Then
         lOffset = m_cScroll.Value(efsVertical)
      End If
   End If
   
   Dim lTop As Long
   lTop = m_tItem(lIndex).yStart - lOffset - 3
   Dim lNewValue As Long
   If (lTop &lt; tR.top) Then
      ' need to scroll up
      lNewValue = m_cScroll.Value(efsVertical) - (tR.top - lTop)
      If (lNewValue &lt;= 2) Then
         lNewValue = 0
      End If
      pScrollTo lNewValue
   Else
      Dim lBottom As Long
      lBottom = m_tItem(lIndex).yStart - lOffset - 3 + m_tItem(lIndex).yExtent
      If (lBottom &gt; tR.bottom) Then
         ' need to scroll down
         lNewValue = m_cScroll.Value(efsVertical) + (lBottom - tR.bottom) + 6
         If (lNewValue &gt; m_cScroll.Max(efsVertical)) Then
            lNewValue = m_cScroll.Max(efsVertical)
         End If
         If (lNewValue &gt;= m_cScroll.Max(efsVertical) - 4) Then
            lNewValue = m_cScroll.Max(efsVertical)
         End If
         pScrollTo lNewValue
      End If
   End If
   '
End Sub

Private Sub pScrollTo(ByVal lNewPos As Long)
Dim lNow As Long
Dim lStepSize As Long
Dim bComplete As Boolean
Dim lNewValue As Long

   lNow = m_cScroll.Value(efsVertical)
   If (lNewPos &gt; lNow) Then
      lStepSize = 1
   Else
      lStepSize = -1
   End If
   
   Do While Not bComplete
      lNewValue = lNow + lStepSize
      If (lStepSize &lt; 0) Then
         If (lNewValue &lt; lNewPos) Then
            lNewValue = lNewPos
            bComplete = True
         End If
      Else
         If (lNewValue &gt; lNewPos) Then
            lNewValue = lNewPos
            bComplete = True
         End If
      End If
      m_cScroll.Value(efsVertical) = lNewValue
      lStepSize = lStepSize * 2
   Loop

End Sub

Private Sub pResize()
Dim bXp As Long
Dim i As Long
Dim lR As Long
Dim tTextBoundR As RECT
Dim tTextR As RECT
Dim hFontOld As Long
Dim iFnt As IFont
Dim tR As RECT
Dim hTheme As Long
Dim bShowScroll As Boolean
Static bScrollResize As Boolean

   If bScrollResize Then
      Exit Sub
   End If
   
   If (m_lItemCount &gt; 0) Then
      GetClientRect UserControl.hwnd, tR
      tR.left = tR.left + 3
      tR.right = tR.left + m_lButtonWidth - 6
      m_cMemDC.Width = m_lButtonWidth
      m_cMemDC.Height = tR.bottom - tR.top
   
      Set iFnt = UserControl.Font
      hFontOld = SelectObject(m_cMemDC.hDC, iFnt.hFont)
      
      ' Measure all the items &amp; count overall height
      bXp = m_bIsXp
      If (bXp) Then
         On Error Resume Next
         hTheme = OpenThemeData(UserControl.hwnd, StrPtr(UXTHEMEBUTTONCLASS))
         On Error GoTo 0
         If (hTheme = 0) Then
            bXp = False
         End If
      End If
   
      If (bXp) Then
         For i = 1 To m_lItemCount
            LSet tTextBoundR = tR
            InflateRect tTextBoundR, -6, -4
            LSet tTextR = tTextBoundR
            lR = GetThemeTextExtent( _
               hTheme, _
               m_cMemDC.hDC, _
               TP_BUTTON, _
               TS_NORMAL, _
               StrPtr(m_tItem(i).sCaption), -1, _
               DT_CENTER Or DT_WORDBREAK, _
               tTextBoundR, tTextR)
            If (i &gt; 1) Then
               m_tItem(i).yStart = m_tItem(i - 1).yStart + m_tItem(i -
                1).yExtent + 4
            Else
               m_tItem(i).yStart = 4
            End If
            m_tItem(i).yExtent = tTextR.bottom - tTextR.top + 4 + m_lIconSize +
             6
         Next i
         
         CloseThemeData hTheme
      Else
         For i = 1 To m_lItemCount
            LSet tTextR = tR
            InflateRect tTextR, -6, -4
            lR = DrawText( _
               m_cMemDC.hDC, _
               m_tItem(i).sCaption, _
               -1, _
               tTextR, _
               DT_CENTER Or DT_WORDBREAK Or DT_CALCRECT)
            If (i &gt; 1) Then
               m_tItem(i).yStart = m_tItem(i - 1).yStart + m_tItem(i -
                1).yExtent + 4
            Else
               m_tItem(i).yStart = 4
            End If
            m_tItem(i).yExtent = tTextR.bottom - tTextR.top + 4 + m_lIconSize +
             6
         Next i
      End If
      
      SelectObject m_cMemDC.hDC, hFontOld
   End If
   
   ' Are scroll bars required?
   If Not (m_cScroll Is Nothing) Then
      If (m_lItemCount &gt; 0) Then
         If (m_tItem(m_lItemCount).yExtent + m_tItem(m_lItemCount).yStart &gt;
          tR.bottom - tR.top) Then
            m_cScroll.Orientation = efsoVertical
            m_cScroll.Min(efsVertical) = 0
            m_cScroll.Max(efsVertical) = (m_tItem(m_lItemCount).yExtent +
             m_tItem(m_lItemCount).yStart - tR.bottom - tR.top) + 3
            m_cScroll.SmallChange(efsVertical) = 10
            m_cScroll.LargeChange(efsVertical) = tR.bottom - tR.top
            bScrollResize = Not (m_cScroll.Visible(efsVertical))
            m_cScroll.Visible(efsVertical) = True
         Else
            bScrollResize = m_cScroll.Visible(efsVertical)
            m_cScroll.Visible(efsVertical) = False
         End If
      Else
         bScrollResize = m_cScroll.Visible(efsVertical)
         m_cScroll.Visible(efsVertical) = False
      End If
   End If
      
   ' Resize the object
   If (bScrollResize) Or Not (m_lLastButtonWidth = m_lButtonWidth) Then
      If Not (m_cScroll Is Nothing) Then
         If (m_cScroll.Visible(efsVertical)) Then
            bShowScroll = True
         End If
      End If
   
      If (bShowScroll) Then
         On Error Resume Next
         UserControl.Extender.Width = UserControl.Extender.Container.ScaleX( _
            (m_lButtonWidth + GetSystemMetrics(SM_CXVSCROLL)), _
            vbPixels, _
            UserControl.Extender.Container.ScaleMode)
         If Not (Err.Number = 0) Then
            ' assume not being used in VB
         End If
      Else
         On Error Resume Next
         UserControl.Extender.Width = UserControl.Extender.Container.ScaleX( _
            m_lButtonWidth, _
            vbPixels, _
            UserControl.Extender.Container.ScaleMode)
         If Not (Err.Number = 0) Then
            ' assume not being used in VB
         End If
      End If
      bScrollResize = False
      m_lLastButtonWidth = m_lButtonWidth
   End If
       
End Sub

Private Function pScaleX(ByVal lPixels As Long) As Single
   pScaleX = UserControl.ScaleX(lPixels, vbPixels, UserControl.ScaleMode)
End Function
Private Function pUnScaleX(ByVal fWidth As Single) As Long
   pUnScaleX = UserControl.ScaleX(fWidth, vbPixels, UserControl.ScaleMode)
End Function

Public Property Get ScaleMode() As ScaleModeConstants
Attribute ScaleMode.VB_Description = "Gets/sets the scale mode used for the
 control."
   ScaleMode = UserControl.ScaleMode
End Property
Public Property Let ScaleMode(ByVal eMode As ScaleModeConstants)
   UserControl.ScaleMode = eMode
   PropertyChanged "ScaleMode"
End Property

Private Sub pClearBackground(tR As RECT)
Dim oBackColor As OLE_COLOR
Dim hBr As Long

   If (m_oBackColor = -1) Then
      If (m_bIsXp) Then
         oBackColor = vbButtonFace
      Else
         oBackColor = vbButtonShadow
      End If
   Else
      oBackColor = m_oBackColor
   End If
   
   If (oBackColor And &amp;H80000000) Then
      hBr = GetSysColorBrush(oBackColor And &amp;H1F&amp;)
   Else
      hBr = CreateSolidBrush(TranslateColor(oBackColor))
   End If
   
   FillRect m_cMemDC.hDC, tR, hBr
   
   DeleteObject hBr
   
End Sub

Private Sub pDrawItems(tR As RECT)
Dim i As Long
Dim hTheme As Long
Dim bXp As Boolean
Dim hFontOld As Long
Dim iFnt As IFont
Dim tItemR As RECT
Dim tContentR As RECT
Dim tIconR As RECT
Dim iStateId As Long
Dim lOffset As Long
Dim sClasses As String
Dim lPressOffset As Long
Dim hBr As Long
   
   Set iFnt = UserControl.Font
   hFontOld = SelectObject(m_cMemDC.hDC, iFnt.hFont)

   bXp = m_bIsXp
   If (bXp) Then
      On Error Resume Next
      hTheme = OpenThemeData(UserControl.hwnd, StrPtr(UXTHEMETOOLBARCLASS))
      On Error GoTo 0
      If (hTheme = 0) Then
         bXp = False
      End If
   End If
   
   If Not (m_cScroll Is Nothing) Then
      If (m_cScroll.Visible(efsVertical)) Then
         lOffset = m_cScroll.Value(efsVertical)
      End If
   End If

   If (bXp) Then
      
      For i = 1 To m_lItemCount
         LSet tItemR = tR
         tItemR.top = m_tItem(i).yStart
         tItemR.bottom = tItemR.top + m_tItem(i).yExtent
         OffsetRect tItemR, 0, -lOffset
         If (m_tItem(i).bEnabled) Then
            If (m_tItem(i).bMouseDown) Then
               If (m_tItem(i).bMouseOver) Then
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_HOTCHECKED
                  Else
                     iStateId = TS_PRESSED
                  End If
               Else
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_CHECKED
                  Else
                     iStateId = TS_HOT
                  End If
               End If
            Else
               If (m_tItem(i).bMouseOver) Then
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_HOTCHECKED
                  Else
                     iStateId = TS_HOT
                  End If
               Else
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_CHECKED
                  Else
                     iStateId = TS_NORMAL
                  End If
               End If
            End If
         Else
            iStateId = TS_DISABLED
         End If
         
         DrawThemeBackground hTheme, m_cMemDC.hDC, TP_BUTTON, iStateId, _
            tItemR, tItemR
         GetThemeBackgroundContentRect hTheme, m_cMemDC.hDC, TP_BUTTON,
          iStateId, _
            tItemR, tContentR
         
         If (iStateId = TS_DISABLED) Then
            CloseThemeData hTheme
            hTheme = OpenThemeData(UserControl.hwnd, StrPtr(UXTHEMEBUTTONCLASS))
            iStateId = PBS_DISABLED
         End If
         
         LSet tIconR = tContentR
         tIconR.left = tContentR.left + (tContentR.right - tContentR.left -
          m_lIconSize) \ 2
         tIconR.right = tIconR.left + m_lIconSize
         tIconR.top = tIconR.top + 4
         tIconR.bottom = tIconR.top + m_lIconSize
         If (iStateId = TS_PRESSED) Then
            OffsetRect tIconR, 1, 1
         End If
         
         If (m_tItem(i).bEnabled) Then
            If (m_ptrVB6ImageList = 0) Then
               DrawThemeIcon hTheme, m_cMemDC.hDC, TP_BUTTON, iStateId, _
                  tIconR, m_hIml, m_tItem(i).iIconIndex
            Else
               ' need to draw the icon using standard means
               ImageListDrawIcon m_ptrVB6ImageList, m_cMemDC.hDC, m_hIml, _
                  m_tItem(i).iIconIndex, _
                  tContentR.left + (tContentR.right - tContentR.left -
                   m_lIconSize) \ 2, _
                  tContentR.top + 4
               
            End If
         Else
            ImageListDrawIconDisabled m_ptrVB6ImageList, m_cMemDC.hDC, m_hIml, _
               m_tItem(i).iIconIndex, _
               tIconR.left, _
               tIconR.top, _
               m_lIconSize
         End If
         
         tContentR.top = tContentR.top + 4 + m_lIconSize
         InflateRect tContentR, -6, 0
         If (iStateId = TS_PRESSED) Then
            OffsetRect tContentR, 1, 1
         End If
                  
         DrawThemeText hTheme, m_cMemDC.hDC, BP_PUSHBUTTON, iStateId, _
            StrPtr(m_tItem(i).sCaption), -1, _
            DT_CENTER Or DT_WORDBREAK, _
            IIf(m_tItem(i).bEnabled, 0, DTT_GRAYED), _
            tContentR
      
         If (iStateId = TS_DISABLED) Then
            CloseThemeData hTheme
            hTheme = OpenThemeData(UserControl.hwnd,
             StrPtr(UXTHEMETOOLBARCLASS))
         End If
      
      Next i
      
      CloseThemeData hTheme
      
   Else
      
      SetBkMode m_cMemDC.hDC, TRANSPARENT
      For i = 1 To m_lItemCount
         LSet tItemR = tR
         tItemR.top = m_tItem(i).yStart
         tItemR.bottom = tItemR.top + m_tItem(i).yExtent
         OffsetRect tItemR, 0, -lOffset
         If (m_tItem(i).bEnabled) Then
            If (m_tItem(i).bMouseDown) Then
               If (m_tItem(i).bMouseOver) Then
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_HOTCHECKED
                  Else
                     iStateId = TS_PRESSED
                  End If
               Else
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_CHECKED
                  Else
                     iStateId = TS_HOT
                  End If
               End If
            Else
               If (m_tItem(i).bMouseOver) Then
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_HOTCHECKED
                  Else
                     iStateId = TS_HOT
                  End If
               Else
                  If (m_tItem(i).bSelected) Then
                     iStateId = TS_CHECKED
                  Else
                     iStateId = TS_NORMAL
                  End If
               End If
            End If
         Else
            iStateId = TS_DISABLED
         End If
         
         ' Draw background to item (if necessary);
         If (iStateId = TS_CHECKED) Then
            hBr = GetSysColorBrush(vbButtonFace And &amp;H1F&amp;)
            FillRect m_cMemDC.hDC, tItemR, hBr
            DeleteObject hBr
         End If
         ' Draw border:
         If (iStateId = TS_HOTCHECKED) Or (iStateId = TS_CHECKED) Then
            DrawEdgeAPI m_cMemDC.hDC, tItemR, BDR_SUNKEN, BF_RECT Or BF_SOFT
         ElseIf (iStateId = TS_HOT) Then
            DrawEdgeAPI m_cMemDC.hDC, tItemR, BDR_RAISED, BF_RECT Or BF_SOFT
         ElseIf (iStateId = TS_PRESSED) Then
            DrawEdgeAPI m_cMemDC.hDC, tItemR, BDR_SUNKEN, BF_RECT Or BF_SOFT
         End If
                  
         LSet tContentR = tItemR
         InflateRect tContentR, -2, -2
                  
         LSet tIconR = tItemR
         tIconR.left = tContentR.left + (tContentR.right - tContentR.left -
          m_lIconSize) \ 2
         tIconR.right = tIconR.left + m_lIconSize
         tIconR.top = tIconR.top + 4
         tIconR.bottom = tIconR.top + m_lIconSize
         If (iStateId = TS_PRESSED) Then
            OffsetRect tIconR, 1, 1
         End If
         
         If (m_tItem(i).bEnabled) Then
            ImageListDrawIcon m_ptrVB6ImageList, m_cMemDC.hDC, m_hIml, _
               m_tItem(i).iIconIndex, _
               tIconR.left + (tIconR.right - tIconR.left - m_lIconSize) \ 2, _
               tIconR.top + 4
         Else
            ImageListDrawIconDisabled m_ptrVB6ImageList, m_cMemDC.hDC, m_hIml, _
               m_tItem(i).iIconIndex, _
               tIconR.left, _
               tIconR.top, _
               m_lIconSize
         End If
         
         tContentR.top = tContentR.top + 4 + m_lIconSize
         InflateRect tContentR, -6, 0
         If (iStateId = TS_PRESSED) Then
            OffsetRect tContentR, 1, 1
         End If
                  
         If (iStateId = TS_DISABLED) Then
            SetTextColor m_cMemDC.hDC, TranslateColor(vb3DHighlight)
            OffsetRect tContentR, 1, 1
         Else
            SetTextColor m_cMemDC.hDC, TranslateColor(UserControl.ForeColor)
         End If
         DrawText m_cMemDC.hDC, _
            m_tItem(i).sCaption, -1, _
            tContentR, _
            DT_CENTER Or DT_WORDBREAK
         If (iStateId = TS_DISABLED) Then
            SetTextColor m_cMemDC.hDC, TranslateColor(vbButtonShadow)
            OffsetRect tContentR, -1, -1
            DrawText m_cMemDC.hDC, _
               m_tItem(i).sCaption, -1, _
               tContentR, _
               DT_CENTER Or DT_WORDBREAK
         End If
            
      Next i
      
   End If
   
   SelectObject m_cMemDC.hDC, hFontOld
   
End Sub

Private Sub pPaint()
Dim tR As RECT
   
   ' Prepare memory DC:
   GetClientRect UserControl.hwnd, tR
   m_cMemDC.Width = m_lButtonWidth
   m_cMemDC.Height = tR.bottom - tR.top
   
   ' Clear the background:
   pClearBackground tR
   
   ' Draw all items in turn:
   tR.left = tR.left + 3
   tR.right = tR.left + m_lButtonWidth - 6

   pDrawItems tR
   
   ' Swap memory DC into UserControl:
   m_cMemDC.Draw UserControl.hDC, 0, 0, m_lButtonWidth, tR.bottom - tR.top

End Sub

Private Function plHitTest() As Long
   Dim tP As POINTAPI
   GetCursorPos tP
   ScreenToClient UserControl.hwnd, tP
   plHitTest = plHitTestPoint(tP.x, tP.y)
End Function

Private Function plHitTestPoint(ByVal x As Long, ByVal y As Long) As Long
Dim i As Long
Dim lOffset As Long
Dim tR As RECT

   GetClientRect UserControl.hwnd, tR
   If Not (PtInRect(tR, x, y) = 0) Then
      If (x &gt;= 3) And (x &lt;= m_lButtonWidth - 6) Then
         If Not (m_cScroll Is Nothing) Then
            If (m_cScroll.Visible(efsVertical)) Then
               lOffset = m_cScroll.Value(efsVertical)
            End If
         End If
         For i = 1 To m_lItemCount
            If (y &gt;= m_tItem(i).yStart - lOffset) Then
               If (y &lt;= m_tItem(i).yStart + m_tItem(i).yExtent - lOffset) Then
                  plHitTestPoint = i
                  Exit For
               End If
            End If
         Next i
      End If
   End If
End Function

Private Function plSelectNext( _
      ByVal lCurrent As Long, _
      ByVal lDir As Long _
   )
Dim bFound As Boolean
Dim lNewIndex As Long
Dim lLastChecked As Long
   
   lLastChecked = lCurrent
   Do While Not (bFound)
      lNewIndex = lLastChecked + lDir
      
      If (lNewIndex &lt; 1) Or (lNewIndex &gt; m_lItemCount) Then
         If (Abs(lDir) &gt; 1) Then
            ' equivalent to hitting Home or End:
            If (Sgn(lDir) = 1) Then
               ' End
               lNewIndex = m_lItemCount
               Do While Not bFound
                  If (m_tItem(lNewIndex).bEnabled) Then
                     bFound = True
                  Else
                     lNewIndex = lNewIndex - 1
                     If (lNewIndex &lt; 1) Then
                        bFound = True
                     End If
                  End If
               Loop
            Else
               ' Home
               lNewIndex = 1
               Do While Not bFound
                  If (m_tItem(lNewIndex).bEnabled) Then
                     bFound = True
                  Else
                     lNewIndex = lNewIndex + 1
                     If (lNewIndex &gt; m_lItemCount) Then
                        bFound = True
                     End If
                  End If
               Loop
            End If
         End If
         bFound = True
      Else
         lLastChecked = lNewIndex
         If (m_tItem(lNewIndex).bEnabled) Then
            bFound = True
         End If
         lDir = Sgn(lDir)
      End If
   Loop
   plSelectNext = lNewIndex
   
End Function

Private Sub pShortcutSelect(ByVal sKey As String)
Dim j As Long
   For j = 1 To m_lItemCount
      If (InStr(UCase(m_tItem(j).sCaption), "&amp;" &amp; sKey) &gt; 0) Then
         ' SPM: Bug fix 2003-06-07: Don't allow a disabled item
         ' to be selected by its mnemonic:
         If (ItemEnabled(j)) Then
            ItemSelected(j) = True
            pEnsureVisible j
            RaiseEvent ItemClick(j)
         End If
         Exit For
      End If
   Next j
End Sub

Private Sub ImageListDrawIcon( _
        ByVal ptrVb6ImageList As Long, _
        ByVal hDC As Long, _
        ByVal hIml As Long, _
        ByVal iIconIndex As Long, _
        ByVal lX As Long, _
        ByVal lY As Long, _
        Optional ByVal bSelected As Boolean = False, _
        Optional ByVal bBlend25 As Boolean = False _
    )
Dim lFlags As Long
Dim lR As Long

    lFlags = ILD_TRANSPARENT
    If (bSelected) Then
        lFlags = lFlags Or ILD_SELECTED
    End If
    If (bBlend25) Then
        lFlags = lFlags Or ILD_BLEND25
    End If
    If (ptrVb6ImageList &lt;&gt; 0) Then
        Dim o As Object
        On Error Resume Next
        Set o = ObjectFromPtr(ptrVb6ImageList)
        If Not (o Is Nothing) Then
            o.ListImages(iIconIndex + 1).Draw hDC, lX * Screen.TwipsPerPixelX,
             lY * Screen.TwipsPerPixelY, lFlags
        End If
        On Error GoTo 0
    Else
        lR = ImageList_Draw( _
                hIml, _
                iIconIndex, _
                hDC, _
                lX, _
                lY, _
                lFlags)
        If (lR = 0) Then
            Debug.Print "Failed to draw Image: " &amp; iIconIndex &amp; " onto hDC " &amp;
             hDC, "ImageListDrawIcon"
        End If
    End If
End Sub
Private Sub ImageListDrawIconDisabled( _
        ByVal ptrVb6ImageList As Long, _
        ByVal hDC As Long, _
        ByVal hIml As Long, _
        ByVal iIconIndex As Long, _
        ByVal lX As Long, _
        ByVal lY As Long, _
        ByVal lSize As Long, _
        Optional ByVal asShadow As Boolean _
    )
Dim lR As Long
Dim hIcon As Long
Dim idp As IMAGELISTDRAWPARAMS

   'If (ptrVb6ImageList = 0) And (m_bIsXp) Then
   '   idp.cbSize = Len(idp)
   '   idp.hIml = m_hIml
   '   idp.hdcDst = hdc
   '   idp.rgbBk = -1
   '   idp.fState = ILD_PRESERVEALPHA Or ILD_IMAGE
   '   idp.x = lX
   '   idp.y = lY
   '   idp.i = iIconIndex
   '   idp.fState = ILS_SATURATE
   '   idp.Frame = 128
   '   lR = ImageList_DrawIndirect(idp)
   '   Debug.Print lR
   'Else

      hIcon = 0
      If (ptrVb6ImageList &lt;&gt; 0) Then
         Dim o As Object
         On Error Resume Next
         Set o = ObjectFromPtr(ptrVb6ImageList)
         If Not (o Is Nothing) Then
            
            Dim lhDCDisp As Long
            Dim lhDC As Long
            Dim lhBmp As Long
            Dim lhBmpOld As Long
            Dim lhIml As Long
                     
            lhDCDisp = CreateDCAsNull("DISPLAY", ByVal 0&amp;, ByVal 0&amp;, ByVal 0&amp;)
            lhDC = CreateCompatibleDC(lhDCDisp)
            lhBmp = CreateCompatibleBitmap(lhDCDisp, o.ImageWidth,
             o.ImageHeight)
            DeleteDC lhDCDisp
            lhBmpOld = SelectObject(lhDC, lhBmp)
            o.ListImages.Item(iIconIndex + 1).Draw lhDC, 0, 0, 0
            SelectObject lhDC, lhBmpOld
            DeleteDC lhDC
            lhIml = ImageList_Create(o.ImageWidth, o.ImageHeight, ILC_MASK Or
             ILC_COLOR32, 1, 1)
            ImageList_AddMasked lhIml, lhBmp, TranslateColor(o.BackColor)
            DeleteObject lhBmp
            hIcon = ImageList_GetIcon(lhIml, 0, 0)
            ImageList_Destroy lhIml
            
         End If
         On Error GoTo 0
      Else
         hIcon = ImageList_GetIcon(hIml, iIconIndex, 0)
      End If
      If (hIcon &lt;&gt; 0) Then
         If (asShadow) Then
            Dim hBr As Long
            hBr = GetSysColorBrush(vb3DShadow And &amp;H1F)
            lR = DrawState(hDC, hBr, 0, hIcon, 0, lX, lY, lSize, lSize,
             DST_ICON Or DSS_MONO)
            DeleteObject hBr
         Else
            lR = DrawState(hDC, 0, 0, hIcon, 0, lX, lY, lSize, lSize, DST_ICON
             Or DSS_DISABLED)
         End If
         DestroyIcon hIcon
      End If
   'End If
End Sub
Private Property Get ObjectFromPtr(ByVal lPtr As Long) As Object
Dim oTemp As Object
   ' Turn the pointer into an illegal, uncounted interface
   CopyMemory oTemp, lPtr, 4
   ' Do NOT hit the End button here! You will crash!
   ' Assign to legal reference
   Set ObjectFromPtr = oTemp
   ' Still do NOT hit the End button here! You will still crash!
   ' Destroy the illegal reference
   CopyMemory oTemp, 0&amp;, 4
   ' OK, hit the End button if you must--you'll probably still crash,
   ' but it will be because of the subclass, not the uncounted reference
End Property

' Convert Automation color to Windows color
Private Function TranslateColor(ByVal clr As OLE_COLOR, _
                        Optional hPal As Long = 0) As Long
    If OleTranslateColor(clr, hPal, TranslateColor) Then
        TranslateColor = -1
    End If
End Function

Private Sub pInitialise()
   If (UserControl.Ambient.UserMode) Then
      m_bRunTime = True
      Set m_cScroll = New pcScrollBars
      m_cScroll.Create UserControl.hwnd
      Set m_tmr = New CTimer
   End If
End Sub
Private Sub pTerminate()
   If Not m_tmr Is Nothing Then
      m_tmr.Interval = 0
      Set m_tmr = Nothing
   End If
   If Not m_cScroll Is Nothing Then
      Set m_cScroll = Nothing
   End If
   Set m_cMemDC = Nothing
End Sub

Private Sub pUpdateMnemonics()
   If (UserControl.AccessKeys = "") Then
      UserControl.AccessKeys = " "
   Else
      UserControl.AccessKeys = ""
   End If
   UserControl.Refresh
End Sub

Friend Function GetControlInfo(pCI As CONTROLINFO) As Long
   
   pCI.cb = LenB(pCI)
   pCI.cAccel = m_cMnemonics.Count
   pCI.hAccel = m_cMnemonics.hAccel
   pCI.dwFlags = 0
   
End Function
Friend Function OnMnemonic(pMsg As MSG) As Long
Dim i As Long
   
   If (pMsg.Message = WM_SYSCHAR Or pMsg.Message = WM_SYSKEYDOWN) Then
      For i = 1 To m_cMnemonics.Count
         If (pMsg.wParam = m_cMnemonics.VirtKey(i)) Then
            ' Got a mnemonic:
            pShortcutSelect m_cMnemonics.Key(i)
            Exit For
         End If
      Next i
   End If
   
End Function


Private Sub m_cScroll_Change(eBar As EFSScrollBarConstants)
   '
   pPaint
   '
End Sub

Private Sub m_cScroll_Scroll(eBar As EFSScrollBarConstants)
   '
   pPaint
   '
End Sub

Private Sub m_cScroll_ScrollClick(eBar As EFSScrollBarConstants, eButton As
 MouseButtonConstants)
   If Not (m_bFocus) Then
      UserControl.SetFocus
   End If
End Sub

Private Sub m_tmr_ThatTime()
Dim i As Long
Dim lIndex As Long
   For i = 1 To m_lItemCount
      If (m_tItem(i).bMouseDown) Then
         Exit Sub
      Else
         If (m_tItem(i).bMouseOver) Then
            lIndex = i
         End If
      End If
   Next i
   
   If (lIndex &gt; 0) Then
      If (plHitTest() = 0) Then
         pSetToolTip ""
         m_tItem(lIndex).bMouseOver = False
         m_tmr.Interval = 0
         pPaint
      End If
   Else
      m_tmr.Interval = 0
      pSetToolTip ""
   End If
End Sub

Private Sub UserControl_GotFocus()
   m_bFocus = True
' Deprecated - replaced with IOleControl implementation
'Dim sKeys As String
'Dim i As Long
'Dim sKey As String
'   If (GetAsyncKeyState(vbKeyMenu) And &amp;H8000&amp;) = &amp;H8000&amp; Then
'      sKeys = UserControl.AccessKeys
'      For i = 1 To Len(sKeys)
'         sKey = Mid$(sKeys, i, 1)
'         If (GetAsyncKeyState(Asc(sKey)) And &amp;H8000&amp;) = &amp;H8000&amp; Then
'            pShortcutSelect sKey
'            Exit For
'         End If
'      Next i
'   End If
End Sub

Private Sub UserControl_Initialize()
   '
   'MsgBox "UC:Init"
   
   ' Get the IOLEControl interface of the control
   Dim IOleCtl As IOleControl
   Set IOleCtl = Me
   ' Replace IOLEControl methods:
   m_ptrGetControlInfoOrig = ReplaceVTableEntry( _
      ObjPtr(IOleCtl), _
      IDX_GetControlInfo, _
      AddressOf mIOleControl.IOleControl_GetControlInfo, _
      ObjPtr(Me) _
      )
   m_ptrOnMnemonicOrg = ReplaceVTableEntry( _
      ObjPtr(IOleCtl), _
      IDX_OnMnemonic, _
      AddressOf mIOleControl.IOleControl_OnMnemonic, _
      ObjPtr(Me) _
      )

   ' Create object to manage Mnemonics for this control:
   Set m_cMnemonics = New pcMnemonics
      
   ' Set up version information:
   Dim lMajor As Long
   Dim lMinor As Long
   
   GetWindowsVersion lMajor, lMinor, , , m_bIsNt
   If (lMajor &gt; 5) Then
      m_bIsXp = True
   ElseIf (lMajor = 5) And (lMinor &gt;= 1) Then
      m_bIsXp = True
   End If
   
   ' General helper objects:
   Set m_cMemDC = New pcMemDC
   m_oBackColor = -1
   m_oForeColor = -1
   m_lButtonWidth = 84
   '
End Sub

Private Sub UserControl_InitProperties()
   '
   pInitialise
   '
End Sub

Private Sub UserControl_KeyDown(KeyCode As Integer, Shift As Integer)
Debug.Print "KeyDown"
Dim sKeys As String
Dim sKey As String
Dim i As Long
Dim j As Long
Dim eKeyCode As KeyCodeConstants
Dim eShift As ShiftConstants
   
   eKeyCode = KeyCode
   eShift = Shift
   
   RaiseEvent KeyDown(eKeyCode, eShift)
   
   If ((Shift And vbAltMask) = vbAltMask) Then
' Deprecated - replaced by IOleControl OnMnemonic processing
'      sKeys = UserControl.AccessKeys
'      For i = 1 To Len(sKeys)
'         sKey = Mid$(sKeys, i, 1)
'         If (Asc(UCase(sKey)) = KeyCode) Or (Asc(LCase(sKey)) = KeyCode) Then
'            Exit For
'         End If
'      Next i
   Else
      If (m_lItemCount &gt; 0) Then
         Dim lNewIndex As Long
         Dim lCurrentIndex As Long
         Dim lMouseOverIndex As Long
         Dim bFound As Boolean
         
         For i = 1 To m_lItemCount
            If (m_tItem(i).bMouseOver) Then
               lMouseOverIndex = i
            End If
            If (m_tItem(i).bSelected) Then
               lCurrentIndex = i
            End If
         Next i
         
         If (lMouseOverIndex &gt; 0) Then
            lCurrentIndex = lMouseOverIndex
         End If
         
         Select Case KeyCode
         Case vbKeyUp
            lNewIndex = plSelectNext(lCurrentIndex, -1)
         Case vbKeyDown
            lNewIndex = plSelectNext(lCurrentIndex, 1)
         Case vbKeyPageUp
            lNewIndex = plSelectNext(lCurrentIndex, -4)
         Case vbKeyPageDown
            lNewIndex = plSelectNext(lCurrentIndex, 4)
         Case vbKeyHome
            lNewIndex = 1
            Do While Not bFound
               If (m_tItem(lNewIndex).bEnabled) Then
                  bFound = True
               Else
                  lNewIndex = lNewIndex + 1
                  If (lNewIndex &gt; m_lItemCount) Then
                     bFound = True
                  End If
               End If
            Loop
         Case vbKeyEnd
            lNewIndex = m_lItemCount
            Do While Not bFound
               If (m_tItem(lNewIndex).bEnabled) Then
                  bFound = True
               Else
                  lNewIndex = lNewIndex - 1
                  If (lNewIndex &lt; 1) Then
                     bFound = True
                  End If
               End If
            Loop
         Case vbKeyReturn
            If (lMouseOverIndex &gt; 0) Then
               ItemSelected(lMouseOverIndex) = True
               m_tItem(lMouseOverIndex).bMouseOver = False
               pEnsureVisible lMouseOverIndex
               RaiseEvent ItemClick(lMouseOverIndex)
            End If
         Case Else
            pShortcutSelect Chr$(KeyCode)
         End Select
         
         If (lNewIndex &lt;&gt; lCurrentIndex) And (lNewIndex &gt; 0) And (lNewIndex &lt;=
          m_lItemCount) Then
            For i = 1 To m_lItemCount
               If (i = lNewIndex) Then
                  m_tItem(i).bMouseOver = True
               Else
                  m_tItem(i).bMouseOver = False
               End If
            Next i
            pEnsureVisible lNewIndex
            pPaint
         End If
         
      End If
   End If
End Sub

Private Sub UserControl_KeyPress(KeyAscii As Integer)
Debug.Print "KeyPress"
   RaiseEvent KeyPress(KeyAscii)
End Sub

Private Sub UserControl_KeyUp(KeyCode As Integer, Shift As Integer)
Dim eKeyCode As KeyCodeConstants
Dim eShift As ShiftConstants
   
   eKeyCode = KeyCode
   eShift = Shift

   RaiseEvent KeyUp(eKeyCode, eShift)
End Sub

Private Sub UserControl_LostFocus()
Dim i As Long
Dim bUpdate As Boolean
   For i = 1 To m_lItemCount
      If (m_tItem(i).bMouseOver) Then
         m_tItem(i).bMouseOver = False
         bUpdate = True
      End If
   Next i
   If (bUpdate) Then
      pPaint
   End If
   m_bFocus = False
End Sub

Private Sub UserControl_MouseDown(Button As Integer, Shift As Integer, x As
 Single, y As Single)
   '
Dim eButton As MouseButtonConstants
Dim eShift As ShiftConstants

   RaiseEvent MouseDown(eButton, eShift, x, y)
   
   m_tmr.Interval = 0
   Dim lIndex As Long
   
   lIndex = plHitTest()
   If (lIndex &gt; 0) Then
      If (Button = vbLeftButton) Then
         m_tItem(lIndex).bMouseDown = True
         pPaint
      ElseIf (Button = vbRightButton) Then
         RaiseEvent ItemRightClick(lIndex, x, y)
      End If
   ElseIf (Button = vbRightButton) Then
      RaiseEvent BarRightClick(x, y)
   End If
   '
End Sub

Private Sub UserControl_MouseMove(Button As Integer, Shift As Integer, x As
 Single, y As Single)
   '
Dim eButton As MouseButtonConstants
Dim eShift As ShiftConstants
   
   RaiseEvent MouseMove(eButton, eShift, x, y)
   
   Dim lIndex As Long
   Dim i As Long
   Dim bChange As Boolean
   
   lIndex = plHitTest()
   For i = 1 To m_lItemCount
      If (i = lIndex) Then
         If Not (m_tItem(i).bMouseOver) Then
            pSetToolTip m_tItem(i).sToolTip
            m_tItem(i).bMouseOver = True
            bChange = True
         End If
      Else
         If (m_tItem(i).bMouseOver) Then
            m_tItem(i).bMouseOver = False
            bChange = True
         End If
      End If
   Next i
   If (lIndex = 0) Then
      pSetToolTip ""
   End If
   
   If (bChange) Then
      pPaint
   End If
   
   If (Button = 0) Then
      If (m_tmr.Interval = 0) Then
         m_tmr.Interval = 50
      End If
   Else
      If (m_tmr.Interval &gt; 0) Then
         m_tmr.Interval = 0
      End If
   End If
   '
End Sub

Private Sub UserControl_MouseUp(Button As Integer, Shift As Integer, x As
 Single, y As Single)
   '
Dim eButton As MouseButtonConstants
Dim eShift As ShiftConstants
   
   RaiseEvent MouseUp(eButton, eShift, x, y)
   
   If (Button = vbLeftButton) Then
      Dim i As Long
      Dim bChange As Boolean
      For i = 1 To m_lItemCount
         If (m_tItem(i).bMouseDown) Then
            If (plHitTest() = i) Then
               If (m_tItem(i).bEnabled) Then
                  ' Click
                  m_tItem(i).bMouseDown = False
                  ItemSelected(i) = True
                  pEnsureVisible i
                  RaiseEvent ItemClick(i)
               Else
                  m_tItem(i).bMouseDown = False
               End If
            Else
               ' no click
               m_tItem(i).bMouseDown = False
               bChange = True
            End If
         End If
      Next i
      If (bChange) Then
         pPaint
      End If
   End If
   '
End Sub

Private Sub UserControl_Paint()
   '
   pPaint
   '
End Sub

Private Sub UserControl_ReadProperties(PropBag As PropertyBag)
   '
   BackColor = PropBag.ReadProperty("BackColor", -1)
   Dim sFnt As New StdFont
   sFnt.Name = "Tahoma"
   sFnt.SIZE = 8
   Set Font = PropBag.ReadProperty("Font", sFnt)
   m_lButtonWidth = PropBag.ReadProperty("ButtonWidth", 96)
   ScaleMode = PropBag.ReadProperty("ScaleMode", vbTwips)
   
   pInitialise
   '
End Sub

Private Sub UserControl_Resize()
   '
   pResize
   RaiseEvent Resize
   '
End Sub

Private Sub UserControl_Show()
   '
   pResize
   '
End Sub

Private Sub UserControl_Terminate()
   '
   'MsgBox "UC:Term"
   pTerminate
      
   ' Clear up IOLEControl interface of the control
   Dim IOleCtl As IOleControl
   Set IOleCtl = Me
   ' Restore IOleControl methods:
   ReplaceVTableEntry _
      ObjPtr(IOleCtl), _
      IDX_GetControlInfo, _
      m_ptrGetControlInfoOrig
   ReplaceVTableEntry _
      ObjPtr(IOleCtl), _
      IDX_OnMnemonic, _
      m_ptrOnMnemonicOrg
   '
End Sub

Private Sub UserControl_WriteProperties(PropBag As PropertyBag)
   '
   PropBag.WriteProperty "BackColor", BackColor, -1
   Dim sFnt As New StdFont
   sFnt.Name = "Tahoma"
   sFnt.SIZE = 8
   PropBag.WriteProperty "Font", Font, sFnt
   PropBag.WriteProperty "ButtonWidth", m_lButtonWidth, 96
   PropBag.WriteProperty "ScaleMode", ScaleMode, vbTwips
   '
End Sub


</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ListBar</a>&#160;.&#160;<a href="article.html">Button ListBar Control</a>&#160;.&#160;<a href="vb5_button_listbar_full_source.html">VB5 Button ListBar Full Source</a>&#160;.&#160;vbalARListBar.ctl</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 5 July 2003</p></td><td></td></tr></table>
</body></html>