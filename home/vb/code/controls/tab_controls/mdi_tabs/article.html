<html lang="en" >
<head>

<title>vbAccelerator - vbAccelerator MDITabs Control</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="Over the years, Microsoft applications have been moving away from the old Multiple Document Interface style to
a more modern look.  This component, provided as a DLL, automatically converts a VB MDI application to one which
looks like Visual Studio, with a tab for each window.  Tabs can be scrolled and repositioned by the user and you
get an excellent usable interface with virtually no extra code.  Note however that this implementation does not
allow undocking or multiple tab groups." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Tab Controls</a>&#160;.&#160;vbAccelerator MDITabs Control</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_mditabs_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 MDITabs Binary</a> (14K)</p><p class="nav"><a href="vb5_mditabs_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 MDITabs Demonstration</a> (50K)</p><p class="nav"><a href="vb5_mditabs_full_source_code.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 MDITabs Full Source Code</a> (79K)</p><p /><p class="nav"><a href="vb6_mditabs_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 MDITabs Binary</a> (15K)</p><p class="nav"><a href="vb6_mditabs_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 MDITabs Demonstration</a> (46K)</p><p class="nav"><a href="vb6_mditabs_full_source_code.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 MDITabs Full Source Code</a> (77K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:2310</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=2310&type=article&title=vbaccelerator_20mditabs_20control.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />28 Mar 2003<br /><p class="update">Correction to colour selection logic; background colour
of tabs now renders correctly under all colour schemes.</p><p class="update">Minor drawing and tab selection logic fixes.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\graphics_and_gdi\flicker_free_api_drawing\article.html">Flicker Free API Drawing</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\toolbar\vbaccelerator_toolbar_and_coolmenu_control\article.html">vbAccelerator Toolbar and CoolMenu Control v3.5</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator MDITabs Control</h1><p class="splash">Convert MDI forms to a Visual Studio style tabbed display</p><img src="mditabs.png" width="363" height="266" alt="MDI Tabs Demonstration" /><p /><p>Over the years, Microsoft applications have been moving away from the old Multiple Document Interface style to
a more modern look.  This component, provided as a DLL, automatically converts a VB MDI application to one which
looks like Visual Studio, with a tab for each window.  Tabs can be scrolled and repositioned by the user and you
get an excellent usable interface with virtually no extra code.  Note however that this implementation does not
allow undocking or multiple tab groups.</p><h2>Moving from MDI</h2><p>There are a number of different ways you can achieve this: when File Manager was replaced by Explorer, 
Microsoft opted for a single document interface (SDI) which allows you to open multiple windows.  In 
Outlook, different windows are selected by the Folders view and Outlook bar, whilst in Visual Studio
multiple windows are shown open but in different tabs.</p><p>The <a href="..\..\toolbar\vbaccelerator_toolbar_and_coolmenu_control\article.html">vbAccelerator Toolbar and CoolMenu control</a> allows you to create an 
Outlook-style application with the option to hide the MDI control buttons whilst forms are maximised.
However, if you wanted to create a Visual Studio style application that way, with tabs for each of the forms
it would be difficult since you would need to draw a tab control below the toolbar and somehow synchronise
that with each of the windows.</p><p>This article provides a component which automates setting up Visual Studio style tabs for MDI applications
and provides all of the code to scroll and remove and replace tabs.</p><h2>Limitations</h2><p>The Visual Studio tabbed MDI window is considerably more powerful than this implementation, since it
additionally allows undocking of panes, and creation of separate tab groups.  Unfortunately this is 
extremely difficult in Visual Basic, since you would need to be able to change the parent of a form
object, something I have not found a reliable way to do despite (literally) years of experimentation.</p><p>Despite this, a tabbed application interface still adds to the impact of an application, and similar 
techniques are used to good effect in applications like <a href="javascript:window.alert(&quot;http://www.xmlspy.com/\nThis link was not retrieved.&quot;)">Altova's XML Spy</a>.</p><h2>How to Use It</h2><p>There are four steps you need to perform when using this component:</p><ol><li>Add a reference to the vbAccelerator MDITabs component and create a <i>WithEvents</i>  instance of 
it in your main MDI form.</li><li>Modify all of the MDI child windows in your application so they have no control box or minimise button.
For maximum smoothness of display, you can also set the <i>WindowState</i> property to 2 (Maximized)
so the form initally loads maximised.</li><li>Whenever you create an MDI child window, change its caption or unload an MDI child window, call the 
<i>ForceRefresh</i> method of the component.</li><li>Respond to the <i>CloseWindow</i> event of the component in order to unload an MDI child form.</li></ol><p>That's really all you need to do to make it work.  You can enhance the interface by responding to
<i>TabClick</i> and <i>TabBarClick</i> events as well, which you can use to show a popup menu in
front of the tab or the tab bar area that's been clicked on.  You can also choose whether the 
tabs are shown above or below the forms using the <i>TabAlign</i> property, and switch whether the
tabs are scrollable or squash up to fit the available space by setting the <i>AllowScroll</i>
property.  By default the component is configured to allow scrolling. Finally, you can change
the font used to display the tabs through the <i>Font</i> and <i>SelectedFont</i> properties.</p><h2>How It Works</h2><p>When an MDI window is created, Windows actually creates two separate windows: the main MDI 
window itself and also a window to hold the MDI child windows, called the MDIClient.  You can
see this by inspecting a MDI window using Windows Spy or similar tool:</p><img src="mdiwindow.png" width="355" height="457" alt="Simple MDI Form Showing Windows" /><p>Next we note that unless the child form has a Control Box, when it is maximised Windows
does not display the MDI control buttons (minimise, maximise, close) in the menu bar.</p><img src="nomdicontrolbuttons.png" width="272" height="173" alt="Effect of removing control box when MDI Child is Maximised" /><p>Clearly this is close to the tabbed display in Visual Studio, all that is missing are the tabs
themselves and the fact that there is a thick inset border around the child form.  Removing the
thick inset border is straightforward: the MDIClient window itself has this border, and it is
drawn by Windows because the MDIClient window has the <i>WS_EX_CLIENTEDGE</i> extended window style set.
This can be removed using the <i>GetWindowLong</i> and <i>SetWindowLong</i> Win32 API calls once
you know the handle of the MDIClient window.  To get the handle of the MDIClient, just use the Win32
<i>FindWindowEx</i> call:</p><pre>
Private Declare Function FindWindowEx Lib "user32" Alias "FindWindowExA" _
   (ByVal hWnd1 As Long, ByVal hWnd2 As Long, _
    ByVal lpsz1 As String, lpsz2 As Any) As Long
...

   hWndMdiClient = FindWindowEx( _
                        hWndMdi, 0, "MDIClient", ByVal 0&amp;)
</pre><p>Drawing the tabs themselves is more tricky.  There are two possible approaches:</p><ol><li>Add a control to the MDI form which aligns above the MDI child windows.  Then draw the
tabs in that.</li><li>Modify the non-client area of the MDI child window so the actual child windows are
pushed down, and then draw the tabs in the non-client area.</li></ol><p>Whilst the first method would be simple to implement, unfortunately it isn't possible
to do in VB under all cases.  The reason for this is that any control which is aligned to 
the top of a form extends the whole width of the form.  Therefore if you wanted to have
any left- or right-aligned components in the MDI window these would appear below the 
tab strip.  This would prevent you, for example, from implementing a typical DevStudio-style
interface with a toolbox and properties window.</p><p>Therefore we need to draw the MDI tabs into the non-client area.  To modify the size of
the non-client area of a window, you need to intercept the Windows <i>WM_NCCALCSIZE</i>
message.  This allows you to suggest an alternative size (or positioning) of the 
non-client area:</p><pre>
' Types needed for NCCALCSIZE processing:
Private Type RECT
    Left As Long
    Top As Long
    Right As Long
    Bottom As Long
End Type
Private Type WINDOWPOS
   hWnd As Long
   hWndInsertAfter As Long
   x As Long
   y As Long
   cx As Long
   cy As Long
   flags As Long
End Type
Private Type NCCALCSIZE_PARAMS
   rgrc(0 To 2) As RECT
   lppos As Long 'WINDOWPOS
End Type

' The WM_NCCALCSIZE message:
Private Const WM_NCCALCSIZE = &amp;H83

' WM_NCCALCSIZE return values;
Private Enum E_WM_NCCALCSIZE_Return_Values
   WVR_ALIGNBOTTOM = &amp;H40
   WVR_ALIGNLEFT = &amp;H20
   WVR_ALIGNRIGHT = &amp;H80
   WVR_ALIGNTOP = &amp;H10
   WVR_HREDRAW = &amp;H100
   WVR_VALIDRECTS = &amp;H400
   WVR_VREDRAW = &amp;H200
   WVR_REDRAW = (WVR_HREDRAW Or WVR_VREDRAW)
End Enum

...

Private Function ISubclass_WindowProc( _
   ByVal hWnd As Long, ByVal iMsg As Long, _
   ByVal wParam As Long, ByVal lParam As Long) As Long

   Case WM_NCCALCSIZE
      'Debug.Print "WM_NCCALCSIZE"
      Dim tNCR As NCCALCSIZE_PARAMS
      Dim tWP As WINDOWPOS
      
      If wParam &lt;&gt; 0 Then

         ' lParam containts a pointer to the 
         ' NCCALCSIZE_PARAMS structure:
         CopyMemory tNCR, ByVal lParam, Len(tNCR)

         ' the NCCALCSIZE_PARAMS structure contains
         ' a pointer to the WINDOWPOS structure:
         CopyMemory tWP, ByVal tNCR.lppos, Len(tWP)

         ' Set the first rectangle to the WINDOWPOS
         ' size:
         With tNCR.rgrc(0)
            .Left = tWP.x
            .Top = tWP.y
            .Right = tWP.x + tWP.cx
            .Bottom = tWP.y + tWP.cy
         End With

         ' Now modify the rectangle if we're showing tabs
         ' to allow space for the tab strip itself:
         If (m_bShowTabs) Then
            tNCR.rgrc(0).Left = tNCR.rgrc(0).Left + 2
            tNCR.rgrc(0).Right = tNCR.rgrc(0).Right - 2
            If (m_eTabAlign = TabAlignBottom) Then
               tNCR.rgrc(0).Top = tNCR.rgrc(0).Top + 2
               tNCR.rgrc(0).Bottom = tNCR.rgrc(0).Bottom - m_lTabHeight
            Else
               tNCR.rgrc(0).Top = tNCR.rgrc(0).Top + m_lTabHeight
               tNCR.rgrc(0).Bottom = tNCR.rgrc(0).Bottom - 2
            End If
         End If

         ' Set the second rectangle to equal the first:
         LSet tNCR.rgrc(1) = tNCR.rgrc(0)
         CopyMemory ByVal lParam, tNCR, Len(tNCR)
        
         ' Tell Windows we've modified the size:
         ISubclass_WindowProc = WVR_VALIDRECTS
      Else
         ' lParam points to a rectangle
         ISubclass_WindowProc = CallOldWindowProc(hWnd, iMsg, wParam, lParam)
      End If

</pre><p>Once this is done, there will be a space for the tabs.  Initially, no drawing
will occur in this area so it will be filled with whatever happens to appear on
 the screen at this position, so you need to draw into it.  This is done by 
intercepting the <i>WM_NCPAINT</i> (non-client paint) message:</p><pre>
   Case WM_NCPAINT
      ' Ensure the standard mon-client drawing is completed:
      ISubclass_WindowProc = CallOldWindowProc(hWnd, iMsg, wParam, lParam)

      ' Do custom drawing: first get a DC to the non-client area:
      Dim lhDC As Long
      lhDC = GetWindowDC(hWnd)

      ' Now can draw in the area we've cleared.
      ...

      ' Clear up DC:
      ReleaseDC lHDC, hWnd
</pre><p>Check the actual source code for the details of drawing the tabs.  The code uses
an <i>EnumWindowsProc</i> callback function to determine all of the windows within
the MDIClient area, and the <i>WM_MDIGETACTIVE</i> message to determine which 
window is the currently selected MDI child (if any).</p><p>Finally, we need to intercept the user clicking on a tab or button within the 
tab control.  There are two messages Windows sends to the non-client area to 
allow you to check for mouse events:</p><ol><li><i>WM_NCHITTEST</i><br />This message allows you to tell Windows that a non-client
area should be treated in a particular way, such as title bar or size gripper.</li><li><i>WM_SETCURSOR</i><br />This message is used by Windows to determine which
cursor to display, however, since it provides the type of mouse action being
performed you can use it to determine mouse movement and button presses in the area.</li></ol><p>The <i>WM_SETCURSOR</i> message provides two pieces of information in the <i>lParam</i>
of the message: the loword is the HitTest code sent to the <i>WM_NCHITTEST</i> message,
which allows you to determine whether you are over a border or title, and the hiword is
the mouse message itself.  The messages can be filtered to only check when the HitTest code 
is <i>HTNOWHERE</i>, which means the mouse isn't over any particular UI component of the 
form's non-client area.  You can then use <i>GetCursorPos</i> to determine where the mouse
is and check if it hitting any of the components of the form.  If it is, and you want to
track whether the mouse is still over any object, you can use <i>SetCapture</i> to redirect
subsequent mouse events messages as normal (i.e. as <i>WM_MOUSEMOVE</i>, <i>WM_LBUTTONDOWN</i> etc)
to the Window. When the mouse is no longer over the object, <i>ReleaseCapture</i> returns
the mouse messages to the normal owners (if you don't do this, then nothing will work correctly
until the next time the mouse button is pressed and released).</p><p>That completes how this implementation works, however, it's useful to compare this to the
way tabs are implemented in Visual Studio itself.  If you point Windows Spy at the Visual 
Studio main pane, you see that it is implemented using a standard MDI client window, but this
contains another window immediately inside called "EzMdiContainer".  This window
then contains a window called "EzMdiTabOwner" (which draws the scrolling and close 
buttons and contains the tabs themselves, drawn in a window called "EzMdiTab".  The
EzMdiContainer window also contains any child windows which are windows of type "DockingView".</p><img src="visualstudiowindows.png" width="419" height="253" alt="Visual Studio MDI Client Windows" /><p>When Visual Studio creates a new tab group, it simply creates a new "EzMdiContainer" window
within the MDI Client.</p><p>This implementation is easier to code for than my version because it uses separate windows to contain
the different components, and these windows can be pretty much written as if they were independent controls,
improving the encapsulation.  However, it isn't very easy to write a VB version this way, since you
would need to be able to change the parent of an object to become part of the MDIClient to create
EZMdiContainer or EZMdiTabOwner, and you would also need to change the parent of a form from MDIClient to 
this new window.  As noted before, changing the parent of a Visual Basic form or control is fraught with
difficulties and I have not managed to get this to work in a stable manner yet.</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Tab Controls</a>&#160;.&#160;vbAccelerator MDITabs Control</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 April 2003</p></td><td></td></tr></table>
</body></html>
