<html lang="en" >
<head>

<title>vbAccelerator - vbAccelerator Icon Selector Control</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="This control provides a simple to use icon selector, and works in the exactly the same
way as the Change Icon dialog in Windows.  You can either use it to select existing
icons, or you can add your own." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Icon Controls</a>&#160;.&#160;vbAccelerator Icon Selector Control</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_icon_selector_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Icon Selector Control</a> (24K)</p><p class="nav"><a href="vb5_icon_selector_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Icon Selector Demonstration</a> (9K)</p><p class="nav"><a href="vb5_icon_selector_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Icon Selector Full Source</a> (59K)</p><p /><p class="nav"><a href="vb6_icon_selector_control.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Icon Selector Control</a> (24K)</p><p class="nav"><a href="vb6_icon_selector_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Icon Selector Demonstration</a> (9K)</p><p class="nav"><a href="vb6_icon_selector_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Icon Selector Full Source</a> (59K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:5291</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=5291&type=article&title=vbaccelerator_20icon_20selector_20control.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />28 Mar 2003<br /><p class="update">Now using <i>ExtractIconEx</i> rather than resource
enumeration to pick the icon.  This ensures the id is compatible
with the ShellLink interface.</p><p class="update">Fixed bug preventing <i>SelectionChange</i> events from being sent.</p><p class="update">When an icon file is specified in code, the file name now
appears in the text box.
</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\common_dialogs\code_only_common_dialogs\article.html">Two code only solutions for displaying Common/Dialogs</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\resources\reading_data_from_local_or_external_library_resources\article.html">Reading Data from Local or External Library Resources</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\type_libraries\ole_guid_and_interface_definitions\article.html">Ole Guid and interface definitions (OleGuids.Tlb) </a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\combo_and_list_boxes\owner_draw_combo_and_list_box\article.html">Owner Draw Combo and List Boxes Version 2.1</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\tips\add_file_or_url_autocompletion_to_textboxes_and_comboboxes\article.html">Add File or URL AutoCompletion to TextBoxes and ComboBoxes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\utilities\simple_windows_spy\article.html">Simple Windows Spy Utility</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator Icon Selector Control</h1><p class="splash">An Icon Selector which precisely emulates the Windows Change Icon Dialog.</p><img src="iconselector.png" width="523" height="330" alt="Icon Selector Demonstration" /><p /><p>This control provides a simple to use icon selector, and works in the exactly the same
way as the Change Icon dialog in Windows.  You can either use it to select existing
icons, or you can add your own.</p><h2>About The Control</h2><p>The control has been designed to be as simple as possible whilst providing
all the features you need to implement an icon selection dialog.  Please feel
free to enhance it and build your own version if you want more features!</p><h3>Style Properties</h3><p>The <i>Font</i> property allows you to select the font used in the control,
and the <i>AllowChangeFile</i> property determines whether the text box
and Browse buttons are displayed or not.</p><h3>Setting Icons To Choose From</h3><p>Setting the <i>FileName</i> property will load all available icons from
the selected file.  If the <i>SelectedIconResourceId</i> property has been
set to a resource in the file, then this will automatically be selected
once the file is loaded.  To clear the control, set the <i>FileName</i>
property to a blank string.</p><h3>Determining the Selected Item</h3><p>You can get the selected item's resource id from the <i>SelectedIconResourceId</i>
property, or the icon itself from the <i>SelectedIcon</i> property.  The
<i>SelectionChange</i> event is fired whenever the selected item is changed.</p><h3>Other Events</h3><p>In a dialog, double-clicking on an item or pressing Return would imply the user
has made a selection. The control supports <i>DblClick</i>, <i>KeyDown</i>, <i>KeyPress</i>
and <i>KeyUp</i> events to allow you to implement this.</p><h2>Icon Selection in the Shell</h2><p>Although the Shell clearly includes an icon selection dialog, this dialog
isn't exposed through any API.  Its probably possible to invoke the dialog
through an undocumented Shell call, but such things cause trouble in the long
run as new versions of Windows are released.  So this control re-implements
the icon selector from scratch.</p><p>Pointing a <a href="..\..\..\..\utilities\simple_windows_spy\article.html">Windows Spy</a> at the Windows 
dialog reveals that the icon selection is done using an owner-draw list box,
with these styles set:</p><ul><li><i>LBS_OWNERDRAWFIXED</i> - Allows the owner of the control to draw the items,
and specifies that all items have the same size.</li><li><i>LBS_MULTICOLUMN</i> - Allows multiple columns of items in the ListBox.</li><li><i>WS_HSCROLL</i> and not <i>WS_VSCROLL</i> - ensures the Window has a Horizontal
scroll bar but not a vertical one.</li></ul><h2>In Detail - Creating The Control</h2><p>VB doesn't allow you to modify the built-in ListBox to set these styles, but
using some of the code from the <a href="..\..\combo_and_list_boxes\owner_draw_combo_and_list_box\article.html">Owner-Draw Combo
and List Box</a> you can create on yourself.</p><h3>Creating the ListBox</h3><p>Building a ListBox with the correct styles using the API is achieved like this:</p><pre>
      ' Create the list box:
      hInst = App.hInstance
      
      ' Set up style bits to get the appropriate type of
      ' window:
      sStyle = "LISTBOX"
      wStyle = WS_VISIBLE Or WS_CHILD
      wStyle = wStyle Or LBS_HASSTRINGS Or _
          LBS_OWNERDRAWFIXED Or LBS_NOTIFY Or LBS_MULTICOLUMN
      wStyle = wStyle Or WS_HSCROLL
      lH = 48
      ' Create the window:
      lW = UserControl.Width \ Screen.TwipsPerPixelX
      m_hWndParent = UserControl.hwnd
      m_hWnd = CreateWindowEx( _
          WS_EX_CLIENTEDGE, _
          sStyle, _
          "", _
          wStyle, _
          0, 0, lW, lH, _
          m_hWndParent, _
          0, _
          hInst, _
          ByVal 0 _
          )
      ' If we succeed
      If Not (m_hWnd = 0) Then
         m_hBackBrush = GetSysColorBrush( _
             vbWindowBackground And &amp;H1F&amp;)
      
         ' Ensure the correct font:
         SendMessageByLong m_hWnd, WM_SETFONT, m_fnt.hFont, 1
         
         ' Start subclassing:
         pSubClass
      End If
</pre><p>In order to make the control work, you need to do two things:</p><ol><li>Implement the <a href="..\..\..\techniques\trapping_the_tab_key_in_a_usercontrol_with_ioleinplaceactiveobject\article.asp\index.html">IOLEInPlaceActiveObject Interface</a>. If you don't do this, then VB will get confused about focus and
the tab key will stop working.</li><li>Subclass for these messages:
    <ul><li><i>WM_DRAWITEM</i> - Sent to the parent of the control whenever an item needs to be draw.</li><li><i>WM_CTLCOLORLISTBOX</i> - Sent to the parent of the control to request the background colour of the ListBox.  If you don't respond to this by returning a brush
then the control won't draw correctly.</li><li><i>WM_COMMAND</i> - Sent to the parent of the control whenever an action
is performed, such as selection and double clicking.</li><li><i>WM_KEYDOWN</i>, <i>WM_CHAR</i>, <i>WM_KEYUP</i> - you cannot modify the response to the key unless you intercept the message on the ListBox itself.</li><li><i>WM_SETFOCUS</i> - Needs to be subclassed on the control and its parent to implement IOLEInPlaceActiveObject.</li><li><i>WM_MOUSEACTIVATE</i>- Needs to be subclassed on the control to implement IOLEInPlaceActiveObject.</li></ul></li></ol><p>With that in place, you can start adding items to the ListBox using the <i>LB_ADDSTRING</i> and <i>LB_SETITEMDATA</i> messages.  To ensure the items are
the correct size, you also need to send <i>LB_SETCOLUMNWIDTH</i> and 
<i>LB_SETITEMHEIGHT</i> messages.</p><h3>Implementing the Rest Of The Control</h3><p>The remainder of the control is implemented using various features described
elsewhere on the site:</p><ul><li>Selecting a file to load icons from is implemented using the <a href="..\..\..\libraries\common_dialogs\code_only_common_dialogs\article.html">code-only common dialogs</a> code.</li><li>Setting the filename text box to auto-complete file names is done using
<i>SHAutoComplete</i>, described in <a href="..\..\..\..\tips\add_file_or_url_autocompletion_to_textboxes_and_comboboxes\article.html">this tip</a>.</li><li>Reading the icons from an executable or library is achieved by 
<a href="..\..\..\libraries\resources\reading_data_from_local_or_external_library_resources\article.html">enumerating resources</a>: icons are stored under
the <i>RT_ICON</i> and <i>RT_GROUP_ICON</i> types.</li><li>Storing and drawing the icons is done using a <a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator
ImageList class.</a></li></ul><h2>That's All</h2><p>Anyway, that's it for now.  I'm off to prepare the oysters and finish the
confit of duck for Valentine's day, because I'm soppy (and I really wanted
to try a confit of duck...).</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Icon Controls</a>&#160;.&#160;vbAccelerator Icon Selector Control</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 9 April 2003</p></td><td></td></tr></table>
</body></html>
