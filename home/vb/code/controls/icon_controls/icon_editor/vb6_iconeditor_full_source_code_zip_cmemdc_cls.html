<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cMemDC.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cMemDC.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Icon Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator Icon Editor Control</a>&#160;.&#160;<a href="vb6_iconeditor_full_source_code.html">VB6 IconEditor Full Source Code</a>&#160;.&#160;cMemDC.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="iconeditor_documentation.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />IconEditor Documentation</a> (1K)</p><p /><p class="nav"><a href="vb5_iconeditor_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 IconEditor Demonstration</a> (126K)</p><p class="nav"><a href="vb5_iconeditor_full_source_code.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 IconEditor Full Source Code</a> (211K)</p><p class="nav"><a href="vb5_iconeditor_ocx.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 IconEditor OCX</a> (43K)</p><p /><p class="nav"><a href="vb6_iconeditor_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 IconEditor Demonstration</a> (123K)</p><p class="nav"><a href="vb6_iconeditor_full_source_code.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 IconEditor Full Source Code</a> (209K)</p><p class="nav"><a href="vb6_iconeditor_ocx.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 IconEditor OCX</a> (43K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:11603</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=11603&type=zip&title=vb6_20iconeditor_20full_20source_20code_2ezip_5fcmemdc.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />21 Mar 2000<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cMemDC.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "cMemDC"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit

'
 ===============================================================================
================
' vbAccelerator
' http://vbaccelerator.com/
'  1999 Steve McMahon (steve@vbaccelerator.com)
'
' cMemDC
' A simple wrapper around a Memory Device Context and
' a bitmap.
'
'
 ===============================================================================
================


Private Declare Function CreateCompatibleBitmap Lib "gdi32" (ByVal hDC As Long,
 ByVal nWidth As Long, ByVal nHeight As Long) As Long
Private Declare Function CreateCompatibleDC Lib "gdi32" (ByVal hDC As Long) As
 Long
Private Declare Function CreateDCAsNull Lib "gdi32" Alias "CreateDCA" (ByVal
 lpDriverName As String, lpDeviceName As Any, lpOutput As Any, lpInitData As
 Any) As Long
Private Declare Function SelectObject Lib "gdi32" (ByVal hDC As Long, ByVal
 hObject As Long) As Long
Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As
 Long
Private Declare Function DeleteDC Lib "gdi32" (ByVal hDC As Long) As Long
Private Declare Function GetObjectAPI Lib "gdi32" Alias "GetObjectA" (ByVal
 hObject As Long, ByVal nCount As Long, lpObject As Any) As Long

Private Type BITMAP '24 bytes
   bmType As Long
   bmWidth As Long
   bmHeight As Long
   bmWidthBytes As Long
   bmPlanes As Integer
   bmBitsPixel As Integer
   bmBits As Long
End Type


Private m_hDC As Long
Private m_hBmp As Long
Private m_hBmpOld As Long

Private m_iSizeX As Long
Private m_iSizeY As Long

Private m_bMono As Boolean

Private m_bInit As Boolean

Private Sub SetSize(ByVal x As Long, ByVal y As Long)
Dim bInit As Boolean
   If x &gt; m_iSizeX Or y &gt; m_iSizeY Then
      m_bInit = True
   End If
   m_iSizeX = x
   m_iSizeY = y
End Sub
Public Property Get Width() As Long
   Width = m_iSizeX
End Property
Public Property Get Height() As Long
   Height = m_iSizeY
End Property
Public Property Let Width(ByVal lWidth As Long)
   If m_iSizeX &lt; lWidth Then
      m_bInit = True
   End If
   m_iSizeX = lWidth
End Property
Public Property Let Height(ByVal lHeight As Long)
   If m_iSizeY &lt; lHeight Then
      m_bInit = True
   End If
   m_iSizeY = lHeight
End Property
Public Property Get hDC() As Long
   If m_bInit Then
      If Init Then
         m_bInit = False
      End If
   End If
   hDC = m_hDC
End Property
Public Property Get Mono() As Boolean
   Mono = m_bMono
End Property
Public Property Let Mono(ByVal bState As Boolean)
   If Not (m_bMono = bState) Then
      m_bInit = True
   End If
   m_bMono = bState
End Property
Private Function Init(Optional ByVal hBmp As Long = 0) As Boolean
Dim hDCDisp As Long
Dim lWidth As Long, lHeight As Long
   
   If m_bMono Then
      If m_hDC = 0 Then
         m_hDC = CreateCompatibleDC(0)
      End If
   Else
      hDCDisp = CreateDCAsNull("DISPLAY", ByVal 0&amp;, ByVal 0&amp;, ByVal 0&amp;)
      
      If hDCDisp &lt;&gt; 0 Then
         If m_hDC = 0 Then
            m_hDC = CreateCompatibleDC(hDCDisp)
            If m_hDC = 0 Then
               ThrowError 1
               Exit Function
            End If
         End If
      Else
         ThrowError 1
         Exit Function
      End If
   End If
   
   If m_hDC &lt;&gt; 0 Then
      If m_hBmpOld &lt;&gt; 0 Then
         SelectObject m_hDC, m_hBmpOld
         m_hBmpOld = 0
      End If
      If m_hBmp &lt;&gt; 0 Then
         DeleteObject m_hBmp
         m_hBmp = 0
      End If
      If hBmp = 0 Then
         If m_bMono Then
            m_hBmp = CreateCompatibleBitmap(m_hDC, m_iSizeX, m_iSizeY)
         Else
            m_hBmp = CreateCompatibleBitmap(hDCDisp, m_iSizeX, m_iSizeY)
         End If
      Else
         m_hBmp = hBmp
      End If
      If m_hBmp = 0 Then
         DeleteDC hDCDisp
         hDCDisp = 0
         ThrowError 1
      Else
         m_hBmpOld = SelectObject(m_hDC, m_hBmp)
         ' ok.
         Init = True
      End If
   Else
      DeleteDC hDCDisp
      hDCDisp = 0
      ThrowError 1
   End If
   
   If Not (hDCDisp = 0) Then
      DeleteDC hDCDisp
   End If
   
   
End Function

Private Function ThrowError(ByVal lErr As Long)
Dim sMsg As String
   If lErr = 1 Then
      ' fatal
      Destroy
      gErr 2
   Else
      gErr 3
   End If
End Function
Private Function Destroy()
   If m_hBmpOld &lt;&gt; 0 Then
      SelectObject m_hDC, m_hBmpOld
      m_hBmpOld = 0
   End If
   If m_hBmp &lt;&gt; 0 Then
      DeleteObject m_hBmp
      m_hBmp = 0
   End If
   If m_hDC &lt;&gt; 0 Then
      DeleteDC m_hDC
      m_hDC = 0
   End If
   
End Function
Public Function ExtractBitmap() As Long
   If m_hBmpOld &lt;&gt; 0 Then
      SelectObject m_hDC, m_hBmpOld
      m_hBmpOld = 0
   End If
   If m_hDC &lt;&gt; 0 Then
      DeleteDC m_hDC
      m_hDC = 0
   End If
   ExtractBitmap = m_hBmp
   ' the responsibility for clearing up
   ' the bitmap now belongs to the caller:
   m_hBmp = 0
   m_bInit = True
End Function
Public Sub InjectBitmap(ByVal hBmp As Long)
Dim tBM As BITMAP
   Destroy
   GetObjectAPI hBmp, Len(tBM), tBM
   Width = tBM.bmWidth
   Height = tBM.bmHeight
   Init hBmp
   m_bInit = False
End Sub

Private Sub Class_Terminate()
   Destroy
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Icon Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator Icon Editor Control</a>&#160;.&#160;<a href="vb6_iconeditor_full_source_code.html">VB6 IconEditor Full Source Code</a>&#160;.&#160;cMemDC.cls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>