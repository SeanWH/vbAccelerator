<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mColouriseGlyph.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mColouriseGlyph.bas" /><link rel="stylesheet" href="..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator Explorer Bar Control</a>&#160;.&#160;<a href="vb5_explorerbar_control_full_source.html">VB5 ExplorerBar Control Full Source</a>&#160;.&#160;mColouriseGlyph.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_explorer_bar_control.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Explorer Bar Control</a> (63K)</p><p class="nav"><a href="vb5_explorerbar_control_demonstration.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ExplorerBar Control Demonstration</a> (83K)</p><p class="nav"><a href="vb5_explorerbar_control_full_source.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ExplorerBar Control Full Source</a> (221K)</p><p /><p class="nav"><a href="vb6_explorer_bar_control_binary.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Explorer Bar Control Binary</a> (64K)</p><p class="nav"><a href="vb6_explorer_bar_control_demonstration.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Explorer Bar Control Demonstration</a> (81K)</p><p class="nav"><a href="vb6_explorer_bar_control_full_source.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Explorer Bar Control Full Source</a> (221K)</p><br /><br /><img src="..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12168</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\linkto_asp\id=12168&type=zip&title=vb5_20explorerbar_20control_20full_20source_2ezip_5fmcolouriseglyph.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 7 / 16</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 3 / 6</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:13 January 2004</p>
<br /><br /><img src="..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\res\update.png" width="8" height="8" alt="Update" />15 Nov 2003<br /><p class="update">Added Watermark and Title Icon properties.</p><p class="update">Titlebars in Search mode can now wrap onto
more than one line.</p><p class="update">Control can now be resized horizontally
or vertically at runtime and items are wrapped correctly.</p><p class="update">Bug fixes: font property, Title background
colour properties, MSVBVM50.DLL dependency, large number of
items truncated, key navigation.  See the BugTrak for full
details.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\xp_visual_styles\drawing_with_xp_visual_styles\article.html">Drawing with XP Visual Styles</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\type_libraries\vbaccelerator_com_support_type_library\article.html">vbAccelerator COM/VB Support Type Library (vbaCOM.Tlb)</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\utilities\bitmap_extractor\article.html">Bitmap Extractor Utility</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\libraries\resources\reading_data_from_local_or_external_library_resources\article.html">Reading Data from Local or External Library Resources</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\type_libraries\ole_guid_and_interface_definitions\article.html">Ole Guid and interface definitions (OleGuids.Tlb) </a></p><br /><br /><img src="..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mColouriseGlyph.bas</h1><pre>Attribute VB_Name = "mColouriseGlyph"
Option Explicit

Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)

Private Type SAFEARRAYBOUND
    cElements As Long
    lLbound As Long
End Type
Private Type SAFEARRAY2D
    cDims As Integer
    fFeatures As Integer
    cbElements As Long
    cLocks As Long
    pvData As Long
    Bounds(0 To 1) As SAFEARRAYBOUND
End Type
Private Declare Function VarPtrArray Lib "msvbvm50.dll" Alias "VarPtr" (Ptr()
 As Any) As Long
Private Declare Function GetPixelAPI Lib "gdi32" Alias "GetPixel" (ByVal hdc As
 Long, ByVal x As Long, ByVal y As Long) As Long

Public Sub ColouriseWatermark( _
      cWatermark As pcAlphaDibSection, _
      ByVal lBackColor As OLE_COLOR _
   )
Dim lRefColor As Long
Dim hueRef As Single, satRef As Single, lumRef As Single
Dim redRef As Long, greenRef As Long, blueRef As Long
Dim hueTo As Single, satTo As Single, lumTo As Single
Dim redTo As Long, greenTo As Long, blueTo As Long

   ' Get the reference colour &amp; its luminance value:
   lRefColor = GetPixelAPI(cWatermark.hdc, 0, 0)
   redRef = (lRefColor And &amp;HFF&amp;)
   greenRef = (lRefColor And &amp;HFF00&amp;) \ &amp;H100&amp;
   blueRef = (lRefColor And &amp;HFF0000) \ &amp;H10000
   RGBToHSL redRef, greenRef, blueRef, _
      hueRef, satRef, lumRef

   ' Now get the back colour we're colourising to:
   lBackColor = TranslateColor(lBackColor)
   redTo = (lBackColor And &amp;HFF&amp;)
   greenTo = (lBackColor And &amp;HFF00&amp;) \ &amp;H100&amp;
   blueTo = (lBackColor And &amp;HFF0000) \ &amp;H10000
   RGBToHSL redTo, greenTo, blueTo, _
      hueTo, satTo, lumTo
   
   ' Now loop through everything in the watermark,
   ' adjusting the hue, saturation and lumination
   ' according to the desired background colour:
Dim bDib() As Byte
Dim x As Long, y As Long
Dim tSA As SAFEARRAY2D
Dim huePixel As Single, satPixel As Single, lumPixel As Single
Dim redPixel As Long, greenPixel As Long, bluePixel As Long
Dim lBytesPerScanLine As Long
Dim fLumOffset As Single
   
   ' Get the bits in the from DIB section:
   With tSA
      .cbElements = 1
      .cDims = 2
      .Bounds(0).lLbound = 0
      .Bounds(0).cElements = cWatermark.Height
      .Bounds(1).lLbound = 0
      .Bounds(1).cElements = cWatermark.BytesPerScanLine()
      .pvData = cWatermark.DIBSectionBitsPtr
   End With
   CopyMemory ByVal VarPtrArray(bDib()), VarPtr(tSA), 4

   lBytesPerScanLine = cWatermark.BytesPerScanLine
   For y = 0 To cWatermark.Height - 1
      For x = 0 To lBytesPerScanLine - 1 Step 4
         
         ' Get H,S, L of pixel:
         RGBToHSL bDib(x + 2, y), bDib(x + 1, y), bDib(x, y), _
            huePixel, satPixel, lumPixel
         ' Determine the offset of lumPixel from the reference
         ' lumPixel
         fLumOffset = lumPixel / lumRef
         ' Apply the luminance offset to the reference luminance:
         lumPixel = lumTo * fLumOffset
         
         ' Calculate the new colour:
         HLSToRGB hueTo, satTo, lumPixel, redPixel, greenPixel, bluePixel
         
         ' Set it:
         bDib(x + 3, y) = 255
         bDib(x + 2, y) = redPixel
         bDib(x + 1, y) = greenPixel
         bDib(x, y) = bluePixel
   
      Next x
   Next y
   
    ' Clear the temporary array descriptor
    ' (This does not appear to be necessary, but
    ' for safety do it anyway)
    CopyMemory ByVal VarPtrArray(bDib), 0&amp;, 4

End Sub

Public Sub ColouriseGlyph( _
      cGlyph As pcAlphaDibSection, _
      ByVal lBackColor As OLE_COLOR _
   )
Dim lTransColor As Long
Dim hueTrans As Single, satTrans As Single, lumTrans As Single
Dim redTrans As Long, greenTrans As Long, blueTrans As Long
Dim hueBack As Single, satBack As Single, lumBack As Single
Dim redBack As Long, greenBack As Long, blueBack As Long

   ' Get transparent colour &amp; its luminance value:
   lTransColor = GetPixelAPI(cGlyph.hdc, 1, 1)
   redTrans = (lTransColor And &amp;HFF&amp;)
   greenTrans = (lTransColor And &amp;HFF00&amp;) \ &amp;H100&amp;
   blueTrans = (lTransColor And &amp;HFF0000) \ &amp;H10000
   RGBToHSL redTrans, greenTrans, blueTrans, _
      hueTrans, satTrans, lumTrans
   
   ' Get base luminance value of the background colour:
   lBackColor = TranslateColor(lBackColor)
   redBack = (lBackColor And &amp;HFF&amp;)
   greenBack = (lBackColor And &amp;HFF00&amp;) \ &amp;H100&amp;
   blueBack = (lBackColor And &amp;HFF0000) \ &amp;H10000
   RGBToHSL redBack, greenBack, blueBack, _
      hueBack, satBack, lumBack
      
   ' Now loop through everything in the glyph,
   ' adjusting the hue, saturation and lumination
   ' according to the desired background colour:
Dim bDib() As Byte
Dim x As Long, y As Long
Dim tSA As SAFEARRAY2D
Dim huePixel As Single, satPixel As Single, lumPixel As Single
Dim redPixel As Long, greenPixel As Long, bluePixel As Long
Dim lBytesPerScanLine As Long
Dim fLumOffset As Single
    
   ' Get the bits in the from DIB section:
   With tSA
      .cbElements = 1
      .cDims = 2
      .Bounds(0).lLbound = 0
      .Bounds(0).cElements = cGlyph.Height
      .Bounds(1).lLbound = 0
      .Bounds(1).cElements = cGlyph.BytesPerScanLine()
      .pvData = cGlyph.DIBSectionBitsPtr
   End With
   CopyMemory ByVal VarPtrArray(bDib()), VarPtr(tSA), 4

   lBytesPerScanLine = cGlyph.BytesPerScanLine
   For y = 0 To cGlyph.Height - 1
      For x = 0 To lBytesPerScanLine - 1 Step 4
         ' Check whether transparent:
         If (redTrans = bDib(x + 2, y) And _
            greenTrans = bDib(x + 1, y) And _
            blueTrans = bDib(x + 2, y)) Then
            bDib(x + 3, y) = 255
            bDib(x + 2, y) = redBack
            bDib(x + 1, y) = greenBack
            bDib(x, y) = blueBack
         Else
            ' Get HSL of pixel:
            RGBToHSL bDib(x + 2, y), bDib(x + 1, y), bDib(x, y), _
               huePixel, satPixel, lumPixel
            ' Determine luminance offset from trans colour:
            fLumOffset = lumPixel / lumTrans
            If (lumPixel &gt; 0.9) Then
               ' here you really want a function which
               ' maps items to lumBack at lumPixel = 0.9
               ' through to 1.0 luminance at lumPixel = 1.0
               ' but we don't need it here.
            Else
               lumPixel = lumBack * fLumOffset
               If (lumPixel &gt; 1#) Then lumPixel = 1#
            End If
            
            ' Create a version of the back colour with
            ' this luminance offset:
            HLSToRGB hueBack, satBack, lumPixel, _
               redPixel, greenPixel, bluePixel
            bDib(x + 3, y) = 255
            bDib(x + 2, y) = redPixel
            bDib(x + 1, y) = greenPixel
            bDib(x, y) = bluePixel
         End If
      Next x
   Next y
   
    ' Clear the temporary array descriptor
    ' (This does not appear to be necessary, but
    ' for safety do it anyway)
    CopyMemory ByVal VarPtrArray(bDib), 0&amp;, 4
   
End Sub


Private Sub RGBToHSL( _
      ByVal r As Long, ByVal g As Long, ByVal b As Long, _
      h As Single, s As Single, l As Single _
   )
Dim Max As Single
Dim Min As Single
Dim delta As Single
Dim rR As Single, rG As Single, rB As Single

   rR = r / 255: rG = g / 255: rB = b / 255

'{Given: rgb each in [0,1].
' Desired: h in [0,360] and s in [0,1], except if s=0, then h=UNDEFINED.}
        Max = Maximum(rR, rG, rB)
        Min = Minimum(rR, rG, rB)
        l = (Max + Min) / 2    '{This is the lightness}
        '{Next calculate saturation}
        If Max = Min Then
            'begin {Acrhomatic case}
            s = 0
            h = 0
           'end {Acrhomatic case}
        Else
           'begin {Chromatic case}
                '{First calculate the saturation.}
           If l &lt;= 0.5 Then
               s = (Max - Min) / (Max + Min)
           Else
               s = (Max - Min) / (2 - Max - Min)
            End If
            '{Next calculate the hue.}
            delta = Max - Min
           If rR = Max Then
                h = (rG - rB) / delta    '{Resulting color is between yellow
                 and magenta}
           ElseIf rG = Max Then
                h = 2 + (rB - rR) / delta '{Resulting color is between cyan and
                 yellow}
           ElseIf rB = Max Then
                h = 4 + (rR - rG) / delta '{Resulting color is between magenta
                 and cyan}
            End If
            'Debug.Print h
            'h = h * 60
           'If h &lt; 0# Then
           '     h = h + 360            '{Make degrees be nonnegative}
           'End If
        'end {Chromatic Case}
      End If
'end {RGB_to_HLS}
End Sub

Private Sub HLSToRGB( _
      ByVal h As Single, ByVal s As Single, ByVal l As Single, _
      r As Long, g As Long, b As Long _
   )
Dim rR As Single, rG As Single, rB As Single
Dim Min As Single, Max As Single

   If s = 0 Then
      ' Achromatic case:
      rR = l: rG = l: rB = l
   Else
      ' Chromatic case:
      ' delta = Max-Min
      If l &lt;= 0.5 Then
         's = (Max - Min) / (Max + Min)
         ' Get Min value:
         Min = l * (1 - s)
      Else
         's = (Max - Min) / (2 - Max - Min)
         ' Get Min value:
         Min = l - s * (1 - l)
      End If
      ' Get the Max value:
      Max = 2 * l - Min
      
      ' Now depending on sector we can evaluate the h,l,s:
      If (h &lt; 1) Then
         rR = Max
         If (h &lt; 0) Then
            rG = Min
            rB = rG - h * (Max - Min)
         Else
            rB = Min
            rG = h * (Max - Min) + rB
         End If
      ElseIf (h &lt; 3) Then
         rG = Max
         If (h &lt; 2) Then
            rB = Min
            rR = rB - (h - 2) * (Max - Min)
         Else
            rR = Min
            rB = (h - 2) * (Max - Min) + rR
         End If
      Else
         rB = Max
         If (h &lt; 4) Then
            rR = Min
            rG = rR - (h - 4) * (Max - Min)
         Else
            rG = Min
            rR = (h - 4) * (Max - Min) + rG
         End If
         
      End If
            
   End If
   r = rR * 255: g = rG * 255: b = rB * 255
End Sub
Private Function Maximum(rR As Single, rG As Single, rB As Single) As Single
   If (rR &gt; rG) Then
      If (rR &gt; rB) Then
         Maximum = rR
      Else
         Maximum = rB
      End If
   Else
      If (rB &gt; rG) Then
         Maximum = rB
      Else
         Maximum = rG
      End If
   End If
End Function
Private Function Minimum(rR As Single, rG As Single, rB As Single) As Single
   If (rR &lt; rG) Then
      If (rR &lt; rB) Then
         Minimum = rR
      Else
         Minimum = rB
      End If
   Else
      If (rB &lt; rG) Then
         Minimum = rB
      Else
         Minimum = rG
      End If
   End If
End Function




</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\index.html" ><IMG SRC="..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="article.html">vbAccelerator Explorer Bar Control</a>&#160;.&#160;<a href="vb5_explorerbar_control_full_source.html">VB5 ExplorerBar Control Full Source</a>&#160;.&#160;mColouriseGlyph.bas</p><br /><p class="nav"><a href="..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 15 November 2003</p></td><td></td></tr></table>
</body></html>