<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mSaveIcon.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mSaveIcon.bas" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;<a href="article.html">vbAccelerator ImageList Control and Class v2.0</a>&#160;.&#160;<a href="vb5_imagelist_full_source.html">VB5 ImageList Full Source</a>&#160;.&#160;mSaveIcon.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="imagelist_class_example__vb5_or_vb6.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />ImageList Class Example, VB5 or VB6</a> (57K)</p><p class="nav"><a href="imagelist_control_documentation.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />ImageList Control Documentation</a> (2K)</p><p /><p class="nav"><a href="vb5_imagelist_control_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ImageList Control Binary</a> (33K)</p><p class="nav"><a href="vb5_imagelist_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ImageList Demonstration</a> (89K)</p><p class="nav"><a href="vb5_imagelist_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 ImageList Full Source</a> (153K)</p><p /><p class="nav"><a href="vb6_imagelist_control_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ImageList Control Binary</a> (32K)</p><p class="nav"><a href="vb6_imagelist_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ImageList Demonstration</a> (56K)</p><p class="nav"><a href="vb6_imagelist_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 ImageList Full Source</a> (121K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:4705</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=4705&type=zip&title=vb5_20imagelist_20full_20source_2ezip_5fmsaveicon.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 6 / 6</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 0 / 0</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:6 February 2004</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />29 Mar 2003<br /><p class="update">Fixed all problems with inconsistent indexes being returned by 
the methods. Indexes returned by the control are now <i>always</i> 1-based.  The
<i>ItemPicture</i> method consequently now works correctly.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\system_image_list\article.html">Using the System Image List with (and without) vbAccelerator Controls</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\displaying_alpha_(32bit)_icons_with_imagelists\article[1].html">Displaying Alpha (32bit) Icons with ImageLists</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mSaveIcon.bas</h1><pre>Attribute VB_Name = "mSaveIcon"
Option Explicit

Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As
 Long
Private Type ICONINFO
   fIcon As Long
   xHotspot As Long
   yHotspot As Long
   hBmMask As Long
   hbmColor As Long
End Type
Private Declare Function GetIconInfo Lib "user32" (ByVal hIcon As Long,
 piconinfo As ICONINFO) As Long
Private Declare Function GetObjectAPI Lib "gdi32" Alias "GetObjectA" (ByVal
 hObject As Long, ByVal nCount As Long, lpObject As Any) As Long
Private Type BITMAP '14 bytes
    bmType As Long
    bmWidth As Long
    bmHeight As Long
    bmWidthBytes As Long
    bmPlanes As Integer
    bmBitsPixel As Integer
    bmBits As Long
End Type
Private Declare Function CreateIconIndirect Lib "user32" (piconinfo As
 ICONINFO) As Long
Private Declare Function CreateBitmapIndirect Lib "gdi32" (lpBitmap As BITMAP)
 As Long
Private Declare Function CreateCompatibleBitmap Lib "gdi32" (ByVal hdc As Long,
 ByVal nWidth As Long, ByVal nHeight As Long) As Long
Private Declare Function GetDeviceCaps Lib "gdi32" (ByVal hdc As Long, ByVal
 nIndex As Long) As Long
Private Const BITSPIXEL = 12         '  Number of bits per pixel

'Private Declare Function GetBitmapBits Lib "gdi32" (ByVal hBitmap As Long,
 ByVal dwCount As Long, lpBits As Any) As Long
'Private Declare Function SetBitmapBits Lib "gdi32" (ByVal hBitmap As Long,
 ByVal dwCount As Long, lpBits As Any) As Long
Type RGBQUAD
   rgbBlue As Byte
   rgbGreen As Byte
   rgbRed As Byte
   rgbReserved As Byte
End Type
Private Type BITMAPINFOHEADER '40 bytes
   biSize As Long
   biWidth As Long
   biHeight As Long
   biPlanes As Integer
   biBitCount As Integer
   biCompression As Long
   biSizeImage As Long
   biXPelsPerMeter As Long
   biYPelsPerMeter As Long
   biClrUsed As Long
   biClrImportant As Long
End Type
Private Type BITMAPINFO_1BPP
   bmiHeader As BITMAPINFOHEADER
   bmiColors(0 To 1) As RGBQUAD
End Type
Private Type BITMAPINFO_4BPP
   bmiHeader As BITMAPINFOHEADER
   bmiColors(0 To 15) As RGBQUAD
End Type
Private Type BITMAPINFO_8BPP
   bmiHeader As BITMAPINFOHEADER
   bmiColors(0 To 255) As RGBQUAD
End Type
Private Type BITMAPINFO_ABOVE8
   bmiHeader As BITMAPINFOHEADER
End Type

Private Const DIB_PAL_COLORS = 1 '  color table in palette indices
Private Const DIB_PAL_INDICES = 2 '  No color table indices into surf palette
Private Const DIB_PAL_LOGINDICES = 4 '  No color table indices into DC palette
Private Const DIB_PAL_PHYSINDICES = 2 '  No color table indices into surf
 palette
Private Const DIB_RGB_COLORS = 0 '  color table in RGBs
Private Declare Function GetDIBits Lib "gdi32" (ByVal aHDC As Long, ByVal
 hBitmap As Long, ByVal nStartScan As Long, ByVal nNumScans As Long, lpBits As
 Any, lpBI As Any, ByVal wUsage As Long) As Long
Private Declare Function SetDIBits Lib "gdi32" (ByVal hdc As Long, ByVal
 hBitmap As Long, ByVal nStartScan As Long, ByVal nNumScans As Long, lpBits As
 Any, lpBI As Any, ByVal wUsage As Long) As Long
Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)
Private Declare Function CreateDCAsNull Lib "gdi32" Alias "CreateDCA" (ByVal
 lpDriverName As String, lpDeviceName As Any, lpOutput As Any, lpInitData As
 Any) As Long
Private Declare Function DeleteDC Lib "gdi32" (ByVal hdc As Long) As Long
Private Const BI_RGB = 0&amp;
Private Const BI_RLE4 = 2&amp;
Private Const BI_RLE8 = 1&amp;

Public Function SerialiseIcon( _
      ByVal lHDC As Long, _
      ByVal hIcon As Long, _
      ByRef b() As Byte, _
      ByVal lByteStart As Long, _
      ByRef lArraySize As Long, _
      ByVal lVersion As Long _
   ) As Boolean
Dim tII As ICONINFO
Dim lR As Long
Dim lMonoSize As Long
Dim lColourSize As Long
   
   ' decompose icon:
   lR = GetIconInfo(hIcon, tII)
   If (lR &lt;&gt; 0) Then
      ' store fIcon, xHotspot, yHotspot:
      CopyMemory b(lByteStart), tII, 12
      ' store the colour bitmap:
      lByteStart = lByteStart + 12
      If (SerialiseBitmap(lHDC, tII.hbmColor, False, b(), lByteStart,
       lColourSize, lVersion)) Then
         lByteStart = lByteStart + lColourSize
         If (SerialiseBitmap(lHDC, tII.hBmMask, True, b(), lByteStart,
          lMonoSize, lVersion)) Then
            lByteStart = lByteStart + lMonoSize
            lArraySize = lColourSize + lMonoSize + 12
            SerialiseIcon = True
         End If
      End If
      DeleteObject tII.hbmColor
      DeleteObject tII.hBmMask
   End If
End Function
Private Function SerialiseBitmap( _
      ByVal lHDC As Long, _
      ByVal hBm As Long, _
      ByVal bMono As Boolean, _
      ByRef b() As Byte, _
      ByVal lByteStart As Long, _
      ByRef lByteSize As Long, _
      ByVal lVersion As Long _
   ) As Boolean
Dim tBM As BITMAP
Dim tBI1 As BITMAPINFO_1BPP
Dim tBI4 As BITMAPINFO_4BPP
Dim tBI8 As BITMAPINFO_8BPP
Dim tBI As BITMAPINFO_ABOVE8
Dim lSize As Long
Dim lR As Long
   
   ' Get the BITMAP structure:
   lR = GetObjectAPI(hBm, Len(tBM), tBM)
   If (lR &lt;&gt; 0) Then
      ' Store the BITMAP structure:
      CopyMemory b(lByteStart), tBM, Len(tBM)
      ' Create a bitmap info structure:
      If (bMono) Then
         With tBI1.bmiHeader
            .biSize = Len(tBI1.bmiHeader)
            .biWidth = tBM.bmWidth
            .biHeight = tBM.bmHeight
            .biPlanes = 1
            .biBitCount = 1
            .biCompression = BI_RGB
         End With
         lSize = (tBI1.bmiHeader.biWidth + 7) / 8
         lSize = ((lSize + 3) \ 4) * 4
         lSize = lSize * tBI1.bmiHeader.biHeight
         lR = GetDIBits(lHDC, hBm, 0, tBM.bmHeight, b(lByteStart + Len(tBM)),
          tBI1, DIB_RGB_COLORS)
      Else
         With tBI.bmiHeader
            .biSize = Len(tBI.bmiHeader)
            .biWidth = tBM.bmWidth
            .biHeight = tBM.bmHeight
            .biPlanes = 1
            .biBitCount = 24
            .biCompression = BI_RGB
         End With
         If (lVersion &gt; 0) Then
            tBI.bmiHeader.biBitCount = 32
            lSize = tBI.bmiHeader.biWidth * tBI.bmiHeader.biHeight * 4
         Else
            ' Get the Bitmap bits into the byte array:
            lSize = tBI.bmiHeader.biWidth
            lSize = lSize * 3
            lSize = ((lSize + 3) / 4) * 4
            lSize = lSize * tBI.bmiHeader.biHeight
         End If
         'lR = GetBitmapBits(hBm, lSize, b(lByteStart + Len(tBM)))
         lR = GetDIBits(lHDC, hBm, 0, tBM.bmHeight, b(lByteStart + Len(tBM)),
          tBI, DIB_RGB_COLORS)
      End If
      
      If (lR &lt;&gt; 0) Then
         ' Success.  Return size:
         lByteSize = lSize + Len(tBM)
         SerialiseBitmap = True
      End If
   End If

End Function
Public Function DeSerialiseIcon( _
      ByVal lHDC As Long, _
      ByRef hIcon As Long, _
      ByRef b() As Byte, _
      ByVal lByteStart As Long, _
      ByRef lArraySize As Long, _
      ByVal lVersion As Long _
   )
Dim tII As ICONINFO
Dim lColourSize As Long
Dim lMonoSize As Long

   hIcon = 0
   ' get fIcon, xHotspot, yHotspot:
   CopyMemory tII, b(lByteStart), 12
   tII.fIcon = 1
   lByteStart = lByteStart + 12
   ' get the colour bitmap:
   If (DeSerialiseBitmap(lHDC, tII.hbmColor, False, b(), lByteStart,
    lColourSize, lVersion)) Then
      lByteStart = lByteStart + lColourSize
      ' get the mono bitmap:
      If (DeSerialiseBitmap(lHDC, tII.hBmMask, True, b(), lByteStart,
       lMonoSize, lVersion)) Then
         ' Set the size:
         lArraySize = lColourSize + lMonoSize + 12
         
         ' Create the icon from the structure:
         hIcon = CreateIconIndirect(tII)
         DeSerialiseIcon = (hIcon &lt;&gt; 0)
        
         DeleteObject tII.hbmColor
         DeleteObject tII.hBmMask
        
      Else
         DeleteObject tII.hbmColor
      End If
   End If
   
End Function
Private Function DeSerialiseBitmap( _
      ByVal lHDC As Long, _
      ByRef hBm As Long, _
      ByVal bMono As Boolean, _
      ByRef b() As Byte, _
      ByVal lByteStart As Long, _
      ByRef lByteSize As Long, _
      ByVal lVersion As Long _
   ) As Boolean
Dim tBM As BITMAP
Dim tBI1 As BITMAPINFO_1BPP
Dim tBI4 As BITMAPINFO_4BPP
Dim tBI8 As BITMAPINFO_8BPP
Dim tBI As BITMAPINFO_ABOVE8
Dim lSize As Long
Dim lR As Long
   
   'Debug.Print lByteStart, lByteSize
   ' Get the BITMAP structure:
   CopyMemory tBM, b(lByteStart), Len(tBM)
   ' Create the bitmap:
   If Not (bMono) Then
      hBm = CreateCompatibleBitmap(lHDC, tBM.bmWidth, tBM.bmHeight)
   Else
      hBm = CreateBitmapIndirect(tBM)
   End If
   If (hBm &lt;&gt; 0) Then
      ' Get the Bitmap bits from the byte array:
      'lSize = tBM.bmWidthBytes * tBM.bmHeight
      'lR = SetBitmapBits(hBm, lSize, b(lByteStart + Len(tBM)))
      If (bMono) Then
         With tBI1.bmiHeader
            .biSize = Len(tBI1.bmiHeader)
            .biWidth = tBM.bmWidth
            .biHeight = tBM.bmHeight
            .biPlanes = 1
            .biBitCount = 1
            .biCompression = BI_RGB
         End With
         lSize = (tBI1.bmiHeader.biWidth + 7) / 8
         lSize = ((lSize + 3) \ 4) * 4
         lSize = lSize * tBI1.bmiHeader.biHeight

         tBI1.bmiColors(1).rgbBlue = 255
         tBI1.bmiColors(1).rgbGreen = 255
         tBI1.bmiColors(1).rgbRed = 255
         lR = SetDIBits(lHDC, hBm, 0, tBM.bmHeight, b(lByteStart + Len(tBM)),
          tBI1, DIB_RGB_COLORS)
      Else
         With tBI.bmiHeader
            .biSize = Len(tBI.bmiHeader)
            .biWidth = tBM.bmWidth
            .biHeight = tBM.bmHeight
            .biPlanes = 1
            .biBitCount = 24
            .biCompression = BI_RGB
         End With
         If (lVersion &gt; 0) Then
            tBI.bmiHeader.biBitCount = 32
            lSize = tBI.bmiHeader.biWidth * tBI.bmiHeader.biHeight * 4
         Else
            lSize = tBI.bmiHeader.biWidth
            lSize = lSize * 3
            lSize = ((lSize + 3) / 4) * 4
            lSize = lSize * tBI.bmiHeader.biHeight
         End If
         
         lR = SetDIBits(lHDC, hBm, 0, tBM.bmHeight, b(lByteStart + Len(tBM)),
          tBI, DIB_RGB_COLORS)
      End If
      
      lByteSize = lSize + Len(tBM)
      If (lR &lt;&gt; 0) Then
         DeSerialiseBitmap = True
      Else
         DeleteObject hBm
      End If
   End If
   
End Function



</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;<a href="article.html">vbAccelerator ImageList Control and Class v2.0</a>&#160;.&#160;<a href="vb5_imagelist_full_source.html">VB5 ImageList Full Source</a>&#160;.&#160;mSaveIcon.bas</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>