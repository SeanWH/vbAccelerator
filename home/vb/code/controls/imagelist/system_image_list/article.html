<html lang="en" >
<head>

<title>vbAccelerator - Using the System Image List with (and without) vbAccelerator Controls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="The System Image List is a component provided as part of the Shell, and is capable of drawing all of the icons you see in 
Explorer. For applications which need to show folders, documents or drives this can be a great alternative to using a real 
Image List, and using it considerably conserves resources." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;Using the System Image List with (and without) vbAccelerator Controls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="owner_draw_combo_list_with_system_image_list_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Owner Draw Combo List with System Image List Sample</a> (37K)</p><p /><p class="nav"><a href="vbaccelerator_system_image_list_class.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />vbAccelerator System Image List Class</a> (30K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:931</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=931&type=article&title=using_20the_20system_20image_20list_20with_20_28and_20without_29_20vbaccel.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />29 May 1999<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\combo_and_list_boxes\owner_draw_combo_and_list_box\article.html">Owner Draw Combo and List Boxes Version 2.1</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\combo_and_list_boxes\comboboxex\article.html">vbAccelerator ComboBoxEx Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Using the System Image List with (and without) vbAccelerator Controls</h1><p class="splash">Free, unlimited, high performance icons from this Shell/Common Controls component.</p><img src="sysimg.gif" alt="OwnerDraw File List Box Sample" width="231" height="274" /><p /><p>The System Image List is a component provided as part of the Shell, and is capable of drawing all of the icons you see in 
Explorer. For applications which need to show folders, documents or drives this can be a great alternative to using a real 
Image List, and using it considerably conserves resources.</p><h2>About the System Image List</h2><p>In use the System Image List appears to work in exactly the same way as a normal COMCTL API Image List. 
However, behind the scenes it is doing something quite different. A standard ImageList will exhaust your system's resources 
quite quickly if you try to display the number of different icons which Explorer has to. In fact you can see this occuring 
if you try the brute force method for getting Explorer icons into your application, as demonstrated in the code sample 
Icons for any file type elsewhere on the site. Although this sample works fine for small directories or numbers of files, 
if you point it at your Windows\System directory you will soon hang the program (NT) or crash the system entirely (Win9x)!</p><p>The System Image List prevents the resource limitation by implementing a transparent caching system behind the scenes 
which continually modifies the contents of the System Image List so icons are made available on a JIT basis.</p><h2>The Impossible Lightness of Being</h2><p>The ideal application of the System Image List would be to attach it directly to a VB ListView or TreeView. However, this 
is not as straightforward as it should be. The VB controls have been written so you pretty much must use the ImageList built 
into the Common Controls OCX, and there is no way to modify this ImageList so it points to a System ImageList rather than 
the internally maintained one.</p><p>Tom Esh has shown you can attach an external ImageList to the Microsoft controls, but you loose a little flexibility and 
you have to take care to ensure it works correctly.</p><p>Controls which can bind to API ImageLists, however, make it easier to take advantage of the System ImageList. All the 
vbAccelerator controls use this method, so whenever a control has an ImageList property on this site you can attach a 
System ImageList to it.</p><h2>Obfuscated Shell</h2><p>Creating and using a System ImageList is straightforward, but as is often the case with the Shell, the method is 
not made particularly clear in the documentation. There are two steps you need to accomplish:</p><ol><li>Get the System Image List handle.</li><li>Getting the "index" of an image you want to draw.</li></ol><h3>1. Getting the System Image List Handle</h3><p>This is achieved through as single call to SHGetFileInfo:</p><pre>
Public Property Get SystemImageListHandle( _
      Optional ByVal bLargeIcons As Boolean=False) As Long
   Dim dwFlags As Long
   Dim hIml As Long
   Dim FileInfo As SHFILEINFO

   dwFlags = SHGFI_USEFILEATTRIBUTES Or SHGFI_SYSICONINDEX
   If Not (bLargeIcons) Then
      dwFlags = dwFlags Or SHGFI_SMALLICON
   End If

   '// Load the image list - use an arbitrary file extension for the
   '// call to SHGetFileInfo (we don't want to touch the disk, so use
   '// FILE_ATTRIBUTE_NORMAL &amp;&amp; SHGFI_USEFILEATTRIBUTES).
   hIml = SHGetFileInfo(".txt", FILE_ATTRIBUTE_NORMAL, _
                        FileInfo, LenB(FileInfo), dwFlags)

   SystemImageListHandle = hIml

End Property
</pre><h3>2. Getting the "Index" of an Image</h3><p>In the System Image List, indexes do not necessarily correspond to an actual image - the indexes are 
more like a handle which Shell uses to track whether it needs to load the specified icon into the list JIT 
for drawing or if it is already there. Therefore do not be surprised that image "indexes" in the system image 
list can be very large positive or negative numbers!</p><p>The index is obtained by another call to <i>SHGetFileInfo</i> as follows:</p><pre>
Dim dwFlags As Long

dwFlags = SHGFI_SYSICONINDEX 
If bLargeIcons Then
   dwFlags = dwFlags Or SHGFI_LARGEICON
Else
   dwFlags = dwFlags Or SHGFI_SMALLICON
End If

' We choose whether to access the disk or not. If you don't
' hit the disk, you may get the wrong icon if the icon is
' not cached. But the speed is very good!
If Not bForceLoadFromDisk Then
   dwFlags = dwFlags Or SHGFI_USEFILEATTRIBUTES
End If

' sFileSpec can be any file. You can specify a
' file that does not exist and still get the
' icon, for example sFileSpec = "C:\PANTS.DOC"
lR = SHGetFileInfo( _
      sFileSpec, FILE_ATTRIBUTE_NORMAL, FileInfo, LenB(FileInfo), _
      dwFlags _
      )

If (lR=0) Then
   ' Failed
Else
   lIndex = FileInfo.iIcon
End If
</pre><p>With these pieces of information you can now use all the standard ImageList API calls (except <i>ImageList_Destroy</i>, 
which would probably not be a good idea!) to use the Images. The vbAccelerator System Image List class in the download 
wraps these calls in VB calls to make it easier to draw, copy and extract icons.</p><p>The sample code in the download shows you how to use the System Image List class with the <a href="..\..\combo_and_list_boxes\owner_draw_combo_and_list_box\article.html">Owner Draw Combo and List Box</a>
to create a new version of the VB File/Directory List Box control which includes Explorer graphics. Use along with the 
<a href="..\..\combo_and_list_boxes\comboboxex\article.html">Owner Draw ComboBoxEx control</a> in Drive Picker mode!</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\libraries\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;Using the System Image List with (and without) vbAccelerator Controls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 8 January 2003</p></td><td></td></tr></table>
</body></html>
