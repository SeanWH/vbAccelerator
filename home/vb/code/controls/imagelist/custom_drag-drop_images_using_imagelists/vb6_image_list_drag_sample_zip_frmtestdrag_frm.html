<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: frmTestDrag.frm</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: frmTestDrag.frm" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;<a href="article.html">Custom Drag-Drop Images Using ImageLists</a>&#160;.&#160;<a href="vb6_image_list_drag_sample.html">VB6 Image List Drag Sample</a>&#160;.&#160;frmTestDrag.frm</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_image_list_drag_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Image List Drag Sample</a> (124K)</p><p /><p class="nav"><a href="vb6_image_list_drag_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Image List Drag Sample</a> (122K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:4103</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=4103&type=zip&title=vb6_20image_20list_20drag_20sample_2ezip_5ffrmtestdrag.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />19 Feb 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\tips\get_a_picture_of_the_desktop_contents\article.html">Get a Picture of the Desktop's Contents</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\displaying_alpha_(32bit)_icons_with_imagelists\article[1].html">Displaying Alpha (32bit) Icons with ImageLists</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\graphics_and_gdi\flicker_free_api_drawing\article.html">Flicker Free API Drawing</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: frmTestDrag.frm</h1><pre>VERSION 5.00
Object = "{396F7AC0-A0DD-11D3-93EC-00C0DFE7442A}#1.0#0"; "vbalIml6.ocx"
Begin VB.Form frmImageListDragDrop 
   Caption         =   "vbAccelerator Image List Drag Drop Demonstration"
   ClientHeight    =   3435
   ClientLeft      =   2940
   ClientTop       =   2865
   ClientWidth     =   6585
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmTestDrag.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   3435
   ScaleWidth      =   6585
   Begin vbalIml6.vbalImageList ilsCustom 
      Left            =   3360
      Top             =   2700
      _ExtentX        =   953
      _ExtentY        =   953
      IconSizeX       =   128
      IconSizeY       =   48
      ColourDepth     =   32
   End
   Begin vbalIml6.vbalImageList ilsIcons 
      Left            =   2700
      Top             =   2700
      _ExtentX        =   953
      _ExtentY        =   953
      IconSizeX       =   32
      IconSizeY       =   32
      ColourDepth     =   32
      Size            =   154420
      Images          =   "frmTestDrag.frx":1272
      Version         =   131072
      KeyCount        =   35
      Keys            =   $"frmTestDrag.frx":26DC6
   End
   Begin VB.TextBox txtDragDrop 
      Height          =   2175
      Left            =   2520
      MultiLine       =   -1  'True
      OLEDropMode     =   2  'Automatic
      ScrollBars      =   2  'Vertical
      TabIndex        =   1
      Text            =   "frmTestDrag.frx":26F4A
      Top             =   360
      Width           =   3615
   End
   Begin VB.PictureBox picDragDrop 
      AutoRedraw      =   -1  'True
      BackColor       =   &amp;H80000005&amp;
      Height          =   2415
      Left            =   60
      OLEDropMode     =   1  'Manual
      ScaleHeight     =   157
      ScaleMode       =   3  'Pixel
      ScaleWidth      =   153
      TabIndex        =   0
      Top             =   60
      Width           =   2355
   End
   Begin VB.Label lblInfo 
      Caption         =   "Text:"
      Height          =   255
      Left            =   2520
      TabIndex        =   2
      Top             =   60
      Width           =   3615
   End
End
Attribute VB_Name = "frmImageListDragDrop"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Private m_cDrag As cImageListDrag

Private Declare Function RedrawWindow Lib "user32" (ByVal hwnd As Long,
 lprcUpdate As RECT, ByVal hrgnUpdate As Long, ByVal fuRedraw As Long) As Long
Private Const RDW_UPDATENOW = &amp;H100
Private Const RDW_INVALIDATE = &amp;H1
Private Const RDW_ALLCHILDREN = &amp;H80
Private Const RDW_ERASE = &amp;H4

' Processing of the Image Picture Box:
Private Type RECT
   left As Long
   top As Long
   right As Long
   bottom As Long
End Type
Private Declare Function PtInRect Lib "user32" (lpRect As RECT, ByVal ptX As
 Long, ByVal ptY As Long) As Long
Private m_iDragOver As Long
Private m_iDragging As Long
Private m_tR() As RECT
Private m_iOrder() As Long
Private m_iCount As Long

' Creating a custom drag image:
Private Declare Function SelectObject Lib "gdi32" (ByVal hdc As Long, ByVal
 hObject As Long) As Long
Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As
 Long
Private Declare Function SetBkColor Lib "gdi32" (ByVal hdc As Long, ByVal
 crColor As Long) As Long
Private Declare Function SetBkMode Lib "gdi32" (ByVal hdc As Long, ByVal
 nBkMode As Long) As Long
Private Declare Function SetTextColor Lib "gdi32" (ByVal hdc As Long, ByVal
 crColor As Long) As Long
Private Declare Function GetSysColor Lib "user32" (ByVal nIndex As Long) As Long
Private Const TRANSPARENT = 1
Private Declare Function DrawText Lib "user32" Alias "DrawTextA" (ByVal hdc As
 Long, ByVal lpStr As String, ByVal nCount As Long, lpRect As RECT, ByVal
 wFormat As Long) As Long
Private Const DT_CENTER = &amp;H1
Private Const DT_TOP = &amp;H0
Private Const DT_WORDBREAK = &amp;H10
Private Const DT_WORD_ELLIPSIS = &amp;H40000
Private m_iLastSelStart As Long
Private m_iLastSelLength As Long

Private Sub setDragState()
   On Error Resume Next
   Dim ctl As Control
   For Each ctl In Me.Controls
      If (ctl.OLEDropMode = 0) Then ' none
         ctl.OLEDropMode = 1 ' manual
      End If
   Next
   If Me.OLEDropMode = 0 Then
      Me.OLEDropMode = 1
   End If
End Sub

Private Sub Form_Load()
   
   setDragState
   
   Set m_cDrag = New cImageListDrag
   'm_cDrag.Owner = Me ' if you set the owner, then the image is only displayed
    within that object's window
   
   Dim i As Long
   m_iCount = ilsIcons.ImageCount
   ReDim m_iOrder(1 To m_iCount) As Long
   For i = 1 To m_iCount
      m_iOrder(i) = i
   Next i
   ReDim m_tR(1 To m_iCount) As RECT
   paintIcons
   
End Sub


Private Sub Form_OLEDragOver(Data As DataObject, Effect As Long, Button As
 Integer, Shift As Integer, X As Single, Y As Single, State As Integer)
   Effect = vbDropEffectNone
End Sub

Private Sub Form_Resize()
   On Error Resume Next
   picDragDrop.Height = Me.ScaleHeight - picDragDrop.top * 2
   txtDragDrop.Move _
      txtDragDrop.left, _
      txtDragDrop.top, _
      Me.ScaleWidth - txtDragDrop.left - 4 * Screen.TwipsPerPixelX, _
      Me.ScaleHeight - txtDragDrop.top - picDragDrop.top
End Sub

Private Sub picDragDrop_MouseDown(Button As Integer, Shift As Integer, X As
 Single, Y As Single)
Dim i As Long
   i = hitTest(X, Y)
   If (i &gt; 0) Then
      m_iDragOver = i
      m_iDragging = i
      picDragDrop.OLEDrag
   End If
End Sub

Private Sub picDragDrop_MouseMove(Button As Integer, Shift As Integer, X As
 Single, Y As Single)
   '
End Sub

Private Sub picDragDrop_OLECompleteDrag(Effect As Long)
   '
   m_cDrag.CompleteDrag
   '
End Sub

Private Sub picDragDrop_OLEDragDrop(Data As DataObject, Effect As Long, Button
 As Integer, Shift As Integer, X As Single, Y As Single)
   '
   m_cDrag.CompleteDrag
   
   Dim i As Long
   Dim j As Long
   Dim iOrder As Long
   i = hitTest(X, Y)
   If (i &gt; 0) Then
      If Not (i = m_iDragging) Then
         If (m_iDragging &lt; i) Then
            iOrder = m_iOrder(m_iDragging)
            For j = m_iDragging To i - 1
               m_iOrder(j) = m_iOrder(j + 1)
            Next j
            m_iOrder(i) = iOrder
         Else
            iOrder = m_iOrder(m_iDragging)
            For j = m_iDragging To i + 1 Step -1
               m_iOrder(j) = m_iOrder(j - 1)
            Next j
            m_iOrder(i) = iOrder
         End If
         paintIcons
      End If
   End If
   '
End Sub

Private Sub picDragDrop_OLEDragOver(Data As DataObject, Effect As Long, Button
 As Integer, Shift As Integer, X As Single, Y As Single, State As Integer)
   '
   Dim b() As Byte
   On Error Resume Next
   b = Data.GetData(&amp;HFFFFB045)
   Dim s As String
   On Error GoTo 0
   s = b
   If (InStr(s, "picDragDrop") &gt; 0) Then
      Dim i As Long
      i = hitTest(X, Y)
      If Not (i = m_iDragOver) Then
         m_iDragOver = i
         paintIcons
      End If
   Else
      Effect = vbDropEffectNone
   End If
   '
End Sub

Private Sub picDragDrop_OLEGiveFeedback(Effect As Long, DefaultCursors As
 Boolean)
   '
   m_cDrag.DragDrop
   '
End Sub

Private Sub picDragDrop_OLESetData(Data As DataObject, DataFormat As Integer)
   '
   '
End Sub

Private Sub picDragDrop_OLEStartDrag(Data As DataObject, AllowedEffects As Long)
   '
   paintIcons
   Data.SetData ilsIcons.ItemKey(m_iDragOver), vbCFText
   Dim b() As Byte
   b = "picDragDrop"
   Data.SetData b, &amp;HFFFFB045
   AllowedEffects = vbDropEffectCopy
   m_cDrag.hImagelist = ilsIcons.hIml
   m_cDrag.StartDrag m_iOrder(m_iDragOver) - 1, -8, -8
   '
End Sub

Private Sub picDragDrop_Resize()
   paintIcons
End Sub

Private Sub paintIcons()
   '
   Dim i As Long
   Dim X As Long
   Dim Y As Long
   picDragDrop.Cls
   X = 4
   Y = 4
   For i = 1 To m_iCount
      m_tR(i).left = X
      m_tR(i).top = Y
      m_tR(i).right = X + 32
      m_tR(i).bottom = Y + 32
      ilsIcons.DrawImage m_iOrder(i), picDragDrop.hdc, X, Y, (i = m_iDragOver)
      X = X + 32 + 8
      If (X + 32 &gt; picDragDrop.ScaleWidth) Then
         X = 4
         Y = Y + 32 + 8
      End If
   Next i
   
   m_cDrag.HideDragImage True
   picDragDrop.Refresh
   m_cDrag.HideDragImage False
   '
End Sub

Private Function hitTest(ByVal X As Long, ByVal Y As Long) As Long
Dim i As Long
   For i = 1 To ilsIcons.ImageCount
      If Not (PtInRect(m_tR(i), X, Y) = 0) Then
         hitTest = i
         Exit For
      End If
   Next i
End Function

Private Function IsInRange( _
      ByVal lIndex As Long, _
      ByVal lStart As Long, _
      ByVal lLength As Long _
   )
   IsInRange = ((lIndex &gt;= lStart) And (lIndex &lt;= lStart + lLength))
End Function

Private Sub txtDragDrop_MouseDown(Button As Integer, Shift As Integer, X As
 Single, Y As Single)
   If IsInRange(txtDragDrop.SelStart, m_iLastSelStart, m_iLastSelLength) Then
      txtDragDrop.SelStart = m_iLastSelStart
      txtDragDrop.SelLength = m_iLastSelLength
      txtDragDrop.OLEDrag
   Else
      m_iLastSelStart = txtDragDrop.SelStart
      m_iLastSelLength = txtDragDrop.SelLength
   End If
End Sub

Private Sub txtDragDrop_MouseUp(Button As Integer, Shift As Integer, X As
 Single, Y As Single)
   m_iLastSelStart = txtDragDrop.SelStart
   m_iLastSelLength = txtDragDrop.SelLength
End Sub

Private Sub txtDragDrop_OLECompleteDrag(Effect As Long)
   m_cDrag.CompleteDrag
   
   Dim tR As RECT
   tR.right = Me.ScaleX(txtDragDrop.Width, Me.ScaleMode, vbPixels)
   tR.bottom = Me.ScaleY(txtDragDrop.Height, Me.ScaleMode, vbPixels)
   RedrawWindow txtDragDrop.hwnd, tR, 0&amp;, RDW_UPDATENOW Or RDW_INVALIDATE Or
    RDW_ALLCHILDREN Or RDW_ERASE
   
   m_iLastSelStart = txtDragDrop.SelStart
   m_iLastSelLength = txtDragDrop.SelLength
   
End Sub


Private Sub txtDragDrop_OLEDragOver(Data As DataObject, Effect As Long, Button
 As Integer, Shift As Integer, X As Single, Y As Single, State As Integer)
   '
End Sub

Private Sub txtDragDrop_OLEGiveFeedback(Effect As Long, DefaultCursors As
 Boolean)
   m_cDrag.DragDrop
End Sub

Private Sub txtDragDrop_OLEStartDrag(Data As DataObject, AllowedEffects As Long)
   '
   ' Get the selected text:
   Dim sText As String
   sText = txtDragDrop.SelText
   
   ' Create a memory DC for adding to the ImageList:
   Dim cMemDC As New pcMemDC
   cMemDC.Width = 128
   cMemDC.Height = 48
   
   ' Draw the text into it:
   Dim hFontOld As Long
   Dim iFnt As IFont
   Dim tR As RECT
   tR.top = 2
   tR.bottom = 2
   tR.right = 126
   tR.bottom = 46
   Set iFnt = txtDragDrop.Font
   hFontOld = SelectObject(cMemDC.hdc, iFnt.hFont)
   SetBkColor cMemDC.hdc, GetSysColor(vbHighlight And &amp;H1F&amp;)
   SetTextColor cMemDC.hdc, GetSysColor(vbHighlightText And &amp;H1F&amp;)
   DrawText cMemDC.hdc, sText, -1, tR, DT_WORDBREAK Or DT_WORD_ELLIPSIS Or
    DT_TOP
   SelectObject cMemDC.hdc, hFontOld
      
   ' Get a clone of the image:
   Dim lhBmp As Long
   lhBmp = cMemDC.hBitmap
   
   ' Add to the custom image list:
   ilsCustom.Clear
   ilsCustom.IconSizeX = 128
   ilsCustom.IconSizeY = 48
   ilsCustom.ColourDepth = ILC_COLOR32
   ilsCustom.AddFromHandle lhBmp, IMAGE_BITMAP, "CUSTOM", &amp;H0&amp;
   DeleteObject lhBmp
   
   m_cDrag.hImagelist = ilsCustom.hIml
   m_cDrag.StartDrag 0, 64, 24
   
   Data.SetData sText, vbCFText
   AllowedEffects = vbDropEffectCopy
   '
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">ImageList</a>&#160;.&#160;<a href="article.html">Custom Drag-Drop Images Using ImageLists</a>&#160;.&#160;<a href="vb6_image_list_drag_sample.html">VB6 Image List Drag Sample</a>&#160;.&#160;frmTestDrag.frm</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>