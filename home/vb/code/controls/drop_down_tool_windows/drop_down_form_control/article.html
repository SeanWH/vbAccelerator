<html lang="en" >
<head>
<title>vbAccelerator - vbAccelerator Drop-Down and Popup Form Control</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="This control allows you to use any form as a drop-down window, and optionally to drag the form off and float it over the form. The form behaves just like the drop-down windows in Office, albeit you cannot currently dock them (yet!) The code includes a VB titlebar modifier class which ensures that any owned forms with the WS_EX_TOOLWINDOW style (i.e. VB WindowStyles 4 and 5) shown in a VB app do not take focus away from the owner form's titlebar - and the form also stays active in the TaskBar too. This functionality is completely generic and works regardless of how many taskbar forms you have in your app." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" />
<link rel="contents" href="../index.asp" /><link rel="meta" type="application/rdf+xml" href="./article.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Drop Down Tool Windows</a>&#160;.&#160;vbAccelerator Drop-Down and Popup Form Control</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_drop_down_form_control_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Binary</a> (18K)</p><p class="nav"><a href="vb5_drop_down_form_control_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Demonstration</a> (44K)</p><p class="nav"><a href="vb5_drop_down_form_control_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Full Source</a> (81K)</p><p /><p class="nav"><a href="vb6_drop_down_form_control_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Binary</a> (19K)</p><p class="nav"><a href="vb6_drop_down_form_control_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Demonstration</a> (48K)</p><p class="nav"><a href="vb6_drop_down_form_control_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Full Source</a> (86K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:1070</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=1070&type=article&title=vbaccelerator_20drop_2ddown_20and_20popup_20form_20control.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />21 Mar 2000<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\emulating_modal_forms\article.html">Emulating Modal Forms</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\office_style_table_picker\article.html">Creating drop-down tool windows</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator Drop-Down and Popup Form Control</h1><p class="splash">Enables any VB form to be used as a drop-down, plus ensures all forms with the ToolWindow style operate just like Office</p><img src="vbalddfm.gif" width="200" height="142" alt="Drop-Down Form Control in Action" /><p /><p>This control allows you to use any form as a drop-down window, and optionally to drag the form off and float it over the form. The form behaves just like the drop-down windows in Office, albeit you cannot currently dock them (yet!) The code includes a VB titlebar modifier class which ensures that any owned forms with the <i>WS_EX_TOOLWINDOW</i> style (i.e. VB WindowStyles 4 and 5) shown in a VB app do not take focus away from the owner form's titlebar - and the form also stays active in the TaskBar too. This functionality is completely generic and works regardless of how many taskbar forms you have in your app.</p><h2>Please Release Me</h2><p>The preview of this control was launched back in August, with the aim of a release a month later Unfortunately, the preview version hit a snag. When you showed a drop-down window, the tasklist switched so it looked like your form was inactive. It doesn't sound like much, does it? Surely you could fix that with a couple of quick API calls? Well, that just didn't happen. The problem with this sort of thing is that whilst VB performs incorrectly, the implementation is hidden and there is no way of working out what it is doing. And the implementation relies on certain messages being passed correctly, so although it was possible to solve parts of the problem (keep the form's titlebar in focus or keep the task bar icon highlighted), many of the solutions had consequences on VB's ability to track the focus control or form. These consequences vary from the tedious (focus always switches to an MDI child form, or have to click twice on a control to make it operate) to the dramatic (blue screen of death, Kernel32.exe faults, white GPF screens, deadcafe... I've had every single one now!)</p><h2>The Question, or the Answer?</h2><p>Anyway, seven months later, I spotted a Q&amp;A article by Karl Peterson in VBPJ, where he writes an "Ask the VB Pro" column. The question in question was how to set your application's icon so it always shows correctly in the Alt-Tab list. The interesting thing about the article was it described how VB creates a hidden window (with the class name ThunderMain) which is the ultimate owner of all other VB windows in a VB application. Hmmm... So would that affect the TaskBar, then?</p><p>You can find the window if you fire up Spy++ and point it at a top-level VB form and then look for the parent window, or, if you're in VB, you can get the window handle using the <i>GetWindow</i> API call:</p><pre>
   hWndThunderMain = GetWindow(Me.hWnd, GW_OWNER)
</pre><p>It took some playing to work out that you can prevent the Taskbar icon from losing its highlight by making the ThunderMain window invisible when you are about to show an owned window. A bit more playing revealed that the perfect behaviour was achieved if you instead just stripped the <i>WS_VISIBLE</i> style bit at the appropriate time, the appropriate time being when the ThunderMain window gets a <i>WM_WINDOWPOSCHANGING</i> message, because it is about to modify the ZOrder position and when the window returned by the <i>GetActiveWindow</i> API call is owned by another VB window rather than ThunderMain. Cool! Three or four versions later, and finally here is the code: a full, generic implementation of the MS Office integration of its main window with Win32, which works on Win95,98,NT,2000 and XP.</p><h2>Pregnant - by the Boy I was Babysitting</h2><p>Since VB operates by only setting up one ThunderMain window per VB application, this results in a tricky coding problem when it comes to add the subclass. If every window just adds a subclass to the ThunderMain window, then you end up processing the same message multiple times when a window is shown. This works fine when you have one window in the application - but of course, that isn't a problem anyway! When you have two windows, you get into problems, particularly when the windows have contradictory intentions about what to do with the taskbar icon - and they start "fighting" each other, causing your VB app to go into a flickering loop which can only be stopped by extreme use of Task Manager :)</p><p>The solution to this problem is to ensure that regardless of the source object, only one subclass is installed, and its processing works without reference to the object which installed the subclass (otherwise you need to fire the same message to multiple objects, and they could return conflicting results).</p><p>Whilst the Subclassing and Timer Assistant component available from this site solves most subclassing issues, it doesn't solve this one, so some customised subclassing code was needed to ensure the object behaves in this manner. You can find this code in the module mTitleBarMod.bas within the Drop-Down form control. Note that if any other component within your application needed to subclass the hidden VB window, you could run into problems with this subclassing approach: it would no longer be guaranteed to receive messages in the same order and hence the focus processing could be lost.</p><h2>The Drop-Down Form Package</h2><p>This object is compiled as an ActiveX control with two constituent controls:</p><h3>vbalTitleBarModifier</h3><p>This component is invisible at runtime and installs the ThunderMain subclasser discussed above to ensure the titlebar activation is correct. This component should be added to all main forms in your application.</p><p>In use, this component has only one method; <i>Attach</i>. You pass in the hWnd of the form you are trying to show as a parameter and the control then does all the rest of the work.</p><h3>vbalDropDownClient</h3><p>This component acts as a replacement titlebar on windows with VB WindowStyle 4 or 5 and the <i>Caption</i> property set to blank and <i>ControlBox</i> set to False. It provides the automatic hide functionality when the form is set to drop-down and also enables the form to be "dragged-off" and floated on the screen. It also provides methods to restrict the size of the window on screen and can be used to auto-hide floating toolwindows when the user switches to anther application similar to the behaviour of Word and Excel.</p><p>This component provides a number of useful events to your dropdown window:</p><ul><li><i>AppActivate</i> - Raised whenever the application is activated or inactivated. You can hide/show the tool window here to emulate the behaviour of Office.</li><li><i>DeactivateForm</i> - Raised whenever focus switches from the ToolWindow to another form in the application. If the window is in the drop-down state, then the control posts a <i>WM_CLOSE</i> message to the form, which has the same effect as if the user chose the System Menu close option.</li><li><i>CaptionResize</i> - Raised when the control has resized the caption, for example, when the form switches between the drop-down and floating states. This event enables you to position the controls on the form to the appropriate point.</li><li><i>Moving</i> - Raised whenever the form is moved. You can control the position of the form by modifying the left, top, width and height parameters of this event.</li><li><i>RightClick</i> - Raised whenever the user right clicks on the control.</li><li><i>Sizing</i> - Raised whenever the form is sized. You can control the position and size of the form by modifying the left,top,width and height parameters of this event.</li></ul><p>The control's behaviour can be customised using the properties and methods:</p><ul><li><i>AllowResize</i><br />
This property enables you to create a form which behaves like the Fixed ToolWindow but with the more pleasant 3D border provided by a Sizable ToolWindow.</li><li><i>AllowTearOff</i><br />
Determines whether you can tear-off the control when it is in the drop-down state.</li><li><i>Caption</i><br />
Gets/sets the caption of the Tool Window.</li><li><i>MoveOnFormMouseDown</i><br />
If set to True, enables mouse clicks on the form to start the form moving as if it was a click on the titlebar.</li><li><i>ShowState</i><br />
Gets/sets the current state of the Tool Window - hidden, shown in the drop-down position or shown floating.</li></ul><p>For more information on the techniques used to detect sizing and activation changes in these controls, check out these articles:</p><ul><li>Detecting when another application is activated</li><li>Sophisticated control over Window Sizing and Moving</li><li>Reliable interception of <i>WM_NCHITTEST</i> messages</li></ul><h2>Showing Drop-Down Forms from Modal Forms</h2><p>One problem with this technique is that you cannot use it directly from a form shown with modally in VB, otherwise you get the error message "Can't show non-modal form when modal form is displayed". There is a workaround for this problem by which you can emulate showing the form modally - see the article <a href="..\..\..\libraries\subclassing\emulating_modal_forms\article.html">Emulating Modal Forms</a>. This technique has the additional advantage in that it allows you to create VB projects which have an Internet Explorer style New Window option, but showing a modal form in one window does not block execution in the other.</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">Drop Down Tool Windows</a>&#160;.&#160;vbAccelerator Drop-Down and Popup Form Control</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 11 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>