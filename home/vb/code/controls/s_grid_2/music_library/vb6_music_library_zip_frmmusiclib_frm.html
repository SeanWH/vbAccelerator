<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: frmMusicLib.frm</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: frmMusicLib.frm" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">MusicLibrary SGrid Sample</a>&#160;.&#160;<a href="vb6_music_library.html">VB6 Music Library</a>&#160;.&#160;frmMusicLib.frm</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_music_library.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Music Library</a> (108K)</p><p /><p class="nav"><a href="vb6_music_library.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Music Library</a> (104K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:13983</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=13983&type=zip&title=vb6_20music_20library_2ezip_5ffrmmusiclib.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />24 Jan 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\common_dialogs\code_only_common_dialogs\article.html">Two code only solutions for displaying Common/Dialogs</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\s_grid_2\article.html">SGrid 2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\type_libraries\ishellfolder\article.html">IShellFolder Extended Type Library Version 1.2 (ISHF_Ex.Tlb)</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vbmedia\audio\reading_and_writing_mp3_id3v1_and_v2_tags\article.html">Reading and Writing MP3 ID3v1 and ID3v2 Tags</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\tips\compact_a_long_path_name_to_fit_a_given_space\article.html">Compact a Long Path Name to fit a given space</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\common_dialogs\folder_browser\article.html">Browsing For Folders</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: frmMusicLib.frm</h1><pre>VERSION 5.00
Object = "{DE8CE233-DD83-481D-844C-C07B96589D3A}#1.1#0"; "vbalSGrid6.ocx"
Object = "{396F7AC0-A0DD-11D3-93EC-00C0DFE7442A}#1.0#0"; "vbalIml6.ocx"
Begin VB.Form frmMusicLib 
   Caption         =   "S-Grid 2.0 Music Library Sample"
   ClientHeight    =   5655
   ClientLeft      =   2970
   ClientTop       =   2550
   ClientWidth     =   9420
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmMusicLib.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   5655
   ScaleWidth      =   9420
   Begin vbalIml6.vbalImageList ilsIcons 
      Left            =   1740
      Top             =   5160
      _ExtentX        =   953
      _ExtentY        =   953
      ColourDepth     =   32
      Size            =   2296
      Images          =   "frmMusicLib.frx":0A02
      Version         =   131072
      KeyCount        =   2
      Keys            =   "SORTASCSORTDESC"
   End
   Begin vbAcceleratorSGrid6.vbalGrid grdLib 
      Height          =   4815
      Left            =   60
      TabIndex        =   0
      Top             =   60
      Width           =   9135
      _ExtentX        =   16113
      _ExtentY        =   8493
      BackgroundPictureHeight=   0
      BackgroundPictureWidth=   0
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      BorderStyle     =   2
      DisableIcons    =   -1  'True
   End
   Begin VB.Menu mnuFileTOP 
      Caption         =   "&amp;File"
      Begin VB.Menu mnuFile 
         Caption         =   "Play &amp;Selected Track"
         Index           =   0
         Shortcut        =   {F5}
      End
      Begin VB.Menu mnuFile 
         Caption         =   "Play this &amp;Album"
         Index           =   1
      End
      Begin VB.Menu mnuFile 
         Caption         =   "Play everything by this A&amp;rtist"
         Index           =   2
      End
      Begin VB.Menu mnuFile 
         Caption         =   "-"
         Index           =   3
      End
      Begin VB.Menu mnuFile 
         Caption         =   "Make &amp;Playlist for Selected Track..."
         Index           =   4
      End
      Begin VB.Menu mnuFile 
         Caption         =   "Make Playlist for Selected A&amp;lbum..."
         Index           =   5
      End
      Begin VB.Menu mnuFile 
         Caption         =   "Make Playlist for Selected Ar&amp;tist..."
         Index           =   6
      End
      Begin VB.Menu mnuFile 
         Caption         =   "-"
         Index           =   7
      End
      Begin VB.Menu mnuFile 
         Caption         =   "&amp;Import Files.."
         Index           =   8
         Shortcut        =   ^I
      End
      Begin VB.Menu mnuFile 
         Caption         =   "-"
         Index           =   9
      End
      Begin VB.Menu mnuFile 
         Caption         =   "E&amp;xit"
         Index           =   10
      End
   End
   Begin VB.Menu mnuEditTOP 
      Caption         =   "&amp;Edit"
      Begin VB.Menu mnuEdit 
         Caption         =   "&amp;Tags..."
         Index           =   0
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "-"
         Index           =   1
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "&amp;Find..."
         Index           =   2
         Shortcut        =   ^F
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "-"
         Index           =   3
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "&amp;Remove Selected Tracks..."
         Index           =   4
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "-"
         Index           =   5
      End
      Begin VB.Menu mnuEdit 
         Caption         =   "&amp;Clear Library..."
         Index           =   6
      End
   End
   Begin VB.Menu mnuViewTOP 
      Caption         =   "&amp;View"
      Begin VB.Menu mnuView 
         Caption         =   "&amp;Columns"
         Index           =   0
         Begin VB.Menu mnuColumns 
            Caption         =   ""
            Index           =   0
         End
      End
      Begin VB.Menu mnuView 
         Caption         =   "-"
         Index           =   1
      End
      Begin VB.Menu mnuView 
         Caption         =   "&amp;Group Box"
         Index           =   2
      End
   End
   Begin VB.Menu mnuHelpTOP 
      Caption         =   "&amp;Help"
      Begin VB.Menu mnuHelp 
         Caption         =   "&amp;vbAccelerator.com..."
         Index           =   0
         Shortcut        =   {F1}
      End
      Begin VB.Menu mnuHelp 
         Caption         =   "-"
         Index           =   1
      End
      Begin VB.Menu mnuHelp 
         Caption         =   "&amp;About..."
         Index           =   2
      End
   End
   Begin VB.Menu mnuHeaderCtxTOP 
      Caption         =   ""
      Visible         =   0   'False
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "Sort &amp;Ascending"
         Index           =   0
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "Sort &amp;Descending"
         Index           =   1
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "-"
         Index           =   2
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "Group by this &amp;Field"
         Index           =   3
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "&amp;Group Box"
         Index           =   4
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "-"
         Index           =   5
      End
      Begin VB.Menu mnuHeaderCtx 
         Caption         =   "&amp;Remove this Column"
         Index           =   6
      End
   End
   Begin VB.Menu mnuGridCtxTOP 
      Caption         =   ""
      Visible         =   0   'False
      Begin VB.Menu mnuGridCtx 
         Caption         =   "Play this &amp;Track"
         Index           =   0
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "Play this &amp;Album"
         Index           =   1
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "Play everything by this A&amp;rtist"
         Index           =   2
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "-"
         Index           =   3
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "&amp;Remove from Library..."
         Index           =   4
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "-"
         Index           =   5
      End
      Begin VB.Menu mnuGridCtx 
         Caption         =   "&amp;Edit"
         Index           =   6
         Visible         =   0   'False
      End
   End
End
Attribute VB_Name = "frmMusicLib"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Private Declare Function ShellExecute Lib "shell32.dll" Alias "ShellExecuteA"
 (ByVal hWnd As Long, ByVal lpOperation As String, ByVal lpFile As String,
 ByVal lpParameters As String, ByVal lpDirectory As String, ByVal nShowCmd As
 Long) As Long
Private Const SW_SHOWNORMAL = 1

Private m_fP As frmProgress
Private m_bDirtyLibrary As Boolean

Private Sub playList(colPlay As Collection)
Dim vItem As Variant

   For Each vItem In colPlay
      ShellExecute Me.hWnd, "Enqueue", vItem, "", "", SW_SHOWNORMAL
   Next

End Sub

Private Sub makePlaylist(ByVal sNameHint As String, colPlay As Collection)
Dim sFile As String
Dim cD As New cCommonDialog
Dim vItem As Variant
Dim iFile As Integer
   sFile = stripBadFileNameChars(sNameHint) &amp; ".m3u"
   If (cD.VBGetOpenFileName(sFile, Filter:="PlayLists (*.M3U)|M3U|All Files
    (*.*)|*.*", DefaultExt:="MRU", Owner:=Me.hWnd)) Then
      killFileIfExists sFile
      On Error GoTo errorHandler
      iFile = FreeFile
      Open sFile For Binary Access Write Lock Read As #iFile
      For Each vItem In colPlay
         Put #iFile, , CStr(vItem) &amp; vbCrLf
      Next
      Close #iFile
   End If
   Exit Sub
errorHandler:
Dim lErr As Long
Dim sErr As String
   lErr = Err.Number
   sErr = Err.Description
   On Error Resume Next
   Close #iFile
   On Error GoTo 0
   MsgBox "An error occurred trying to write the playlist: " &amp; sErr,
    vbExclamation
   Exit Sub
End Sub

Private Function stripBadFileNameChars(ByVal sBad As String) As String
Dim i As Long
Dim sC As String
Dim sRet As String
   For i = 1 To Len(sBad)
      sC = Mid(sBad, i, 1)
      Select Case sC
      Case "\", "/", "*", ":", "?", """", "&lt;", "&gt;", "|"
         sRet = sRet &amp; "_"
      Case Else
         sRet = sRet &amp; sC
      End Select
   Next i
   stripBadFileNameChars = sRet
End Function

Private Sub addGroupSubItems(ByVal iRow As Long, colPlay As Collection)
Dim iSubRow As Long
Dim iLevel As Long
Dim iSubLevel As Long
Dim bComplete As Boolean
   
   With grdLib
      iLevel = .RowGroupingLevel(iRow)
      iSubRow = iRow
      Do
         iSubRow = iSubRow + 1
         If (iSubRow &gt; .Rows) Then
            bComplete = True
         Else
            If (.RowIsGroup(iSubRow)) Then
               If (.RowGroupingLevel(iSubRow) &lt;= iLevel) Then
                  bComplete = True
               End If
            Else
               On Error Resume Next
               colPlay.Add .CellText(iSubRow, 6), .CellText(iSubRow, 6)
               On Error GoTo 0
            End If
         End If
      Loop While Not bComplete
   End With
End Sub

Private Sub createSelectionPlayList(colPlay As Collection)
Dim i As Long
Dim iRow As Long

   With grdLib
      For i = 1 To .SelectionCount
         iRow = .SelectedRowByIndex(i)
         If (.RowIsGroup(iRow)) Then
            addGroupSubItems iRow, colPlay
         Else
            On Error Resume Next
            colPlay.Add .CellText(iRow, 6), .CellText(iRow, 6)
            On Error GoTo 0
         End If
      Next i
   End With
   
End Sub

Private Sub createArtistPlayList(ByVal sArtist As String, colPlay As Collection)
Dim iRow As Long
   With grdLib
      For iRow = 1 To .Rows
         If Not (.RowIsGroup(iRow)) Then
            If StrComp(.CellText(iRow, 2), sArtist, vbTextCompare) = 0 Then
               colPlay.Add .CellText(iRow, 6), .CellText(iRow, 6)
            End If
         End If
      Next iRow
   End With
End Sub

Private Function createAlbumPlayList(ByVal sAlbum As String, colPlay As
 Collection)
Dim iRow As Long
   With grdLib
      For iRow = 1 To .Rows
         If Not (.RowIsGroup(iRow)) Then
            If StrComp(.CellText(iRow, 3), sAlbum, vbTextCompare) = 0 Then
               colPlay.Add .CellText(iRow, 6), .CellText(iRow, 6)
            End If
         End If
      Next iRow
   End With

End Function

Private Sub setUpColumnsMenu()
Dim iCol As Long
Dim iMenu As Long

   With grdLib
      For iCol = 1 To .Columns
         If (iMenu &gt; 0) Then
            Load mnuColumns(iMenu)
            mnuColumns(iMenu).Visible = True
         End If
         If (.ColumnHeader(iCol) = "") Then
            mnuColumns(iMenu).Caption = StrConv(.ColumnKey(iCol), vbProperCase)
         Else
            mnuColumns(iMenu).Caption = .ColumnHeader(iCol)
         End If
         mnuColumns(iMenu).Tag = .ColumnKey(iCol)
         mnuColumns(iMenu).Checked = .ColumnVisible(iCol)
         iMenu = iMenu + 1
      Next iCol
   End With

End Sub

Private Function findMp3Row(ByVal sFile As String) As Long
Dim sFilename As String
Dim iRow As Long
Dim lFoundRow As Long

   sFilename = fileNameOf(sFile)
   
   For iRow = 1 To grdLib.Rows
      If InStr(grdLib.CellText(iRow, 6), sFilename) &gt; 0 Then
         lFoundRow = iRow
         Exit For
      End If
   Next iRow
      
   findMp3Row = lFoundRow
   
End Function

Private Sub processMp3File(ByVal sFile As String)
Dim c1 As New cMP3ID3v1
Dim c2 As New cMP3ID3v2
Dim sType As String
Dim lRow As Long
Dim dFileLastImport As Date
Dim dFileDateTime As Date
   
   dFileDateTime = FileDateTime(sFile)
   lRow = findMp3Row(sFile)
   If (lRow &gt; 0) Then
      ' Check whether need to process this file or not:
      dFileLastImport = grdLib.CellText(lRow, 9)
      If (dFileDateTime &lt;= dFileLastImport) Then
         ' unchanged
         Exit Sub
      End If
   Else
      ' Add a new row
      grdLib.AddRow
      lRow = grdLib.Rows
   End If
   

   c1.MP3File = sFile
   If (c1.HasID3v1Tag) Then
      sType = "1"
   End If
   
   c2.MP3File = sFile
   If (c2.HasID3v2Tag) Then
      If (Len(sType) &gt; 0) Then
         sType = sType &amp; ","
      End If
      sType = sType &amp; "2"
   End If
     
   If (c2.HasID3v2Tag) Then
      grdLib.CellText(lRow, 1) = c2.Title
      grdLib.CellText(lRow, 2) = c2.Artist
      grdLib.CellText(lRow, 3) = c2.Album
      grdLib.CellText(lRow, 4) = c2.Track
      grdLib.CellText(lRow, 5) = c2.GenreName(c2.Genre)
      grdLib.CellText(lRow, 8) = c2.Year
      grdLib.CellText(lRow, 10) = c2.Comment
   ElseIf (c1.HasID3v1Tag) Then
      grdLib.CellText(lRow, 1) = c1.Title
      grdLib.CellText(lRow, 2) = c1.Artist
      grdLib.CellText(lRow, 3) = c1.Album
      grdLib.CellText(lRow, 4) = c1.Track
      grdLib.CellText(lRow, 5) = c1.GenreName(c1.Genre)
      grdLib.CellText(lRow, 8) = c1.Year
      grdLib.CellText(lRow, 10) = c1.Comment
   Else
      grdLib.CellText(lRow, 1) = fileNameOf(sFile)
   End If
   grdLib.CellText(lRow, 6) = sFile
   grdLib.CellText(lRow, 7) = sType
   grdLib.CellText(lRow, 9) = dFileDateTime
   
   grdLib.CellTextAlign(lRow, 6) = DT_LEFT Or DT_SINGLELINE Or DT_PATH_ELLIPSIS
   grdLib.CellTextAlign(lRow, 4) = DT_RIGHT Or DT_SINGLELINE Or DT_END_ELLIPSIS
   grdLib.CellTextAlign(lRow, 7) = DT_RIGHT Or DT_SINGLELINE Or DT_END_ELLIPSIS
   grdLib.CellTextAlign(lRow, 8) = DT_RIGHT Or DT_SINGLELINE Or DT_END_ELLIPSIS
      
End Sub

Private Function fileNameOf(ByVal sFile As String) As String
Dim i As Long
   For i = Len(sFile) To 1 Step -1
      If (Mid(sFile, i, 1) = "\") Then
         fileNameOf = Mid(sFile, i + 1)
         Exit Function
      End If
   Next i
   fileNameOf = sFile
End Function

Private Sub recurseCheckMP3Files(ByVal sInitDir As String)

Dim colDir As New Collection
Dim colFile As New Collection
Dim sDir As String
Dim sBase As String
Dim vItem As Variant

   If (Right(sInitDir, 1) &lt;&gt; "\") Then
      sBase = sInitDir &amp; "\"
   Else
      sBase = sInitDir
   End If
   
   sDir = Dir(sBase &amp; "*.*", vbDirectory)
   Do While Len(sDir) &gt; 0
      'Debug.Print sDir
      If (GetAttr(sBase &amp; sDir) And vbDirectory) = vbDirectory Then
         If Not (sDir = ".") And Not (sDir = "..") Then
            colDir.Add sBase &amp; sDir
         End If
      Else
         If LCase(Right(sDir, 3)) = "mp3" Then
            colFile.Add sBase &amp; sDir
         End If
      End If
      sDir = Dir
   Loop
   
   ' recurse process directories:
   For Each vItem In colDir
      recurseCheckMP3Files vItem
   Next

   ' process the files
   For Each vItem In colFile
      m_fP.Import = vItem
      processMp3File vItem
      If Not (m_fP.Shown) Then
         Exit For
      End If
      DoEvents
   Next


End Sub


Private Function musicLibFile() As String
Dim sFile As String
   sFile = App.Path
   If (Right(sFile, 1) &lt;&gt; "\") Then sFile = sFile &amp; "\"
   sFile = sFile &amp; "musicLib.dat"
   musicLibFile = sFile
End Function

Private Function musicLibBackupFile() As String
Dim sFile As String
   sFile = App.Path
   If (Right(sFile, 1) &lt;&gt; "\") Then sFile = sFile &amp; "\"
   sFile = sFile &amp; "musicLib.bak"
   musicLibBackupFile = sFile
End Function

Private Function getImportFolder() As String
   Dim cf As New cBrowseForFolder
   cf.hWndOwner = Me.hWnd
   cf.UseNewUI = True
   cf.Title = "Choose Folder to import MP3 files from"
   Dim sFolder As String
   sFolder = cf.BrowseForFolder
   If (Len(sFolder) &gt; 0) Then
      If (Right(sFolder, 1) &lt;&gt; "\") Then
         sFolder = sFolder &amp; "\"
      End If
      getImportFolder = sFolder
   End If
End Function

Private Sub importMusic()
Dim sFolder As String
   m_bDirtyLibrary = True
   sFolder = getImportFolder
   If Len(sFolder) &gt; 0 Then
      Set m_fP = New frmProgress
      m_fP.Show , Me
      recurseCheckMP3Files sFolder
      Unload m_fP
      Set m_fP = Nothing
   End If
End Sub

Private Sub loadLibrary()
Dim sFile As String
   sFile = musicLibFile()
   If (fileExists(sFile)) Then
      grdLib.LoadGridData sFile
      grdLib_SelectionChange 0, 0
   End If
End Sub

Private Sub saveLibrary()
Dim sFile As String
Dim sBackFile As String
   sFile = musicLibFile()
   If (fileExists(sFile)) Then
      sBackFile = musicLibBackupFile()
      killFileIfExists sBackFile
      FileCopy sFile, sBackFile
      killFileIfExists sFile
   End If
   If (grdLib.Rows &gt; 0) Then
      grdLib.SaveGridData musicLibFile()
   Else
      killFileIfExists sFile
   End If
End Sub

Private Function fileExists(ByVal sFile As String) As Boolean
Dim sDir As String
   On Error Resume Next
   sDir = Dir(sFile)
   fileExists = ((Err.Number = 0) And (Len(sDir) &gt; 0))
End Function
Private Sub killFileIfExists(ByVal sFile As String)
   On Error Resume Next
   Kill sFile
End Sub
Private Sub setUpGrid()
   
   ' Set general options:
   With grdLib
      .BackColor = RGB(80, 120, 100)
      .AlternateRowBackColor = RGB(84, 126, 105)
      .GroupRowBackColor = RGB(56, 84, 70)
      .GroupingAreaBackColor = .BackColor
      .ForeColor = RGB(243, 247, 245)
      .GroupRowForeColor = .ForeColor
      .HighlightForeColor = vbWindowText
      .HighlightBackColor = RGB(255, 255, 255)
      .NoFocusHighlightBackColor = RGB(200, 200, 200)
      .SelectionAlphaBlend = True
      .SelectionOutline = True
      .DrawFocusRectangle = False
      .HighlightSelectedIcons = False
      .HotTrack = True
      .RowMode = True
      .MultiSelect = True
   
      ' Add the columns:
      .AddColumn "Title", "Title", lColumnWidth:=192,
       eSortType:=CCLSortStringNoCase
      .AddColumn "Artist", "Artist", lColumnWidth:=128,
       eSortType:=CCLSortStringNoCase
      .AddColumn "Album", "Album", lColumnWidth:=192,
       eSortType:=CCLSortStringNoCase
      .AddColumn "Track", "Track", eAlign:=ecgHdrTextALignRight,
       eSortType:=CCLSortNumeric
      .AddColumn "Genre", "Genre", bVisible:=False,
       eSortType:=CCLSortStringNoCase
      .AddColumn "Filename", "Filename", eSortType:=CCLSortStringNoCase
      .AddColumn "TagType", "TagType", eAlign:=ecgHdrTextALignRight,
       bVisible:=False, eSortType:=CCLSortStringNoCase
      .AddColumn "Year", "Year", eAlign:=ecgHdrTextALignRight, bVisible:=False,
       eSortType:=CCLSortNumeric
      .AddColumn "LastImportFileDate", "", , , , bVisible:=False
      .AddColumn "Comments", "Comments", bRowTextColumn:=True
      
      .HeaderImageList = ilsIcons
      
      .StretchLastColumnToFit = True
      
   End With
   
End Sub

Private Sub Form_Load()
   
   setUpGrid
   setUpColumnsMenu
   
   Me.Show
   Me.Refresh
   
   loadLibrary
   
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
   If (m_bDirtyLibrary) Then
      Dim fP As New frmProgress
      fP.Import = "Saving Music Library..."
      fP.Show
      fP.Refresh
      Me.Enabled = False
      saveLibrary
      Unload fP
   End If
End Sub

Private Sub Form_Resize()
   On Error Resume Next
   grdLib.Move grdLib.Left, grdLib.TOp, Me.ScaleWidth - grdLib.Left * 2,
    Me.ScaleHeight - grdLib.TOp * 2
End Sub

Private Sub grdLib_ColumnClick(ByVal lCol As Long)
Dim iCol As Long
Dim iSortCol As Long
Dim sJunk() As String, eJunk() As ECGSortOrderConstants

   With grdLib.SortObject
      .ClearNongrouped
      iSortCol = .IndexOf(lCol)
      If (iSortCol &lt;= 0) Then
         iSortCol = .Count + 1
      End If
      
      .SortColumn(iSortCol) = lCol
      If (grdLib.ColumnSortOrder(lCol) = CCLOrderNone) Or
       (grdLib.ColumnSortOrder(lCol) = CCLOrderDescending) Then
         .SortOrder(iSortCol) = CCLOrderAscending
      Else
         .SortOrder(iSortCol) = CCLOrderDescending
      End If
      grdLib.ColumnSortOrder(lCol) = .SortOrder(iSortCol)
      .SortType(iSortCol) = grdLib.ColumnSortType(lCol)
      
      ' Place ascending/descending icon:
      For iCol = 1 To grdLib.Columns
         If (iCol &lt;&gt; lCol) Then
            If Not (grdLib.ColumnIsGrouped(iCol)) Then
               If grdLib.ColumnImage(iCol) &gt; -1 Then
                  grdLib.ColumnImage(iCol) = -1
               End If
            End If
         ElseIf grdLib.ColumnHeader(iCol) &lt;&gt; "" Then
            grdLib.ColumnImageOnRight(iCol) = True
            If (.SortOrder(iSortCol) = CCLOrderAscending) Then
               grdLib.ColumnImage(iCol) = 0
            Else
               grdLib.ColumnImage(iCol) = 1
            End If
         End If
      Next iCol
      
   End With
   
   Screen.MousePointer = vbHourglass
   grdLib.Sort
   Screen.MousePointer = vbDefault
   

End Sub

Private Sub grdLib_HeaderRightClick(ByVal x As Single, ByVal y As Single)
Dim lCol As Long
   
   lCol = grdLib.ColumnHeaderFromPoint(x, y)
   
   If (lCol &gt; 0) Then
      mnuHeaderCtx(0).Enabled = True
      mnuHeaderCtx(1).Enabled = True
      mnuHeaderCtx(3).Enabled = True
      mnuHeaderCtx(3).Caption = IIf(grdLib.ColumnIsGrouped(lCol), "Don't Group
       By This Field", "Group By This Field")
      mnuHeaderCtx(6).Enabled = True
            
      mnuHeaderCtx(0).Checked = (grdLib.ColumnSortOrder(lCol) =
       CCLOrderAscending)
      mnuHeaderCtx(1).Checked = (grdLib.ColumnSortOrder(lCol) =
       CCLOrderDescending)
      
   Else
      mnuHeaderCtx(0).Enabled = False
      mnuHeaderCtx(1).Enabled = False
      mnuHeaderCtx(3).Enabled = False
      mnuHeaderCtx(6).Enabled = False
   
      mnuHeaderCtx(0).Checked = False
      mnuHeaderCtx(1).Checked = False
   
   End If
      
   x = (x + grdLib.ScrollOffsetX) * Screen.TwipsPerPixelX + grdLib.Left
   y = y * Screen.TwipsPerPixelY + grdLib.TOp
   mnuHeaderCtxTOP.Tag = lCol
   Me.PopupMenu mnuHeaderCtxTOP, , x, y

End Sub

Private Sub grdLib_MouseDown(Button As Integer, Shift As Integer, x As Single,
 y As Single, bDoDefault As Boolean)
   '
   '
End Sub

Private Sub grdLib_MouseUp(Button As Integer, Shift As Integer, x As Single, y
 As Single)
   '
   If (Button = vbLeftButton) Or (Button = vbRightButton) Then
      Dim lRow As Long
      Dim lCol As Long
      grdLib.CellFromPoint x \ Screen.TwipsPerPixelX, y \
       Screen.TwipsPerPixelY, lRow, lCol
      ' TODO: bug for multi select: doesn't always raise selection
      ' changed...
      grdLib_SelectionChange lRow, lCol
   End If
   
   If (Button = vbRightButton) Then
      
      If (lRow &gt; 0) And (lCol &gt; 0) Then
                  
         mnuGridCtxTOP.Tag = lRow

         ' Show the menu
         x = x + grdLib.Left
         y = y + grdLib.TOp
         Me.PopupMenu mnuGridCtxTOP, , x, y

      End If
   End If
   
   '
End Sub

Private Sub grdLib_SelectionChange(ByVal lRow As Long, ByVal lCol As Long)
   
   Dim iSelCount As Long
   iSelCount = grdLib.SelectionCount
   
   If (lRow &gt; 0) And (lCol &gt; 0) Then
      
      If (grdLib.RowIsGroup(lRow) Or (iSelCount &gt; 1)) Then
         mnuGridCtx(0).Caption = "Play &amp;Selected Items"
         mnuGridCtx(0).Enabled = True
         mnuFile(0).Caption = mnuGridCtx(0).Caption
         mnuFile(0).Enabled = True
         mnuGridCtx(1).Enabled = False
         mnuFile(1).Enabled = False
         mnuGridCtx(2).Enabled = False
         mnuFile(2).Enabled = False
         mnuFile(5).Enabled = False
         mnuFile(6).Enabled = False
         mnuEdit(0).Enabled = True
         mnuEdit(4).Enabled = True
      Else
         mnuGridCtx(0).Caption = "Play this &amp;Track"
         mnuGridCtx(0).Enabled = (iSelCount &gt; 0)
         mnuFile(0).Caption = mnuGridCtx(0).Caption
         mnuFile(0).Enabled = (iSelCount &gt; 0)
         mnuGridCtx(1).Enabled = (iSelCount &gt; 0)
         mnuFile(1).Enabled = (iSelCount &gt; 0)
         mnuGridCtx(2).Enabled = (iSelCount &gt; 0)
         mnuFile(2).Enabled = (iSelCount &gt; 0)
         mnuFile(5).Enabled = (iSelCount &gt; 0)
         mnuFile(6).Enabled = (iSelCount &gt; 0)
         mnuEdit(0).Enabled = (iSelCount &gt; 0)
         mnuEdit(4).Enabled = (iSelCount &gt; 0)
      End If
   Else
      mnuGridCtx(0).Enabled = False
      mnuFile(0).Enabled = False
      mnuGridCtx(1).Enabled = False
      mnuFile(1).Enabled = False
      mnuGridCtx(2).Enabled = False
      mnuFile(2).Enabled = False
      mnuFile(5).Enabled = False
      mnuFile(6).Enabled = False
      mnuEdit(0).Enabled = False
      mnuEdit(4).Enabled = False
   End If
End Sub

Private Sub mnuColumns_Click(index As Integer)
Dim bS As Long
   bS = Not (mnuColumns(index).Checked)
   mnuColumns(index).Checked = bS
   grdLib.ColumnVisible(mnuColumns(index).Tag) = bS
End Sub

Private Sub mnuEdit_Click(index As Integer)
   Select Case index
   Case 0 ' Tags
      MsgBox "Not implemented", vbInformation
   Case 2 ' Find
      MsgBox "Not implemented", vbInformation
   Case 4 ' remove selected
      MsgBox "Not implemented", vbInformation
   Case 6 ' clear
      If (MsgBox("Are you sure you want to clear the music library?",
       vbQuestion Or vbYesNo)) Then
         grdLib.Clear
         grdLib_SelectionChange 0, 0
      End If
   End Select
End Sub

Private Sub mnuFile_Click(index As Integer)
Dim colPlay As New Collection
Dim lRow As Long
Dim sText As String

   Select Case index
   Case 0
      mnuGridCtx_Click 0
   Case 1
      mnuGridCtx_Click 1
   Case 2
      mnuGridCtx_Click 2
   Case 4
      lRow = grdLib.SelectedRow
      createSelectionPlayList colPlay
      If (grdLib.RowIsGroup(lRow)) Then
         sText = grdLib.CellText(lRow, grdLib.Columns)
      Else
         sText = grdLib.CellText(lRow, 1)
      End If
      makePlaylist sText, colPlay
   Case 5
      lRow = grdLib.SelectedRow
      createAlbumPlayList grdLib.CellText(lRow, 3), colPlay
      makePlaylist grdLib.CellText(lRow, 3), colPlay
   Case 6
      lRow = grdLib.SelectedRow
      createArtistPlayList grdLib.CellText(lRow, 2), colPlay
      makePlaylist grdLib.CellText(lRow, 2), colPlay
   Case 8
      importMusic
   Case 10
      Unload Me
   End Select
   
End Sub

Private Sub mnuGridCtx_Click(index As Integer)
Dim colPlay As New Collection
Dim lRow As Long
Dim vItem As Variant

   Select Case index
   Case 0 ' selected
      lRow = grdLib.SelectedRow
      If (mnuGridCtx(1).Enabled) Then
         ' single selection
         ShellExecute Me.hWnd, "Enqueue", grdLib.CellText(lRow, 6), "", "",
          SW_SHOWNORMAL
      Else
         ' multi selection
         createSelectionPlayList colPlay
         playList colPlay
      End If
      
   Case 1 ' album
      lRow = grdLib.SelectedRow
      createAlbumPlayList grdLib.CellText(lRow, 3), colPlay
      playList colPlay
      
   Case 2 ' artist
      lRow = grdLib.SelectedRow
      createArtistPlayList grdLib.CellText(lRow, 2), colPlay
      playList colPlay
   
   Case 4 ' remove
      If (vbYes = MsgBox("Are you sure you want to remove the selected items
       from the library?", vbYesNo Or vbQuestion)) Then
         '
         '
      End If
   
   End Select
End Sub

Private Sub mnuHeaderCtx_Click(index As Integer)
   Select Case index
   Case 0
      If (mnuHeaderCtx(0).Checked) Then
         mnuHeaderCtx(0).Checked = False
         grdLib.ColumnSortOrder(mnuHeaderCtxTOP.Tag) = CCLOrderNone
      Else
         mnuHeaderCtx(0).Checked = True
         grdLib.ColumnSortOrder(mnuHeaderCtxTOP.Tag) = CCLOrderNone
         grdLib_ColumnClick mnuHeaderCtxTOP.Tag
      End If
   
   Case 1
      If (mnuHeaderCtx(1).Checked) Then
         mnuHeaderCtx(1).Checked = False
         grdLib.ColumnSortOrder(mnuHeaderCtxTOP.Tag) = CCLOrderNone
      Else
         mnuHeaderCtx(1).Checked = True
         grdLib.ColumnSortOrder(mnuHeaderCtxTOP.Tag) = CCLOrderAscending
         grdLib_ColumnClick mnuHeaderCtxTOP.Tag
      End If
   
   Case 3
      Dim iIndex As Long
      iIndex = CLng(mnuHeaderCtxTOP.Tag)
      If (grdLib.ColumnIsGrouped(iIndex)) Then
         ' Ungroup
         grdLib.ColumnIsGrouped(iIndex) = False
      Else
         ' Group
         grdLib.ColumnIsGrouped(iIndex) = True
      End If
   Case 4
      ' Group box:
      grdLib.AllowGrouping = Not (grdLib.AllowGrouping)
      mnuHeaderCtx(index).Checked = grdLib.AllowGrouping
      mnuView(2).Checked = grdLib.AllowGrouping
   Case 6
      grdLib.ColumnVisible(mnuHeaderCtxTOP.Tag) = False
      mnuColumns(mnuHeaderCtxTOP.Tag - 1).Checked = False
   End Select
   
End Sub

Private Sub mnuHelp_Click(index As Integer)
   Select Case index
   Case 0
      ShellExecute Me.hWnd, "open", "http://vbaccelerator.com/", "", "",
       SW_SHOWNORMAL
   Case 2
      frmAbout.Show vbModal, Me
   End Select
End Sub

Private Sub mnuView_Click(index As Integer)
   Select Case index
   Case 2
      mnuView(2).Checked = Not (mnuView(2).Checked)
      mnuHeaderCtx(4).Checked = mnuView(2).Checked
      grdLib.AllowGrouping = mnuView(2).Checked
   End Select
End Sub

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="javascript:window.alert(&quot;http://vbaccelerator.com/home/include/adredir.asp?url=http://oneandone.co.uk/xml/init?k_id=5791003&image=http://oneandone.co.uk/xml/banner?size=1&number=1\nThis link was not retrieved.&quot;)" ><IMG SRC="..\..\..\..\..\..\..\oneandone_co_uk\xml\banner\size=1&number=1.html" ALT="1&1 Web Hosting" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">MusicLibrary SGrid Sample</a>&#160;.&#160;<a href="vb6_music_library.html">VB6 Music Library</a>&#160;.&#160;frmMusicLib.frm</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 February 2004</p></td><td></td></tr></table>
</body></html>