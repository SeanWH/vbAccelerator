<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mMouseHook.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mMouseHook.bas" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">SGrid 2.0</a>&#160;.&#160;<a href="vb5_sgrid_2_full_source.html">VB5 SGrid 2 Full Source</a>&#160;.&#160;mMouseHook.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_sgrid_2_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2 Demonstration</a> (144K)</p><p class="nav"><a href="vb5_sgrid_2_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2 Full Source</a> (446K)</p><p class="nav"><a href="vb5_sgrid_2_0_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2.0 Binary</a> (194K)</p><p /><p class="nav"><a href="vb6_sgrid_2_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Binary</a> (173K)</p><p class="nav"><a href="vb6_sgrid_2_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Demonstration</a> (138K)</p><p class="nav"><a href="vb6_sgrid_2_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Full Source</a> (419K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:14154</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=14154&type=zip&title=vb5_20sgrid_202_20full_20source_2ezip_5fmmousehook.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 4 / 5</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 8 / 8</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:9 February 2004</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />10 Feb 2004<br /><p class="update">The VB6 Downloads for the Grid contained incorrect files. The versions
posted now have the correct files.  Please ensure your version of vbalSGrid6.OCX has the file
version 2.0.0.40 and accept my apologies for this stupid error.</p><p class="update">TaskList demo had a missing line in the mnuColumns event handler which
caused a 'Subscript out of Range' error when showing or hiding columns (it was trying
to hide/show column 0).  Fixed.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\s_grid\article.html">vbAccelerator S-Grid Control</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mMouseHook.bas</h1><pre>Attribute VB_Name = "mMouseHook"
Option Explicit

'
 ===============================================================================
=======
' Name:     mGDI
' Author:   Steve McMahon (steve@vbaccelerator.com)
' Date:     22 December 1998
'
' Copyright  1998-1999 Steve McMahon for vbAccelerator
'
 -------------------------------------------------------------------------------
-------
' Visit vbAccelerator - advanced free source code for VB programmers
' http://vbaccelerator.com
'
 -------------------------------------------------------------------------------
-------
'
' Various GDI declares and helper functions for the vbAcceleratorGrid
' control.
'
' FREE SOURCE CODE - ENJOY!
'
 ===============================================================================
=======

Private Type POINTAPI
   x As Long
   y As Long
End Type

Private Type MOUSEHOOKSTRUCT
    pt As POINTAPI
    hwnd As Long
    wHitTestCode As Long
    dwExtraInfo As Long
End Type

Private Declare Function SetWindowsHookEx Lib "user32" Alias
 "SetWindowsHookExA" (ByVal idHook As Long, ByVal lpFn As Long, ByVal hmod As
 Long, ByVal dwThreadId As Long) As Long
Private Declare Function UnhookWindowsHookEx Lib "user32" (ByVal hHook As Long)
 As Long
Private Declare Function CallNextHookEx Lib "user32" (ByVal hHook As Long,
 ByVal nCode As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetCurrentThreadId Lib "kernel32" () As Long
Private Declare Function IsWindow Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Function GetActiveWindow Lib "user32" () As Long
Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)
Private Const WH_MOUSE = 7

Private Const WM_RBUTTONUP As Long = &amp;H205

''' &lt;summary&gt;
''' Mouse hook handle
''' &lt;/summary&gt;
Private m_hMouseHook As Long
''' &lt;summary&gt;
''' Array of unreferenced pointers to the Grid object to
''' call when a mouse hook event occurs
''' &lt;/summary&gt;
Private m_lMouseHookPtr() As Long
''' &lt;summary&gt;
''' Array of window handles to the Grid object to call
''' when a mouse hook event occurs.
''' &lt;/summary&gt;
Private m_lMouseHookhWnd() As Long
''' &lt;summary&gt;
''' Count of grids receiving mouse hook notifications
''' &lt;/summary&gt;
Private m_iMouseHookCount As Long

''' &lt;summary&gt;
''' Attaches a mouse hook for a particular grid.
''' &lt;/summary&gt;
''' &lt;param name="ctlGrid"&gt;The Grid to attach the mouse
''' hook for&lt;/param&gt;
Public Sub AttachMouseHook(ctlGrid As vbalGrid)
Dim lpFn As Long
Dim lPtr As Long
Dim i As Long
   
   If m_iMouseHookCount = 0 Then
      lpFn = HookAddress(AddressOf MouseFilter)
      m_hMouseHook = SetWindowsHookEx(WH_MOUSE, lpFn, 0&amp;, GetCurrentThreadId())
      Debug.Assert (m_hMouseHook &lt;&gt; 0)
   End If
   lPtr = ObjPtr(ctlGrid)
   For i = 1 To m_iMouseHookCount
      If lPtr = m_lMouseHookPtr(i) Then
         ' we already have it:
         Debug.Assert False
         Exit Sub
      End If
   Next i
   ReDim Preserve m_lMouseHookPtr(1 To m_iMouseHookCount + 1) As Long
   ReDim Preserve m_lMouseHookhWnd(1 To m_iMouseHookCount + 1) As Long
   m_iMouseHookCount = m_iMouseHookCount + 1
   m_lMouseHookPtr(m_iMouseHookCount) = lPtr
   m_lMouseHookhWnd(m_iMouseHookCount) = ctlGrid.hwnd
   
End Sub

''' &lt;summary&gt;
''' Detaches a mouse hook attached by a particular grid.
''' &lt;/summary&gt;
''' &lt;param name="ctlGrid"&gt;The Grid which attached the mouse
''' hook&lt;/param&gt;
Public Sub DetachMouseHook(ctlGrid As vbalGrid)
Dim i As Long
Dim lPtr As Long
Dim iThis As Long
   
   lPtr = ObjPtr(ctlGrid)
   For i = 1 To m_iMouseHookCount
      If m_lMouseHookPtr(i) = lPtr Then
         iThis = i
         Exit For
      End If
   Next i
   If iThis &lt;&gt; 0 Then
      If m_iMouseHookCount &gt; 1 Then
         For i = iThis To m_iMouseHookCount - 1
            m_lMouseHookPtr(i) = m_lMouseHookPtr(i + 1)
         Next i
      End If
      m_iMouseHookCount = m_iMouseHookCount - 1
      If m_iMouseHookCount &gt;= 1 Then
         ReDim Preserve m_lMouseHookPtr(1 To m_iMouseHookCount) As Long
      Else
         Erase m_lMouseHookPtr
      End If
   Else
      ' Trying to detach SGrid which was never attached...
   End If
   
   If m_iMouseHookCount &lt;= 0 Then
      If (m_hMouseHook &lt;&gt; 0) Then
         UnhookWindowsHookEx m_hMouseHook
         m_hMouseHook = 0
      End If
   End If
   
End Sub

''' &lt;summary&gt;
''' Hack to return the value returned by &lt;c&gt;AddressOf&lt;/c&gt; to
''' allow it to be placed into a variable
''' &lt;/summary&gt;
''' &lt;param name="lPtr"&gt;Variable to receive &lt;c&gt;AddressOf&lt;/c&gt;
''' value.&lt;/param&gt;
''' &lt;returns&gt;Pointer returned by &lt;c&gt;AddressOf&lt;/c&gt;&lt;/returns&gt;
Private Function HookAddress(ByVal lPtr As Long) As Long
   HookAddress = lPtr
End Function

''' &lt;summary&gt;
''' Call back routine for a Mouse Hook
''' &lt;/summary&gt;
''' &lt;param name="nCode"&gt;Hook Code&lt;/param&gt;
''' &lt;param name="wParam"&gt;Mouse message code&lt;/param&gt;
''' &lt;param name="lParam"&gt;Pointer to MOUSEHOOKSTRUCT containing information
 about the
''' mouse message&lt;/param&gt;
''' &lt;returns&gt;Value of next mouse hook, if any&lt;/returns&gt;
Private Function MouseFilter(ByVal nCode As Long, ByVal wParam As Long, ByVal
 lParam As Long) As Long
Dim tMHS As MOUSEHOOKSTRUCT
Dim i As Long
Dim ctlGrid As vbalGrid

On Error GoTo ErrorHandler

   ' Decode lParam:
   CopyMemory tMHS, ByVal lParam, Len(tMHS)
   
   ' Loop through attached grids (there should only be one)
   For i = 1 To m_iMouseHookCount
      ' Call the MouseEvent of any Grid that is attached:
      If Not (m_lMouseHookPtr(i) = 0) Then
         If Not (IsWindow(m_lMouseHookhWnd(i)) = 0) Then
            Set ctlGrid = ObjectFromPtr(m_lMouseHookPtr(i))
            If Not ctlGrid Is Nothing Then
               If ctlGrid.MouseEvent(wParam, tMHS.hwnd, _
                  tMHS.pt.x, tMHS.pt.y, tMHS.wHitTestCode) Then
                  
               End If
            End If
         End If
      End If
   Next i
   
   If Not (m_hMouseHook = 0) Then
      MouseFilter = CallNextHookEx(m_hMouseHook, nCode, wParam, lParam)
   End If

   Exit Function

ErrorHandler:
   debugmsg "Error in MouseFilter:" &amp; Err.Number &amp; "," &amp; Err.Description
   Exit Function
End Function

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vbmedia\using_gdi_plus\index.html" ><IMG SRC="..\..\..\..\..\res\gdiplus.png" ALT="A GDI+ Library for VB - read and write PNG, JPG, TIF and GIF files, and manipulate bitmaps quickly" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">SGrid 2.0</a>&#160;.&#160;<a href="vb5_sgrid_2_full_source.html">VB5 SGrid 2 Full Source</a>&#160;.&#160;mMouseHook.bas</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 11 February 2004</p></td><td></td></tr></table>
</body></html>