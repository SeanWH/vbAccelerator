<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cShellSort.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cShellSort.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">SGrid 2.0</a>&#160;.&#160;<a href="vb6_sgrid_2_full_source.html">VB6 SGrid 2 Full Source</a>&#160;.&#160;cShellSort.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_sgrid_2_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2 Demonstration</a> (144K)</p><p class="nav"><a href="vb5_sgrid_2_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2 Full Source</a> (446K)</p><p class="nav"><a href="vb5_sgrid_2_0_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 SGrid 2.0 Binary</a> (194K)</p><p /><p class="nav"><a href="vb6_sgrid_2_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Binary</a> (173K)</p><p class="nav"><a href="vb6_sgrid_2_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Demonstration</a> (138K)</p><p class="nav"><a href="vb6_sgrid_2_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 SGrid 2 Full Source</a> (419K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:14213</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=14213&type=zip&title=vb6_20sgrid_202_20full_20source_2ezip_5fcshellsort.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 4 / 5</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 8 / 8</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:9 February 2004</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />10 Feb 2004<br /><p class="update">The VB6 Downloads for the Grid contained incorrect files. The versions
posted now have the correct files.  Please ensure your version of vbalSGrid6.OCX has the file
version 2.0.0.40 and accept my apologies for this stupid error.</p><p class="update">TaskList demo had a missing line in the mnuColumns event handler which
caused a 'Subscript out of Range' error when showing or hiding columns (it was trying
to hide/show column 0).  Fixed.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\s_grid\article.html">vbAccelerator S-Grid Control</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cShellSort.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cGridSortObject"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit

' =================================================================
' Class:    cGridSortObject
' Author:   SPM
' Date:     1 Feb 1997, modified 12/01/99 to support tGridCells
'
' Shell sorts a variant array according to a given
' column, using numeric, string or date type, ascending
' or descending.
'
' 19/10/99
' * Added CCLSortStringNoCase
' 2004-12-14
' * Change to use row indirection for sorting
' * Added CCLSortItemData
' * Added properties to interrogate the sort information
' * Grouping can now be configured using the sort object
'
' FREE SOURCE CODE - ENJOY!
' =================================================================

Public Enum ECGSortTypeConstants
   
   ' Text sorting:
    CCLSortNumeric = 100
    CCLSortString = 102
    CCLSortStringNoCase = 103
    
    ' Date sorting
    CCLSortDate = 200
    CCLSortDateYearAccuracy = 250
    CCLSortDateMonthAccuracy = 251
    CCLSortDateDayAccuracy = 252
    CCLSortDateHourAccuracy = 253
    CCLSortDateMinuteAccuracy = 254
    
    ' Icon sorting:
    CCLSortIcon = 300
    CCLSortExtraIcon = 301
    
    ' Colour sorting:
    CCLSortForeColor = 400
    CCLSortBackColor = 401
    
    ' Font sorting:
    CCLSortFontIndex = 500
    
    ' Selection sorting
    CCLSortSelected = 600
    
    ' Indentation sorting
    CCLSortIndentation = 700
    
    ' Item Data sorting
    CCLSortItemData = 800
    
End Enum

Private Const INTERNAL_FIND_GROUP_LEVEL As Long = &amp;H2000&amp;

Public Enum ECGSortOrderConstants
   CCLOrderNone = 0
   CCLOrderAscending = 1
   CCLOrderDescending = 2
End Enum

Private Type tSortInfo
   Column As Integer
   SortOrder As ECGSortOrderConstants
   SortType As ECGSortTypeConstants
   Group As Boolean
   GridColumnArrayIndex As Integer
End Type
Private m_tSort() As tSortInfo
Private m_iSortIndexCount As Integer
Private m_iLastSortIndex As Integer

Private m_bGridMatch As Boolean

Friend Sub SetGridMatch()
   m_bGridMatch = True
End Sub

Friend Property Get GridMatch() As Boolean
   GridMatch = m_bGridMatch
End Property

Friend Sub RemoveGroupBubbles()
Dim i As Long
Dim j As Long
Dim iLastGroupItem As Long
Dim tSwap As tSortInfo

   For i = 1 To m_iSortIndexCount
      If (m_tSort(i).Group) Then
         If (i - iLastGroupItem &gt; 1) Then
            ' This item needs to be shuffled down
            ' until it reaches iLastGroupItem + 1
            LSet tSwap = m_tSort(i)
            For j = i To iLastGroupItem + 1 Step -1
               LSet m_tSort(j) = m_tSort(j - 1)
            Next j
            iLastGroupItem = iLastGroupItem + 1
            LSet m_tSort(iLastGroupItem) = tSwap
         Else
            iLastGroupItem = i
         End If
      End If
   Next i

End Sub

Public Sub Clear()
Attribute Clear.VB_Description = "Clears all columns from the sort object."
   m_iSortIndexCount = 0
   Erase m_tSort
   m_bGridMatch = False
End Sub

Public Property Get Count() As Long
Attribute Count.VB_Description = "Gets the number of sorting columns."
   Count = m_iSortIndexCount
End Property

Public Property Get IndexOf(ByVal lCol As Long) As Long
Attribute IndexOf.VB_Description = "Gets the index of the sort data for the
 specified column, or zero if no sorting should be applied to the column."
Dim i As Long
   For i = 1 To m_iSortIndexCount
      If (m_tSort(i).Column = lCol) Then
         IndexOf = i
         Exit For
      End If
   Next i
End Property

Public Sub Remove(ByVal lIndex As Long)
Attribute Remove.VB_Description = "Removes the sort data for the specified
 index."
   If (lIndex &gt; 0) And (lIndex &lt;= m_iSortIndexCount) Then
      Dim i As Long
      For i = lIndex To m_iSortIndexCount - 1
         LSet m_tSort(i) = m_tSort(i + 1)
      Next i
      m_iSortIndexCount = m_iSortIndexCount - 1
      If (m_iSortIndexCount &gt; 0) Then
         ReDim Preserve m_tSort(1 To m_iSortIndexCount) As tSortInfo
      End If
      m_bGridMatch = False
   Else
      gErr 9, "Subscript out of range."
   End If
End Sub

Public Sub ClearNongrouped()
Attribute ClearNongrouped.VB_Description = "Clears only non-grouping sort rows
 from the sort object."
Dim i As Long
Dim j As Long
   For i = m_iSortIndexCount To 1 Step -1
      If Not (m_tSort(i).Group) Then
         If (m_iSortIndexCount &gt; 1) Then
            For j = i + 1 To m_iSortIndexCount
               LSet m_tSort(j - 1) = m_tSort(j)
            Next j
            m_iSortIndexCount = m_iSortIndexCount - 1
            ReDim Preserve m_tSort(1 To m_iSortIndexCount) As tSortInfo
         Else
            Erase m_tSort
            m_iSortIndexCount = 0
            Exit For
         End If
      End If
   Next i
   m_bGridMatch = False ' maybe...
End Sub

Public Property Get LastSortIndex() As Integer
Attribute LastSortIndex.VB_Description = "Deprecated."
    LastSortIndex = m_iLastSortIndex
End Property
Public Property Let LastSortIndex( _
        ByVal iLastSortIndex As Integer _
    )
    m_iLastSortIndex = iLastSortIndex
End Property

Public Property Let SortColumn( _
        ByVal iSortIndex As Integer, _
        ByVal iSortColumn As Integer _
    )
Attribute SortColumn.VB_Description = "Gets/sets the column to sort by for the
 specified index."
   If (pbValidSortIndex(iSortIndex)) Then
      If Not (m_tSort(iSortIndex).Column = iSortColumn) Then
         m_tSort(iSortIndex).Column = iSortColumn
         m_bGridMatch = False
      End If
   End If
End Property
Public Property Get SortColumn( _
        ByVal iSortIndex As Integer _
    ) As Integer
    SortColumn = m_tSort(iSortIndex).Column
End Property

Public Property Get GroupBy( _
      ByVal iSortIndex As Integer _
   ) As Boolean
Attribute GroupBy.VB_Description = "Gets/sets whether the grid data should be
 grouped by the specified sorting column."
   GroupBy = m_tSort(iSortIndex).Group
End Property
Public Property Let GroupBy( _
      ByVal iSortIndex As Integer, _
      ByVal bState As Boolean _
   )
   If (pbValidSortIndex(iSortIndex)) Then
      If Not (m_tSort(iSortIndex).Group = bState) Then
         m_tSort(iSortIndex).Group = bState
         m_bGridMatch = False
      End If
   End If
End Property
   
Public Property Get SortOrder( _
      ByVal iSortIndex As Integer _
   ) As ECGSortOrderConstants
Attribute SortOrder.VB_Description = "Gets/sets the order to sort in for the
 specified index."
   SortOrder = m_tSort(iSortIndex).SortOrder
End Property
Public Property Let SortOrder( _
      ByVal iSortIndex As Integer, _
      ByVal iSortOrder As ECGSortOrderConstants _
   )
   If (pbValidSortIndex(iSortIndex)) Then
      If Not (m_tSort(iSortIndex).SortOrder = iSortOrder) Then
         m_tSort(iSortIndex).SortOrder = iSortOrder
         m_bGridMatch = False
      End If
   End If
End Property

Public Property Get SortType( _
      ByVal iSortIndex As Integer _
   ) As ECGSortTypeConstants
Attribute SortType.VB_Description = "Gets/sets the sorting type to use for the
 specified index."
   SortType = m_tSort(iSortIndex).SortType
End Property
Public Property Let SortType( _
      ByVal iSortIndex As Integer, _
      ByVal eSortType As ECGSortTypeConstants _
   )
   If (pbValidSortIndex(iSortIndex)) Then
      If Not (m_tSort(iSortIndex).SortType = eSortType) Then
         m_tSort(iSortIndex).SortType = eSortType
         m_bGridMatch = False
      End If
   End If
End Property

Friend Property Get GridColumnArrayIndex( _
      ByVal iSortIndex As Integer _
   ) As Long
   GridColumnArrayIndex = m_tSort(iSortIndex).GridColumnArrayIndex
End Property
Friend Property Let GridColumnArrayIndex( _
      ByVal iSortIndex As Integer, _
      ByVal iGridColumnArrayIndex As Long _
   )
   m_tSort(iSortIndex).GridColumnArrayIndex = iGridColumnArrayIndex
End Property

Private Function pbValidSortIndex( _
      ByVal iSortIndex As Integer _
   ) As Boolean
   
   If (iSortIndex &gt; 0) And (iSortIndex &lt;= 8) Then
      If (iSortIndex &gt; m_iSortIndexCount) Then
         m_iSortIndexCount = iSortIndex
         ReDim Preserve m_tSort(1 To m_iSortIndexCount) As tSortInfo
      End If
      pbValidSortIndex = True
   Else
      gErr 503, "Invalid sort array index."
   End If
   
End Function

Friend Sub SortItems( _
        ByRef vItems() As tGridCell, _
        ByRef tRows() As tRowPosition, _
        ByVal lStartItem As Long, _
        ByVal lItems As Long _
    )
Dim iSwapIndex As Long
Dim iIncrement As Long
Dim iMainLoop As Long
Dim iSubLoop As Long
Dim vSortItems() As tGridCell
Dim tSortRow As tRowPosition
Dim iItemCount As Long
Dim iMainLoopRow As Long
Dim bIsEqual As Boolean
           
   ' 2003-10-14: Check it out, no shift of cell data, can be &gt;10x quicker
           
    iItemCount = lItems

    ' Shell sort the list:
    ' ========================================================
    ' Implementation of Shell Sort algorithm using
    ' + 1 * 3 increment.
    ' ========================================================
    ' Prepare swap space storage:
    'ReDim vSortItems(1 To iColumns) As tGridCell
    ' Get inital shell sort increment
    If (iItemCount &gt; 2) Then
        iIncrement = piGetSuitableShellSortInitialIncrement(iItemCount)
        Do Until iIncrement &lt; 1
            For iMainLoop = iIncrement + 1 To iItemCount
            
                LSet tSortRow = tRows(iMainLoop)
                iMainLoopRow = tRows(iMainLoop).lGridCellArrayRow
                
                ' Loop from MainLoop-Increment to start item
                For iSubLoop = (iMainLoop - iIncrement) To lStartItem Step
                 -iIncrement
                    If (pbGreater(vItems(), iMainLoopRow,
                     tRows(iSubLoop).lGridCellArrayRow, bIsEqual)) Then
                        Exit For
                    End If
                    LSet tRows(iSubLoop + iIncrement) = tRows(iSubLoop)
                Next iSubLoop
                LSet tRows(iSubLoop + iIncrement) = tSortRow
            Next iMainLoop
            ' Get next shell sort increment value:
            iIncrement = iIncrement - 1
            iIncrement = iIncrement \ 3
        Loop
    Else
        ' For only two items just check whether the second should
        ' be swapped with the first:
        '    Fix - last version caused GPF as it fell off the end
        '    of the array..
        If (iItemCount = lStartItem + 1) Then
            'For iCol = 1 To iColumns
            '   LSet vSortItems(iCol) = vItems(iCol, lStartItem)
            'Next iCol
            If (pbGreater(vItems(), tRows(lStartItem).lGridCellArrayRow,
             tRows(lStartItem + 1).lGridCellArrayRow, bIsEqual)) Then
               ' swap
               LSet tSortRow = tRows(lStartItem)
               LSet tRows(lStartItem) = tRows(lStartItem + 1)
               LSet tRows(lStartItem + 1) = tSortRow
            End If
         End If
    End If
    
End Sub

Friend Function GetLastGroupSortColumn() As Long
Dim i As Long
Dim lIndex As Long
   For i = 1 To m_iSortIndexCount
      If (m_tSort(i).Group) Then
         lIndex = i
      End If
   Next i
   GetLastGroupSortColumn = lIndex
End Function

Friend Function FindInsertLocation( _
        ByRef vItems() As tGridCell, _
        ByRef tRows() As tRowPosition, _
        ByVal lStartItem As Long, _
        ByVal lItems As Long, _
        ByRef iResult As Long _
      ) As Long
Dim iStartRow As Long
Dim iEndRow As Long
Dim iMidRow As Long
Dim lRow As Long
Dim bGroupRowsOnly As Boolean
Dim bRemoveTempSort As Boolean
Dim lIndentMatchLevel As Long
Dim lIndexLastGroup As Long

   lIndexLastGroup = GetLastGroupSortColumn
   If (lIndexLastGroup = m_iSortIndexCount) And (m_iSortIndexCount &gt; 0) Then
      lIndentMatchLevel = lIndexLastGroup
      ' Temporarily Add row group indent level to the sort
      m_iSortIndexCount = m_iSortIndexCount + 1
      ReDim Preserve m_tSort(1 To m_iSortIndexCount) As tSortInfo
      m_tSort(m_iSortIndexCount).SortType = INTERNAL_FIND_GROUP_LEVEL
      bRemoveTempSort = True
   End If

   iStartRow = lStartItem
   iEndRow = lItems - 1

   ' Binary search
   iResult = 0
   lRow = plBinSearch(vItems, tRows, lItems, iStartRow, iEndRow,
    lIndentMatchLevel, iResult)

   If (bRemoveTempSort) Then
      m_iSortIndexCount = m_iSortIndexCount - 1
      ReDim Preserve m_tSort(1 To m_iSortIndexCount) As tSortInfo
   End If
   
   FindInsertLocation = lRow
   
End Function

Private Function plBinSearch( _
      ByRef vItems() As tGridCell, _
      ByRef tRows() As tRowPosition, _
      ByVal lMatchFor As Long, _
      ByVal lStart As Long, _
      ByVal lEnd As Long, _
      ByVal lIndentMatchLevel As Long, _
      ByRef iR As Long _
   ) As Long
Dim iP As Long
Dim bIsEqual As Boolean
Dim bGreater As Boolean
   
   If lEnd - lStart &gt; 1 Then
      iP = lStart + (lEnd - lStart) \ 2
      bGreater = pbGreaterBinSearch( _
            vItems, _
            tRows(iP).lGridCellArrayRow, _
            tRows(lMatchFor).lGridCellArrayRow, _
            tRows(iP).lGroupIndentLevel, _
            lIndentMatchLevel, _
            bIsEqual)
      If bIsEqual Then
         ' Success:
         iR = 0
         plBinSearch = iP
      ElseIf bGreater Then
         ' the centre element is greater than the
         ' item we're searching for.  Set the end
         ' to the centre element &amp; repeat:
         lEnd = iP - 1
         plBinSearch = plBinSearch(vItems, tRows, lMatchFor, lStart, lEnd,
          lIndentMatchLevel, iR)
      Else
         ' the centre element is less than the
         ' item we're searching for.  Set the start
         ' to the centre element &amp; repeat:
         lStart = iP + 1
         plBinSearch = plBinSearch(vItems, tRows, lMatchFor, lStart, lEnd,
          lIndentMatchLevel, iR)
      End If
   Else
      ' 1 or 2 items left.  Check if either
      ' match the search item.
      bGreater = pbGreaterBinSearch( _
            vItems, _
            tRows(lMatchFor).lGridCellArrayRow, _
            tRows(lEnd).lGridCellArrayRow, _
            lIndentMatchLevel, _
            tRows(lEnd).lGroupIndentLevel, _
            bIsEqual)
      If bIsEqual Then
         iR = 0
         plBinSearch = lEnd
      ElseIf (bGreater) Then
         iR = 1
         plBinSearch = lEnd
      Else
         bGreater = pbGreaterBinSearch( _
               vItems, _
               tRows(lStart).lGridCellArrayRow, _
               tRows(lMatchFor).lGridCellArrayRow, _
               tRows(lStart).lGroupIndentLevel, _
               lIndentMatchLevel, _
               bIsEqual)
         If (bIsEqual) Then
            iR = 0
            plBinSearch = lStart
         Else
            iR = IIf(bGreater, -1, 1)
            plBinSearch = lStart
         End If
      End If
   End If
   
End Function

Private Function pbGreaterBinSearch( _
      ByRef vItems() As tGridCell, _
      ByVal iRow1 As Long, _
      ByVal iRow2 As Long, _
      ByVal lGroupIndentRow1 As Long, _
      ByVal lGroupIndentRow2 As Long, _
      ByRef bIsEqual As Boolean _
   ) As Boolean
Dim iSortIndex As Integer
Dim bR As Boolean

   For iSortIndex = 1 To m_iSortIndexCount
      If (m_tSort(iSortIndex).SortType = INTERNAL_FIND_GROUP_LEVEL) Then
         If (lGroupIndentRow1 = 0) Then lGroupIndentRow1 = &amp;H4000&amp;
         If (lGroupIndentRow2 = 0) Then lGroupIndentRow2 = &amp;H4000&amp;
         bIsEqual = (lGroupIndentRow1 = lGroupIndentRow2)
         If Not (bIsEqual) Then
            bR = (lGroupIndentRow1 &gt; lGroupIndentRow2)
         End If
      Else
         bR = pbIsGreater( _
            vItems(m_tSort(iSortIndex).Column, iRow1), _
            vItems(m_tSort(iSortIndex).Column, iRow2), _
            iSortIndex, bIsEqual)
      End If
      If (iSortIndex &lt; m_iSortIndexCount) And bIsEqual Then
         ' Must go to the next one
      Else
         pbGreaterBinSearch = bR
         Exit For
      End If
   Next iSortIndex
   
End Function

Private Function pbGreater( _
      ByRef vItems() As tGridCell, _
      ByVal iRow1 As Long, _
      ByVal iRow2 As Long, _
      ByRef bIsEqual As Boolean _
   ) As Boolean
Dim iSortIndex As Integer
Dim bR As Boolean

   For iSortIndex = 1 To m_iSortIndexCount
      bR = pbIsGreater( _
         vItems(m_tSort(iSortIndex).Column, iRow1), _
         vItems(m_tSort(iSortIndex).Column, iRow2), _
         iSortIndex, bIsEqual)
      If (iSortIndex &lt; m_iSortIndexCount) And bIsEqual Then
         ' Must go to the next one
      Else
         pbGreater = bR
         Exit For
      End If
   Next iSortIndex
   
End Function

Private Function pbIsGreater( _
        ByRef vSortItem As tGridCell, _
        ByRef vItem As tGridCell, _
        ByVal iSortIndex As Long, _
        ByRef bIsEqual As Boolean _
    ) As Boolean
Dim vR As Variant
Dim lR As Long
Dim sSortItemText As String, sItemText As String
Dim vSortDate As Date, vDate As Date
Dim bSortDate As Boolean, bDate As Boolean
Dim lDiff As Long

   Select Case m_tSort(iSortIndex).SortType
   
   Case CCLSortSelected
      lR = Abs(vSortItem.bSelected) - Abs(vItem.bSelected)
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
    
   Case CCLSortFontIndex
      lR = vSortItem.iFntIndex - vItem.iFntIndex
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
    
   Case CCLSortIndentation
      lR = vSortItem.lIndent - vItem.lIndent
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
    
   Case CCLSortItemData
      lR = vSortItem.lItemData - vItem.lItemData
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
      
   Case CCLSortIcon
      lR = vSortItem.iIconIndex - vItem.iIconIndex
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
          pbIsGreater = (lR &gt;= 0)
      Else
          pbIsGreater = (lR &lt;= 0)
      End If
    
   Case CCLSortExtraIcon
      lR = vSortItem.lExtraIconIndex - vItem.lExtraIconIndex
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
    
    Case CCLSortForeColor
        lR = vSortItem.oForeColor - vItem.oForeColor
        bIsEqual = (vR = 0)
        If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
            pbIsGreater = (lR &gt;= 0)
        Else
            pbIsGreater = (lR &lt;= 0)
        End If
    
    Case CCLSortBackColor
      lR = vSortItem.oBackColor - vItem.oBackColor
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (lR &gt;= 0)
      Else
         pbIsGreater = (lR &lt;= 0)
      End If
    
   Case CCLSortNumeric
      On Error Resume Next
      vR = Val(vSortItem.sText - vItem.sText)
      If (Err.Number = 0) Then
         bIsEqual = (vR = 0)
      Else
         If (IsNumeric(vSortItem.sText)) Then
            vR = 1
         ElseIf (IsNumeric(vItem.sText)) Then
            vR = -1
         Else
            vR = 0
         End If
      End If
      On Error GoTo 0
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
         pbIsGreater = (vR &gt;= 0)
      Else
         pbIsGreater = (vR &lt;= 0)
      End If
        
   Case CCLSortString
      If Not (IsMissing(vSortItem.sText)) Then
         sSortItemText = vSortItem.sText
      End If
      If Not (IsMissing(vItem.sText)) Then
         sItemText = vItem.sText
      End If
      lR = StrComp(sSortItemText, sItemText)
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
          pbIsGreater = (lR &gt; -1)
      Else
          pbIsGreater = (lR &lt; 1)
      End If
      
   Case CCLSortStringNoCase
      If Not (IsMissing(vSortItem.sText)) Then
         sSortItemText = vSortItem.sText
      End If
      If Not (IsMissing(vItem.sText)) Then
         sItemText = vItem.sText
      End If
      lR = StrComp(sSortItemText, sItemText, vbTextCompare)
      bIsEqual = (lR = 0)
      If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
          pbIsGreater = (lR &gt; -1)
      Else
          pbIsGreater = (lR &lt; 1)
      End If
    
   Case CCLSortDate
      If Not (IsMissing(vSortItem.sText)) Then
         sSortItemText = vSortItem.sText
      End If
      If Not (IsMissing(vItem.sText)) Then
         sItemText = vItem.sText
      End If
      bIsEqual = (vSortItem.sText = vItem.sText)
      If Not (bIsEqual) Then
         If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
            pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
         Else
            pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
         End If
      Else
         pbIsGreater = True
      End If
        
   Case CCLSortDateYearAccuracy
      If IsDate(vSortItem.sText) Then
         vSortDate = DateSerial(Year(vSortItem.sText), 1, 1)
         bSortDate = True
      End If
      If IsDate(vItem.sText) Then
         vDate = DateSerial(Year(vItem.sText), 1, 1)
         bDate = True
      End If
      If (bSortDate) And (bDate) Then
         bIsEqual = (vDate = vSortDate)
         If Not (bIsEqual) Then
            If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
                pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
            Else
                pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
            End If
         End If
      ElseIf bSortDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderAscending)
      ElseIf bDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderDescending)
      Else
         bIsEqual = True
      End If
        
   Case CCLSortDateMonthAccuracy
      If IsDate(vSortItem.sText) Then
         vSortDate = DateSerial(Year(vSortItem.sText), Month(vSortItem.sText),
          1)
         bSortDate = True
      End If
      If IsDate(vItem.sText) Then
         vDate = DateSerial(Year(vItem.sText), Month(vItem.sText), 1)
         bDate = True
      End If
      If (bSortDate) And (bDate) Then
         bIsEqual = (vDate = vSortDate)
         If Not (bIsEqual) Then
            If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
                pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
            Else
                pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
            End If
         End If
      ElseIf bSortDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderAscending)
      ElseIf bDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderDescending)
      Else
         bIsEqual = True
      End If
        
   Case CCLSortDateDayAccuracy
      If IsDate(vSortItem.sText) Then
         vSortDate = DateSerial(Year(vSortItem.sText), Month(vSortItem.sText),
          Day(vSortItem.sText))
         bSortDate = True
      End If
      If IsDate(vItem.sText) Then
         vDate = DateSerial(Year(vItem.sText), Month(vItem.sText),
          Day(vItem.sText))
         bDate = True
      End If
      If (bSortDate) And (bDate) Then
         bIsEqual = (vDate = vSortDate)
         If Not (bIsEqual) Then
            If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
                pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
            Else
                pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
            End If
         End If
      ElseIf bSortDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderAscending)
      ElseIf bDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderDescending)
      Else
         bIsEqual = True
      End If
    
   Case CCLSortDateHourAccuracy
      If IsDate(vSortItem.sText) Then
         vSortDate = DateSerial(Year(vSortItem.sText), Month(vSortItem.sText),
          Day(vSortItem.sText)) + TimeSerial(Hour(vSortItem.sText), 0, 0)
         bSortDate = True
      End If
      If IsDate(vItem.sText) Then
         vDate = DateSerial(Year(vItem.sText), Month(vItem.sText),
          Day(vItem.sText)) + TimeSerial(Hour(vItem.sText), 0, 0)
         bDate = True
      End If
      If (bSortDate) And (bDate) Then
         bIsEqual = (vDate = vSortDate)
         If Not (bIsEqual) Then
            If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
                pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
            Else
                pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
            End If
         End If
      ElseIf bSortDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderAscending)
      ElseIf bDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderDescending)
      Else
         bIsEqual = True
      End If
    
   Case CCLSortDateMinuteAccuracy
      If IsDate(vSortItem.sText) Then
         vSortDate = DateSerial(Year(vSortItem.sText), Month(vSortItem.sText),
          Day(vSortItem.sText)) + TimeSerial(Hour(vSortItem.sText),
          Minute(vSortItem.sText), 0)
         bSortDate = True
      End If
      If IsDate(vItem.sText) Then
         vDate = DateSerial(Year(vItem.sText), Month(vItem.sText),
          Day(vItem.sText)) + TimeSerial(Hour(vItem.sText),
          Minute(vItem.sText), 0)
         bDate = True
      End If
      If (bSortDate) And (bDate) Then
         bIsEqual = (vDate = vSortDate)
         If Not (bIsEqual) Then
            If (m_tSort(iSortIndex).SortOrder = CCLOrderAscending) Then
                pbIsGreater = (vSortItem.sText &gt;= vItem.sText)
            Else
                pbIsGreater = (vItem.sText &gt;= vSortItem.sText)
            End If
         End If
      ElseIf bSortDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderAscending)
      ElseIf bDate Then
         pbIsGreater = (m_tSort(iSortIndex).SortOrder = CCLOrderDescending)
      Else
         bIsEqual = True
      End If
             
       
   End Select
    
End Function
Private Function piGetSuitableShellSortInitialIncrement( _
        iSortSize As Long _
    ) As Long
' ==============================================================
' Part of the implementation of Shell Sort algorithm using
' + 1 * 3 increment strategy.  This function returns the
' largest increment based on +1*3 which is less than the
' sort size.
' ==============================================================
Dim iRet As Long
Dim iLastRet As Long
    iLastRet = 1
    iRet = 1
    Do While iRet &lt; iSortSize
        iLastRet = iRet
        iRet = iRet * 3 + 1
    Loop
    piGetSuitableShellSortInitialIncrement = iLastRet
End Function

Private Sub Class_Initialize()
   'debugmsg "cShellSortTGridCells:Initialize"
End Sub

Private Sub Class_Terminate()
   'debugmsg "cShellSortTGridCells:Terminate"
End Sub


</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;<a href="article.html">SGrid 2.0</a>&#160;.&#160;<a href="vb6_sgrid_2_full_source.html">VB6 SGrid 2 Full Source</a>&#160;.&#160;cShellSort.cls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 11 February 2004</p></td><td></td></tr></table>
</body></html>