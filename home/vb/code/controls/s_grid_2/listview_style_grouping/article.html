<html lang="en" >
<head>

<title>vbAccelerator - Creating ListView Style Groups with SGrid 2</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
This
sample demonstrates how to use owner-draw to customise the appearance of
grouping rows, and to ensure
that they remain open in the style of the Windows XP ListView
in grouped mode.  It also
demonstrates adding new rows to a grouped grid and moving them to the correct 
position given the current sorting and grouping options.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;Creating ListView Style Groups with SGrid 2</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_fixed_grouping_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Fixed Grouping Sample</a> (64K)</p><p /><p class="nav"><a href="vb6_fixed_grouping_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Fixed Grouping Sample</a> (62K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:13698</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=13698&type=article&title=creating_20listview_20style_20groups_20with_20sgrid_202.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />24 Jan 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\s_grid_2\article.html">SGrid 2.0</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Creating ListView Style Groups with SGrid 2</h1><img src="listviewgroup.png" width="522" height="346" alt="ListView Style Groups Sample" /><p /><p>
This
sample demonstrates how to use owner-draw to customise the appearance of
grouping rows, and to ensure
that they remain open in the style of the Windows XP ListView
in grouped mode.  It also
demonstrates adding new rows to a grouped grid and moving them to the correct 
position given the current sorting and grouping options.
</p><h2>Groupings in SGrid 2.0</h2><p>
Although the groupings feature in SGrid 2.0 is provided internally, you
can still customise the appearance and behaviour of the groups. 
This demo shows how to customise the view by performing the following
tasks:
</p><ol><li>Configuring the grid to allow for code-only grouping without a drag-drop area</li><li>Owner-drawing grouping rows.</li><li>Preventing rows from collapsing when the user performs an action that
would normally cause this to occur.</li><li>Ensuring all rows are expanded.</li></ol><p>
These will now be covered in detail.
</p><h3>1. Configuring the Grid for Code-Only Grouping</h3><p>
Rows can be grouped in the grid when the <span class="code">AllowGrouping</span>
property is set to <span class="code">True</span>.  However, by default a 
grouping area for drag-drop of the columns will appear. You can clear this by
using the <span class="code">HideGroupingBox</span> property.  Setting
<span class="code">HideGroupingBox</span> before setting <span class="code">AllowGrouping</span>
will be smoother than doing it the other way around:
</p><pre>
   grd.HideGroupingBox = True
   grd.AllowGrouping = True
</pre><h3>2. Owner-Drawing Grouping Rows</h3><p>
Grouping rows are drawn using an internally customised version of SGrid's
<span class="code">RowTextColumn</span> functionality.  This means that
the cell which contains the group row information is the <span class="code">RowTextColumm</span>
column (the last column) in the row, and you can owner-draw over it in the same way 
you can owner-draw any other cell.
</p><p>
To owner-drawing cells, you to implement the 
<span class="code">IOwnerDrawGridCell</span> interface.  In this case, we only want to 
draw grouping rows, and hence the basic code is as follows:
</p><pre>
Implements IGridCellOwnerDraw

Private Sub configureGrid(grd As vbalSGrid)
   grd.OwnerDrawImpl = Me
End Sub

Private Sub IGridCellOwnerDraw_Draw( _
      cell As cGridCell, _
      ByVal lHDC As Long, _
      ByVal eDrawStage As ECGDrawStage, _
      ByVal lLeft As Long, ByVal lTop As Long, _
      ByVal lRight As Long, ByVal lBottom As Long, _
      bSkipDefault As Boolean)
   '
   If (eDrawStage = ecgBeforeIconAndText) Then
      If m_grd.RowIsGroup(cell.Row) Then
         drawGroupRow cell, lHDC, lLeft, lTop, lRight, lBottom
         bSkipDefault = True
      End If
   End If
   '
End Sub
</pre><p>
To look like a grouped ListView, the cell should contain the text of the 
grouped set in bold with a gradient underline below it.  When SGrid 2.0 
groups rows, it places the text and/or icon of the items that have been grouped into
the <span class="code">Text</span> of the <span class="code">RowTextColumn</span> cell 
(note the default drawing  writes the column name first followed by this text/icon, 
but the column name is added dynamically and not stored in the text property).  Hence
drawing the group row is pretty simple:
</p><pre>
Private Sub drawGroupRow( _
      cell As cGridCell, _
      ByVal lHDC As Long, _
      ByVal lLeft As Long, _
      ByVal lTop As Long, _
      ByVal lRight As Long, _
      ByVal lBottom As Long _
   )
Dim hFont As Long
Dim hFontOld As Long
Dim tR As RECT
Dim tBR As RECT
   
   tR.left = lLeft
   tR.top = lTop
   tR.right = lRight
   tR.bottom = lBottom
   
   LSet tBR = tR
   tBR.top = tBR.bottom - 5
   tBR.bottom = tBR.bottom - 2
   If (cell.Selected) Then
      GradientFillRect lHDC, tBR, _
         vbHighlight, vbWindowBackground, GRADIENT_FILL_RECT_H
   Else
      GradientFillRect lHDC, tBR, _
         vbButtonShadow, vbWindowBackground, GRADIENT_FILL_RECT_H
   End If
   
   ' m_fnt contains the bold version of the grid font, and
   ' IFontOf simply returns the IFont interface from it:
   hFont = IFontOf(m_fnt).hFont
   hFontOld = SelectObject(lHDC, hFont)
   tR.bottom = tR.bottom - 3
   DrawTextA lHDC, " " &amp; cell.Text, -1, tR, cell.TextAlign
   SelectObject lHDC, hFontOld

End Sub
</pre><p>
Check the download code in <span class="code">cBugList.cls</span> for details on the 
declares and  the <span class="code">GradientFillRect</span> routine used here.  Note 
that unlike other cells, group rows
do not have an automatic selection box drawn; in this case the code detects
whether the cell is selected and changes the gradient colour to highlight that the group is
selected.
</p><h3>3. Preventing Rows From Collapsing</h3><p>
Whenever a group row is about to expand or collapse in the grid, the
<span class="code">RowGroupingStateChange</span> event is fired.
By default, the state change is allowed, but you can override it
to collapse the groups:
</p><pre>
Private Sub grdFixedGroups_RowGroupingStateChange( _
      ByVal lRow As Long, _
      ByVal eNewState As ECGGroupRowState, _
      bCancel As Boolean)
   If (eNewState = ecgCollapsed) Then
      bCancel = True
   End If
End Sub
</pre><h3>4. Ensuring all Rows are Expanded</h3><p>
The default behaviour of the grid when a grouping is performed is to collapse all
of the non-grouped rows.  Currently the only way of overriding this is to 
manually expand the rows (in a future release, the default state will be made
configurable).  Doing this is not difficult however:
</p><pre>
Private Sub expandAllGroups()
   ' Expand all of the groups
   grd.Redraw = False
   Dim iRow As Long
   For iRow = 1 To grd.Rows
      If (grd.RowIsGroup(iRow)) Then          
         grd.RowGroupingState(iRow) = ecgExpanded
      End If
   Next iRow
   grd.Redraw = True
End Sub
</pre><h2>Conclusion</h2><p>
This article shows how to create grids which have a fixed grouping structure
defined in code which models the grouping option provided by the ListView
control under Windows XP.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="javascript:window.alert(&quot;http://vbaccelerator.com/home/include/adredir.asp?url=http://oneandone.co.uk/xml/init?k_id=5791003&image=http://oneandone.co.uk/xml/banner?size=1&number=3\nThis link was not retrieved.&quot;)" ><IMG SRC="..\..\..\..\..\..\..\oneandone_co_uk\xml\banner\size=1&number=3.html" ALT="1&1 Web Hosting" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Controls</a>&#160;.&#160;<a href="..\index.html">S Grid 2</a>&#160;.&#160;Creating ListView Style Groups with SGrid 2</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 February 2004</p></td><td></td></tr></table>
</body></html>