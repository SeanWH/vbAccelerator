<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mKeyboardHook.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mKeyboardHook.bas" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">Common Dialog Hooks - Create a VB Style Open Project Dialog</a>&#160;.&#160;<a href="vb5_vb_style_file_open_dialog.html">VB5 VB Style File Open Dialog</a>&#160;.&#160;mKeyboardHook.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_common_dialog_with_picture_preview.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Common Dialog with Picture Preview</a> (27K)</p><p class="nav"><a href="vb5_vb_style_file_open_dialog.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 VB Style File Open Dialog</a> (31K)</p><p /><p class="nav"><a href="vb6_common_dialog_with_picture_preview.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Common Dialog with Picture Preview</a> (25K)</p><p class="nav"><a href="vb6_vb_style_file_open_dialog.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 VB Style File Open Dialog</a> (30K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:1830</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=1830&type=zip&title=vb5_20vb_20style_20file_20open_20dialog_2ezip_5fmkeyboardhook.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:kapag@tir.com">Mark Grimes</a></p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />19 Dec 2002<br /><p class="update">Added VB6 version</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\using_templates_with_common_dialogs\article.html">Common Dialog Templates - Create a WinZip Style File Add Dialog</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\common_dialog_direct\article.html">CommonDialog/Direct</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mKeyboardHook.bas</h1><pre>Attribute VB_Name = "mKeyboardHook"
Option Explicit

Type RECT
    Left As Long
    Top As Long
    Right As Long
    Bottom As Long
End Type

Type POINTAPI
    X As Long
    Y As Long
End Type

Public Declare Function GetParent Lib "user32" (ByVal hWnd As Long) As Long
Public Declare Function SetParent Lib "user32" (ByVal hWndChild As Long, ByVal
 hWndNewParent As Long) As Long
Public Declare Function GetWindowRect Lib "user32" (ByVal hWnd As Long, lpRect
 As RECT) As Long
Public Declare Function ScreenToClient Lib "user32" (ByVal hWnd As Long,
 lpPoint As POINTAPI) As Long

Public Declare Function MoveWindow Lib "user32" (ByVal hWnd As Long, ByVal X As
 Long, ByVal Y As Long, ByVal nWidth As Long, ByVal nHeight As Long, ByVal
 bRepaint As Long) As Long
Public Declare Function ShowWindow Lib "user32" (ByVal hWnd As Long, ByVal
 nCmdShow As Long) As Long
Public Declare Function SendMessageLong Lib "user32" Alias "SendMessageA"
 (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As
 Long) As Long
Public Declare Function SendMessageString Lib "user32" Alias "SendMessageA"
 (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As
 String) As Long
Public Declare Function GetWindow Lib "user32" (ByVal hWnd As Long, ByVal wCmd
 As Long) As Long


Declare Function FindWindowEx Lib "user32" Alias "FindWindowExA" (ByVal hWnd1
 As Long, ByVal hWnd2 As Long, ByVal lpsz1 As String, ByVal lpsz2 As String) As
 Long


   
'Declare constants used by GetWindow.
Public Const GW_CHILD = 5
Public Const GW_HWNDFIRST = 0
Public Const GW_HWNDLAST = 1
Public Const GW_HWNDNEXT = 2
Public Const GW_HWNDPREV = 3
Public Const GW_OWNER = 4

'Dialog Internal Controls
Public Const fdlgChxReadOnly = &amp;H410
Public Const fdlgcmbSaveAsType = &amp;H470
Public Const fdlgCmbSaveInFindIn = &amp;H471
Public Const fdlgEdtFileName = &amp;H480
Public Const fdlgIDCANCEL = 2
Public Const fdlgIDOK = 1
Public Const fdlgLBLstFiles = &amp;H460
Public Const fdlgLVLstFiles = &amp;H461
Public Const fdlgPshHelp = &amp;H40E
Public Const fdlgStcFileName = &amp;H442
Public Const fdlgStcSaveAsType = &amp;H441
Public Const fdlgStcSaveInFindIn = &amp;H443

Public Const SWP_NOSIZE = &amp;H1
Public Const SWP_NOMOVE = &amp;H2
Public Const SWP_NOZORDER = &amp;H4
Public Const SWP_NOREDRAW = &amp;H8
Public Const SWP_NOACTIVATE = &amp;H10
Public Const SWP_FRAMECHANGED = &amp;H20
Public Const SWP_SHOWWINDOW = &amp;H40
Public Const SWP_HIDEWINDOW = &amp;H80
Public Const SWP_NOCOPYBITS = &amp;H100
Public Const SWP_NOOWNERZORDER = &amp;H200
Public Const SWP_DRAWFRAME = SWP_FRAMECHANGED
Public Const SWP_NOREPOSITION = SWP_NOOWNERZORDER

Public Const SWP_MOVEHIDE = SWP_NOSIZE Or SWP_HIDEWINDOW

'Key Const
Public Const VK_TAB = &amp;H9
Public Const VK_SHIFT = &amp;H10
Public Const VK_CONTROL = &amp;H11

'Traps Alter Key
Public Const KBH_MASK = &amp;H20000000

'Hook Const
Public Const WH_KEYBOARD = 2

'For Trapping Tab Key on Dialog Box
Declare Function CallNextHookEx Lib "user32" (ByVal hHook As Long, ByVal nCode
 As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Declare Function UnhookWindowsHookEx Lib "user32" (ByVal hHook As Long) As Long
Declare Function SetWindowsHookEx Lib "user32" Alias "SetWindowsHookExA" (ByVal
 idHook As Long, ByVal lpfn As Long, ByVal hmod As Long, ByVal dwThreadId As
 Long) As Long

Declare Function PostMessage Lib "user32" Alias "PostMessageA" (ByVal hWnd As
 Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Declare Function EnableWindow Lib "user32" (ByVal hWnd As Long, ByVal fEnable
 As Long) As Long
Declare Function SetWindowPos Lib "user32" (ByVal hWnd As Long, ByVal
 hWndInsertAfter As Long, ByVal X As Long, ByVal Y As Long, ByVal cx As Long,
 ByVal cy As Long, ByVal wFlags As Long) As Long
Declare Function GetKeyState Lib "user32" (ByVal nVirtKey As Long) As Integer
Declare Function GetFocusAPI Lib "user32" Alias "GetFocus" () As Long
Declare Function SetFocusAPI Lib "user32" Alias "SetFocus" (ByVal hWnd As Long)
 As Long
Declare Function GetDlgItem Lib "user32" (ByVal hDlg As Long, ByVal nIDDlgItem
 As Long) As Long
Declare Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal hWnd As
 Long, ByVal wMsg As Long, ByVal wParam As Integer, ByVal lParam As Any) As Long
Declare Function SetDlgItemText&amp; Lib "user32" Alias "SetDlgItemTextA" (ByVal
 hDlg As Long, ByVal nIDDlgItem As Long, ByVal lpString As String)
Declare Function GetDlgItemText&amp; Lib "user32" Alias "GetDlgItemTextA" (ByVal
 hDlg As Long, ByVal nIDDlgItem As Long, ByVal lpString As String, ByVal
 nMaxCount As Long)
Declare Function SetDlgItemInt&amp; Lib "user32" (ByVal hDlg As Long, ByVal
 nIDDlgItem As Long, ByVal wValue As Long, ByVal bSigned As Long)

Public Const WM_CLOSE = &amp;H10&amp;
Public Const WM_COMMAND = &amp;H111&amp;
Public Const WM_USER = &amp;H400&amp;

Public Const CDM_FIRST = (WM_USER + 100)
Public Const CDM_GETFILEPATH = (CDM_FIRST + &amp;H1)

Public Const MAX_PATH = 260

Private m_hKeyHook  As Long

Public Sub InstallHook()
   If m_hKeyHook = 0 Then
      m_hKeyHook = SetWindowsHookEx(WH_KEYBOARD, AddressOf TabKeyProc, 0&amp;,
       App.ThreadID)
   End If
End Sub
Public Sub RemoveHook()
   If m_hKeyHook &lt;&gt; 0 Then
      UnhookWindowsHookEx m_hKeyHook
      m_hKeyHook = 0
   End If
End Sub

Public Property Get GetCDlgFileName(ByVal hDlg As Long) As String
Dim sBuf As String
Dim iPos As Long
Dim hWnd As Long
   hWnd = GetParent(hDlg)
   sBuf = String$(MAX_PATH, 0)
   SendMessageString hWnd, CDM_GETFILEPATH, 260, sBuf
   iPos = InStr(sBuf, vbNullChar)
   If iPos &gt; 0 Then
      GetCDlgFileName = Left$(sBuf, iPos - 1)
   End If
End Property

Public Function TabKeyProc(ByVal nCode As Long, ByVal wParam As Long, ByVal
 lParam As Long) As Long
  
 If nCode &gt;= 0 And Not (frmNew Is Nothing) Then
  If wParam = 9 Then
      
   If (lParam And &amp;HC0000000) = 0 And (lParam And KBH_MASK) &lt;&gt; 0 Then
    'do nothing
   ElseIf GetKeyState(VK_CONTROL) &lt;= 1 Then
    
    If GetKeyState(VK_SHIFT) &lt; 0 And GetKeyState(VK_TAB) &lt; 0 Then
     If lParam = 135200769 Or lParam = 1208942593 Or lParam = 983041 Or
      1074724865 Then
      If frmNew.SetBackwardFocus Then
       TabKeyProc = 1&amp;: Exit Function
      End If
     End If

    ElseIf GetKeyState(VK_TAB) &lt; 0 Then
     If lParam = 135200769 Or lParam = 1208942593 Or lParam = 983041 Or
      1074724865 Then
      If frmNew.SetForwardFocus Then
       TabKeyProc = 1&amp;: Exit Function
      End If
     End If
    
    End If
   
   End If
  
  ElseIf wParam = 13 Then
   If frmNew.IsNew Then
    If Not (frmNew.lvwNew.SelectedItem Is Nothing) Then
     If frmNew.lvwNew.SelectedItem.Text &lt;&gt; "" Then
      frmNew.cmdNewOpen.Value = True
      TabKeyProc = 1: Exit Function
     End If
    End If
   End If
  End If
 
 End If
         
 TabKeyProc = CallNextHookEx(m_hKeyHook, nCode, wParam, lParam)
         
End Function




</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">Common Dialog Hooks - Create a VB Style Open Project Dialog</a>&#160;.&#160;<a href="vb5_vb_style_file_open_dialog.html">VB5 VB Style File Open Dialog</a>&#160;.&#160;mKeyboardHook.bas</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>