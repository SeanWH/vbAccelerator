<html lang="en" >
<head>
<title>vbAccelerator - Fix for GPF Hooking the Pring Dialog </title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
Common Dialog/Direct is a new DLL or class library which shows how to completely replace 
COMDLG32.OCX through Visual Basic code. The main advantage of this is you no longer need 
to put a control on a form to use common dialogs - just declare an instance of the class and 
you have a straight replacement. You can also incorporate the Common Dialog/Direct code 
straight into your own project if you want to reduce dependency files when you 
ship your project.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">CommonDialog/Direct</a>&#160;.&#160;<a href="bugtrak.html">BugTrak Summary</a>&#160;.&#160;Fix for GPF Hooking the Pring Dialog </p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_common_dialog_direct_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Common Dialog Direct Binary</a> (32K)</p><p class="nav"><a href="vb5_common_dialog_direct_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Common Dialog Direct Demonstration</a> (19K)</p><p class="nav"><a href="vb5_common_dialog_direct_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Common Dialog Direct Full Source</a> (73K)</p><p /><p class="nav"><a href="vb6_common_dialog_direct_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Common Dialog Direct Binary</a> (32K)</p><p class="nav"><a href="vb6_common_dialog_direct_demonstration.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Common Dialog Direct Demonstration</a> (14K)</p><p class="nav"><a href="vb6_common_dialog_direct_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Common Dialog Direct Full Source</a> (70K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:1419</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=1419&type=article&title=commondialog_2fdirect.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav"><a href="bugtrak.html">BugTrak</a></p><p class="nav"><a href="bugtrak.html#bugs"><img src="..\..\..\..\..\res\btbug.png" width="16" height="16" alt="Bug" />&#160;Bugs:</a> 3 / 4</p><p class="nav"><a href="bugtrak.html#issues"><img src="..\..\..\..\..\res\btissue.png" width="16" height="16" alt="Issue" />&#160;Issues:</a> 2 / 3</p><p class="nav"><a href="bugtrak.html#questions"><img src="..\..\..\..\..\res\btquestion.png" width="16" height="16" alt="Question" />&#160;Questions:</a> 0 / 0</a></p><p class="nav">Updated:8 December 2003</p>
<br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />20 Jun 2003<br /><p class="update">Hook support now enabled for Print Dialogs.  The prior code did not
work as the structure was incorrectly aligned.  The new version fixes this problem.  Many
thanks to Uwe Wiemer and Klaus Probst for identifying the fix.
        </p><p class="update">Added a properties to return the selected Printer device name, driver
name and port.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Fix for GPF Hooking the Pring Dialog </h1><h2>Summary</h2><table class="article"><tr><td>Id:</td><td>1419.2</td></tr><tr><td>Type:</td><td><img src="..\..\..\..\..\res\btbugclosed.png" width="16" height="16" alt="Bug" />&#160;Bug</td></tr><tr><td>Current Status:</td><td>Resolved</td></tr></table><h2>Detail</h2><table class="article"><tr class="header"><td>4&#160;Jun&#160;2003</td><td>Open</td><td width="100%">Uwe Wiemer</td></tr><tr><td colspan="3"><p>Thanks for your answer. I have attached a text file with the new Print-DLG structure and how to assign the hook address to the hook-members of the "new" structure. It should be self-explanatory. If not, please drop me a line. I found the solution to this problem somewhere in a vb-newsgroup - I guess. I wanted to send you that posting too but couldn't find it any more. As far as I remember Klaus H. Probst (vbbox.com) posted the answer to that problem.</p><codeChar>'!!!!!!!!!!!!!!!!!! New structure due to misalignment problems, !!!!!!!!!!!!!!!!</codeChar><codeChar>'!!!!!!!!!!!!!!!!!! that's why we don't use the structure below !!!!!!!!!!!!!!!!</codeChar><codeChar>'***************Declarations for the Print-Dialogs************************</codeChar><codeChar>'***************This one here causes some troubles (GPF!)*****************</codeChar><codeChar>'Private Type TPRINTDLG</codeChar><codeChar>'            lStructSize As Long</codeChar><codeChar>'            hwndOwner As Long</codeChar><codeChar>'            hDevMode As Long</codeChar><codeChar>'            hDevNames As Long</codeChar><codeChar>'            hdc As Long</codeChar><codeChar>'            flags As Long</codeChar><codeChar>'            nFromPage As Integer</codeChar><codeChar>'            nToPage As Integer</codeChar><codeChar>'            nMinPage As Integer</codeChar><codeChar>'            nMaxPage As Integer</codeChar><codeChar>'            nCopies As Integer</codeChar><codeChar>'            hInstance As Long   '&lt;-- Misalignment starts here, with this member of the UDT !!!!!</codeChar><codeChar>'            lCustData As Long</codeChar><codeChar>'            lpfnPrintHook As Long</codeChar><codeChar>'            lpfnSetupHook As Long</codeChar><codeChar>'            lpPrintTemplateName As String</codeChar><codeChar>'            lpSetupTemplateName As String</codeChar><codeChar>'            hPrintTemplate As Long</codeChar><codeChar>'            hSetupTemplate As Long</codeChar><codeChar>'End Type    'Type TPRINTDLG</codeChar><codeChar></codeChar><codeChar>'~~~~~~~~~~~~ Declarations for the Print-Dialog for use with VB6 ~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~ Due to alignment problems (32 bit alignment) we have to ~~~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~~use a slightly different PrintDlg-Structure !!!!!! ~~~~~~~~~~~~~~~~~~~~~~</codeChar><codeChar>Private Type TPRINTDLG_VB</codeChar><codeChar>             lStructSize As Long</codeChar><codeChar>             hwndOwner As Long</codeChar><codeChar>             hDevMode As Long</codeChar><codeChar>             hDevNames As Long</codeChar><codeChar>             hdc As Long</codeChar><codeChar>             flags As Long</codeChar><codeChar>             nFromPage As Integer</codeChar><codeChar>             nToPage As Integer</codeChar><codeChar>             nMinPage As Integer</codeChar><codeChar>             nMaxPage As Integer</codeChar><codeChar>             nCopies As Integer</codeChar><codeChar></codeChar><codeChar>             ' !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</codeChar><codeChar>             'Here starts the trouble/the misalignment.</codeChar><codeChar>             'Each long of an UDT has to start at a 4-Byte (=32-Bit) boundary.</codeChar><codeChar>             'The new micro-processors can access such a long var. with one operation.</codeChar><codeChar>             'VB adds padding bytes so that the long var starts at such a 4-Byte</codeChar><codeChar>             'boundary, hence VB shifts the offsets of the vars. in the UDT.</codeChar><codeChar>             'The C-DLL expects the hook address at a certain offset and since</codeChar><codeChar>             'VB has added some padding bytes the hook address the C-Dll receives</codeChar><codeChar>             'is wrong. That causes a GPF. To avoid that we divide the long vars. into</codeChar><codeChar>             'high and low integer vars; we especially divide the hook address in a</codeChar><codeChar>             'high and low integer.</codeChar><codeChar>             ' !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</codeChar><codeChar>             hInstanceLow As Integer</codeChar><codeChar>             hInstanceHigh As Integer</codeChar><codeChar>             lCustDataLow As Integer</codeChar><codeChar>             lCustDataHigh As Integer</codeChar><codeChar></codeChar><codeChar>             lpfnPrintHookLow As Integer            'low word of lpfnPrintHook</codeChar><codeChar>             lpfnPrintHookHigh As Integer           'high word of lpfnPrintHook</codeChar><codeChar>             lpfnSetupHookLow As Integer</codeChar><codeChar>             lpfnSetupHookHigh As Integer</codeChar><codeChar></codeChar><codeChar>             lpPrintTemplateNameLow As Integer</codeChar><codeChar>             lpPrintTemplateNameHigh As Integer</codeChar><codeChar>             lpSetupTemplateNameLow As Integer</codeChar><codeChar>             lpSetupTemplateNameHigh As Integer</codeChar><codeChar>             hPrintTemplateLow As Integer</codeChar><codeChar>             hPrintTemplateHigh As Integer</codeChar><codeChar>             hSetupTemplateLow As Integer</codeChar><codeChar>             hSetupTemplateHigh As Integer</codeChar><codeChar>End Type   'TPRINTDLG_VB</codeChar><codeChar>'~~~~~~~~~~~~ Declarations for the Print-Dialog for use with VB6 ~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~ Due to alignemnt problems (32 bit alignment) we have to ~~~~~~~~~~~~~~~~~</codeChar><codeChar>'~~~~~~~use a slightly different PrintDlg-Structure !!!!!! ~~~~~~~~~~~~~~~~~~~~~~</codeChar><codeChar></codeChar><codeChar></codeChar><codeChar></codeChar><codeChar></codeChar><codeChar></codeChar><codeChar>lngHookAdr = GetMyHookFunctionAdr(AddressOf MyPrintDlgHook)</codeChar><codeChar>                   'since we have divided the Long-Pointer of the hook address into</codeChar><codeChar>                   'a high and a low word - due to bit-alignment problems with VB</codeChar><codeChar>                   'and the PrintDlg-strucuture - we have to divide the hook address</codeChar><codeChar>                   'into a high and and a low word</codeChar><codeChar>                .lpfnPrintHookHigh = lngHookAdr / 65536</codeChar><codeChar>                .lpfnPrintHookLow = lngHookAdr Mod 65536</codeChar></td></tr><tr class="header"><td>22&#160;Jun&#160;2003</td><td>Resolved</td><td width="100%">Steve McMahon steve@vbaccelerator.com</td></tr><tr><td colspan="3"><p>Fixed alignment in a similar way to that described above.  The actual deployed code uses byte arrays and CopyMemory rather than integers and math to prevent problems with unsigned values but is otherwise the same.</p></td></tr></table><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="javascript:window.alert(&quot;http://vbaccelerator.com/home/include/adredir.asp?url=http://oneandone.co.uk/xml/init?k_id=5791003&image=http://oneandone.co.uk/xml/banner?size=1&number=3\nThis link was not retrieved.&quot;)" ><IMG SRC="..\..\..\..\..\..\..\oneandone_co_uk\xml\banner\size=1&number=3.html" ALT="1&1 Web Hosting" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">CommonDialog/Direct</a>&#160;.&#160;<a href="bugtrak.html">BugTrak Summary</a>&#160;.&#160;Fix for GPF Hooking the Pring Dialog </p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 22 June 2003</p></td><td></td></tr></table>
</body></html>