<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mHook.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mHook.bas" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">Using the Find and Replace Common Dialogs</a>&#160;.&#160;<a href="vb6_findreplace_class_and_sample.html">VB6 FindReplace Class and Sample</a>&#160;.&#160;mHook.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_findreplace_class_and_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 FindReplace Class and Sample</a> (18K)</p><p /><p class="nav"><a href="vb6_findreplace_class_and_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 FindReplace Class and Sample</a> (17K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12318</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=12318&type=zip&title=vb6_20findreplace_20class_20and_20sample_2ezip_5fmhook.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />20 Jun 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\hooks\vbaccelerator_hook_library\article.html">Win32 Hooks in VB - The vbAccelerator Hook Library</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mHook.bas</h1><pre>Attribute VB_Name = "mFindReplaceHook"
Option Explicit

Private Declare Function SetWindowsHookEx Lib "user32" Alias
 "SetWindowsHookExA" (ByVal idHook As Long, ByVal lpFn As Long, ByVal hmod As
 Long, ByVal dwThreadId As Long) As Long
Private Declare Function UnhookWindowsHookEx Lib "user32" (ByVal hHook As Long)
 As Long
Private Declare Function CallNextHookEx Lib "user32" (ByVal hHook As Long,
 ByVal nCode As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetCurrentThreadId Lib "kernel32" () As Long
Private Const WH_KEYBOARD = 2
Private Const WH_MSGFILTER = (-1)

Private Type POINTAPI
   x As Long
   y As Long
End Type
Private Type Msg
   hWnd As Long
   message As Long
   wParam As Long
   lParam As Long
   time As Long
   pt As POINTAPI
End Type
Private Declare Function IsDialogMessage Lib "user32" Alias "IsDialogMessageA"
 (ByVal hDlg As Long, lpMsg As Msg) As Long
Private Declare Function GetActiveWindow Lib "user32" () As Long
Private Declare Function SendMessageLong Lib "user32" Alias "SendMessageA"
 (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As
 Long) As Long
Private Declare Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
Private Declare Function GetCurrentTime Lib "kernel32" Alias "GetTickCount" ()
 As Long
Private Declare Function PostMessage Lib "user32" Alias "PostMessageA" (ByVal
 hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As Long)
 As Long
Private Declare Function GetFocusAPI Lib "user32" Alias "GetFocus" () As Long
Private Declare Function SetFocusAPI Lib "user32" Alias "SetFocus" (ByVal hWnd
 As Long) As Long
Private Declare Function GetNextDlgGroupItem Lib "user32" (ByVal hDlg As Long,
 ByVal hCtl As Long, ByVal bPrevious As Long) As Long
Private Declare Function GetNextDlgTabItem Lib "user32" (ByVal hDlg As Long,
 ByVal hCtl As Long, ByVal bPrevious As Long) As Long
Private Declare Function SendDlgItemMessage Lib "user32" Alias
 "SendDlgItemMessageA" (ByVal hDlg As Long, ByVal nIDDlgItem As Long, ByVal
 wMsg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA"
 (ByVal hWnd As Long, ByVal nIndex As Long) As Long
Private Const GWL_WNDPROC = (-4)
Private Declare Function CallWindowProc Lib "user32" Alias "CallWindowProcA"
 (ByVal lpPrevWndFunc As Long, ByVal hWnd As Long, ByVal Msg As Long, ByVal
 wParam As Long, ByVal lParam As Long) As Long

Private Const WM_KEYDOWN = &amp;H100
Private Const WM_KEYUP = &amp;H101

Private m_hHook As Long
Private m_hWnd As Long

Public Sub Attach(ByVal hWnd As Long)
   If (m_hHook = 0) Then
      Dim lpFn As Long
      lpFn = HookProcAddress(AddressOf HookProc)
      m_hHook = SetWindowsHookEx(WH_KEYBOARD, lpFn, App.hInstance,
       GetCurrentThreadId())
      If Not m_hHook = 0 Then
         m_hWnd = hWnd
      Else
         Debug.Assert (m_hHook &lt;&gt; 0)
      End If
   End If
End Sub
Public Sub Detach()
   If Not (m_hHook = 0) Then
      UnhookWindowsHookEx m_hHook
      m_hHook = 0
      m_hWnd = 0
   End If
End Sub

Private Function HookProcAddress(ByVal lPtr As Long) As Long
   HookProcAddress = lPtr
End Function


Private Function HookProc(ByVal nCode As Long, ByVal wParam As Long, ByVal
 lParam As Long) As Long
Dim lR As Long
Dim bKeyDown As Boolean
   If (nCode &gt;= 0) Then
      If (GetActiveWindow() = m_hWnd) Then
         Dim lpMsg As Msg
         lpMsg.hWnd = m_hWnd
         lpMsg.time = GetCurrentTime
         Dim pt As POINTAPI
         GetCursorPos pt
         lpMsg.pt = pt
         lpMsg.lParam = lParam
         lpMsg.wParam = wParam
         lpMsg.message = IIf((lParam And &amp;H40000000) = &amp;H40000000, WM_KEYUP,
          WM_KEYDOWN)
         If (wParam = vbKeyEscape) Or (wParam = vbKeyReturn) Or (wParam =
          vbKeyTab) Then
            If Not (IsDialogMessage(m_hWnd, lpMsg) = 0) Then
               lR = 1
            End If
         End If
      End If
      If (lR = 1) Then
         HookProc = 1
      Else
         HookProc = CallNextHookEx(m_hHook, nCode, wParam, lParam)
      End If
   End If
   Exit Function
   
End Function
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Common Dialogs</a>&#160;.&#160;<a href="article.html">Using the Find and Replace Common Dialogs</a>&#160;.&#160;<a href="vb6_findreplace_class_and_sample.html">VB6 FindReplace Class and Sample</a>&#160;.&#160;mHook.bas</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 23 June 2003</p></td><td></td></tr></table>
</body></html>