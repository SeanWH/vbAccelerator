<html lang="en" >
<head>

<title>vbAccelerator - Reading Data from Local or External Library Resources</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="Often your application will have associated data, such as pictures, sounds, static data and 
so forth you need to ship with it. If you are localizing your application then you also 
need to be able to provide alternative text strings for menus, messages, labels on so forth. 
Resources are a great way to package up all of this extra data into a single file and read 
it efficiently at run time. Not just that, but by putting the data into a resource file 
you significantly reduce the chances of someone tampering with your files and replacing 
them with their own 'humourous' versions." /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Resources</a>&#160;.&#160;Reading Data from Local or External Library Resources</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="external_resources_demonstration_project.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />External Resources Demonstration Project</a> (52K)</p><p /><p class="nav"><a href="jpg_resource_file_sample_project.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />JPG Resource File Sample Project</a> (43K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:2522</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=2522&type=article&title=reading_20data_20from_20local_20or_20external_20library_20resources.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />1 Nov 1999<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Reading Data from Local or External Library Resources</h1><p class="splash">Techniques for managing static data associated with your application</p><img src="resimg.gif" width="196" height="157" alt="Somehow there's never enough disk space on my system." /><p /><p>Often your application will have associated data, such as pictures, sounds, static data and 
so forth you need to ship with it. If you are localizing your application then you also 
need to be able to provide alternative text strings for menus, messages, labels on so forth. 
Resources are a great way to package up all of this extra data into a single file and read 
it efficiently at run time. Not just that, but by putting the data into a resource file 
you significantly reduce the chances of someone tampering with your files and replacing 
them with their own "humourous" versions.</p><p>VB has reasonable resource support with the <i>LoadResData</i> function, however, it 
lacks some features:</p><ol><li>You can only load data from the local module, i.e. you cannot put your resources 
in an external DLL and load them from there.</li><li>You cannot determine the resource contents of a file.</li><li>It is not obvious how you can use the function to load an 
arbitrary resource type, such as JPEG file.</li></ol><p>This article covers the code and tools you can use to overcome these limitations 
in a Visual Basic application.</p><h2>Step Up to Resources</h2><p>There are two ways of getting resources into a VB application.</p><ul><li><strong>The Resource Compiler</strong><br />
The traditional method is to create a Resource Compiler (.RC) file and compile it into a 
Resource .RES file using the Microsoft Resource Compiler (RC.EXE).</li><li><strong>IDE Support for Resource Files</strong><br />
VB 6 has a visual resource compiler built into the IDE. For VB5 you can download 
a resource compiler add-in from the Visual Basic area at MSDN. 
Note: if you don't have RC.EXE then this is also included in the VB5 resource compiler add-in download.</li></ul><p>The second method is a lot easier to manage, as there is an IDE to add and remove the files. 
Unfortunately, in my experience, it does not always seem to create resources which can be read 
by other tools, or even straight API calls. I don't know if this is always true, but if 
you're trying to add a document icon (say to support Document File Associations) which can be read by 
Windows then I always needed to use RC.EXE.</p><p>The important thing to note is it is really simple to use RC.EXE. Simply place RC.EXE and RCDLL.DLL 
into your system's path, or set the path to point to the directory these files live in, 
write your .RC file and then compile it with this command line:</p><pre>
   RC /r /fo [Output File] [Input File]
</pre><p>For more details, read the article "Using RC.EXE".</p><h2>Loading Resources From an External Module</h2><p>Unlike Visual Basic, The Windows API does not differentiate between loading resources 
from the local application or from an external module. The only thing it requires is a 
handle to the module where it will find the resource. For the local module, this is 
the value returned from <i>App.hInstance</i>. For an external binary, you need to load the 
file using the API <i>LoadLibrary</i> function in order to get a handle to the data. 
Paste the code below into a class module, then you have a simple means of loading an external 
EXE, OCX or DLL as a library, accessing the hModule handle and ensuring the resource is 
unloaded when you have finished with it:</p><pre>
Private Declare Function LoadLibraryEx Lib "kernel32" Alias "LoadLibraryExA" _
   (ByVal lpLibFileName As String, _
    ByVal hFile As Long, _
    ByVal dwFlags As Long) As Long
' Missing from VB API declarations:
Private Const DONT_RESOLVE_DLL_REFERENCES = &amp;H1&amp;
Private Const LOAD_LIBRARY_AS_DATAFILE = &amp;H2&amp;
Private Const LOAD_WITH_ALTERED_SEARCH_PATH = &amp;H8&amp;
Private Declare Function LoadLibrary Lib "kernel32" Alias "LoadLibraryA" _
    (ByVal lpLibFileName As String) As Long

Private Declare Function FreeLibrary Lib "kernel32" _
     (ByVal hLibModule As Long) As Long

Private m_sFileName As String
Private m_hMod As Long

Public Property Get Filename() As String
   Filename = m_sFileName
End Property

Public Property Let Filename(ByVal sFileName As String)
   ClearUp
   m_sFileName = sFileName
   If m_sFileName &lt;&gt; "" Then
      m_hMod = LoadLibraryEx(m_sFileName, 0, 0)
      If (m_hMod = 0) Then
         Err.Raise vbObjectError + 1048 + 1, _
             App.EXEName &amp; ".cLibrary", WinError(Err.LastDllError)
      End If
   End If
End Property

Public Property Get hModule() As Long
   hModule = m_hMod
End Property

Private Sub ClearUp()
   If Not (m_hMod = 0) Then
      FreeLibrary m_hMod
   End If
   m_hMod = 0
   m_sFileName = ""
End Sub


Private Sub Class_Terminate()
   ClearUp
End Sub
</pre><p>Putting your resources in a external module is then simple: simply create a VB 
ActiveX DLL project, add your .RES file to it, compile it and that's it! Ready to use.</p><h2>Determing The Resource Contents Of a File</h2><p>To do this you need to able to call the Win32 API functions <i>EnumResourceTypes</i> to get 
the different types of resources and <i>EnumResourceNames</i> to get the names of the resources. 
The code to do this is fundamentally simple but a bit of a pain to get working correctly 
(read: ensuring the ByVal and ByRefs are in the right place!). The finished product is demonstrated 
in the <i>cResources</i> class of the demonstration download. The biggest problem with the 
code is that the API has a strange way of reusing String parameters as Long values and vice-versa, 
which certainly doesn't look nice to anyone who has had the luxury of the variant before. 
I'm sure it saves, ooh, at least twenty-five bytes on disk for the typical project though.</p><img src="119.bmp" width="180" height="36" alt="WinHelp Resource ID 119" /><p class="caption">Do It Yourself: I was hoping for an animated cursor, but this is how they did it: Bitmap Resources 119 and 120 from WinHlp32.EXE...</p><p>The source code also demonstrates helper functions to read bitmaps, icons, cursors and 
binary data as well as to save them to disk in the <i>mResource</i> module.</p><h2>Loading Arbitary Resources</h2><p>Whilst VB provides you with a method to read a bitmap from a resource file, 
that can (literally) add Megabytes to the size of your application. What you want to do is 
to store the picture in a smaller format, such as JPG (or GIF, if you really have to). The problem 
is that VB doesn't allow you to read in these formats with the <i>LoadResPicture</i> function.</p><p>There are two solutions to this problem: one is simple, and the other is much harder. For both you 
add the picture data in JPG or GIF format as a binary resource format. In the simple method, 
you read the binary data using either <i>LoadResPicture</i> for local data or the techniques in the 
<i>mResource</i> module of the demonstration project for external data, and then you write it to a temporary file. 
It is simple then to use the <i>LoadPicture</i> function on the temporary file and clear up the file. 
The <i>TempRes</i> demonstration project demonstrates this technique.</p><p>The harder technique would be to implement the <i>IPersistStream</i> function to allow a 
<i>StdPicture</i> object to deserialise itself directly from a byte array. I haven't figured out how 
to do it yet, but if anyone has any tips on doing this, I'd love to hear!</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Resources</a>&#160;.&#160;Reading Data from Local or External Library Resources</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 23 April 2003</p></td><td></td></tr></table>
</body></html>
