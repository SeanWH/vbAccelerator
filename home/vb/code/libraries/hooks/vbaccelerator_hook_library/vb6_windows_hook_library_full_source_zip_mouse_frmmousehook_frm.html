<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: Mouse_frmMouseHook.frm</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: Mouse_frmMouseHook.frm" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Hooks</a>&#160;.&#160;<a href="article.html">Win32 Hooks in VB - The vbAccelerator Hook Library</a>&#160;.&#160;<a href="vb6_windows_hook_library_full_source.html">VB6 Windows Hook Library Full Source</a>&#160;.&#160;Mouse_frmMouseHook.frm</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_windows_hook_library_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Windows Hook Library Binary</a> (17K)</p><p class="nav"><a href="vb5_windows_hook_library_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Windows Hook Library Full Source</a> (61K)</p><p /><p class="nav"><a href="vb6_windows_hook_library_binary.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Windows Hook Library Binary</a> (17K)</p><p class="nav"><a href="vb6_windows_hook_library_full_source.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Windows Hook Library Full Source</a> (60K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12590</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=12590&type=zip&title=vb6_20windows_20hook_20library_20full_20source_2ezip_5fmouse_5ffrmmousehook.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 Jun 2003<br /><p class="update">Added support for Journal Record and Playback hooks</p><p class="update">Added <span class="code">MsgFilterlParam</span> method
for working with the <span class="code">WH_GETMESSAGE</span> Hook.</p></p><p class="update"><a href="updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\accelerator_control\article.html">vbAccelerator Accelerator Control</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\resources\babbage\vb6_docking_forms\article.html">(Incomplete) Docking Forms In VB</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: Mouse_frmMouseHook.frm</h1><pre>VERSION 5.00
Begin VB.Form frmMouseHook 
   Caption         =   "vbAccelerator Windows Hooks - Mouse"
   ClientHeight    =   6495
   ClientLeft      =   3090
   ClientTop       =   2355
   ClientWidth     =   5400
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmMouseHook.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   6495
   ScaleWidth      =   5400
   Begin VB.Frame fraTest 
      Caption         =   "Test Frame"
      Height          =   735
      Left            =   60
      TabIndex        =   18
      Top             =   3480
      Width           =   5175
      Begin VB.TextBox txtTest4 
         Height          =   285
         Left            =   120
         TabIndex        =   20
         Text            =   "Text1"
         Top             =   300
         Width           =   2595
      End
      Begin VB.Label lblInfo 
         Caption         =   "Label Within a Frame"
         Height          =   195
         Index           =   3
         Left            =   3000
         TabIndex        =   19
         Top             =   180
         Width           =   1935
      End
   End
   Begin VB.CheckBox chkSelect 
      Caption         =   """&amp;Select"" Controls"
      Height          =   255
      Left            =   60
      TabIndex        =   17
      Top             =   840
      Width           =   1575
   End
   Begin VB.PictureBox picContainer 
      Height          =   1395
      Left            =   2940
      ScaleHeight     =   1335
      ScaleWidth      =   2235
      TabIndex        =   12
      Top             =   2040
      Width           =   2295
      Begin VB.OptionButton optTest 
         Caption         =   "Option1"
         Height          =   195
         Index           =   1
         Left            =   60
         TabIndex        =   16
         Top             =   1080
         Width           =   2055
      End
      Begin VB.OptionButton optTest 
         Caption         =   "Option1"
         Height          =   195
         Index           =   0
         Left            =   60
         TabIndex        =   15
         Top             =   840
         Value           =   -1  'True
         Width           =   2055
      End
      Begin VB.CommandButton cmdTestChild2 
         Caption         =   "Command1"
         Height          =   315
         Left            =   60
         Style           =   1  'Graphical
         TabIndex        =   14
         Top             =   420
         Width           =   1275
      End
      Begin VB.CommandButton cmdTestChild1 
         Caption         =   "Command1"
         Height          =   315
         Left            =   60
         Style           =   1  'Graphical
         TabIndex        =   13
         Top             =   60
         Width           =   1275
      End
   End
   Begin VB.TextBox txtTest 
      Height          =   855
      Left            =   60
      TabIndex        =   6
      Text            =   "Text1"
      Top             =   1620
      Width           =   2715
   End
   Begin VB.TextBox txtUnaffected 
      Height          =   315
      Left            =   60
      TabIndex        =   5
      Text            =   "Text1"
      Top             =   4620
      Width           =   2775
   End
   Begin VB.ListBox lstUnaffected 
      Height          =   840
      Left            =   60
      TabIndex        =   4
      Top             =   5040
      Width           =   2775
   End
   Begin VB.CommandButton cmdTest1 
      Caption         =   "Command1"
      Height          =   315
      Left            =   2940
      Style           =   1  'Graphical
      TabIndex        =   3
      Top             =   4620
      Width           =   1275
   End
   Begin VB.CommandButton cmdTest2 
      Caption         =   "Command1"
      Height          =   315
      Left            =   2940
      Style           =   1  'Graphical
      TabIndex        =   2
      Top             =   4980
      Width           =   1275
   End
   Begin VB.ComboBox cboTest 
      Height          =   315
      Left            =   2940
      TabIndex        =   1
      Text            =   "Combo1"
      Top             =   1620
      Width           =   2295
   End
   Begin VB.ListBox lstTest 
      Height          =   840
      Left            =   60
      TabIndex        =   0
      Top             =   2580
      Width           =   2715
   End
   Begin VB.Label lblMousePos 
      BorderStyle     =   1  'Fixed Single
      Caption         =   "Label1"
      Height          =   315
      Left            =   4020
      TabIndex        =   11
      Top             =   6120
      Width           =   1335
   End
   Begin VB.Label lblStatus 
      BorderStyle     =   1  'Fixed Single
      Caption         =   "Label1"
      Height          =   315
      Left            =   60
      TabIndex        =   10
      Top             =   6120
      Width           =   3855
   End
   Begin VB.Label lblInfo 
      Caption         =   "This is an information label"
      Height          =   195
      Index           =   0
      Left            =   60
      TabIndex        =   9
      Top             =   1320
      Width           =   5175
   End
   Begin VB.Label lblInfo 
      Caption         =   $"frmMouseHook.frx":1272
      Height          =   615
      Index           =   1
      Left            =   60
      TabIndex        =   8
      Top             =   60
      Width           =   5235
   End
   Begin VB.Label lblInfo 
      Caption         =   "This is an information label"
      Height          =   315
      Index           =   2
      Left            =   60
      TabIndex        =   7
      Top             =   4320
      Width           =   5175
   End
End
Attribute VB_Name = "frmMouseHook"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Implements IWindowsHook

Private Type POINTAPI
   x As Long
   y As Long
End Type
Private Declare Function GetProp Lib "user32" Alias "GetPropA" (ByVal hwnd As
 Long, ByVal lpString As String) As Long
Private Declare Function SetProp Lib "user32" Alias "SetPropA" (ByVal hwnd As
 Long, ByVal lpString As String, ByVal hData As Long) As Long
Private Declare Function WindowFromPoint Lib "user32" (ByVal xPoint As Long,
 ByVal yPoint As Long) As Long
Private Declare Function ScreenToClient Lib "user32" (ByVal hwnd As Long,
 lpPoint As POINTAPI) As Long
Private m_objParent As Object
Private m_iSelCount As Long

Private Function FindControl(ByVal lhWndCmp, ByVal x As Long, ByVal y As Long,
 ByRef ctlOver As Control)
Dim lhWNd As Long
   ' This returns the window the mouse is over:
   lhWNd = WindowFromPoint(x, y)
   ' Now if we get a window, we need to find what control
   ' it is.  Some controls don't have a window handle.  The
   ' handle for these controls is the parent handle.  Some
   ' controls (e.g. combo box) have sub windows.
   If lhWNd &lt;&gt; 0 Then
      ' Check if a direct control hWnd:
      If Not IsControl(lhWNd, ctlOver) Then
         ' Check if a child of any control
         If Not IsChildOfControl(lhWNd, ctlOver) Then
            ' Check for control without hWnd:
            IsControlNohWnd lhWNd, ctlOver, x, y
         End If
      Else
         ' Check if we have a control without hWnd
         ' contained within this hWnd which is actually what the
         ' mouse is over:
         IsControlNohWnd lhWNd, ctlOver, x, y
      End If
   End If
   
End Function
Private Function IsControlNohWnd(ByVal lhWndParent As Long, ctlOver As Control,
 ByVal x As Long, ByVal y As Long) As Boolean
Dim ctl As Control
Dim lhWndC As Long
Dim objParent As Object
Dim tP As POINTAPI
   If lhWndParent = Me.hwnd Then
      Set objParent = Me
   Else
      For Each ctl In Me.Controls
         On Error Resume Next
         lhWndC = ctl.hwnd
         If Err.Number &lt;&gt; 0 Then lhWndC = 0
         If lhWndC = lhWndParent Then
            Set objParent = ctl
            Exit For
         End If
      Next
   End If
   If Not objParent Is Nothing Then
      For Each ctl In Me.Controls
         On Error Resume Next
         If ctl.Container Is objParent Then
            tP.x = x: tP.y = y
            ScreenToClient objParent.hwnd, tP
            If tP.x &gt;= ctl.Left \ Screen.TwipsPerPixelX And tP.x &lt;= (ctl.Left +
             ctl.Width) \ Screen.TwipsPerPixelX Then
               If tP.y &gt;= ctl.Top \ Screen.TwipsPerPixelX And tP.y &lt;= (ctl.Top
                + ctl.Height) \ Screen.TwipsPerPixelX Then
                  Set ctlOver = ctl
                  IsControlNohWnd = True
               End If
            End If
         End If
      Next
   End If
End Function

Private Function IsControl(ByVal lhWNd As Long, ByRef ctlOver As Control)
Dim ctl As Control
Dim lhWndC As Long
   For Each ctl In Me.Controls
      On Error Resume Next
      lhWndC = ctl.hwnd
      If Err.Number &lt;&gt; 0 Then lhWndC = 0
      If lhWNd = lhWndC Then
         IsControl = True
         Set ctlOver = ctl
         Exit For
      End If
   Next
End Function
Private Function IsChildOfControl(ByVal lhWNd As Long, ByRef ctlOver As Control)
Dim ctl As Control
Dim lhWndC As Long
   For Each ctl In Me.Controls
      On Error Resume Next
      lhWndC = ctl.hwnd
      If Err.Number &lt;&gt; 0 Then lhWndC = 0
      If lhWndC &lt;&gt; 0 Then
         If IsChildWindow(lhWndC, lhWNd) Then
            Set ctlOver = ctl
            Exit For
         End If
      End If
   Next
End Function

Private Sub Form_Load()
   installhook Me, WH_MOUSE
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
   removehook Me, WH_MOUSE
End Sub

Private Function IWindowsHook_HookProc(ByVal eType As EHTHookTypeConstants,
 ByVal nCode As Long, ByVal wParam As Long, ByVal lParam As Long, bConsume As
 Boolean) As Long
Dim ctlOver As Control
Dim bS As Boolean
Dim lC As Long
Dim lhWNd As Long
Dim bSkip As Boolean
Static ctlIgnore As Control

   With MouselParam(lParam)
      Select Case wParam
      Case WM_MOUSEMOVE
   
         lblMousePos.Caption = .x &amp; "," &amp; .y
         
         FindControl .hwnd, .x, .y, ctlOver
         If Not ctlOver Is Nothing Then
            lblStatus.Caption = ctlOver.Name
         Else
            lblStatus.Caption = ""
         End If
      
      Case WM_NCMOUSEMOVE
         lblStatus.Caption = "Mouse in Non-Client area"
      
      Case WM_LBUTTONUP, WM_LBUTTONDOWN
         If .hwnd &lt;&gt; chkSelect.hwnd Then
            If chkSelect.Value = Checked Then
               Debug.Print wParam
               FindControl .hwnd, .x, .y, ctlOver
               If Not ctlOver Is Nothing Then
                  bConsume = True
                  ' Check for control having the same
                  ' parent as other selections:
                  If m_objParent Is Nothing Then
                     Set m_objParent = ctlOver.Container
                  Else
                     If Not ctlOver.Container Is m_objParent Then
                        ' Don't do anything.
                        bSkip = True
                     End If
                  End If
               
                  If Not bSkip Then
                     On Error Resume Next
                     lhWNd = ctlOver.hwnd
                     If Err.Number &lt;&gt; 0 Then
                        bS = (ctlOver.Tag &lt;&gt; "")
                        bS = Not (bS)
                        If bS Then
                           If wParam = WM_LBUTTONDOWN Then
                              m_iSelCount = m_iSelCount + 1
                              ctlOver.Tag = ctlOver.BackColor
                              ctlOver.BackColor = &amp;HFF00&amp;
                              Set ctlIgnore = ctlOver
                           End If
                        Else
                           If wParam = WM_LBUTTONUP Then
                              If Not ctlIgnore Is ctlOver Then
                                 m_iSelCount = m_iSelCount - 1
                                 ctlOver.BackColor = ctlOver.Tag
                                 ctlOver.Tag = ""
                              End If
                              Set ctlIgnore = Nothing
                           End If
                        End If
                     Else
                        bS = GetProp(ctlOver.hwnd, "Selected")
                        bS = Not (bS)
                        If bS Then
                           If wParam = WM_LBUTTONDOWN Then
                              m_iSelCount = m_iSelCount + 1
                              SetProp ctlOver.hwnd, "OrigBackColor",
                               ctlOver.BackColor
                              SetProp ctlOver.hwnd, "Selected", bS
                              ctlOver.BackColor = &amp;HFF00&amp;
                              Set ctlIgnore = ctlOver
                           End If
                        Else
                           If wParam = WM_LBUTTONUP Then
                              If Not ctlIgnore Is ctlOver Then
                                 m_iSelCount = m_iSelCount - 1
                                 lC = GetProp(ctlOver.hwnd, "OrigBackColor")
                                 ctlOver.BackColor = lC
                                 SetProp ctlOver.hwnd, "Selected", bS
                              End If
                              Set ctlIgnore = Nothing
                           End If
                        End If
                     End If
                     If m_iSelCount = 0 Then
                        Set m_objParent = Nothing
                     End If
                  End If
               End If
            End If
         End If
      End Select
      
   End With
End Function

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Hooks</a>&#160;.&#160;<a href="article.html">Win32 Hooks in VB - The vbAccelerator Hook Library</a>&#160;.&#160;<a href="vb6_windows_hook_library_full_source.html">VB6 Windows Hook Library Full Source</a>&#160;.&#160;Mouse_frmMouseHook.frm</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 July 2003</p></td><td></td></tr></table>
</body></html>