<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cDialogCentre.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cDialogCentre.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Hooks</a>&#160;.&#160;<a href="article.html">Using CBT Hooks to Centre API Dialogs</a>&#160;.&#160;<a href="vb5_dialog_centre_sample.html">VB5 Dialog Centre Sample</a>&#160;.&#160;cDialogCentre.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_dialog_centre_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Dialog Centre Sample</a> (30K)</p><p /><p class="nav"><a href="vb6_dialog_centre_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Dialog Centre Sample</a> (29K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12554</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=12554&type=zip&title=vb5_20dialog_20centre_20sample_2ezip_5fcdialogcentre.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />27 Jun 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\vbaccelerator_hook_library\article.html">Win32 Hooks in VB - The vbAccelerator Hook Library</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\resources\babbage\vb6_docking_forms\article.html">(Incomplete) Docking Forms In VB</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cDialogCentre.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cCommonDialogCentre"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit

Private Type RECT
   Left As Long
   Top As Long
   right As Long
   bottom As Long
End Type

Private Type MONITORINFO
   cbSize As Long
   rcMonitor As RECT
   rcWork As RECT
   dwFlags As Long
End Type

Private Declare Function SetProp Lib "user32" Alias "SetPropA" (ByVal hwnd As
 Long, ByVal lpString As String, ByVal hData As Long) As Long
Private Declare Function GetProp Lib "user32" Alias "GetPropA" (ByVal hwnd As
 Long, ByVal lpString As String) As Long
Private Declare Function RemoveProp Lib "user32" Alias "RemovePropA" (ByVal
 hwnd As Long, ByVal lpString As String) As Long
Private Const WM_DESTROY = &amp;H2
Private Declare Function CallWindowProc Lib "user32" Alias "CallWindowProcA"
 (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal
 wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA"
 (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib "user32" Alias "SetWindowLongA"
 (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function IsWindow Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Function GetWindowThreadProcessId Lib "user32" (ByVal hwnd As
 Long, lpdwProcessId As Long) As Long
Private Declare Function GetCurrentProcessId Lib "kernel32" () As Long
Private Const GWL_WNDPROC = (-4)
Private Declare Function GetClassName Lib "user32" Alias "GetClassNameA" (ByVal
 hwnd As Long, ByVal lpClassName As String, ByVal nMaxCount As Long) As Long
Private Declare Function GetDlgCtrlID Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Function GetParent Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Function MoveWindow Lib "user32" (ByVal hwnd As Long, ByVal x
 As Long, ByVal y As Long, ByVal nWidth As Long, ByVal nHeight As Long, ByVal
 bRepaint As Long) As Long
Private Declare Function MonitorFromWindow Lib "user32" (ByVal hwnd As Long,
 ByVal dwFlags As Long) As Long
Private Declare Function SystemParametersInfo Lib "user32" Alias
 "SystemParametersInfoA" (ByVal uAction As Long, ByVal uParam As Long, ByRef
 lpvParam As Any, ByVal fuWinIni As Long) As Long
Private Declare Function GetMonitorInfoA Lib "user32" ( _
      ByVal hMonitor As Long, _
      lpmi As MONITORINFO _
   ) As Long
Private Declare Function GetWindowRect Lib "user32" (ByVal hwnd As Long, lpRect
 As RECT) As Long

Private Const MONITOR_DEFAULTTONEAREST = 0

Private Const HCBT_CREATEWND = 3
Private Const HCBT_DESTROYWND = 4

Private Const WM_INITDIALOG = &amp;H110

Private Const SPI_GETWORKAREA = &amp;H30&amp;

Implements IWindowsHook
Implements ISubclass

Private m_bHook As Boolean
Private m_frmCentreTo As Object
Private m_lWidth As Long
Private m_lHeight As Long

Public Sub Start( _
      frmCentreTo As Object, _
      Optional ByVal lMinWidth As Long = -1, _
      Optional ByVal lMinHeight As Long = -1 _
   )
   Set m_frmCentreTo = frmCentreTo
   m_lWidth = lMinWidth
   m_lHeight = lMinHeight
   m_bHook = True
   InstallHook Me, WH_CBT
End Sub


Private Sub Class_Terminate()
   If (m_bHook) Then
      RemoveHook Me, WH_CBT
   End If
   m_bHook = False
End Sub

Private Property Let ISubclass_MsgResponse(ByVal RHS As SSubTimer.EMsgResponse)
   '
End Property

Private Property Get ISubclass_MsgResponse() As SSubTimer.EMsgResponse
   ISubclass_MsgResponse = emrPreprocess
End Property

Private Function ISubclass_WindowProc(ByVal hwnd As Long, ByVal iMsg As Long,
 ByVal wParam As Long, ByVal lParam As Long) As Long
Dim rectCentreTo As RECT
Dim rectDialog As RECT
Dim rectWork As RECT
Dim rectCentred As RECT
Dim hMon As Long
Dim lOffset As Long

   GetWindowRect hwnd, rectDialog
   If (rectDialog.right - rectDialog.Left) &lt; m_lWidth Then
      rectDialog.right = rectDialog.Left + m_lWidth
   End If
   If (rectDialog.bottom - rectDialog.Top) &lt; m_lHeight Then
      rectDialog.bottom = rectDialog.Top + m_lHeight
   End If
   
   GetWindowRect m_frmCentreTo.hwnd, rectCentreTo
   
   On Error Resume Next
   hMon = MonitorFromWindow(m_frmCentreTo.hwnd, MONITOR_DEFAULTTONEAREST)
   On Error GoTo 0
   If (hMon = 0) Then
      SystemParametersInfo SPI_GETWORKAREA, 0, rectWork, 0
   Else
      Dim tMI As MONITORINFO
      tMI.cbSize = Len(tMI)
      GetMonitorInfoA hMon, tMI
      LSet rectWork = tMI.rcWork
   End If

   ' Centre:
   rectCentred.Left = rectCentreTo.Left + ((rectCentreTo.right -
    rectCentreTo.Left) - (rectDialog.right - rectDialog.Left)) \ 2
   rectCentred.Top = rectCentreTo.Top + ((rectCentreTo.bottom -
    rectCentreTo.Top) - (rectDialog.bottom - rectDialog.Top)) \ 2
   rectCentred.right = rectCentred.Left + (rectDialog.right - rectDialog.Left)
   rectCentred.bottom = rectCentred.Top + (rectDialog.bottom - rectDialog.Top)
   If (rectCentred.Left &lt; rectWork.Left) Then
      lOffset = (rectWork.Left - rectCentred.Left)
      rectCentred.Left = rectCentred.Left + lOffset
      rectCentred.right = rectCentred.right + lOffset
   End If
   If (rectCentred.right &gt; rectWork.right) Then
      lOffset = (rectCentred.right - rectWork.right)
      rectCentred.Left = rectCentred.Left - lOffset
      rectCentred.right = rectCentred.right - lOffset
   End If
   If (rectCentred.Top &lt; rectWork.Top) Then
      lOffset = (rectWork.Top - rectCentred.Top)
      rectCentred.Top = rectCentred.Top + lOffset
      rectCentred.bottom = rectCentred.bottom + lOffset
   End If
   If (rectCentred.bottom &gt; rectWork.bottom) Then
      lOffset = (rectCentred.bottom - rectWork.bottom)
      rectCentred.Top = rectCentred.Top - lOffset
      rectCentred.bottom = rectCentred.bottom - lOffset
   End If
   
   ' Move:
   MoveWindow hwnd, rectCentred.Left, rectCentred.Top, _
      rectCentred.right - rectCentred.Left, _
      rectCentred.bottom - rectCentred.Top, _
      1

   ' Finished subclassing &amp; Hooking:
   DetachMessage Me, hwnd, WM_INITDIALOG
   RemoveHook Me, WH_CBT
   
   m_bHook = False
End Function

Private Function IWindowsHook_HookProc(ByVal eType As
 vbalWinHook.EHTHookTypeConstants, ByVal nCode As Long, ByVal wParam As Long,
 ByVal lParam As Long, bConsume As Boolean) As Long
   If eType = WH_CBT Then
      If nCode = HCBT_CREATEWND Then
         InstallWinProc wParam
      End If
   End If
End Function


Private Function InstallWinProc(ByVal hwnd As Long)
Dim lProcOld As Long
Dim sClass As String
Dim iPos As Long

   If IsValidLocalWindow(hwnd) Then
      If (InStr(ClassName(hwnd), "#32770")) Then
         AttachMessage Me, hwnd, WM_INITDIALOG
      End If
   End If
End Function

Private Function IsValidLocalWindow(ByVal hwnd As Long) As Boolean
   If IsWindow(hwnd) Then
      Dim idWnd As Long
      Call GetWindowThreadProcessId(hwnd, idWnd)
      IsValidLocalWindow = (idWnd = GetCurrentProcessId())
   End If
End Function
Private Property Get ClassName(ByVal hwnd As Long) As String
Dim sBuf As String
Dim iPos As Long
   sBuf = String$(255, 0)
   GetClassName hwnd, sBuf, 255
   iPos = InStr(sBuf, Chr$(0))
   If iPos &gt; 1 Then
      ClassName = Left$(sBuf, iPos - 1)
   End If
End Property

</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\..\..\index.html" ><IMG SRC="..\..\..\..\..\res\vbaccelad.png" ALT="vbAccelerator - Faster VB Code" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Hooks</a>&#160;.&#160;<a href="article.html">Using CBT Hooks to Centre API Dialogs</a>&#160;.&#160;<a href="vb5_dialog_centre_sample.html">VB5 Dialog Centre Sample</a>&#160;.&#160;cDialogCentre.cls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 July 2003</p></td><td></td></tr></table>
</body></html>