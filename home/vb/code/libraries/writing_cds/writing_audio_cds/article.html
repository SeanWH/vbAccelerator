<html lang="en" >
<head>
<title>vbAccelerator - Writing Audio CDs</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="'Perhaps they were expecting someone to write an audio recorder in Visual Basic?'
Paul DiLascia writes, somewhat sarcastically, in the April 2004 issue of 
MSDN Magazine on the subject of the
Image Mastering API.  Whether they were expecting it or not, here it is: a VB application 
which creates audio CDs.
" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /><link rel="copyright" href="/home/The_Site/Copyright/article.asp" />
<link rel="contents" href="../index.asp" /><link rel="meta" type="application/rdf+xml" href="./article.rdf" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Writing Audio CDs</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb5_audio_burner.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Audio Burner</a> (81K)</p><p /><p class="nav"><a href="vb6_audio_burner.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Audio Burner</a> (78K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:14970</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=14970&type=article&title=writing_20audio_20cds.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />12 Jun 2004<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\imapi\article.html">Image Mastering API (IMAPI) Library for VB</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\type_libraries\imapi_(cd_burning)\article[1].html">VB IMAPI (CD Burning) Interfaces (IVBIMAPI.tlb)</a></p><p class="nav"><img src="..\..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vbmedia\audio\using_winamp_plugins\article.html">Using WinAmp In Plugins From VB</a></p><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Writing Audio CDs</h1><p class="splash">Burn Audio CDs using IMAPI on XP and above</p><img src="audiocdburner.png" width="368" height="293" alt="Audio CD Writer Sample Application" /><p /><p>"Perhaps they were expecting someone to write an audio recorder in Visual Basic?"
Paul DiLascia writes, somewhat sarcastically, in the April 2004 issue of 
<a href="javascript:window.alert(&quot;http://msdn.microsoft.com/msdnmag/code04.aspx\nThis link was not retrieved.&quot;)">MSDN Magazine</a> on the subject of the
Image Mastering API.  Whether they were expecting it or not, here it is: a VB application 
which creates audio CDs.
</p><h2>Writing Audio CDs</h2><p>
In the article on <a href="..\imapi\article.html">IMAPI</a> I demonstrated a 
wrapper and a simple properties sample showing how to use the CD Image Mastering API
provided on XP and above.  As noted, the API provides two mastering interfaces for
building a CD image; <span class="code">IRedbookDiscMaster</span> for creating audio
CDs and <span class="code">IJolietDiscMaster</span> for creating data CDs.  This articleshows how to use the audio CD interface.
</p><p>
Assuming you have completed the initial task of picking which songs you want to include on the CD, 
there are four main steps in creating an audio CD using IMAPI:
</p><ol><li>Select a Disc Recorder which supports recording audio CDs; make it the
active recorder on the system and set the mastering format to Redbook.</li><li>Determine whether there is an appropriate disc available on the active recorder.</li><li>Build up the CD image by adding tracks and streaming the audio data into
the stash.</li><li>Call the <span class="code">RecordDisc</span> method and wait until the 
<span class="code">BurnComplete</span> event fires.</li></ol><p>
I'll cover doing these in turn.
</p><h3>1. Selecting a Disc Recorder</h3><p>
In order to select a recorder, you must first have a 
<span class="code">cDiscMaster</span> instance.  Once you have that,
then get a <span class="code">RedbookDiscMaster</span> instance, which
sets the disc mastering format to audio.  You can then select the
recorder to use using the <span class="code">Recorders</span> collection:
</p><pre>
Private m_cDiscMaster As cDiscMaster
Private m_cRedbook As cRedbookDiscMaster


   Dim cRecorder As cDiscRecorder

   ' Get an instance of the DiscMaster object:
   Set m_cDiscMaster = New cDiscMaster
   m_cDiscMaster.Initialise

   ' Set the active mastering format to Redbook
   ' and obtain a Redbook Mastering instance:
   Set m_cRedbook = m_cDiscMaster.RedbookDiscMaster

   ' Set the active recorder (nIndex is the 1-based index
   ' of the recorder you want):
   m_cDiscMaster.Recorders(nIndex).SetAsActive
   Set cRecorder = m_cDiscMaster.Recorders.ActiveRecorder

   ' .. other steps to complete the CD


   ' Clear up
   Set cRecoder = Nothing
   Set m_cRedbook = nothing
   m_cDiscMaster.ClearUp

</pre><p>
Note that any image you stage using <span class="code">cRedbookDiscMaster</span> will
be freed if you request the <span class="code">RedbookDiscMaster</span> object
again, or if you change the disc mastering format through the 
<span class="code">JolietDiscMaster</span> method.  You should therefore keep
a reference to the object until the burn has completed.  The image is also
freed whenever the <span class="code">cDiscMaster</span> object is released.
</p><h3>2. Checking the Recorder Media</h3><p>
To determine what media is available in the recorder, use the
<span class="code">MediaInfo</span> method of the <span class="code">cDiscRecorder</span> object.  Note that to get information about the media you must first
open the recorder for exclusive access; make sure you close it again otherwise
you will get an error when you try to burn the disc:
</p><pre>
   ' Exclusively open the recorder:
   cRecorder.OpenExclusive

   ' Get the media info:
   Set cInfo = cRecorder.MediaInfo
   
   ' We can close the recorder now:
   cRecorder.CloseExclusive

   ' Check we have media and that it is writable:
   If (cInfo.MediaPresent) And _
      ((cInfo.mediaflags And MEDIA_WRITABLE) = MEDIA_WRITABLE) Then
  
      ' ... Staging and burning

   End If
</pre><h3>3. Building up the CD Image</h3><p>
In order to build up the CD image, you need to have a way of getting 
chunks of wave data which can be accessed through a memory pointer.  
In this sample, I've used the <span class="code">cWaveReader</span>
class which was introduced in the <a href="..\..\..\vbmedia\audio\wav_file_viewer\article.html">Wav File
Viewer Control</a>.  However, any other source of data can be used, provided
the data is arranged as a 16-bit stereo 44.1kHz wave file.
</p><p>
The image is staged by adding tracks using the <span class="code">CreateTrack</span>
method.  This takes the number of blocks for the track as a parameter,
although the documentation suggests this is optional.  Once the track is open,
data is added using the <span class="code">AddAudioTrackBlocks</span> method.
Data must be added in chunks of the audio block size, so if the audio is not
an even multiple of 2352 bytes (1/75 second) then padding zeros are needed.
Finally, once all the data has been added for a track then class 
<span class="code">CloseTrack</span>. Here's the code for creating one
track:
</p><pre>
Private Sub addTrack(ByVal sFile As String)
Dim lBlockSize As Long
Dim cWav As cWavReader
Dim lTrackSize As Long
Dim lTrackBlocks As Long
Dim bMore As Boolean

   ' Get block size:
   lBlockSize = m_cRedbook.AudioBlockSize   

   ' Create a WAVE reader and set the buffer size
   ' to the block size:
   Set cWav = New cWavReader
   cWav.ReadBufferSize = lBlockSize \ 4
   cWav.OpenFile sFile
      
   ' Evaluate the number of blocks in the track:
   lTrackSize = cWav.AudioLength * 4
   lTrackBlocks = lTrackSize \ lBlockSize
   If (lTrackSize Mod lBlockSize) &gt; 0 Then
      lTrackBlocks = lTrackBlocks + 1
   End If
      
   ' Create the audio track:
   m_cRedbook.CreateAudioTrack lTrackBlocks
   
   ' Add audio data until there is none left:
   Do
      bMore = cWav.Read
      If (bMore) Then
         lReadSize = cWav.ReadSize * 4
         cWav.ZeroUnusedBufferBytes
         m_cRedbook.AddAudioTrackBlocks cWav.ReadBufferPtr, lBlockSize
         DoEvents
      End If
      
   Loop While (bMore) 

   ' Close the track
   m_cRedbook.CloseAudioTrack

   ' Close the wave file:
   cWav.CloseFile

End Sub
</pre><p>
Whilst adding tracks, you need to determine whether there is enough space on
the CD to fit the selected tracks.  There are two ways of doing this: you
can either precalculate whether the tracks will fit 
compared to the number of <span class="code">FreeBlocks</span> on the
disc (as I have done in this example), or you can stage the image and respond to <span class="code">AddProgress</span> events from the <span class="code">cDiscMaster</span>
object, which will notify you of the number of blocks used and blocks available.
</p><p>
Note that a CD must have at least one track and no more than 99 tracks 
per audio CD; this is part of the Redbook specification.  As far as I can
tell you cannot set up trick tracks with negative offsets from the 
start of the CD using this API.
</p><h3>4. Buring the CD</h3><p>
To burn the CD, call the <span class="code">RecordDisc</span> method.  This 
takes two boolean parameters; the first is whether to simulate the record
or actually record and the second is whether to eject once recording is
complete.
</p><pre>
      m_cDiscMaster.RecordDisc False, True
</pre><p>
The method does not return until the burn has complete and once recording 
is underway, these events will be fired:
</p><ul><li><span class="code">PreparingBurn</span><br />
Raised before burning starts. Provides an estimated number of seconds the
prepare phase will take before burning commences.</li><li><span class="code">BlockProgress</span><br />
Raised during burning.  Provides the current block being burnt and the
total number of blocks to burn.</li><li><span class="code">TrackProgress</span><br />
Raised during burning as each track is written.  The track number provided
is a zero-based index of the track about to be written; when this
reaches the number of tracks then all tracks have been done.</li><li><span class="code">ClosingDisc</span><br />
Raised when all the data has been burnt and the disc is being closed. Provides 
an estimated number of seconds the closing phase will take.</li><li><span class="code">BurnComplete</span><br />
Raised when the brun is complete.</li><li><span class="code">QueryCancel</span><br />
Raised regularly during burn.  The <span class="code">bCancel</span> 
parameter can be set to abort the burn.</li></ul><h2>Issues</h2><p>
There are two issues with this implementation currently; any suggestions for fixing either would be a great help:
</p><ol><li><strong>Track Spacing</strong><br /><p>The spacing between tracks recorded by the sample is hardcoded at 150 blocks (a
CD block is 1/75 second so this is 2 seconds).  This is the default for audio CDs,
but for things like mix CDs you really want to be able to configure the spacing.  My
recorder exposes a property called "AudioGapSize"
but whenever I attempt to set it the new value is ignored.  I'm not sure whether
this is because the property is read-only, or whether setting properties doesn't
work.</p></li><li><strong>Cannot click Cancel whilst Burning</strong><p>The <span class="code">Burn</span> method is synchronous, which means it does not
return until the CD Burn is complete.  Unfortunately, when you make a COM call, VB replaces 
the application message loop with one that means any keystroke results in the horrific 
"Component Request Pending" dialog:</p><img src="hellish.png" width="327" height="164" alt="My second-least favourite dialog in VB: Component Pending" /><p class="caption">My second-least favourite dialog in VB: Component Pending</p><p>
As usual with this dialog, there is no "other application" and "Switch To" and "Retry"
never do anything.  Its also stupid because clearly the application is getting the events
you want it to; its just intercepting them before they get where they need to go!  
If there was a way to get at the application message
loop then I think you could fix this, but I don't know how to do that in VB.  Alternatively, the
<span class="code">Burn</span> method could be called on a background thread; but threading of this
sort is rather tricky in VB.  Perhaps something from Matt Curland's Advanced VB6 book would do the trick?
</p></li></ol><h2>Suggestions</h2><p>
The sample recorder provided here is intentionally minimal, just being there to demonstrate
that you can create an audio CD with this technique.  There's quite a few things you could
do to improve it:
</p><ol><li>
A real recorder application would almost certainly have a better UI with
a step-based ("inductive") approach to creating a CD, starting with 
chosing what type of CD you want to create,
then picking the files, and then showing a nice progress display whilst the burn was in progress.
Then there would be some nice alpha fades and some cute graphics...
</li><li>
The current sample only allows you to pick stereo WAV files; however, with the code provided in
<a href="..\..\..\vbmedia\audio\using_winamp_plugins\article.html">Using WinAmp plugins</a> you can easily extend it to work
with MP3, MP4, APE and other file formats too.
</li><li>
Building up the staging image is a bit slow.  Currently, I am adding the audio data in single
blocks; however, you can add multiple blocks at the same time which would almost certainly
speed things up quite a bit.
</li><li>
I haven't really looked at CD-RW support in this sample.
</li></ol><h2>Conclusion</h2><p>
This sample demonstrates how to create audio CDs using the IMAPI library.  There are a couple
of issues with the current sample but hopefully they will be resolved soon.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.html">Writing CDs</a>&#160;.&#160;Writing Audio CDs</p><br /><table style="font-size: 100%;"><tr><td valign="top"><a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\res\cc.png" width="88" height="31" alt="Creative Commons Licence" /></a></td></a></td><td valign="top"><p class="nav" style="padding-bottom: 4px;">All contents of this web site are licensed under a <a href="javascript:window.alert(&quot;http://creativecommons.org/licenses/by/1.0/\nThis link was not retrieved.&quot;)">Creative Commons Licence</a>, except where otherwise noted.</p><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>, vbAccelerator Ltd.<br />Last Updated: 13 June 2004</p></td></tr></table></td><td></td></tr></table>
</body></html>