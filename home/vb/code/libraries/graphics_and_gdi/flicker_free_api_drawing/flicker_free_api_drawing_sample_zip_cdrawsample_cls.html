<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cDrawSample.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cDrawSample.cls" /><link rel="stylesheet" href="..\..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.asp\index.html">Graphics and GDI</a>&#160;.&#160;<a href="article.html">Flicker Free API Drawing</a>&#160;.&#160;<a href="flicker_free_api_drawing_sample.html">Flicker Free API Drawing Sample</a>&#160;.&#160;cDrawSample.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="flicker_free_api_drawing_sample.html"><img src="..\..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Flicker Free API Drawing Sample</a> (6K)</p><br /><br /><img src="..\..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:2968</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\..\linkto_asp\id=2968&type=zip&title=flicker_20free_20api_20drawing_20sample_2ezip_5fcdrawsample.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\..\res\update.png" width="8" height="8" alt="Update" />8 Jan 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><br /><br /><img src="..\..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cDrawSample.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cDrawSample"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit

Private Type POINTAPI
   x As Long
   y As Long
End Type
Private Type RECT
   Left As Long
   Top As Long
   Right As Long
   Bottom As Long
End Type
Private Declare Function FillRect Lib "user32" (ByVal hdc As Long, lpRect As
 RECT, ByVal hBrush As Long) As Long
Private Declare Function OffsetRect Lib "user32" (lpRect As RECT, ByVal xOffset
 As Long, ByVal yOffset As Long) As Long
Private Declare Function GetSysColorBrush Lib "user32" (ByVal nIndex As Long)
 As Long
Private Declare Function CreateSolidBrush Lib "gdi32" (ByVal crColor As Long)
 As Long
Private Declare Function LineTo Lib "gdi32" (ByVal hdc As Long, ByVal x As
 Long, ByVal y As Long) As Long
Private Declare Function MoveToEx Lib "gdi32" (ByVal hdc As Long, ByVal x As
 Long, ByVal y As Long, lpPoint As POINTAPI) As Long
Private Declare Function CreatePen Lib "gdi32" (ByVal nPenStyle As Long, ByVal
 nWidth As Long, ByVal crColor As Long) As Long
Private Const PS_SOLID = 0
Private Declare Function DrawText Lib "user32" Alias "DrawTextA" (ByVal hdc As
 Long, ByVal lpStr As String, ByVal nCount As Long, lpRect As RECT, ByVal
 wFormat As Long) As Long
Private Declare Function SelectObject Lib "gdi32" (ByVal hdc As Long, ByVal
 hObject As Long) As Long
Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As
 Long
Private Enum EDrawTextFormat
   DT_BOTTOM = &amp;H8
   DT_CALCRECT = &amp;H400
   DT_CENTER = &amp;H1
   DT_EXPANDTABS = &amp;H40
   DT_EXTERNALLEADING = &amp;H200
   DT_INTERNAL = &amp;H1000
   DT_LEFT = &amp;H0
   DT_NOCLIP = &amp;H100
   DT_NOPREFIX = &amp;H800
   DT_RIGHT = &amp;H2
   DT_SINGLELINE = &amp;H20
   DT_TABSTOP = &amp;H80
   DT_TOP = &amp;H0
   DT_VCENTER = &amp;H4
   DT_WORDBREAK = &amp;H10
   DT_EDITCONTROL = &amp;H2000&amp;
   DT_PATH_ELLIPSIS = &amp;H4000&amp;
   DT_END_ELLIPSIS = &amp;H8000&amp;
   DT_MODIFYSTRING = &amp;H10000
   DT_RTLREADING = &amp;H20000
   DT_WORD_ELLIPSIS = &amp;H40000
End Enum
Private Declare Function SetBkMode Lib "gdi32" (ByVal hdc As Long, ByVal
 nBkMode As Long) As Long
Private Const OPAQUE = 2
Private Const TRANSPARENT = 1
Private Declare Function SetTextColor Lib "gdi32" (ByVal hdc As Long, ByVal
 crColor As Long) As Long
Private Declare Function GetSysColor Lib "user32" (ByVal nIndex As Long) As Long

Private Type DrawObjectData
   iDirX As Integer
   iDirY As Integer
   foreColor As Long
   backColor As Long
   sCaption As String
   tP As POINTAPI
   lSize As Long
End Type
Private m_tDrawObject() As DrawObjectData
Private m_iDrawObjectCount As Long
Private m_font As IFont

Private m_bUseMemDc As Boolean
Private m_cMemDc As pcMemDC
Private m_tR As RECT


Public Property Get UseMemDc() As Boolean
   UseMemDc = m_bUseMemDc
End Property
Public Property Let UseMemDc(ByVal value As Boolean)
   m_bUseMemDc = value
End Property
Public Property Get Left() As Long
   Left = m_tR.Left
End Property
Public Property Let Left(ByVal value As Long)
   m_tR.Left = value
End Property
Public Property Get Top() As Long
   Top = m_tR.Top
End Property
Public Property Let Top(ByVal value As Long)
   m_tR.Top = value
End Property
Public Property Get Width() As Long
   Width = m_cMemDc.Width
End Property
Public Property Let Width(ByVal value As Long)
   m_cMemDc.Width = value
End Property
Public Property Get Height() As Long
   Height = m_cMemDc.Height
End Property
Public Property Let Height(ByVal value As Long)
   m_cMemDc.Height = value
End Property
Public Property Get Font() As IFont
   Set Font = m_font
End Property
Public Property Let Font(value As IFont)
   pSetFont value
End Property
Public Property Set Font(value As IFont)
   pSetFont value
End Property
Private Sub pSetFont(theFont As IFont)
   theFont.Clone m_font
End Sub


Public Sub Draw(ByVal lOutputDc As Long)
Dim tDrawR As RECT
Dim lhDC As Long

   ' set up the drawing rectangle:
   m_tR.Right = m_tR.Left + m_cMemDc.Width
   m_tR.Bottom = m_tR.Top + m_cMemDc.Height
   
   ' Get where we're drawing to:
   Dim lOffsetX As Long
   Dim lOffsetY As Long
   LSet tDrawR = m_tR
   If (m_bUseMemDc) Then
      lhDC = m_cMemDc.hdc
      OffsetRect tDrawR, -m_tR.Left, -m_tR.Top
   Else
      lhDC = lOutputDc
      lOffsetX = m_tR.Left
      lOffsetY = m_tR.Top
   End If
   
   ' draw the background:
   drawBackground lhDC, tDrawR
   
   Dim hFont As Long
   Dim hFontOld As Long
   hFont = SelectObject(lhDC, m_font.hFont)
   SetBkMode lhDC, TRANSPARENT
   ' draw the objects
   Dim i As Long
   For i = 1 To m_iDrawObjectCount
      drawObject lhDC, i, lOffsetX, lOffsetY
   Next i
   SelectObject lhDC, hFontOld
      
   ' if using a memory DC, we need to copy the result:
   If (m_bUseMemDc) Then
      m_cMemDc.Draw lOutputDc, , , , , m_tR.Left, m_tR.Top
   End If

End Sub
Private Sub drawBackground(ByVal lhDC As Long, tDrawR As RECT)
Dim hBr As Long
   hBr = GetSysColorBrush(vbWindowBackground And &amp;H1F&amp;)
   FillRect lhDC, tDrawR, hBr
   DeleteObject hBr
Dim hPen As Long
Dim hPenOld As Long
Dim tJunk As POINTAPI
   hPen = CreatePen(PS_SOLID, 1, GetSysColor(vbHighlight And &amp;H1F&amp;))
   hPenOld = SelectObject(lhDC, hPen)
   MoveToEx lhDC, tDrawR.Left, tDrawR.Top, tJunk
   LineTo lhDC, tDrawR.Right - 1, tDrawR.Top
   LineTo lhDC, tDrawR.Right - 1, tDrawR.Bottom - 1
   LineTo lhDC, tDrawR.Left, tDrawR.Bottom - 1
   LineTo lhDC, tDrawR.Left, tDrawR.Top
   SelectObject lhDC, hPenOld
   DeleteObject hPen
   
End Sub
Public Sub CreateObjects(ByVal iCount As Long)
   m_iDrawObjectCount = iCount
   ReDim Preserve m_tDrawObject(1 To m_iDrawObjectCount) As DrawObjectData
   Dim i As Long
   Dim lSize As Long
   Dim h As Single, s As Single, l As Single
   Dim r As Long, b As Long, g As Long
   Dim rf As Long, bf As Long, gf As Long
   RGBToHLS &amp;H33, &amp;H99, &amp;HEE, h, s, l
   For i = 1 To m_iDrawObjectCount
      With m_tDrawObject(i)
         HLSToRGB h, s, l, r, g, b
         l = l * 0.95
         .backColor = RGB(r, g, b)
         HLSToRGB h, s, l * 4, rf, gf, bf
         .foreColor = RGB(rf, gf, bf)
         Do While (.iDirX = 0)
            .iDirX = Rnd * 8 - 4
         Loop
         Do While (.iDirY = 0)
            .iDirY = Rnd * 8 - 4
         Loop
         .sCaption = Hex(.backColor)
         .lSize = 32 + Rnd * 32
         .tP.x = Rnd * (m_cMemDc.Width - .lSize)
         .tP.y = Rnd * (m_cMemDc.Height - .lSize)
      End With
   Next i
End Sub

Private Sub drawObject(ByVal lhDC As Long, ByVal iIndex As Long, ByVal lOffsetX
 As Long, ByVal lOffsetY As Long)
   With m_tDrawObject(iIndex)
      ' update the position
      If (.tP.x + .lSize + .iDirX &gt;= m_cMemDc.Width) Then
         .iDirX = -.iDirX
      End If
      If (.tP.x + .iDirX &lt;= 0) Then
         .iDirX = -.iDirX
      End If
      If (.tP.y + .lSize + .iDirY &gt;= m_cMemDc.Height) Then
         .iDirY = -.iDirY
      End If
      If (.tP.y + .iDirY &lt;= 0) Then
         .iDirY = -.iDirY
      End If
      .tP.x = .tP.x + .iDirX
      .tP.y = .tP.y + .iDirY
      
      Dim hBr As Long
      Dim tR As RECT
      tR.Left = .tP.x
      tR.Top = .tP.y
      tR.Right = tR.Left + .lSize
      tR.Bottom = tR.Top + .lSize
      
      OffsetRect tR, lOffsetX, lOffsetY
      
      hBr = CreateSolidBrush(.backColor)
      FillRect lhDC, tR, hBr
      DeleteObject hBr
      
      SetTextColor lhDC, .foreColor
      DrawText lhDC, .sCaption, -1, tR, DT_CENTER Or DT_VCENTER Or DT_SINGLELINE
   End With
   
   
End Sub

Private Sub RGBToHLS( _
     ByVal r As Long, ByVal g As Long, ByVal b As Long, _
     h As Single, s As Single, l As Single _
     )
 Dim Max As Single
 Dim Min As Single
 Dim delta As Single
 Dim rR As Single, rG As Single, rB As Single

     rR = r / 255: rG = g / 255: rB = b / 255

 '{Given: rgb each in [0,1].
 ' Desired: h in [0,360] and s in [0,1], except if s=0, then h=UNDEFINED.}
         Max = Maximum(rR, rG, rB)
         Min = Minimum(rR, rG, rB)
             l = (Max + Min) / 2 '{This is the lightness}
         '{Next calculate saturation}
         If Max = Min Then
             'begin {Acrhomatic case}
             s = 0
             h = 0
             'end {Acrhomatic case}
         Else
             'begin {Chromatic case}
                 '{First calculate the saturation.}
             If l &lt;= 0.5 Then
                 s = (Max - Min) / (Max + Min)
             Else
                 s = (Max - Min) / (2 - Max - Min)
             End If
             '{Next calculate the hue.}
             delta = Max - Min
             If rR = Max Then
                     h = (rG - rB) / delta '{Resulting color is between yellow
                      and magenta}
             ElseIf rG = Max Then
                 h = 2 + (rB - rR) / delta '{Resulting color is between cyan
                  and yellow}
             ElseIf rB = Max Then
                 h = 4 + (rR - rG) / delta '{Resulting color is between magenta
                  and cyan}
             End If
         'end {Chromatic Case}
     End If
 End Sub

Private Sub HLSToRGB( _
     ByVal h As Single, ByVal s As Single, ByVal l As Single, _
     r As Long, g As Long, b As Long _
     )
Dim rR As Single, rG As Single, rB As Single
Dim Min As Single, Max As Single

     If s = 0 Then
     ' Achromatic case:
     rR = l: rG = l: rB = l
     Else
     ' Chromatic case:
     ' delta = Max-Min
     If l &lt;= 0.5 Then
         's = (Max - Min) / (Max + Min)
         ' Get Min value:
         Min = l * (1 - s)
     Else
         's = (Max - Min) / (2 - Max - Min)
         ' Get Min value:
         Min = l - s * (1 - l)
     End If
     ' Get the Max value:
     Max = 2 * l - Min
     
     ' Now depending on sector we can evaluate the h,l,s:
     If (h &lt; 1) Then
         rR = Max
         If (h &lt; 0) Then
             rG = Min
             rB = rG - h * (Max - Min)
         Else
             rB = Min
             rG = h * (Max - Min) + rB
         End If
     ElseIf (h &lt; 3) Then
         rG = Max
         If (h &lt; 2) Then
             rB = Min
             rR = rB - (h - 2) * (Max - Min)
         Else
             rR = Min
             rB = (h - 2) * (Max - Min) + rR
         End If
     Else
         rB = Max
         If (h &lt; 4) Then
             rR = Min
             rG = rR - (h - 4) * (Max - Min)
         Else
             rG = Min
             rR = (h - 4) * (Max - Min) + rG
         End If
         
     End If
             
     End If
     r = rR * 255: g = rG * 255: b = rB * 255
 End Sub
 Private Function Maximum(rR As Single, rG As Single, rB As Single) As Single
   If (rR &gt; rG) Then
      If (rR &gt; rB) Then
         Maximum = rR
      Else
         Maximum = rB
      End If
   Else
      If (rB &gt; rG) Then
         Maximum = rB
      Else
         Maximum = rG
      End If
   End If
End Function
Private Function Minimum(rR As Single, rG As Single, rB As Single) As Single
   If (rR &lt; rG) Then
      If (rR &lt; rB) Then
         Minimum = rR
      Else
         Minimum = rB
      End If
   Else
      If (rB &lt; rG) Then
         Minimum = rB
      Else
         Minimum = rG
      End If
   End If
End Function


Private Sub Class_Initialize()
   Set m_cMemDc = New pcMemDC
   Dim s As New StdFont
   s.Name = "Arial"
   s.Size = 8
   Set m_font = s
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\compression\index.html" ><IMG SRC="..\..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\..\index.html">Code</a>&#160;.&#160;<a href="..\..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="..\index.asp\index.html">Graphics and GDI</a>&#160;.&#160;<a href="article.html">Flicker Free API Drawing</a>&#160;.&#160;<a href="flicker_free_api_drawing_sample.html">Flicker Free API Drawing Sample</a>&#160;.&#160;cDrawSample.cls</p><br /><p class="nav"><a href="..\..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>