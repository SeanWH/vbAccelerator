<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: WinSubHook_Thunks_cWindow.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: WinSubHook_Thunks_cWindow.cls" /><link rel="stylesheet" href="..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="article.html">Subclassing and Hooking with Machine Code Thunks</a>&#160;.&#160;<a href="vb6_winsubhook.html">VB6 WinSubHook</a>&#160;.&#160;WinSubHook_Thunks_cWindow.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb6_winsubhook.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 WinSubHook</a> (92K)</p><br /><br /><img src="..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:4242</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\linkto_asp\id=4242&type=zip&title=vb6_20winsubhook_2ezip_5fwinsubhook_5fthunks_5fcwindow.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:paul_caton@hotmail.com">Paul Caton</a></p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\res\update.png" width="8" height="8" alt="Update" />20 Feb 2003<br />First Posted</p><br /><br /><img src="..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\graphics_and_gdi\drop_shadows\article.html">Creating Drop-Shadows</a></p><br /><br /><img src="..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: WinSubHook_Thunks_cWindow.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "cWindow"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
'-------------------------------------------------------------------------------
-------------------
'cWindow - module-less, IDE safe machine code WndProc for API windows
'
'v1.00 20030107 First
 cut..........................................................................
'

Option Explicit

Private Const OFFSET_P1 As Long = 9                       'Callback gate address
Private Const OFFSET_P2 As Long = 22                      'Owner object address
 for iWindow_WndProc
Private Const OFFSET_P3 As Long = 34                      'Before table entry
 count
Private Const OFFSET_P4 As Long = 49                      'Before table address
Private Const OFFSET_P5 As Long = 63                      'IDE check
Private Const OFFSET_P6 As Long = 137                     'DefWindowProc address
Private Const OFFSET_P7 As Long = 157                     'DestroyWindow address
Private Const ARRAY_LB  As Long = 1                       'Lowest bound of
 arrays

Private Type tCode
  Buf(ARRAY_LB To 168)  As Byte                           'Code buffer
End Type

Private Type tCodeBuf
  Code                  As tCode                          'Subclass WndProc code
End Type

Private CodeBuf         As tCodeBuf                       'WndProc code instance
Private nBreakGate      As Long                           'Callback breakpoint
 gate
Private nMsgCnt         As Long                           'Msg table entry count
Private aMsgTbl()       As WinSubHook.eMsg                'Msg table array
Private nWndProc        As Long                           'The address of the
 WndProc
Private col_hWnds       As Collection                     'Collection of window
 handles
Private m_sClass        As String                         'Class name
Private m_Owner         As iWindow                        'Private member
 property variable

'-----------------------------
'Class creation/destruction

'Called automatically when the class instance is created.
Private Sub Class_Initialize()
Const OPS As String =
 "558BEC83C4F85756BE_patch1_33C08945FC8945F8BA_patch2_8B0283F8007478B90000000083
F900745183F9FF740CBF000000008B450CF2AF754033C03D_patch5_740B833E007532C706010000
008D4514508D4510508D450C508D4508508D45FC508D45F8508B0252FF501CC706000000008B45F8
83F8007514FF7514FF7510FF750CFF7508E8_patch6_8945FC5E5F8B45FCC9C21000FF7508E8_pat
ch7_33C08945FCEBE8"
Dim i     As Long, _
    j     As Long

'Convert the string of opcodes from hex pairs to bytes and store in the code
 buffer
  With CodeBuf.Code
    j = 1                                                 'Set the character
     index to the start of the opcode string
    For i = ARRAY_LB To UBound(.Buf)                      'For each byte of the
     code buufer
      .Buf(i) = Val("&amp;H" &amp; Mid$(OPS, j, 2))               'Pull a pair of hex
       characters and convert to a byte
      j = j + 2                                           'Bump to the next
       pair of characters
    Next i                                                'Next byte of the
     code buffer
    
    nWndProc = VarPtr(.Buf(ARRAY_LB))                     'Address of the
     cWindow WndProc entry point
  End With
      
'Patch the WndProc code with runtime values
  Call PatchVal(OFFSET_P1, VarPtr(nBreakGate))            'Breakpoint gate
   address
  Call PatchVal(OFFSET_P5, InIDE)                         'Whether we need
   check the breakpoint gate and the vtable
  Call PatchRel(OFFSET_P6, AddrFunc("DefWindowProcA"))    'Address of the
   DefWindowProc api function
  Call PatchRel(OFFSET_P7, AddrFunc("DestroyWindow"))     'Address of the
   DestroyWindow api function
  
  Set col_hWnds = New Collection                          'Create instance of
   window handle collection
End Sub

'Called automatically when the class instance is destroyed.
Private Sub Class_Terminate()
  Dim i As Long
  
  Call PatchVal(OFFSET_P3, 0)                             'Patch the code to
   ensure no further iWindow_WndProc callbacks
  
  For i = col_hWnds.Count To 1 Step -1                    'For each window
   created (and not yet destroyed)
    Call WinSubHook.DestroyWindow(col_hWnds.Item(i))      'Destroy the window
    Call col_hWnds.Remove(i)                              'Remove from the
     collection
  Next i                                                  'Next window
  Set col_hWnds = Nothing                                 'Destroy the
   collection
  
  If Len(m_sClass) &gt; 0 Then                               'If a class was
   registered
    Call UnregisterClass(m_sClass, App.hInstance)         'Unregister the
     window class
  End If
End Sub

'-----------------------------
'Public interface

'Call this method to add a message to the msg callback table. NB This method
 can be called at any time
Public Sub AddMsg(uMsg As WinSubHook.eMsg)
  Dim nEntry As Long
  
  If uMsg = ALL_MESSAGES Then                             'If ALL_MESSAGES
    nMsgCnt = -1                                          'Indicates that all
     messages are to callback
  Else                                                    'Else a specific
   message number
    For nEntry = ARRAY_LB To nMsgCnt                      'For each existing
     entry. NB will skip if 0 or -1 (ALL_MESSAGES)
      Select Case aMsgTbl(nEntry)                         'Select on the
       message number stored in this table entry
      Case -1                                             'This msg table slot
       is a deleted entry
        aMsgTbl(nEntry) = uMsg                            'Re-use this entry
        Exit Sub                                          'Bail
      Case uMsg                                           'The msg is already
       in the table!
        Exit Sub                                          'Bail
      End Select
    Next nEntry                                           'Next entry
    
'Make space for the new entry
    ReDim Preserve aMsgTbl(ARRAY_LB To nEntry)            'Increase the size of
     the table. NB nEntry = nMsgCnt + 1
    nMsgCnt = nEntry                                      'Bump the entry count
    aMsgTbl(nEntry) = uMsg                                'Store the message in
     the table
  End If
  
  Call PatchVal(OFFSET_P3, nMsgCnt)                       'Patch the Before
   table entry count
  Call PatchVal(OFFSET_P4, AddrMsgTbl())                  'Patch the address of
   the Before message table. We need do this because there's no guarantee that
   the table existed at SubClass time, the table only gets created if a
   specific message number is added.
End Sub

'Arbitarily call the DefWindowProc - Normally, if bHandled isn't set in the
 WndProc callback, the DefWindowProc
'is called in the assembler thunk after the callback. Use this method to call
 the DefWindowProc first.
Public Function CallDefWndProc(hWnd As Long, uMsg As WinSubHook.eMsg, wParam As
 Long, lParam) As Long
  CallDefWndProc = WinSubHook.DefWindowProc(hWnd, uMsg, wParam, lParam)
End Function

'Return the window class name
Public Property Get Class() As String
  Class = m_sClass
End Property

'Call this method to delete a message from the msg table. NB This method can be
 called at any time
Public Sub DelMsg(uMsg As WinSubHook.eMsg, When As WinSubHook.eMsgWhen)
  Dim nEntry As Long
  
  If uMsg = ALL_MESSAGES Then                             'If deleting all
   messages (specific or ALL_MESSAGES)
    nMsgCnt = 0                                           'Message count is now
     zero
    Call PatchVal(OFFSET_P3, 0)                           'Patch the before
     table message count
  Else                                                    'Else deleteting a
   specific message
    For nEntry = ARRAY_LB To nMsgCnt                      'For each table entry
      If aMsgTbl(nEntry) = uMsg Then                      'If this entry is the
       message we wish to delete
        aMsgTbl(nEntry) = -1                              'Mark the table slot
         as available
        Exit For                                          'Bail
      End If
    Next nEntry                                           'Next entry
  End If
End Sub

'Set the window class owner, Form/Class/UserControl
Public Property Set Owner(NewOwner As WinSubHook.iWindow)
  Set m_Owner = NewOwner
  Call PatchVal(OFFSET_P2, ObjPtr(m_Owner))               'Owner object address
   for iWindow_WndProc
End Property

'Register the window class, call this before creating windows--unless one of
 the predefined window classes is required.
Public Function WindowClassRegister(sClass As String, _
                                    Optional colBackground As Long = &amp;HFFFFFF, _
                                    Optional Style As WinSubHook.eClassStyle =
                                     0, _
                                    Optional hCursor As Long = 0, _
                                    Optional hIcon As Long = 0, _
                                    Optional hIconSm As Long = 0, _
                                    Optional cbClassExtra As Long = 0, _
                                    Optional cbWndExtra As Long = 0) As Boolean
  Dim wc As tWNDCLASSEX

  Debug.Assert (m_sClass = vbNullString)                  'This method should
   only be called once or never for a predefined class
  
  m_sClass = sClass                                       'Store the class name

  With wc
    .cbSize = Len(wc)                                     'Size of the window
     class type
    .cbClsExtra = cbClassExtra                            'Number of class
     extra bytes
    .cbWndExtra = cbWndExtra                              'Number of window
     extra bytes
    .hbrBackground = CreateSolidBrush(colBackground)      'Class background
    .hCursor = hCursor                                    'Class cursor
    .hIcon = hIcon                                        'Class icon
    .hIconSm = hIconSm                                    'Class small icon
    .hInstance = App.hInstance                            'Application instance
     handle
    .lpfnWndProc = nWndProc                               'Class WndProc address
    .Style = Style                                        'Class style
    .lpszClassName = StrPtr( _
                      StrConv(m_sClass, vbFromUnicode))   'Class name
  End With

  WindowClassRegister = (RegisterClassEx(wc) &lt;&gt; 0)        'Register the window
   class
End Function

'Create a window, return the window handle
Public Function WindowCreate(dwExStyle As WinSubHook.eWindowStyleEx, _
                             dwStyle As WinSubHook.eWindowStyle, _
                             Optional Class As WinSubHook.eWindowClass =
                              AS_WINDOWCLASS, _
                             Optional x As Long = 0, _
                             Optional y As Long = 0, _
                             Optional nWidth As Long = 0, _
                             Optional nHeight As Long = 0, _
                             Optional sCaption As String = "", _
                             Optional hWndParent As Long = 0, _
                             Optional hMenu As Long = 0, _
                             Optional lParam As Long = 0) As Long
Dim hWnd    As Long, _
    sClass  As String
  
  Debug.Assert (Not (m_Owner Is Nothing))                 'LOGIC ERROR! the
   Owner must be set before calling this methos
  
  Select Case Class
'User defined window class
    Case WinSubHook.eWindowClass.AS_WINDOWCLASS:             sClass = m_sClass
    
'Predefined window classes
    Case WinSubHook.eWindowClass.PREDEFINED_BUTTON:          sClass = "BUTTON"
    Case WinSubHook.eWindowClass.PREDEFINED_COMBOBOX:        sClass = "COMBOBOX"
    Case WinSubHook.eWindowClass.PREDEFINED_EDIT:            sClass = "EDIT"
    Case WinSubHook.eWindowClass.PREDEFINED_LISTBOX:         sClass = "LISTBOX"
    Case WinSubHook.eWindowClass.PREDEFINED_MDICLIENT:       sClass =
     "MDICLIENT"
    Case WinSubHook.eWindowClass.PREDEFINED_RICHEDIT:        sClass = "RichEdit"
    Case WinSubHook.eWindowClass.PREDEFINED_RICHEDIT_CLASS:  sClass =
     "RICHEDIT_CLASS"
    Case WinSubHook.eWindowClass.PREDEFINED_SCROLLBAR:       sClass =
     "SCROLLBAR"
    Case WinSubHook.eWindowClass.PREDEFINED_STATIC:          sClass = "STATIC"
  End Select
  Debug.Assert (sClass &lt;&gt; vbNullString)                   'LOGIC ERROR! Class
   name not defined
  
'Create the window
  hWnd = WinSubHook.CreateWindowEx(dwExStyle, _
                                    sClass, _
                                    sCaption, _
                                    dwStyle, _
                                    x, y, nWidth, nHeight, _
                                    hWndParent, _
                                    hMenu, _
                                    App.hInstance, _
                                    lParam)
  Debug.Assert hWnd                                       'CreateWindow failed
  Call col_hWnds.Add(hWnd, "h" &amp; hWnd)                    'Add the window
   handle to the collection
  WindowCreate = hWnd
End Function

'Destroy window
Public Function WindowDestroy(ByVal hWnd As Long) As Boolean
Dim sKey As String
  
  On Error GoTo Catch
    sKey = "h" &amp; hWnd
    hWnd = col_hWnds.Item(sKey)                           'Ensure the handle is
     in the collection
    Call WinSubHook.DestroyWindow(hWnd)                   'Destroy the window
    Call col_hWnds.Remove(sKey)                           'Remove the handle
     from the collection
    WindowDestroy = True
Catch:
  On Error GoTo 0
End Function

'-----------------------------
' Private subroutines

'Return the address of the passed user32.dll api function
Private Function AddrFunc(sProc As String) As Long
  AddrFunc = WinSubHook.GetProcAddress(WinSubHook.GetModuleHandle("user32"),
   sProc)
End Function

'Return the address of the low bound of the passed table array
Private Function AddrMsgTbl() As Long
  On Error Resume Next                                    'The table may not be
   dimensioned yet so we need protection
    AddrMsgTbl = VarPtr(aMsgTbl(ARRAY_LB))                'Get the address of
     the first element of the passed message table
  On Error GoTo 0                                         'Switch off error
   protection
End Function

'Patch the code offset with the passed value
Private Sub PatchVal(nOffset As Long, nValue As Long)
  Call WinSubHook.CopyMemory(ByVal (nWndProc + nOffset), nValue, 4)
End Sub

'Patch the code offset with the relative address to the target address
Private Sub PatchRel(nOffset As Long, nTargetAddr As Long)
  Call WinSubHook.CopyMemory(ByVal (nWndProc + nOffset), nTargetAddr - nWndProc
   - nOffset - 4, 4)
End Sub

'Return -1 if we're running in the IDE or 0 if were running compiled
Private Function InIDE() As Long
  Static Value As Long
  
  If Value = 0 Then
    Value = 1
    Debug.Assert InIDE() Or True                          'This line won't
     exist in the compiled app
    InIDE = Value - 1
  End If
  
  Value = 0
End Function
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\compression\index.html" ><IMG SRC="..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Code</a>&#160;.&#160;<a href="..\index.asp\index.html">Libraries</a>&#160;.&#160;<a href="article.html">Subclassing and Hooking with Machine Code Thunks</a>&#160;.&#160;<a href="vb6_winsubhook.html">VB6 WinSubHook</a>&#160;.&#160;WinSubHook_Thunks_cWindow.cls</p><br /><p class="nav"><a href="..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body></html>