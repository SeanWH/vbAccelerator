<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: frmPSAPI.frm</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: frmPSAPI.frm" /><link rel="stylesheet" href="..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">VB</a>&#160;.&#160;<a href="..\index.asp\index.html">Tips</a>&#160;.&#160;<a href="article.html">Using PSAPI to get a complete task list and memory usage.</a>&#160;.&#160;<a href="vb_psapi_demonstration.html">VB PSAPI Demonstration</a>&#160;.&#160;frmPSAPI.frm</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="vb_psapi_demonstration.html"><img src="..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB PSAPI Demonstration</a> (12K)</p><br /><br /><img src="..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:13275</p><p class="nav">&#160;&#160;<a href="..\..\..\..\linkto_asp\id=13275&type=zip&title=vb_20psapi_20demonstration_2ezip_5ffrmpsapi.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\res\update.png" width="8" height="8" alt="Update" />16 Aug 1998<br />First Posted</p><br /><br /><img src="..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\utilities\gui_resource_tracer\article.html">GUI Resource Tracer</a></p><br /><br /><img src="..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\the_site\newsite\article.html"><img src="..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: frmPSAPI.frm</h1><pre>VERSION 5.00
Object = "{6B7E6392-850A-101B-AFC0-4210102A8DA7}#1.3#0"; "COMCTL32.OCX"
Begin VB.Form frmMain 
   Caption         =   "VB Task Viewer"
   ClientHeight    =   4155
   ClientLeft      =   5475
   ClientTop       =   1980
   ClientWidth     =   6585
   Icon            =   "frmPSAPI.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   4155
   ScaleWidth      =   6585
   Begin ComctlLib.ListView lvwProcesses 
      Height          =   3315
      Left            =   60
      TabIndex        =   0
      Top             =   60
      Width           =   6435
      _ExtentX        =   11351
      _ExtentY        =   5847
      View            =   3
      LabelWrap       =   -1  'True
      HideSelection   =   -1  'True
      _Version        =   327682
      SmallIcons      =   "ilsIcons"
      ForeColor       =   -2147483640
      BackColor       =   -2147483643
      Appearance      =   1
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      NumItems        =   5
      BeginProperty ColumnHeader(1) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Process ID"
         Object.Width           =   2540
      EndProperty
      BeginProperty ColumnHeader(2) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   1
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Base Name"
         Object.Width           =   2540
      EndProperty
      BeginProperty ColumnHeader(3) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   2
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Mem Usage"
         Object.Width           =   2540
      EndProperty
      BeginProperty ColumnHeader(4) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   3
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Executable"
         Object.Width           =   2540
      EndProperty
      BeginProperty ColumnHeader(5) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   4
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Modules"
         Object.Width           =   2540
      EndProperty
   End
   Begin VB.PictureBox picButtons 
      BorderStyle     =   0  'None
      Height          =   675
      Left            =   60
      ScaleHeight     =   675
      ScaleWidth      =   4275
      TabIndex        =   1
      Top             =   3420
      Width           =   4275
      Begin VB.CommandButton cmdGet 
         Caption         =   "Get Processes"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   0
         TabIndex        =   4
         Top             =   0
         Width           =   1275
      End
      Begin VB.CommandButton cmdMem 
         Caption         =   "Memory Usage"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   1320
         TabIndex        =   3
         Top             =   0
         Width           =   1395
      End
      Begin VB.CheckBox chkShowDLLS 
         Caption         =   "&amp;Show DLLs"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   0
         TabIndex        =   2
         Top             =   420
         Width           =   2715
      End
   End
   Begin ComctlLib.ImageList ilsIcons 
      Left            =   4440
      Top             =   3420
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   327682
      BeginProperty Images {0713E8C2-850A-101B-AFC0-4210102A8DA7} 
         NumListImages   =   1
         BeginProperty ListImage1 {0713E8C3-850A-101B-AFC0-4210102A8DA7} 
            Picture         =   "frmPSAPI.frx":030A
            Key             =   ""
         EndProperty
      EndProperty
   End
End
Attribute VB_Name = "frmMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Private Const MAX_PATH = 260
Private Declare Function OpenProcess Lib "kernel32" (ByVal dwDesiredAccess As
 Long, ByVal bInheritHandle As Long, ByVal dwProcessId As Long) As Long
Private Declare Function CloseHandle Lib "kernel32" (ByVal hObject As Long) As
 Long
Private Const PROCESS_TERMINATE = &amp;H1
Private Const PROCESS_CREATE_THREAD = &amp;H2
Private Const PROCESS_VM_OPERATION = &amp;H8
Private Const PROCESS_VM_READ = &amp;H10
Private Const PROCESS_VM_WRITE = &amp;H20
Private Const PROCESS_DUP_HANDLE = &amp;H40
Private Const PROCESS_CREATE_PROCESS = &amp;H80
Private Const PROCESS_SET_QUOTA = &amp;H100
Private Const PROCESS_SET_INFORMATION = &amp;H200
Private Const PROCESS_QUERY_INFORMATION = &amp;H400
'private const PROCESS_ALL_ACCESS        =(STANDARD_RIGHTS_REQUIRED or
 SYNCHRONIZE | \
'                                   0xFFF)

Public Sub PrintMemoryInfo(ByVal sProcessName As String, ByVal lProcessID As
 Long)
Dim tPMC As PROCESS_MEMORY_COUNTERS
Dim sMsg As String
Dim hProcess As Long
    
    '// Print information about the memory usage of the process.
    hProcess = OpenProcess(PROCESS_QUERY_INFORMATION Or PROCESS_VM_READ, _
                                    0, lProcessID)
                                    
    If (hProcess &lt;&gt; 0) Then
      
       If (GetProcessMemoryInfo(hProcess, tPMC, Len(tPMC)) &lt;&gt; 0) Then
         sMsg = "Process: " &amp; sProcessName &amp; vbCrLf &amp; vbCrLf
         sMsg = sMsg &amp; "PageFaultCount: " &amp; Format$(tPMC.PageFaultCount,
          "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "PeakWorkingSetSize: " &amp;
          Format$(tPMC.PeakWorkingSetSize, "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "WorkingSetSize: " &amp; Format$(tPMC.WorkingSetSize,
          "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "QuotaPeakPagedPoolUsage: " &amp;
          Format$(tPMC.QuotaPeakPagedPoolUsage, "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "QuotaPagedPoolUsage: " &amp;
          Format$(tPMC.QuotaPagedPoolUsage, "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "QuotaPeakNonPagedPoolUsage: " &amp;
          Format$(tPMC.QuotaPeakNonPagedPoolUsage, "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "QuotaNonPagedPoolUsage: " &amp;
          Format$(tPMC.QuotaNonPagedPoolUsage, "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "PagefileUsage: " &amp; Format$(tPMC.PagefileUsage,
          "#,###,###,###") &amp; vbCrLf
         sMsg = sMsg &amp; "PeakPagefileUsage: " &amp; Format$(tPMC.PeakPagefileUsage,
          "#,###,###,###")
         MsgBox sMsg, vbInformation
      Else
         MsgBox "Failed to get memory usage information", vbExclamation
      End If
      
      CloseHandle hProcess

   Else
      MsgBox "Failed to get a handle to query process.", vbExclamation
   End If

End Sub

Public Sub PrintProcessNameAndID(ByVal lProcessID As Long)
Dim szProcessName As String
Dim lLen As Long
Dim hProcess As Long
Dim hMod(0 To 1023) As Long
Dim cbNeeded As Long
Dim i As Long
Dim iMax As Long
Dim lR As Long
Dim itmX As ListItem
Dim tPMC As PROCESS_MEMORY_COUNTERS

   Set itmX = lvwProcesses.ListItems.Add(, "P" &amp; lProcessID, lProcessID, , 1)

   lLen = MAX_PATH
   
   hProcess = OpenProcess(PROCESS_QUERY_INFORMATION Or _
                                   PROCESS_VM_READ, _
                                   0, lProcessID)
   If (lProcessID = 0) Then
      itmX.SubItems(1) = "System Idle Process"
   ElseIf (lProcessID = 2) Then
      itmX.SubItems(1) = "System"
   Else
      '// get the process name and memory usage:
      If (hProcess &lt;&gt; 0) Then
         If (EnumProcessModules(hProcess, hMod(0), 1024 * 4, _
             cbNeeded)) Then
            itmX.SubItems(4) = cbNeeded \ 4
            If chkShowDLLS.Value = Checked Then
               iMax = cbNeeded \ 4
            Else
               iMax = 1
            End If
            For i = 0 To iMax - 1
               If i &lt;&gt; 0 Then
                  Set itmX = lvwProcesses.ListItems.Add(, "P" &amp; lProcessID &amp;
                   ":M" &amp; i)
               Else
                  ' // get the memory usage:
                  If (GetProcessMemoryInfo(hProcess, tPMC, Len(tPMC)) &lt;&gt; 0) Then
                     itmX.SubItems(2) = Format$(tPMC.WorkingSetSize \ 1024,
                      "#,###,###") &amp; "KB"
                  End If
               End If
               szProcessName = String$(lLen, 0)
               LSet szProcessName = "unknown"
               lR = GetModuleBaseName(hProcess, hMod(i), szProcessName, lLen)
               itmX.SubItems(1) = szProcessName
               
               szProcessName = String$(lLen, 0)
               LSet szProcessName = "unknown"
               lR = GetModuleFileNameEx(hProcess, hMod(i), szProcessName, lLen)
               itmX.SubItems(3) = szProcessName
            Next i
         End If
      End If
   End If
   CloseHandle hProcess

End Sub


Private Sub cmdGet_Click()
Dim aProcesses() As Long
Dim cbNeeded As Long
Dim cProcesses As Long
Dim i As Long

   lvwProcesses.ListItems.Clear

   ' // Get the list of process identifiers.
   ReDim aProcesses(0 To 1023) As Long
   If (EnumProcesses(aProcesses(0), 1024 * 4, cbNeeded) &lt;&gt; 0) Then
      '// Calculate how many process identifiers were returned.
      cProcesses = cbNeeded / 4
      '// Print the name and process identifier for each process.
      For i = 0 To cProcesses - 1
        PrintProcessNameAndID (aProcesses(i))
      Next i
   Else
      MsgBox "Failed to get process list.", vbCritical
   End If

End Sub

Private Sub cmdMem_Click()
Dim sKey As String
Dim lProcessID As Long
Dim iPos As Long
Dim sProcessName As String

   If Not (lvwProcesses.SelectedItem Is Nothing) Then
      sKey = lvwProcesses.SelectedItem.Key
      iPos = InStr(sKey, ":")
      If (iPos &lt;&gt; 0) Then
         sKey = Left$(sKey, (iPos - 1))
      End If
      sProcessName = lvwProcesses.ListItems(sKey).SubItems(1)
      lProcessID = Mid$(sKey, 2)
      PrintMemoryInfo sProcessName, lProcessID
   Else
      MsgBox "Please select an item to get memory usage.", vbInformation
   End If
End Sub

Private Sub Form_Load()
   Me.Show
   Me.Refresh
   cmdGet_Click
End Sub

Private Sub Form_Resize()

   With lvwProcesses
      .Move .Left, .Top, Me.ScaleWidth - .Left * 2, Me.ScaleHeight - .Top * 3 -
       picButtons.Height
      picButtons.Move .Left, .Top * 2 + .Height
   End With
End Sub

Private Sub lvwProcesses_DblClick()
   cmdMem_Click
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\code\libraries\compression\index.html" ><IMG SRC="..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">VB</a>&#160;.&#160;<a href="..\index.asp\index.html">Tips</a>&#160;.&#160;<a href="article.html">Using PSAPI to get a complete task list and memory usage.</a>&#160;.&#160;<a href="vb_psapi_demonstration.html">VB PSAPI Demonstration</a>&#160;.&#160;frmPSAPI.frm</p><br /><p class="nav"><a href="..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 November 2003</p></td><td></td></tr></table>
</body></html>