<html lang="en" >
<head>

<title>vbAccelerator - Alpha Icon Creator Utility</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="
This utility helps you to create 32-bit icons with alpha channels in multiple sizes from a 
single bitmap source image using Alpha Resampling to 
create smartly downsized images with smooth, blended edges.
" /><link rel="stylesheet" href="..\..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\..\res\print.css" media="PRINT" /><link rel="SHORTCUT ICON" href="/home/res/vbaccel.ico" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Utilities</a>&#160;.&#160;Alpha Icon Creator Utility</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="..\vb5_alpha_icon_creator.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB5 Alpha Icon Creator</a> (186K)</p><p /><p class="nav"><a href="..\vb6_alpha_icon_creator.html"><img src="..\..\..\..\res\get.png" width="8" height="8" alt="Download Page" />VB6 Alpha Icon Creator</a> (179K)</p><br /><br /><img src="..\..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Article:13706</p><p class="nav">&#160;&#160;<a href="..\..\..\..\..\linkto_asp\id=13706&type=article&title=alpha_20icon_20creator_20utility.html">Link to this page</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\..\res\update.png" width="8" height="8" alt="Update" />15 Apr 2004<br /><p class="update">Fixed error with setting transparent colour: it was comparing the Red
colour value with the Blue value and hence only worked with shades of grey.</p><p class="update">Added <a href="..\..\..\code\libraries\windows\forcing_a_window_to_show_in_the_taskbar\article.html">ShowInTaskbar</a> code to the
project.</p><p class="update">Added more options for generated icon sizes.</p><p class="update">Fixed crash when attempting to create an icon which
was larger than the resampled image (for example, if tried to resampled a
640x480 image to 48x48 then the resampled version would be 48x36, which
would crash the program when attempting to copy).  The code now centres
images which are smaller to fit.</p></p><p class="update"><a href="..\updates.html">Update History &gt;</a></p><br /><br /><img src="..\..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\code\vbmedia\dib_sections\resampling_with_alpha\article.html">Resampling with Alpha</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\..\..\article_asp\id=4758.html">Readme2.txt</a></p><p class="nav"><img src="..\..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\code\libraries\graphics_and_gdi\reading_and_saving_ico_files_in_vb\article.html">Reading and Saving .ICO files and resources in VB</a></p><br /><br /><img src="..\..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\..\the_site\newsite\article.html"><img src="..\..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>Alpha Icon Creator Utility</h1><p class="splash">Create 32bit smooth alpha-blended icons with smooth edges in various sizes</p><img src="..\alphaiconcreator.png" width="455" height="374" alt="Alpha Icon&#xD;&#xA;Creator Utility" /><p /><p>
This utility helps you to create 32-bit icons with alpha channels in multiple sizes from a 
single bitmap source image using <a href="..\..\..\code\vbmedia\dib_sections\resampling_with_alpha\article.html">Alpha Resampling</a> to 
create smartly downsized images with smooth, blended edges.
</p><h2>About the Utility</h2><p>
The utility has a very simple interface; first select a bitmap that you want to 
resample down to create the icons.  The code will automatically pick the colour
of the top, left pixel of the image as the transparent colour but you can choose
an alternative colour if necessary.  Then choose the icon sizes you want to 
create, a file name for the icon and click next, and the image is resampled and
the icon created.
</p><p>
For best results, the source image should be an even multiple of each of the icon
sizes you want to create.  For example, if you want to create 16x16, 32x32 and 48x48
icons, then a source image of size 480x480 is a good choice since this is evenly 
divisble by each icon size (480/16 = 30, 480/32 = 15, 480/48 = 10).  The code still
works for images of any size, but it has to do more work to calculate the fractional 
contribution of source pixels that straddle multiple pixels in the output.
</p><p>
Here's an example of a source image and the resulting icon images:
</p><img src="..\results.png" width="400" height="240" alt="Source and resulting icon images" /><p class="caption">Source Image and resulting icon images</p><h2>Creating Alpha Icons - An Overview</h2><p>
The concept of resampling an image and using an alpha channel to feather the
edges is described in the Alpha-DIB section article <a href="id=11998.html">Alpha
Resampling</a>.   The idea is that you start with a single, pixel accurate bitmap of a much
larger size to the image you want to draw.  Then you assign the background colour of the
bitmap as the "transparent" colour.  This colour is then mapped so that in the destination
image it has an alpha value of 0, i.e. the destination pixels are completely transparent.
Then say you want to create a version of the image that is 1/4 of the size.  Each pixel
in the smaller version of the image corresponds to 16 pixels (4 x 4) in the source image.
Then, rather than just averaging the colours in each of the source pixels to create
the output pixel, you take both the colour average for non-transparent pixels and the
average overall alpha of the 16 pixel cell.  The result is then the colour average
with the overall alpha applied.  This means that a 4 x 4 block that is half filled 
with black pixels will result in a single black pixel in the output with 50% transparency,
and as a consequence the sampled-down image looks much smoother to the eye.
</p><p>
An example of this process is shown in the figure below:
</p><img src="..\resamplewithalpha.png" width="280" height="142" alt="Resampling with Alpha" /><p class="caption">Resampling with Alpha</p><p>
Icons are internally stored in Windows as DIBSections, as described in the 
<a href="..\..\..\code\libraries\graphics_and_gdi\reading_and_saving_ico_files_in_vb\article.html">cFileIcon article</a>.  The main difference between
an icon and a standard Windows bitmap are two fold:
</p><ol><li>An icon can store multiple renderings within the same file structure, with 
different sizes and colour depths.  These are called Device Images.</li><li>Each icon Device Image contains two DIB Sections: the image (which is just 
the image bitmap) and the Mask.  The Mask is a monochrome DIBSection (i.e. it
uses just 1 bit for each pixel) in which the pixels are 'white' (1) were the icon
should be transparent otherwise they are 'black' (0).</li></ol><p>
Note that for images with an alpha channel, the Mask image is redundant,
since the alpha channel itself can encode which pixels should be transparent
(and also enables the much-needed ability to provide partially transparent pixels).
However, typically the Mask for an icon with an alpha-channel is still set to 
exclude each pixel that is completely transparent (alpha = 0) in the image.
</p><p>
Once you have code which can read and write these image parts to the correct icon
structure in memory, you can then easily create icons in code from other bitmaps
or DIBSection objects.  
</p><p>
The sample code adds a couple of extra methods to the <span class="code">cFileIcon</span>
class to allow DIB data to be copied into the icon structure in memory:
</p><pre>
Public Sub SetImageBits(ByVal lIndex As Long, ByVal lPtr As Long)
   '
Dim tBMIH As BITMAPINFOHEADER
Dim lXor As Long

   ' Get the icon device image size:
   CopyMemory tBMIH, m_tBits(lIndex - 1).bBits(0), Len(tBMIH)
   tBMIH.biHeight = tBMIH.biHeight \ 2

   ' Find the address of the Image bits:
   lXor = FindDIBits(tBMIH)

   ' Copy the image DIB bits directly into the image:
   CopyMemory m_tBits(lIndex - 1).bBits(lXor), _
      ByVal lPtr, _
      tBMIH.biHeight * WidthBytes( _
         tBMIH.biWidth * tBMIH.biPlanes * tBMIH.biBitCount)
   '
End Sub

Public Sub SetMaskBits(ByVal lIndex As Long, ByVal lPtr As Long)
Dim tBMIH As BITMAPINFOHEADER
Dim lXor As Long
Dim lAnd As Long
   
   ' Get the icon device image size:
   CopyMemory tBMIH, m_tBits(lIndex - 1).bBits(0), Len(tBMIH)
   tBMIH.biHeight = tBMIH.biHeight \ 2

   ' Find the address of the Image bits:
   lXor = FindDIBits(tBMIH)
   ' Find the address of the Mask bits offset from the Image bits:
   lAnd = lXor + m_tIDE(lIndex - 1).bHeight * 1# * WidthBytes( _
      tBMIH.biWidth * tBMIH.biPlanes * tBMIH.biBitCount)
   
   ' Copy the mask DIB bits directly into the array:
   CopyMemory m_tBits(lIndex - 1).bBits(lAnd), _
      ByVal lPtr, _ 
      WidthBytes(tBMIH.biWidth) * tBMIH.biHeight
   
End Sub
</pre><p>
Now you can set the image of the icon directly from a DIBSection object
with the correct size and resolution just by passing the pointer to the
DIBSection memory into the <span class="code">SetImageBits</span>
method:
</p><pre>
Dim cResampled As cAlphaDIBSection
   ' Resample the input bitmap:
   Set cResampled = m_cSource.AlphaResample(lWidth)
   ' Set the alpha bits to the result
   cFI.SetImageBits lIndex, cResampled.DIBSectionBitsPtr

</pre><p>
Setting the mask bits is a bit harder since we need to create a 
monochrome DIB with all bits set to 1 where the image
is transparent otherwise 0.  To do this, a byte array is
created to hold the mask and the alpha image is read pixel by 
pixel to set the byte array information, and then finally the
memory in the byte array is copied into the mask:
</p><pre>
Dim b() As Byte
Dim lWidthBytes As Long
   lWidthBytes = ((cResampled.Width + 31) \ 32) * 4
   ReDim b(0 To lWidthBytes - 1, 0 To lHeight - 1) As Byte
   
   createMask cResampled, b()
   cFI.SetMaskBits lIndex, VarPtr(b(0, 0))

..


Private Sub createMask( _
      cDib As cAlphaDIBSection, _
      b() As Byte _
   )
Dim lWidthBytes As Long
Dim lHeight As Long
Dim lCurVal As Long
Dim lBit As Long
Dim x As Long
Dim y As Long
Dim tSA As SAFEARRAY2D
Dim bDib() As Byte
Dim xOut As Long
Dim yOut As Long
         
   ' Get the bits in the from DIB section:
   With tSA
      .cbElements = 1
      .cDims = 2
      .Bounds(0).lLbound = 0
      .Bounds(0).cElements = lHeight
      .Bounds(1).lLbound = 0
      .Bounds(1).cElements = cDib.BytesPerScanLine()
      .pvData = cDib.DIBSectionBitsPtr
   End With
   CopyMemory ByVal VarPtrArray(bDib()), VarPtr(tSA), 4
   
   xOut = 0
   For x = 0 To cDib.BytesPerScanLine() - 4 Step 4
      If (lBit = 8) Then
         lBit = 0
         xOut = xOut + 1
      End If
      For y = 0 To lHeight - 1
         yOut = y
         If (bDib(x + 3, y) = 0) Then
            ' Output = 1
            b(xOut, yOut) = BitSet(b(xOut, yOut), lBit)
         Else
            ' Output = 0
         End If
      Next y
      lBit = lBit + 1
   Next x
   
   ' Clear the temporary array descriptor
   ' (This does not appear to be necessary, but
   ' for safety do it anyway)
   CopyMemory ByVal VarPtrArray(bDib), 0&amp;, 4
   
End Sub

Private Function BitSet(ByVal b As Byte, ByVal lBit As Long) As Byte
   Select Case lBit
   Case 0
      b = b Or &amp;H1
   Case 1
      b = b Or &amp;H2
   Case 2
      b = b Or &amp;H4
   Case 3
      b = b Or &amp;H8
   Case 4
      b = b Or &amp;H10
   Case 5
      b = b Or &amp;H20
   Case 6
      b = b Or &amp;H40
   Case 7
      b = b Or &amp;H80
   End Select
   BitSet = b
End Function
</pre><h2>Conclusion</h2><p>
This utility provides a simple way to create high-quality 32 bit
icons with multiple sizes from a single source bitmap (of course,
you still need to be able to draw the source bitmap!).  The 
provided code can also be used for dynamic creation and manipulation
of alpha-blended icons at run-time.
</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\code\libraries\compression\index.html" ><IMG SRC="..\..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\..\index.html"><img width="125" height="25" src="..\..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\..\index.html">VB</a>&#160;.&#160;<a href="..\..\index.html">Utilities</a>&#160;.&#160;Alpha Icon Creator Utility</p><br /><p class="nav"><a href="..\..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2004 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 17 April 2004</p></td><td></td></tr></table>
</body></html>