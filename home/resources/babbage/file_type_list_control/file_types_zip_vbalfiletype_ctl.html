<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: vbalFileType.ctl</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: vbalFileType.ctl" /><link rel="stylesheet" href="..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) File Type List Control</a>&#160;.&#160;<a href="file_types.html">File Types</a>&#160;.&#160;vbalFileType.ctl</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="file_types.html"><img src="..\..\..\res\get.png" width="8" height="8" alt="Download Page" />File Types</a> (28K)</p><br /><br /><img src="..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12361</p><p class="nav">&#160;&#160;<a href="..\..\..\..\linkto_asp\id=12361&type=zip&title=file_20types_2ezip_5fvbalfiletype.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\res\update.png" width="8" height="8" alt="Update" />26 Jun 2003<br />First Posted</p><br /><br /><img src="..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vb\code\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\the_site\newsite\article.html"><img src="..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: vbalFileType.ctl</h1><pre>VERSION 5.00
Object = "{6B7E6392-850A-101B-AFC0-4210102A8DA7}#1.3#0"; "COMCTL32.OCX"
Begin VB.UserControl vbalFileType 
   ClientHeight    =   3600
   ClientLeft      =   0
   ClientTop       =   0
   ClientWidth     =   4800
   ScaleHeight     =   3600
   ScaleWidth      =   4800
   Begin ComctlLib.ListView lvwTypes 
      Height          =   2355
      Left            =   0
      TabIndex        =   0
      Top             =   0
      Width           =   3495
      _ExtentX        =   6165
      _ExtentY        =   4154
      SortKey         =   1
      View            =   3
      Arrange         =   2
      LabelEdit       =   1
      Sorted          =   -1  'True
      LabelWrap       =   -1  'True
      HideSelection   =   0   'False
      _Version        =   327682
      ForeColor       =   -2147483640
      BackColor       =   -2147483643
      Appearance      =   0
      NumItems        =   2
      BeginProperty ColumnHeader(1) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         Key             =   ""
         Object.Tag             =   ""
         Text            =   ""
         Object.Width           =   2540
      EndProperty
      BeginProperty ColumnHeader(2) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   1
         Key             =   ""
         Object.Tag             =   ""
         Text            =   ""
         Object.Width           =   2540
      EndProperty
   End
   Begin ComctlLib.ImageList ilsJunkSmall 
      Left            =   3720
      Top             =   2700
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   327682
      BeginProperty Images {0713E8C2-850A-101B-AFC0-4210102A8DA7} 
         NumListImages   =   1
         BeginProperty ListImage1 {0713E8C3-850A-101B-AFC0-4210102A8DA7} 
            Picture         =   "vbalFileType.ctx":0000
            Key             =   ""
         EndProperty
      EndProperty
   End
   Begin ComctlLib.ImageList ilsJunkLarge 
      Left            =   3720
      Top             =   2100
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   32
      ImageHeight     =   32
      MaskColor       =   12632256
      _Version        =   327682
      BeginProperty Images {0713E8C2-850A-101B-AFC0-4210102A8DA7} 
         NumListImages   =   1
         BeginProperty ListImage1 {0713E8C3-850A-101B-AFC0-4210102A8DA7} 
            Picture         =   "vbalFileType.ctx":01DA
            Key             =   ""
         EndProperty
      EndProperty
   End
End
Attribute VB_Name = "vbalFileType"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit

Public Enum EVFTBorderStyleTypes
   evplNone
   evplFixedSingle
   evplThin
   evplRaised
End Enum

Private Type tFileType
   lIcon As Long
   sProgId As String
   sDescription As String
   sExtension As String
   sMimeType As String
End Type

Public Enum EVFTViewConstants
   evftLargeIcons
   evftSmallIcons
   evftList
   evftReport
End Enum

Public Enum EVFTIconSizeConstants
   evftSmall
   evftLarge
End Enum

Private m_cFH As cFlatHeader
Private m_cLVE As cLVExternalImageList
Private m_cSysILLarge As cVBALSysImageList
Private m_cSysILSmall As cVBALSysImageList
Private m_bCancel As Boolean
Private m_eBorderStyle As EVFTBorderStyleTypes

Private m_tFileTypes() As tFileType
Private m_iCount As Long

Public Property Get BorderStyle() As EVFTBorderStyleTypes
   BorderStyle = m_eBorderStyle
End Property
Public Property Let BorderStyle(ByVal eStyle As EVFTBorderStyleTypes)
Dim lhWnd As Long
Dim lS As Long
   m_eBorderStyle = eStyle
   UserControl.BorderStyle() = 0
      
   lhWnd = UserControl.hWnd
   lS = GetWindowLong(lhWnd, GWL_EXSTYLE)
   Select Case eStyle
   Case evplNone
      lS = lS And Not (WS_EX_CLIENTEDGE Or WS_EX_STATICEDGE Or WS_EX_WINDOWEDGE)
   Case evplFixedSingle
      lS = (lS Or WS_EX_CLIENTEDGE) And Not (WS_EX_STATICEDGE Or
       WS_EX_WINDOWEDGE)
   Case evplRaised
      lS = (lS Or WS_EX_WINDOWEDGE) And Not (WS_EX_STATICEDGE Or
       WS_EX_CLIENTEDGE)
   Case evplThin
      lS = (lS Or WS_EX_STATICEDGE) And Not (WS_EX_CLIENTEDGE Or
       WS_EX_WINDOWEDGE)
   End Select
   SetWindowLong lhWnd, GWL_EXSTYLE, lS
   
   SetWindowPos lhWnd, 0, 0, 0, 0, 0, SWP_NOMOVE Or SWP_NOSIZE Or
    SWP_NOOWNERZORDER Or SWP_NOZORDER Or SWP_FRAMECHANGED
   
   PropertyChanged "BorderStyle"
End Property

Public Property Get View() As EVFTViewConstants
   View = lvwTypes.View
End Property
Public Property Let View(ByVal eView As EVFTViewConstants)
   lvwTypes.View = eView
   PropertyChanged "View"
End Property
Public Property Get Font() As IFont
   Set Font = lvwTypes.Font
End Property
Public Property Let Font(ByRef iFnt As IFont)
   Set lvwTypes.Font = iFnt
   PropertyChanged "Font"
End Property
Public Property Set Font(ByRef iFnt As IFont)
   Set lvwTypes.Font = iFnt
   PropertyChanged "Font"
End Property

Public Sub LoadTypes(Optional ByVal bYielding As Boolean = False)
Dim cR As New cRegistry
Dim sSect() As String, iSectCount As Long
Dim i As Long
Dim lIcon As Long
Dim sProgId As String
Dim sDescription As String
Dim sMimeType As String
   
   m_iCount = 0
   Erase m_tFileTypes
   m_bCancel = False
   If Not bYielding Then
      lvwTypes.Visible = False
   End If
   
   cR.ClassKey = HKEY_CLASSES_ROOT
   cR.EnumerateSections sSect(), iSectCount
   cR.ValueType = REG_SZ
   For i = 1 To iSectCount
      If left$(sSect(i), 1) = "." Then
         m_iCount = m_iCount + 1
         ReDim Preserve m_tFileTypes(1 To m_iCount) As tFileType
                  
         cR.SectionKey = sSect(i)
         sProgId = cR.Value
         cR.ValueKey = "Content Type"
         sMimeType = cR.Value
         cR.SectionKey = sProgId
         cR.ValueKey = ""
         sDescription = cR.Value
         If Len(sDescription) = 0 Then
            sDescription = UCase$(Mid$(sSect(i), 2)) &amp; " file"
         End If
         
         With m_tFileTypes(m_iCount)
            .sDescription = sDescription
            .sExtension = sSect(i)
            .sProgId = sProgId
            .sMimeType = sMimeType
         End With
      
         AddToLv m_iCount
      
         If bYielding Then
            DoEvents
            If m_bCancel Then
               Exit For
            End If
         End If
      
      End If
   Next i

   If Not bYielding Then
      lvwTypes.Visible = True
   End If

End Sub

Private Sub AddToLv(ByVal lindex As Long)
Dim itmX As ListItem

   With m_tFileTypes(m_iCount)
      Set itmX = lvwTypes.ListItems.Add(, "X" &amp; .sExtension, .sExtension)
      itmX.SubItems(1) = .sDescription
      .lIcon = m_cSysILLarge.ItemIndex("C:\JUNK" &amp; .sExtension)
      m_cLVE.SetIcon itmX, .lIcon
   End With

End Sub

Public Property Get FileTypes() As CFileTypes
   Dim cF As New CFileTypes
   cF.fInit UserControl.hWnd
   Set FileTypes = cF
End Property

Public Sub Cancel()
   m_bCancel = True
End Sub

Private Sub pInitialise()
   
   lvwTypes.Icons = ilsJunkLarge
   lvwTypes.SmallIcons = ilsJunkSmall
     
   Set m_cSysILLarge = New cVBALSysImageList
   With m_cSysILLarge
      .IconSizeX = 32
      .IconSizeY = 32
      .Create
   End With
   Set m_cSysILSmall = New cVBALSysImageList
   With m_cSysILSmall
      .IconSizeX = 16
      .IconSizeY = 16
      .Create
   End With
   Set m_cFH = New cFlatHeader
   m_cFH.Attach lvwTypes.hWnd
   Set m_cLVE = New cLVExternalImageList
   m_cLVE.Initialise lvwTypes, m_cSysILLarge.hIml, m_cSysILSmall.hIml, True
   
   SetProp UserControl.hWnd, GCFTCProp, ObjPtr(Me)
   
End Sub
Private Sub pTerminate()
   RemoveProp UserControl.hWnd, GCFTCProp
End Sub

Public Property Get SelectedItem() As CFileType
   If Not lvwTypes.SelectedItem Is Nothing Then
      Dim cF As New CFileType
      cF.fInit UserControl.hWnd, left$(lvwTypes.SelectedItem.Key, 2)
      Set SelectedItem = cF
   End If
End Property

Friend Property Get fExtension(ByVal lindex As Long) As String
   fExtension = m_tFileTypes(lindex).sExtension
End Property
Friend Property Get fDescription(ByVal lindex As Long) As String
   fDescription = m_tFileTypes(lindex).sProgId
End Property
Friend Property Get fProgID(ByVal lindex As Long) As String
   fProgID = m_tFileTypes(lindex).sProgId
End Property
Friend Property Get fMIMEType(ByVal lindex As Long) As String
   fMIMEType = m_tFileTypes(lindex).sMimeType
End Property
Friend Property Get fCount() As Long
   fCount = m_iCount
End Property
Friend Function fGetIcon(ByVal lindex As Long, ByVal eSize As
 EVFTIconSizeConstants) As IPicture
   If eSize = evftLarge Then
      Set fGetIcon = m_cSysILLarge.ItemPicture(m_tFileTypes(lindex).lIcon)
   Else
      Set fGetIcon = m_cSysILSmall.ItemPicture(m_tFileTypes(lindex).lIcon)
   End If
End Function
Friend Function fEditDialog(ByVal lindex As Long) As Boolean

End Function
Friend Function fChangeIconDialog(ByVal lindex As Long) As Boolean
   
End Function
Friend Function fRemoveFileType(ByVal lindex As Long) As Boolean
Dim l As Long

   ' First remove from the registry:
   Dim cR As New cRegistry
   cR.ClassKey = HKEY_CLASSES_ROOT
   
   

   If m_iCount &gt; 1 Then
      For l = lindex To m_iCount - 1
         LSet m_tFileTypes(l) = m_tFileTypes(l + 1)
      Next l
      m_iCount = m_iCount - 1
      ReDim Preserve m_tFileTypes(1 To m_iCount) As tFileType
   Else
      m_iCount = 0
      Erase m_tFileTypes
   End If
End Function
Friend Property Get fActionCount(ByVal lindex As Long) As Long

End Property

Friend Function fAdd(ByVal sExt As String, ByVal sProgId As String)
Dim i As Long
Dim iPos As Long

   ' Validate:
   If Len(sExt) &gt; 1 Then
      If left$(sExt, 1) &lt;&gt; "." Then
         gErr 3
         Exit Function
      End If
   Else
      gErr 3
      Exit Function
   End If
   
   If Len(sProgId) &gt; 0 Then
      iPos = InStr(sProgId, ".")
      If Not iPos = 0 Then
         iPos = InStr(sProgId, ".")
         If Not iPos = 0 Then
            gErr 4
            Exit Function
         End If
      Else
         gErr 4
         Exit Function
      End If
   Else
      gErr 4
      Exit Function
   End If
   
   ' Check for duplicate Ext/ProgID
   For i = 1 To m_iCount
      If m_tFileTypes(i).sExtension = sExt Then
         gErr 1
         Exit Function
      End If
      If m_tFileTypes(i).sProgId = sProgId Then
         gErr 2
         Exit Function
      End If
   Next i
   
   ' No duplicates, add the thing:
   Dim cR As New cRegistry
   cR.ValueType = REG_SZ
   cR.ClassKey = HKEY_CLASSES_ROOT
   cR.SectionKey = sExt
   cR.Value = sProgId
   cR.SectionKey = sProgId
   cR.Value = UCase$(Mid$(sExt, 2)) &amp; " File"
   
   ' Add to the lists:
   
   fAdd = m_iCount
   
End Function

Friend Property Get fGetIndex(Index As Variant) As Long
Dim i As Long
Dim sIndex As String
   If IsNumeric(Index) Then
      If Index &gt; 0 And Index &lt;= m_iCount Then
         fGetIndex = Index
         Exit Property
      End If
   Else
      On Error Resume Next
      sIndex = UCase$(Index)
      
      On Error GoTo 0
      If Not Err.Number = 0 Then
         Err.Raise 13
      Else
         For i = 1 To m_iCount
            If m_tFileTypes(i).sExtension = sIndex Then
               fGetIndex = i
               Exit Property
            End If
         Next i
      End If
   End If
   
   Err.Raise 9
End Property

Private Sub lvwTypes_ColumnClick(ByVal ColumnHeader As ComctlLib.ColumnHeader)
Dim colX As ColumnHeader

   '
   For Each colX In lvwTypes.ColumnHeaders
      If Not colX Is ColumnHeader Then
         colX.Tag = ""
      End If
   Next
   
   If ColumnHeader.Tag = "ASC" Then
      ColumnHeader.Tag = "DESC"
      lvwTypes.SortOrder = lvwDescending
   Else
      ColumnHeader.Tag = "ASC"
      lvwTypes.SortOrder = lvwAscending
   End If
   
   lvwTypes.SortKey = ColumnHeader.Index - 1
   lvwTypes.Sorted = True
      
End Sub

Private Sub UserControl_Initialize()
   m_eBorderStyle = evplFixedSingle
End Sub

Private Sub UserControl_InitProperties()
   '
   pInitialise
End Sub

Private Sub UserControl_ReadProperties(PropBag As PropertyBag)
    '
   pInitialise
   BorderStyle = PropBag.ReadProperty("BorderStyle", evplFixedSingle)
   Dim sFnt As New StdFont
   sFnt.Name = "MS Sans Serif"
   Font = PropBag.ReadProperty("Font", sFnt)
End Sub

Private Sub UserControl_Resize()
   On Error Resume Next
   lvwTypes.Move 0, 0, UserControl.ScaleWidth, UserControl.ScaleHeight
End Sub

Private Sub UserControl_Show()
   UserControl_Resize
End Sub

Private Sub UserControl_Terminate()
   pTerminate
End Sub

Private Sub UserControl_WriteProperties(PropBag As PropertyBag)
   '
   PropBag.WriteProperty "BorderStyle", BorderStyle, evplFixedSingle
   Dim sFnt As New StdFont
   sFnt.Name = "MS Sans Serif"
   PropBag.WriteProperty "Font", Font, sFnt
End Sub
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vb\code\libraries\compression\index.html" ><IMG SRC="..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) File Type List Control</a>&#160;.&#160;<a href="file_types.html">File Types</a>&#160;.&#160;vbalFileType.ctl</p><br /><p class="nav"><a href="..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 July 2003</p></td><td></td></tr></table>
</body></html>