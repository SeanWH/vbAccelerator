<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: cLVExternalImageList.cls</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: cLVExternalImageList.cls" /><link rel="stylesheet" href="..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) File Type List Control</a>&#160;.&#160;<a href="file_types.html">File Types</a>&#160;.&#160;cLVExternalImageList.cls</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="file_types.html"><img src="..\..\..\res\get.png" width="8" height="8" alt="Download Page" />File Types</a> (28K)</p><br /><br /><img src="..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12361</p><p class="nav">&#160;&#160;<a href="..\..\..\..\linkto_asp\id=12361&type=zip&title=file_20types_2ezip_5fclvexternalimagelist.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\res\update.png" width="8" height="8" alt="Update" />26 Jun 2003<br />First Posted</p><br /><br /><img src="..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vb\code\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><br /><br /><img src="..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\the_site\newsite\article.html"><img src="..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: cLVExternalImageList.cls</h1><pre>VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cLVExternalImageList"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit


'=== API declarations
 ===========================================================
'==== general =================
Private Const GWL_STYLE = (-16)
Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA"
 (ByVal hWnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib "user32" Alias "SetWindowLongA"
 (ByVal hWnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal
 hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long
Private Const WM_DESTROY = &amp;H2
'==== imagelist ============
Private Declare Function ImageList_GetImageCount Lib "COMCTL32.DLL" (ByVal hIml
 As Long) As Long
Private Declare Function ImageList_Destroy Lib "COMCTL32" (ByVal hImageList As
 Long) As Long

'==== listview ==============================================
Private Const LVS_SHAREIMAGELISTS = &amp;H40&amp; 'don't destroy assigned ILs
Private Const LVM_FIRST = &amp;H1000&amp;
Private Const LVM_SETIMAGELIST = (LVM_FIRST + 3)
Private Const LVM_SETITEM = (LVM_FIRST + 6)
Private Const LVSIL_NORMAL = 0&amp;
Private Const LVSIL_SMALL = 1&amp;
Private Const LVIF_IMAGE = 2&amp;

Private Type LV_ITEM
    mask As Long
    iItem As Long
    iSubItem As Long
    State As Long
    stateMask As Long
    pszText As String
    cchTextMax As Long
    iImage As Long
    lParam As Long '(~ ItemData)
'#if (_WIN32_IE &gt;= 0x0300)
    iIndent As Long
'#End If
End Type

Implements ISubclass

Private m_hWnd As Long
Private m_bAllowSetImageLists As Boolean
Private m_hImageListLarge As Long
Private m_hImageListSmall As Long

Public Sub Initialise( _
      lvwThis As ListView, _
      Optional ByVal hImageListLarge As Long = 0, _
      Optional ByVal hImageListSmall As Long = 0, _
      Optional ByVal bClearVBImageLists As Boolean = False _
   )
   pTerminate
   
   If bClearVBImageLists Then
      On Error Resume Next
      m_hImageListLarge = lvwThis.Icons.hImageList
      m_hImageListSmall = lvwThis.SmallIcons.hImageList
   End If
   
   On Error GoTo 0
   m_hWnd = lvwThis.hWnd
   AttachMessage Me, m_hWnd, WM_DESTROY
   AttachMessage Me, m_hWnd, LVM_SETIMAGELIST
   SetImageLists hImageListLarge, hImageListSmall
   
End Sub
Public Sub SetImageLists( _
      Optional ByVal hImageListLarge As Long = 0, _
      Optional ByVal hImageListSmall As Long = 0 _
   )
Dim lR As Long
   If m_hWnd &lt;&gt; 0 Then
      m_bAllowSetImageLists = True
      If hImageListLarge &lt;&gt; 0 Then
         lR = SendMessage(m_hWnd, LVM_SETIMAGELIST, LVSIL_NORMAL, ByVal
          hImageListLarge)
         If m_hImageListLarge &lt;&gt; 0 Then
            ImageList_Destroy m_hImageListLarge
            m_hImageListLarge = 0
         End If
      End If
      If hImageListSmall &lt;&gt; 0 Then
         lR = SendMessage(m_hWnd, LVM_SETIMAGELIST, LVSIL_SMALL, ByVal
          hImageListSmall)
         If m_hImageListSmall &lt;&gt; 0 Then
            ImageList_Destroy m_hImageListSmall
            m_hImageListSmall = 0
         End If
      End If
      m_bAllowSetImageLists = False
   Else
      ' error, not initialised
      
   End If
End Sub
Public Sub SetIcon( _
      ByRef itmX As ListItem, _
      ByVal lIconIndex As Long _
   )
Dim tLV As LV_ITEM
Dim lR As Long
   tLV.iItem = itmX.Index - 1
   tLV.iImage = lIconIndex
   tLV.mask = LVIF_IMAGE
   lR = SendMessage(m_hWnd, LVM_SETITEM, 0&amp;, tLV)
End Sub

Private Sub pTerminate()
   If m_hWnd &lt;&gt; 0 Then
      DetachMessage Me, m_hWnd, WM_DESTROY
      DetachMessage Me, m_hWnd, LVM_SETIMAGELIST
      m_hWnd = 0
   End If
   m_hImageListLarge = 0
   m_hImageListSmall = 0
End Sub

Private Sub Class_Terminate()
   pTerminate
End Sub

Private Property Let ISubClass_MsgResponse(ByVal RHS As SSubTimer.EMsgResponse)
   '
End Property

Private Property Get ISubClass_MsgResponse() As SSubTimer.EMsgResponse
   Select Case CurrentMessage
   Case WM_DESTROY
      ISubClass_MsgResponse = emrPreprocess
   Case Else
      ISubClass_MsgResponse = emrConsume
   End Select
End Property

Private Function ISubClass_WindowProc(ByVal hWnd As Long, ByVal iMsg As Long,
 ByVal wParam As Long, ByVal lParam As Long) As Long
   Select Case iMsg
   Case WM_DESTROY
      ' For safety - if the scope of this class is
      ' wider than the form containing the ListView
      ' this ensures we clear up right.
      pTerminate
   Case LVM_SETIMAGELIST
      If m_bAllowSetImageLists Then
         ISubClass_WindowProc = CallOldWindowProc(hWnd, iMsg, wParam, lParam)
      Else
         Debug.Print "Consuming LV SetImageList"
      End If
   End Select
End Function


</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="javascript:window.alert(&quot;http://vbaccelerator.com/home/include/adredir.asp?url=http://oneandone.co.uk/xml/init?k_id=5791003&image=http://oneandone.co.uk/xml/banner?size=1&number=1\nThis link was not retrieved.&quot;)" ><IMG SRC="..\..\..\..\..\oneandone_co_uk\xml\banner\size=1&number=1.html" ALT="1&1 Web Hosting" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) File Type List Control</a>&#160;.&#160;<a href="file_types.html">File Types</a>&#160;.&#160;cLVExternalImageList.cls</p><br /><p class="nav"><a href="..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 July 2003</p></td><td></td></tr></table>
</body></html>