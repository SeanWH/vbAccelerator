<html lang="en" >
<head>
<title>vbAccelerator - Contents of code file: mHook.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mHook.bas" /><link rel="stylesheet" href="..\..\..\res\screen.css" media="SCREEN" /><link rel="stylesheet" href="..\..\..\res\print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><td colspan="3">
<!-- TF 468x60 JScript HORIZ NoPop code -->
<script language=javascript><!--
document.write('<scr'+'ipt language=javascript src="http://a.tribalfusion.com/j.ad?site=VBAcceleratorcom&adSpace=ROS&size=468x60&type=horiz&pop=0&requestID='+((new Date()).getTime() % 2147483648) + Math.random()+'"></scr'+'ipt>');
//-->
</script>
<noscript>
   <a href="javascript:window.alert(&quot;http://a.tribalfusion.com/i.click?site=VBAcceleratorcom&adSpace=ROS&size=468x60&requestID=1423477941\nThis link was not retrieved.&quot;)" target=_blank>
   <img src="http://cdn5.tribalfusion.com/media/493786.gif" 
                  width=468 height=60 border=0 alt="Click Here"></a>
</noscript>
<!-- TF 468x60 JScript HORIZ NoPop code -->
</td></tr><tr class="navbar"><td><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) Menus From First Principles</a>&#160;.&#160;<a href="menu_picker.html">Menu Picker</a>&#160;.&#160;mHook.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="..\..\..\res\download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="menu_picker.html"><img src="..\..\..\res\get.png" width="8" height="8" alt="Download Page" />Menu Picker</a> (35K)</p><br /><br /><img src="..\..\..\res\information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:12405</p><p class="nav">&#160;&#160;<a href="..\..\..\..\linkto_asp\id=12405&type=zip&title=menu_20picker_2ezip_5fmhook.html">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB6</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="..\..\..\res\bugtrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="..\..\..\res\updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="..\..\..\res\update.png" width="8" height="8" alt="Update" />26 Jun 2003<br />First Posted</p><br /><br /><img src="..\..\..\res\related.png" width="125" height="21" alt="Related Items" /><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vb\code\libraries\subclassing\ssubtimer\article.html">Subclassing Without The Crashes</a></p><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vb\code\controls\imagelist\vbaccelerator_image_list_control\article.html">vbAccelerator ImageList Control and Class v2.0</a></p><p class="nav"><img src="..\..\..\res\rel.png" width="8" height="8" alt="Related Item" /><a href="..\..\..\vb\type_libraries\ishellfolder\article.html">IShellFolder Extended Type Library Version 1.2 (ISHF_Ex.Tlb)</a></p><br /><br /><img src="..\..\..\res\search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="javascript:window.alert(&quot;http://www.google.com/search\nThis link was not retrieved.&quot;)"><img src="..\..\..\..\..\www_google_com\logos\logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="..\..\..\the_site\newsite\article.html"><img src="..\..\..\res\newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mHook.bas</h1><pre>Attribute VB_Name = "mHook"
Option Explicit

Private Declare Function GetAsyncKeyState Lib "user32" (ByVal vKey As Long) As
 Integer
Private Declare Function SetWindowsHookEx Lib "user32" Alias
 "SetWindowsHookExA" (ByVal idHook As Long, ByVal lpfn As Long, ByVal hmod As
 Long, ByVal dwThreadId As Long) As Long
Private Declare Function UnhookWindowsHookEx Lib "user32" (ByVal hHook As Long)
 As Long
Private Declare Function CallNextHookEx Lib "user32" (ByVal hHook As Long,
 ByVal nCode As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetCurrentThreadId Lib "kernel32" () As Long
Private Const WH_KEYBOARD As Long = 2
Private Const MSGF_MENU = 2
Private Const HC_ACTION = 0
Private Const WH_MOUSE As Long = 7
Private Const WM_MOUSEMOVE = &amp;H200
Private Const WM_NCMOUSEMOVE = &amp;HA0

Private m_iKeyHookCount As Long
Private m_lKeyHookhWnd() As Long
Private m_hKeyHook As Long

Private m_iMouseHookCount As Long
Private m_lMouseHookhWnd() As Long
Private m_hMouseHook As Long

Public Sub AttachMouseHook(ByVal hWnd As Long)
   
   Dim lpfn As Long
   If (m_iMouseHookCount = 0) Then
      lpfn = HookAddress(AddressOf MouseFilter)
      m_hMouseHook = SetWindowsHookEx(WH_MOUSE, lpfn, 0&amp;, GetCurrentThreadId())
      Debug.Assert (m_hMouseHook &lt;&gt; 0)
   End If
   
   Dim i As Long
   For i = 1 To m_iMouseHookCount
      If hWnd = m_lMouseHookhWnd(i) Then
         ' we already have it
         'Debug.Assert False
         Exit Sub
      End If
   Next i
   
   If Not (m_hMouseHook = 0) Then
      ReDim Preserve m_lMouseHookhWnd(1 To m_iMouseHookCount + 1) As Long
      m_iMouseHookCount = m_iMouseHookCount + 1
      m_lMouseHookhWnd(m_iMouseHookCount) = hWnd
   End If
   
End Sub

Public Sub DetachMouseHook(ByVal hWnd As Long)
Dim i As Long
Dim lPtr As Long
Dim iThis As Long
   
   For i = 1 To m_iMouseHookCount
      If m_lMouseHookhWnd(i) = hWnd Then
         iThis = i
         Exit For
      End If
   Next i
   
   If Not (iThis = 0) Then
      If m_iMouseHookCount &gt; 1 Then
         For i = iThis To m_iMouseHookCount - 1
            m_lMouseHookhWnd(i) = m_lMouseHookhWnd(i + 1)
         Next i
      End If
      m_iMouseHookCount = m_iMouseHookCount - 1
      If m_iMouseHookCount &gt;= 1 Then
         ReDim Preserve m_lMouseHookhWnd(1 To m_iMouseHookCount) As Long
      Else
         Erase m_lMouseHookhWnd
      End If
   Else
      ' hmmm
   End If
   
   If m_iMouseHookCount &lt;= 0 Then
      If Not (m_hMouseHook = 0) Then
         UnhookWindowsHookEx m_hMouseHook
         m_hMouseHook = 0
      End If
   End If

End Sub


Public Sub AttachKeyboardHook(ByVal hWnd As Long)
   
   Dim lpfn As Long
   If m_iKeyHookCount = 0 Then
      lpfn = HookAddress(AddressOf KeyboardFilter)
      m_hKeyHook = SetWindowsHookEx(WH_KEYBOARD, lpfn, 0&amp;, GetCurrentThreadId())
      Debug.Assert (m_hKeyHook &lt;&gt; 0)
   End If
   
   Dim i As Long
   For i = 1 To m_iKeyHookCount
      If hWnd = m_lKeyHookhWnd(i) Then
         ' we already have it:
         Debug.Assert False
         Exit Sub
      End If
   Next i
      
   If Not (m_hKeyHook = 0) Then
      ReDim Preserve m_lKeyHookhWnd(1 To m_iKeyHookCount + 1) As Long
      m_iKeyHookCount = m_iKeyHookCount + 1
      m_lKeyHookhWnd(m_iKeyHookCount) = hWnd
   End If
   
End Sub

Public Sub DetachKeyboardHook(ByVal hWnd As Long)
Dim i As Long
Dim lPtr As Long
Dim iThis As Long
   
   For i = 1 To m_iKeyHookCount
      If m_lKeyHookhWnd(i) = hWnd Then
         iThis = i
         Exit For
      End If
   Next i
   
   If Not (iThis = 0) Then
      If m_iKeyHookCount &gt; 1 Then
         For i = iThis To m_iKeyHookCount - 1
            m_lKeyHookhWnd(i) = m_lKeyHookhWnd(i + 1)
         Next i
      End If
      m_iKeyHookCount = m_iKeyHookCount - 1
      If m_iKeyHookCount &gt;= 1 Then
         ReDim Preserve m_lKeyHookhWnd(1 To m_iKeyHookCount) As Long
      Else
         Erase m_lKeyHookhWnd
      End If
   Else
      ' hmmm
   End If
   
   If m_iKeyHookCount &lt;= 0 Then
      If Not (m_hKeyHook = 0) Then
         UnhookWindowsHookEx m_hKeyHook
         m_hKeyHook = 0
      End If
   End If

End Sub

Private Function HookAddress(ByVal lPtr As Long) As Long
   HookAddress = lPtr
End Function


Private Function KeyboardFilter(ByVal nCode As Long, ByVal wParam As Long,
 ByVal lParam As Long) As Long
Dim bKeyUp As Boolean
Dim bAlt As Boolean, bCtrl As Boolean, bShift As Boolean
Dim bFKey As Boolean, bEscape As Boolean, bDelete As Boolean
Dim wMask As ShiftConstants
Dim i As Long
Dim lErr As Long
Dim ctlPicker As vbalPicker
Dim bProcessed As Boolean
Dim bConsume As Boolean

On Error GoTo ErrorHandler

   If nCode = HC_ACTION And m_iKeyHookCount &gt; 0 Then
      ' Key up or down:
      bKeyUp = ((lParam And &amp;H80000000) = &amp;H80000000)
      bShift = (GetAsyncKeyState(vbKeyShift) &lt;&gt; 0)
      bAlt = (GetAsyncKeyState(vbKeyMenu) &lt;&gt; 0) Or (wParam = vbKeyMenu)
      bCtrl = (GetAsyncKeyState(vbKeyControl) &lt;&gt; 0)
      bFKey = ((wParam &gt;= vbKeyF1) And (wParam &lt;= vbKeyF12))
      bEscape = (wParam = vbKeyEscape)
      bDelete = (wParam = vbKeyDelete)
      wMask = Abs(bShift * vbShiftMask) Or Abs(bCtrl * vbCtrlMask) Or Abs(bAlt
       * vbAltMask)
      For i = m_iKeyHookCount To 1 Step -1
         If Not (m_lKeyHookhWnd(i) = 0) Then
            lErr = 0
            On Error Resume Next
            gbValidOwner m_lKeyHookhWnd(i), ctlPicker
            lErr = Err.Number
            On Error GoTo 0
            If (lErr = 0) And Not (ctlPicker Is Nothing) Then
               If ctlPicker.fKeyPress(wParam, wMask, bKeyUp) Then
                  bConsume = True
                  Exit For
               ElseIf ctlPicker.fInMenuLoop Then
                  bConsume = True
               End If
            End If
         End If
      Next i
   End If
   
   
   bProcessed = True
   If (bConsume) Then
      KeyboardFilter = 1
   Else
      KeyboardFilter = CallNextHookEx(m_hKeyHook, nCode, wParam, lParam)
   End If
   Exit Function

ErrorHandler:
   Debug.Print "Keyboard Hook Error!"
   If Not bProcessed Then
      On Error Resume Next
      KeyboardFilter = CallNextHookEx(m_hKeyHook, nCode, wParam, lParam)
   End If
   Exit Function
   
End Function

Private Function MouseFilter(ByVal nCode As Long, ByVal wParam As Long, ByVal
 lParam As Long) As Long
Dim lErr As Long
Dim i As Long
Dim ctlPicker As vbalPicker
Dim bProcessed As Boolean
Dim bInNone As Boolean

On Error GoTo ErrorHandler
   
   If (nCode = HC_ACTION) Then
      If Not ((wParam = WM_MOUSEMOVE) Or (wParam = WM_NCMOUSEMOVE)) Then
         bInNone = True
         Dim tMHS As MOUSEHOOKSTRUCT
         CopyMemory tMHS, ByVal lParam, Len(tMHS)
         Debug.Print Hex(tMHS.dwExtraInfo)
         For i = m_iMouseHookCount To 1 Step -1
            If m_lMouseHookhWnd(i) &lt;&gt; 0 Then
               lErr = 0
               On Error Resume Next
               gbValidOwner m_lMouseHookhWnd(i), ctlPicker
               lErr = Err.Number
               On Error GoTo 0
               If (lErr = 0) And Not (ctlPicker Is Nothing) Then
                  If ctlPicker.fMousePress(tMHS.pt.x, tMHS.pt.y) Then
                     bInNone = False
                     Exit For
                  End If
               End If
            End If
         Next i
         If bInNone Then
            i = 1
            Do While m_iMouseHookCount &gt; 0
               lErr = 0
               On Error Resume Next
               gbValidOwner m_lMouseHookhWnd(i), ctlPicker
               lErr = Err.Number
               On Error GoTo 0
               If (lErr = 0) And Not (ctlPicker Is Nothing) Then
                  ctlPicker.fEndMenuLoop
               End If
            Loop
         End If
      End If
   End If
   
   bProcessed = True
   MouseFilter = CallNextHookEx(m_hMouseHook, nCode, wParam, lParam)
   Exit Function
   
ErrorHandler:
   Debug.Print "Mouse Hook Error!"
   If Not bProcessed Then
      On Error Resume Next
      MouseFilter = CallNextHookEx(m_hMouseHook, nCode, wParam, lParam)
   End If
   Exit Function
   
End Function
</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<noscript>
<A HREF="..\..\..\vb\code\libraries\compression\index.html" ><IMG SRC="..\..\..\res\compress.png" ALT="Create and read Zip files and compress your data using Zlib" WIDTH=468 HEIGHT=60 BORDER=0></A>
</noscript>

</p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="..\..\..\index.html"><img width="125" height="25" src="..\..\..\res\vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="..\..\..\index.html">Home</a>&#160;.&#160;<a href="..\..\index.html">Resources</a>&#160;.&#160;<a href="..\index.asp\index.html">Babbage</a>&#160;.&#160;<a href="article.html">(Incomplete) Menus From First Principles</a>&#160;.&#160;<a href="menu_picker.html">Menu Picker</a>&#160;.&#160;mHook.bas</p><br /><p class="nav"><a href="..\..\..\the_site\copyright\article.html">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 1 July 2003</p></td><td></td></tr></table>
</body></html>